<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="icon" href="/static/favicon.ico"  type="image/x-icon">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/static/css/common.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/login.css" />
	<script src="/static/js/jquery-3.5.1.min.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/global.js"></script>
</head>
<script type="text/javascript">

	$(document).ready(function() {
		var loginId = getCookie("loginId");
		var validYn = getCookie("jwtToken");
		if(validYn != null) {
			checkToken();
		}
		if(loginId != null) {
			$("#id").val(loginId);
			$("#idSaveCheck").prop("checked", true);
		}
		$("body").keydown(function(key) {
			if (key.keyCode == 13) {
				loginAction();
			}
		});
		$("#idSaveCheck").change(function(){ // 체크박스에 변화가 발생시
	        if($("#idSaveCheck").is(":checked")){ // ID 저장하기 체크했을 때,
	            var loginId = $("#id").val();
	            setCookie("loginId", loginId, 7); // 7일 동안 쿠키 보관
	        }else{ // ID 저장하기 체크 해제 시,
	            deleteCookie("loginId");
	        }
	    });
		// ID 저장하기를 체크한 상태에서 ID를 입력하는 경우, 이럴 때도 쿠키 저장.
	    $("#id").keyup(function(){ // ID 입력 칸에 ID를 입력할 때,
	        if($("#idSaveCheck").is(":checked")){ // ID 저장하기를 체크한 상태라면,
	            var loginId = $("#id").val();
	            setCookie("loginId", loginId, 7); // 7일 동안 쿠키 보관
	        }
	    });
	    setImg();
	});
	
	function checkToken() {
		$.ajax({
		    type: "POST",
		    url: "/admin/cm/cm02/selectRoleInfo",
		    beforeSend: function (request) {
	            request.setRequestHeader("Authorization", authorizationToken);
	        },
		    success: function(data){
		    	menuIdx = getCookie("menuIdx");
				openNotiPop();
		    },
	        error: function (data) {
	        	return;
	        }
		});
	}
	
	function setupAuthorization(headerValue) {
		$.ajaxSetup({
			contentType: "application/x-www-form-urlencoded; charset=utf-8",
			beforeSend: function (request)
            {
                request.setRequestHeader("Authorization", headerValue);
            }
		});
	}
	
	function getToken() {
		//헤더 세팅
		setupAuthorization("Basic "+btoa($("#id").val()+":"+$("#pass").val()));
		
		var formData = {
			"grant_type" : "password",	
			"id" : $("#id").val(),
			"password" : $("#pass").val()
		}
		$.post(
			"/oauth/token",
			formData,
			function(data, status, request) {
				setCookie("jwtToken", "Bearer "+data.access_token, 1);
				authorizationToken = getCookie("jwtToken");
				jwt = parseJwt(authorizationToken);
				menuIdx = getCookie("menuIdx");
				selectAuthInfo();
			}
		);
	}
	
	function openNotiPop() {
		var defaultUrl = "/static/html/admin/cm/cm10/CM1001M01.html";
		postAjax("/admin/cm/cm09/selectNotiPopList", {}, null, function(data){
			var list = data.result;
			var left = 30;
			var top = 30;
			for(var i=0; i<list.length; i++) {
				if(getCookie(list[i]) == null){
					window.open("/static/html/cmn/notiPop.html?notiKey="+list[i], "popup"+i, "width=600, height=600, left="+left+", top="+top);	
					left += 600;
				}
			}
			if(jwt.authInfo.indexOf("AUTH100") > -1){
				defaultUrl = "/static/html/admin/cm/cm11/CM1101M01.html";
			}
			location.href = defaultUrl;
		});
	}
	
	function loginAction() {
		var isValid = true;
		$("input").each(function(index, item){
			if($(this)[0].id != '_retVal12'){
				if($(this).val() == "") {
					isValid = false;
					return false;
				}
			}
		});
		if(!isValid) {
			alert("모든 정보를 입력하셔야 합니다.");
			return;
		}
		var formData = {
			"grant_type" : "password",	
			"id" : $("#id").val(),
			"password" : $("#pass").val()
		}
		$.ajax({
		    type: "POST",
		    url: "/login",
		    contentType: "application/json; charset=utf-8",
		    data: JSON.stringify(formData),
		    success: function(data){
		    	if(data.msg == "success"){
		    		getToken();	    		
		    	} else {
		    		alert(data.msg);
		    	}
		    }
		});
	}
	
	function selectAuthInfo(){
		var formData = {
			"authInfo" : jwt.authInfo
		}
		postAjaxSync("/selectMenuAuth", formData, null, function(data) {
			var authString = JSON.stringify(data.accessJSON);
			deleteCookie("authArr");
			setCookie("authArr", authString, 1);
			console.log(authString);
			var arr = JSON.parse(getCookie("authArr"));
			console.log(arr);
			//arr = [{"menuUrl":"SD0201M01","saveYn":"Y"},{"menuUrl":"BM0601M01","saveYn":"Y"},{"menuUrl":"CM1001M01","saveYn":"Y"},{"menuUrl":"BM0101M01","saveYn":"Y"},{"menuUrl":"SD0601M01","saveYn":"Y"},{"menuUrl":"RD0101M01","saveYn":"Y"},{"menuUrl":"SM0601M01","saveYn":"Y"},{"menuUrl":"SM0101M01","saveYn":"Y"},{"menuUrl":"SD0301M01","saveYn":"Y"},{"menuUrl":"CM1101M01","saveYn":"Y"},{"menuUrl":"BM0201M01","saveYn":"Y"},{"menuUrl":"BM0301M01","saveYn":"Y"},{"menuUrl":"SD0501M01","saveYn":"Y"},{"menuUrl":"FI0202M01","saveYn":"Y"},{"menuUrl":"SM0102M01","saveYn":"Y"},{"menuUrl":"RD0401M01","saveYn":"Y"},{"menuUrl":"BM0401M01","saveYn":"Y"},{"menuUrl":"SD0401M01","saveYn":"Y"},{"menuUrl":"FI0203M01","saveYn":"Y"},{"menuUrl":"SM0201M01","saveYn":"Y"},{"menuUrl":"SM0301M01","saveYn":"Y"},{"menuUrl":"BM0501M01","saveYn":"Y"},{"saveYn":"Y"},{"menuUrl":"OD0401M01","saveYn":"Y"},{"menuUrl":"SM0401M01","saveYn":"Y"},{"menuUrl":"RD0501M01","saveYn":"Y"},{"menuUrl":"BM0601M01","saveYn":"Y"},{"menuUrl":"AR0301M01","saveYn":"Y"},{"menuUrl":"BM0701M01","saveYn":"Y"},{"menuUrl":"BM0801M01","saveYn":"Y"},{"menuUrl":"SD0701M01","saveYn":"Y"},{"menuUrl":"AR1001M01","saveYn":"Y"},{"menuUrl":"CM9901M01","saveYn":"Y"},{"menuUrl":"AR1101M01","saveYn":"Y"},{"menuUrl":"CM0101M01","saveYn":"Y"},{"menuUrl":"SD0801M01","saveYn":"Y"},{"menuUrl":"BM0801M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0101M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"OD0101M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"FI0101M01","saveYn":"Y"},{"menuUrl":"AR1201M01","saveYn":"Y"},{"menuUrl":"AR1002M01","saveYn":"Y"},{"menuUrl":"FI0201M01","saveYn":"Y"},{"menuUrl":"OD0201M01","saveYn":"Y"},{"menuUrl":"BM0201M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"account","saveYn":"Y"},{"menuUrl":"CM2001M01","saveYn":"Y"},{"menuUrl":"AR0201M01","saveYn":"Y"},{"menuUrl":"CM0201M01","saveYn":"Y"},{"menuUrl":"BM0801H01","saveYn":"Y"},{"menuUrl":"CM0301M01","saveYn":"Y"},{"menuUrl":"OD0201M02","saveYn":"Y"},{"menuUrl":"AR0201M02","saveYn":"Y"},{"menuUrl":"SD0901M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"SM0501M01","saveYn":"Y"},{"menuUrl":"OD0301M01","saveYn":"Y"},{"menuUrl":"AR0701M01","saveYn":"Y"},{"menuUrl":"CM0401M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0701M02","saveYn":"Y"},{"menuUrl":"PP0101M01","saveYn":"Y"},{"menuUrl":"CM0501M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0501M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"CM0601M01","saveYn":"Y"},{"menuUrl":"OD0501M01","saveYn":"Y"},{"menuUrl":"AR0601M01","saveYn":"Y"},{"menuUrl":"AR0801M01","saveYn":"Y"},{"menuUrl":"AR0901M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"CM0701M01","saveYn":"Y"},{"menuUrl":"AR0401M01","saveYn":"Y"},{"menuUrl":"CM0901M01","saveYn":"Y"},{"menuUrl":"uploadExcel","saveYn":"Y"},{"menuUrl":"message","saveYn":"Y"},{"menuUrl":"PP0401M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"SM0103M01","saveYn":"Y"},{"menuUrl":"maker","saveYn":"Y"},{"menuUrl":"standard","saveYn":"Y"},{"menuUrl":"production","saveYn":"Y"},{"menuUrl":"equipment","saveYn":"Y"},{"saveYn":"Y"},{"menuUrl":"clearance","saveYn":"Y"},{"menuUrl":"workflow","saveYn":"Y"}];
			//arr =[{"menuUrl":"SD0201M01","saveYn":"Y"},{"menuUrl":"BM0601M01","saveYn":"Y"},{"menuUrl":"CM1001M01","saveYn":"Y"},{"menuUrl":"BM0101M01","saveYn":"Y"},{"menuUrl":"SD0601M01","saveYn":"Y"},{"menuUrl":"RD0101M01","saveYn":"Y"},{"menuUrl":"SM0601M01","saveYn":"Y"},{"menuUrl":"SM0101M01","saveYn":"Y"},{"menuUrl":"SD0301M01","saveYn":"Y"},{"menuUrl":"CM1101M01","saveYn":"Y"},{"menuUrl":"BM0201M01","saveYn":"Y"},{"menuUrl":"BM0301M01","saveYn":"Y"},{"menuUrl":"SD0501M01","saveYn":"Y"},{"menuUrl":"FI0202M01","saveYn":"Y"},{"menuUrl":"SM0102M01","saveYn":"Y"},{"menuUrl":"RD0401M01","saveYn":"Y"},{"menuUrl":"BM0401M01","saveYn":"Y"},{"menuUrl":"SD0401M01","saveYn":"Y"},{"menuUrl":"FI0203M01","saveYn":"Y"},{"menuUrl":"SM0201M01","saveYn":"Y"},{"menuUrl":"SM0301M01","saveYn":"Y"},{"menuUrl":"BM0501M01","saveYn":"Y"},{"saveYn":"Y"},{"menuUrl":"OD0401M01","saveYn":"Y"},{"menuUrl":"SM0401M01","saveYn":"Y"},{"menuUrl":"RD0501M01","saveYn":"Y"},{"menuUrl":"BM0601M01","saveYn":"Y"},{"menuUrl":"AR0301M01","saveYn":"Y"},{"menuUrl":"BM0701M01","saveYn":"Y"},{"menuUrl":"BM0801M01","saveYn":"Y"},{"menuUrl":"SD0701M01","saveYn":"Y"},{"menuUrl":"AR1001M01","saveYn":"Y"},{"menuUrl":"CM9901M01","saveYn":"Y"},{"menuUrl":"AR1101M01","saveYn":"Y"},{"menuUrl":"CM0101M01","saveYn":"Y"},{"menuUrl":"SD0801M01","saveYn":"Y"},{"menuUrl":"BM0801M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0101M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"OD0101M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"FI0101M01","saveYn":"Y"},{"menuUrl":"AR1201M01","saveYn":"Y"},{"menuUrl":"AR1002M01","saveYn":"Y"},{"menuUrl":"FI0201M01","saveYn":"Y"},{"menuUrl":"OD0201M01","saveYn":"Y"},{"menuUrl":"BM0201M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"account","saveYn":"Y"},{"menuUrl":"CM2001M01","saveYn":"Y"},{"menuUrl":"AR0201M01","saveYn":"Y"},{"menuUrl":"CM0201M01","saveYn":"Y"},{"menuUrl":"BM0801H01","saveYn":"Y"},{"menuUrl":"CM0301M01","saveYn":"Y"},{"menuUrl":"OD0201M02","saveYn":"Y"},{"menuUrl":"AR0201M02","saveYn":"Y"},{"menuUrl":"SD0901M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"SM0501M01","saveYn":"Y"},{"menuUrl":"OD0301M01","saveYn":"Y"},{"menuUrl":"AR0701M01","saveYn":"Y"},{"menuUrl":"CM0401M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0701M02","saveYn":"Y"},{"menuUrl":"PP0101M01","saveYn":"Y"},{"menuUrl":"CM0501M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"AR0501M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"CM0601M01","saveYn":"Y"},{"menuUrl":"OD0501M01","saveYn":"Y"},{"menuUrl":"AR0601M01","saveYn":"Y"},{"menuUrl":"AR0801M01","saveYn":"Y"},{"menuUrl":"AR0901M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"CM0701M01","saveYn":"Y"},{"menuUrl":"AR0401M01","saveYn":"Y"},{"menuUrl":"CM0901M01","saveYn":"Y"},{"menuUrl":"uploadExcel","saveYn":"Y"},{"menuUrl":"message","saveYn":"Y"},{"menuUrl":"PP0401M01","saveYn":"Y"},{"menuUrl":"-","saveYn":"Y"},{"menuUrl":"SM0103M01","saveYn":"Y"},{"menuUrl":"maker","saveYn":"Y"},{"menuUrl":"standard","saveYn":"Y"},{"menuUrl":"production","saveYn":"Y"},{"menuUrl":"equipment","saveYn":"Y"},{"saveYn":"Y"},{"menuUrl":"clearance","saveYn":"Y"},{"menuUrl":"workflow","saveYn":"Y"}];
			console.log(arr);
			console.log(arr.length);
			for(var i = 0; i < arr.length; i++){
				console.log(arr[i].menuUrl);
			}

			//openNotiPop();
		});
	}
	
	function setImg() {
		var imgUrl = "";
		var bgImgUrl = "";
		if(location.hostname == "localhost") {
			imgUrl = "/static/img/Logo_GUM.png";
			bgImgUrl = "/static/img/Login_bg_GUM.png";
		} else {
			imgUrl = "/static/img/Logo_GG.png";
			bgImgUrl = "/static/img/Login_bg_GG.png";
		}
		$("#logoImg").attr("src", imgUrl);
		$("#login").css("background", "url("+bgImgUrl+") no-repeat 100% 0% #ffffff");
	}
	
</script>
<body>
  <div id="login">
    <div class="login_box">
      <h1 class="logo">
        <img id="logoImg" src="" alt="금문철강">
      </h1>
      <h2>Login</h2>
      <ul>
        <li><input id="id" type="text" placeholder="ID"></li>
        <li><input id="pass" type="password" placeholder="Password"></li>
        <li style="margin-top: 0px;">
        	<input type="checkbox" id="idSaveCheck" style="width: 20px  !important; cursor: pointer;">
        	<label style="font-size: larger;vertical-align:sub;">아이디 저장</label> 
        </li>
      </ul>
      <button onclick="loginAction();">Login</button>
    </div>

  </div>
</body>
</html>
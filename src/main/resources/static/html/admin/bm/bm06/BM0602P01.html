<style>
	input[comma] {text-align: right;}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">거래처관리(여신)</h4>
    </div>

	<div class="popup_table">
		<div class="form-group">
			<input type="file" id="clntFile" style="display:none" multiple="multiple" onchange="setClntFile(this);"/>
			<form id="clntForm">
				<input type="hidden" id="pgmId" name="pgmId" value="BM0602P01">
				<input type="hidden" id="clntCd" name="clntCd">
				<!-- 기본정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="15%">
						<col width="18%">
						<col width="15%">
						<col width="18%">
						<col width="15%">
						<col width="19%">
					</colgroup>
					<thead>
						<tr>
							<td colspan="5" style="text-align: left;">기본정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th class="hit">거래처명</th>
							<td>
								<input type="text" class="form-control" id="clntNm" name="clntNm" maxlength="25" required msg="회사명">
							</td>
							<th class="hit">사업자등록번호</th>
							<td>
								<input type="text" class="form-control" id="crn" name="crn" onkeyup="crnFormatter(this);" maxlength="15" required msg="사업자등롭번호">
							</td>
							<th>법인번호</th>
							<td>
								<input type="text" class="form-control" id="coprtNo" name="coprtNo" maxlength="14">
							</td>

						</tr>
						<tr>
							<th>대표자명</th>
							<td>
								<input type="text" class="form-control" id="repstNm" name="repstNm" maxlength="25">
							</td>
							<th class="hit">번호유형</th>
							<td>
							    <select class="form-control input-sm" id="crnTyp" name="crnTyp" data-kind="CRNTYP" required msg="사업자번호 등록번호 유형">
<!-- 									<option value="">선택</option> -->
								</select>
							</td>
							<th>업태</th>
							<td>
								<input type="text" class="form-control" id="bizconNm" name="bizconNm" maxlength="50">
							</td>
						</tr>
						<tr>
							<th rowspan="2">주소</th>
							<td>
								<div class="search_form">
									<input type="text" id="bizZip" name="bizZip" placeholder="우편번호" readonly>
									<a onclick="openDaumPostcode();"><i class="i_search_w"></i></a>
								</div>
							</td>
							<th>거래처구분</th>
							<td>
								<select class="form-control input-sm" id="clntDivCd" name="clntDivCd" data-kind="CLNTDIV">
									<option value="">선택</option>
								</select>
							</td>
							<th>종목</th>
							<td>
								<input type="text" class="form-control" id="bstyNm" name="bstyNm" maxlength="50">
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<div class="form-inline" style="text-align: left;">
									<input type="text" class="form-control" id="bizAddr" name="bizAddr" style="width:49.5%;" placeholder="주소" readonly>
									<input type="text" class="form-control" id="bizAddrDtl" name="bizAddrDtl" style="width:49.5%;" placeholder="상세주소" maxlength="100">
								</div>
							</td>
							<th >사용여부</th>
							<td  colspan="2">
								<select class="form-control input-sm" id="useYn" name="useYn">
									<option value="Y">사용</option>
									<option value="N">미사용</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>전화번호</th>
							<td>
								<input type="text" class="form-control" id="bizTelNo" name="bizTelNo" onkeyup="telNumberFormatter(this);" maxlength="20">
							</td>
							<th>FAX</th>
							<td>
								<input type="text" class="form-control" id="bizFaxNo" name="bizFaxNo" onkeyup="telNumberFormatter(this);" maxlength="20">
							</td>
							<th>URL</th>
							<td>
								<input type="text" class="form-control" id="subRmkUrl" name="subRmkUrl" onkeyup="exceptKorean(this);" maxlength="100">
							</td>
						</tr>
						<tr>
							<th>주거래은행</th>
							<td>
								<select class="form-control input-sm" id="bankCd" name="bankCd" data-kind="BANK">
									<option value="">선택</option>
								</select>
							</td>
							<th>계좌번호</th>
							<td>
								<input type="text" class="form-control" id="bkacNo" name="bkacNo" onkeyup="onlyBkac(this);" maxlength="20">
							</td>
							<th>계좌소유주</th>
							<td>
								<input type="text" class="form-control" id="bkacOwner" name="bkacOwner" maxlength="10">
							</td>
						</tr>
						<tr>
							<th>신용연계여부</th>
							<td>
								<select class="form-control input-sm" id="linkGrpYn" name="linkGrpYn" data-kind="YN" onchange="ctrlLinkGrp();">
									<option value="">선택</option>
								</select>
							</td>
	                    	<th>연계거래처</th>
	                        <td>
	                            <div class="search_form" id="drctArea">
	          						<input type="hidden" id="basisCdtlnAmt" name="basisCdtlnAmt" >
									<input type="hidden" id="linkGrpClntCd" name="linkGrpClntCd">
									<input type="text" id="linkGrpClntNm" name ="linkGrpClntNm" readonly> 
									<a onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
		                        </div>
	                        </td>  
<!-- 							<th>기본여신금액</th> -->
<!-- 							<td> -->
<!-- 								<input type="text" class="form-control" id="basisCdtlnAmt" name="basisCdtlnAmt" onkeyup="onlyNumber(this);" comma> -->
<!-- 							</td> -->
						</tr>
						<tr>
							<th>메모</th>
							<td colspan="5">
								<textarea class="form-control" id="clntRmk" name="clntRmk" style="height: 60px;" maxlength="500"></textarea>
							</td>
						</tr>
					</tbody>
				</table>
				<br>
				<!-- 매입/매출정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="15%">
						<col width="35%">
					</colgroup>
					<thead>
						<tr>
							<td colspan="6" style="text-align: left;">매입/매출정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th class="tc">구분</th>
							<th class="tc">지급구분</th>
							<th class="tc">결제방법</th>
							<th class="tc">수금조건</th>
							<th class="tc">결제일</th>
							<th class="tc">부가세</th>
							<th class="tc">비고</th>
						</tr>
						<tr>
							<td>매입</td>
							<td>
								<select class="form-control input-sm" id="pchsPayDivCd" name="pchsPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsPmntMtdCd" name="pchsPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>							
							<td>
								<select class="form-control input-sm" id="pchsClmnDivCd" name="pchsClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
							   <input type="text" class="form-control" id="pchsClmnDay" name="pchsClmnDay" maxlength="20">
							</td>
							<td>
								<select class="form-control input-sm" id="pchsVatCd" name="pchsVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
							<td>
							   <input type="text" class="form-control" id="pchsClmnRmk" name="pchsClmnRmk">
							</td>							
						</tr>
						<tr>
							<td>매출</td>
							<td>
								<select class="form-control input-sm" id="sellPayDivCd" name="sellPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellPmntMtdCd" name="sellPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>							
							<td>
								<select class="form-control input-sm" id="sellClmnDivCd" name="sellClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
							   <input type="text" class="form-control" id="sellClmnDay" name="sellClmnDay" maxlength="20">
							</td>
							<td>
								<select class="form-control input-sm" id="sellVatCd" name="sellVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
							<td>
							   <input type="text" class="form-control" id="sellClmnRmk" name="sellClmnRmk">
							</td>
						</tr>
					</tbody>
				</table>
			</form>
			<br>
			<!-- 사업부 테이블 -->
			<table class="popup_table" id="bizdeptTable">
				<colgroup>
					<col width="3%">
					<col width="11%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="11%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="11%">
					<col width="8%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="11" style="text-align: left;">사업부</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="12">
							<div class="add_btn">
								<a onclick="addBizdeptRow();" authchk>+</a> 
								<a onclick="removeBizdeptRow();" authchk>-</a>
							</div>
						</td>
					</tr>
					<tr name="bizdeptHead">
						<th></th>
						<th class="tc hit">사업부명</th>
						<th class="tc">사업구분</th>
						<th class="tc">담당자명</th>
						<th class="tc">담당자전화번호</th>
						<th class="tc">담당자휴대전화</th>
						<th class="tc">담당자이메일</th>
						<th class="tc">담당자부서명</th>
						<th class="tc">담당자직위</th>
						<th class="tc">영업회사</th>
						<th class="tc">영업사원</th>
						<th class="tc">사용여부</th>
					</tr>
				</tbody>
			</table>
			<table id="bizdeptFrameTable" style="display: none;">
				<tr name="bizdeptRow">
					<td>
						<input type="hidden"   id="bizdeptSn" name="bizdeptSn">
						<input type="checkbox" name="bizdeptChkBox">
					</td>
					<td>
						<input type="text" class="form-control" name="bizdeptNm" maxlength="25" required msg="사업부명">
					</td>
					<td>
						<select class="form-control input-sm" name="bizdeptDivCd" data-kind="BIZDIV" >
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<input type="text" class="form-control" name="mngNm" maxlength="5">
					</td>
					<td>
						<input type="text" class="form-control" name="mngTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">
					</td>
					<td>
						<input type="text" class="form-control" name="mngMoblphonNo" onkeyup="telNumberFormatter(this);" maxlength="13">
					</td>
					<td>
						<input type="text" class="form-control" name="mngEmail" onkeyup="exceptKorean(this)" maxlength="50">
					</td>
					<td>
						<input type="text" class="form-control" name="mngDeptNm" maxlength="15">
					</td>
					<td>
						<select class="form-control input-sm" name="mngPstCd" data-kind="PST">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<select class="form-control input-sm" name="salesCoCd" data-kind="CO" onchange="initSalesEmp(this);">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<div class="search_form">
							<input type="hidden" class="form-control" name="salesEmpId">
							<input type="text" class="form-control" name="salesEmpNm" readonly>
							<a onclick="openSecondUserSearch(this);">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>
					<td>
						<select class="form-control input-sm" name="useYn">
							<option value="Y">Y</option>
							<option value="N">N</option>
						</select>
					</td>
				</tr>
			</table>
			<br>
			<!-- 담보내역 테이블 -->
			<table class="popup_table" id="pldgTable">
				<colgroup>
					<col width="3%">
					<col width="8%">
					<col width="5%">
					<col width="8%">
					<col width="8%">
<!-- 					<col width="11%"> -->
					<col width="10%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="20%">
					<col width="8%">
					<col width="6%">
					<col width="8%">
					<col width="6%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="13" style="text-align: left;">담보내역</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr name="pldgHead">
						<td colspan="14">
							<div class="add_btn">
								<a onclick="addPldgRow();" authchk>+</a> 
								<a onclick="removePldgRow();" authchk>-</a>
							</div>
						</td>
					</tr>
					<tr>
						<th></th>
						<th class="tc hit">회사</th>
						<th class="tc hit">구분</th>
						<th class="tc hit">제품그룹</th>
						<th class="tc hit">변경</th>
						<th class="tc hit">유형</th>
						<th class="tc">금액</th>
<!-- 						<th class="tc">여신금액</th> -->
						<th class="tc hit">설정일</th>
						<th class="tc">만기일</th>
						<th class="tc">비고</th>
						<th class="tc">보증기관</th>
						<th class="tc">사용여부</th>
						<th class="tc">신청자</th>
						<th class="tc">수정일</th>
					</tr>
				</tbody>
			</table>
			<table id="pldgFrameTable" style="display: none;">
				<tr name="pldgRow">
					<td>
				 		<input type="hidden"   id="pldgSn" name="pldgSn" >
						<input type="checkbox" name="pldgChkBox">
					</td>
					<td>
				 		<select class="form-control input-sm" name="coCd" data-kind="CO" required msg="회사">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" id="selpchCd" name="selpchCd" data-kind="SELPCH" required msg="구분">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="prdtGrp" data-kind="PRDTGRP">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="pldgChgCd" data-kind="PLDGCHG" required msg="변경">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="pldgDivCd" data-kind="PLDG" required msg="유형">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="pldgAmt" onkeyup="onlyNumber(this); calCdtlnAmt(this); countTot();" comma>
				 		<input type="hidden" class="form-control tr" name="pldgRcognRate" value=100>
				 	</td>
<!-- 				 	<td> -->
<!-- 				 		<input type="text" class="form-control" name="cdtlnAmt" comma readOnly> -->
<!-- 				 	</td> -->
				 	<td>
				 		<input type="text" class="input_calendar" autocomplete="off" name="setupDt" date style="text-align: center;" required msg="설정일">
				 	</td>
				 	<td>
				 		<input type="text" class="input_calendar" autocomplete="off" name="exprtnDt" date style="text-align: center;">
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="pldgRmk" maxlength="127">
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="grntyInsttCd" data-kind="INSTT"  msg="보증기관">
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="useYn">
							<option value="Y">Y</option>
							<option value="N">N</option>
						</select>
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="ptonNm"  style="text-align: center;">
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="udtDttm" readonly style="text-align: center;">
				 	</td>
				 </tr>
			</table>
			<table>
				<colgroup>
					<col width="3%">
					<col width="8%">
					<col width="5%">
					<col width="8%">
					<col width="8%">
<!-- 					<col width="11%"> -->
					<col width="10%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="20%">
					<col width="8%">
					<col width="6%">
					<col width="8%">
					<col width="6%">
				</colgroup>
				<tr>
					<th class="tc" colspan="6">합계</th>
					<td>
						<input class="tr" type="text" id="pldgTotAmt" name="pldgTotAmt" comma readonly>
					</td>
					<td></td> <!-- 인증비율 -->
					<td>
<!-- 						<input class="tr" type="text" id="cdtlnTotAmt" name="cdtlnTotAmt" comma readonly> -->
					</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</table>
			<br>
			<!-- 첨부파일 테이블 -->
			<table class="popup_table">
				<colgroup>
					<col width="12%">
					<col width="">
				</colgroup>
				<thead>
					<tr>
						<td style="text-align: left;">첨부파일</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>
							<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="clntFile.click();">첨부파일</button>
						</th>
						<td>
							<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<div>
	    <button type="button" class="btn btn-default btn-sm" id="actionBtn" authchk></button>
	    <button type="button" class="btn btn-default btn-sm" onclick="modalStack.close();">닫기</button>
    </div>
</div>
<script type="text/javascript">
	var clntFileArr = [];
	var deleteFileArr = [];
	var fileGridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showRowSelector: true,
	        	multipleSelect: true,
				header: {selector: false},
				body: {
		            onDBLClick: function () {
		            	if(this.item.fileKey){
							downloadFile(this.item.fileKey);
						}
		            }
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 500},
	                {key: "fileType", label: "파일타입", width: 100},
	                {key: "fileSize", label: "파일크기", width: 100},
	                {
						key:"fileDelete", label: "삭제", width:60,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');" authchk>삭제</button>'
						}
					}
	            ]
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			targetObj.setData({
				list: clntFileArr,
				page : {
					totalElements : clntFileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		
		// 공통코드 set
		setCommonSelect($(".popup_area select[data-kind]"));
		
		// 그리드 초기화
		fileGridView.initView().setData();
		
		var actionType = modalStack.last().paramObj.actionType;
		if(actionType == "C"){
			$('#linkGrpYn').val("N");
	//		addPldgRow();
			$('#actionBtn').text("등록");
			$('#actionBtn').on("click", function(){insertClnt();});
		}else if(actionType == "U"){
			selectClntInfo();
			$('#actionBtn').text("저장");
			$('#actionBtn').on("click", function(){updateClnt();});
		}
		
		// 연계그룹 컨트롤
		ctrlLinkGrp();

		$("#selpchCd option[value='SELPCH3']").remove();
		$("#selpchCd option[value='SELPCH4']").remove();

		authChk();		
	});
	
	function selectClntInfo() {
		
		var row = gridView.target.getList("selected")[0];
		
		if(gridView.target.getList("selected").length == 0){
			row = gridView.target.getList(0);
		}
		var paramObj = {"clntCd": row[0].clntCd};
		
		postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function(data){
			setClntInfo(data.clntInfo);
		});
	}
	
	function setClntInfo(clntInfo) {
		// 기본정보 set
		$.each(clntInfo, function(key, value){
			if($('#'+key)[0]){
				$('#'+key).val(value);
				// 금액 콤마 set
				if($('#'+key).is('[comma]')){
					onlyNumber($('#'+key)[0]);
				}
			}
		});
		// 사업부 set
		var bizdeptList = clntInfo.bizdeptList;
		if(bizdeptList.length > 0){
			$.each(bizdeptList, function(idx, obj){
				var $bizdeptRow = addBizdeptRow();
				for(var i=0;i<$bizdeptRow.find('[name]').length;i++){
					var bizdeptItem = $bizdeptRow.find('[name]')[i];
					var itemValue = obj[bizdeptItem.name];
					if(itemValue){
						$(bizdeptItem).val(itemValue);
					}
				}
			});
		}
// 		else{
// 			addBizdeptRow();
// 		}
		
		// 담보내역 set
		var pldgList = clntInfo.pldgList;
		if(pldgList.length > 0){
			$.each(pldgList, function(idx, obj){
				var $pldgRow = addPldgRow();
				for(var i=0;i<$pldgRow.find('[name]').length;i++){
					var pldgItem = $pldgRow.find('[name]')[i];
					var itemValue = obj[pldgItem.name];
					
					if(itemValue){
						if($(pldgItem).is('[date]')){
							$(pldgItem).datepicker("setDate", moment(itemValue, 'YYYY-MM-DD').toDate());
						}else{
							if($(pldgItem).is('[comma]')){
								itemValue = addCommaStr(itemValue);
							}
							$(pldgItem).val(itemValue);
						}
					}
				}
			});
		}
// 		else{
// 			addPldgRow();
// 		}
		countTot();
		
		// 첨부파일 set
		var clntFileList = clntInfo.clntFileList;
		$.each(clntFileList, function(idx, obj){
			clntFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#bizZip').val(data.zonecode);
				$('#bizAddr').val(data.roadAddress || data.address  + ' ' + data.buildingName);
			}
		}).open();
	}

	// 사업부 추가
	function addBizdeptRow(){
		var $bizdeptRow = $('#bizdeptFrameTable tr[name="bizdeptRow"]').clone();
		$('#bizdeptTable tbody').append($bizdeptRow[0]);
		return $bizdeptRow;
	}
	
	// 사업부 삭제
	function removeBizdeptRow(){
		var $checkedBizdepts = $('#bizdeptTable input[name="bizdeptChkBox"]:checked');
		// 사업부 내역 추가
		var bizdeptArr = [];

		if($checkedBizdepts.length > 0){
			$.each($checkedBizdepts, function(idx, elem){

				var bizdepObj = {};
				// 키 추가
				var bizdeptSn = $(elem).closest('tr').find('[name="bizdeptSn"]').val();
				if(pldgSn){
					bizdepObj["bizdeptSn"] = bizdeptSn;
					bizdeptArr.push(bizdepObj);
				}
				
				$(elem).closest('tr[name="bizdeptRow"]').remove();
			});
			
			deleteAjax("/admin/bm/bm02/deleteClntBizdept", {"bizdeptArr": bizdeptArr}, null, function(data) {
				if (data.resultCode == 200) {
					alert(data.resultMessage);
				}
			});
		}else{
			alert("삭제할 사업부를 선택해주세요.");
		}
	}
	
	// 영업회사 변경
	function initSalesEmp(elem){
		var changedRow = $(elem).closest('tr[name="bizdeptRow"]');
		changedRow.find('[name="salesEmpId"]').val("");
		changedRow.find('[name="salesEmpNm"]').val("");
	}
	
	// 영업사원 검색
	function openSecondUserSearch(elem){
		$targetRow = $(elem).closest('tr[name="bizdeptRow"]');
		
		if(!$targetRow.find('[name="salesCoCd"]').val()){
			alert("영업회사를 선택해주세요.");
			$targetRow.find('[name="salesCoCd"]').focus();
			return false;
		}
		
		var paramObj = {
			"coCd" : "GUM", // $targetRow.find('[name="salesCoCd"]').val(),
			"userId": $targetRow.find('[name="salesEmpId"]').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$targetRow.find('[name=salesEmpId]').val(checkedNode.id);
			$targetRow.find('[name=salesEmpNm]').val(checkedNode.text);
		});
	}
	
	
	// 연계그룹 컨트롤
	function ctrlLinkGrp() {
		var linkGrpYn = $('#linkGrpYn').val();	
		if(linkGrpYn == "Y"){
			$("#drctArea button").prop("disabled", false);
	   } else {
			$("#drctArea input").val("");
	   		$("#drctArea button").prop("disabled", true);
	   }
	}
	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "연계거래처", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#linkGrpClntCd').val(row.clntCd);
			$('#linkGrpClntNm').val(row.clntNm);
		});
	}
	
	// 담보내역 추가
	function addPldgRow(){
		var $pldgRow = $('#pldgFrameTable tr[name="pldgRow"]').clone();
		$('#pldgTable tbody').append($pldgRow[0]);
		
		// datepicker bind
		$pldgRow.find('.input_calendar').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		
		return $pldgRow;
	}
	
	// 담보내역 삭제
	function removePldgRow(){
		var $checkedPldgs = $('#pldgTable input[name="pldgChkBox"]:checked');
		// 담보내역 추가
		var pldgArr = [];		
		
		if($checkedPldgs.length > 0){
			$.each($checkedPldgs, function(idx, elem){
				var pldgObj = {};
				// 키 추가
				var pldgSn = $(elem).closest('tr').find('[name="pldgSn"]').val();
				if(pldgSn){
					pldgObj["pldgSn"] = pldgSn;
					pldgArr.push(pldgObj);
				}
				// 화면 삭제
				$(elem).closest('tr[name="pldgRow"]').remove();	
			});
			
			deleteAjax("/admin/bm/bm02/deleteClntPldg", {"pldgArr": pldgArr}, null, function(data) {
				if (data.resultCode == 200) {
					alert(data.resultMessage);
				}
			});
		}else{
			alert("삭제할 담보내역을 선택해주세요.");
		}
	}
	
	// 여신금액 계산
	function calCdtlnAmt(elem){
		var $pldgRow = $(elem).closest('tr[name="pldgRow"]');
		var pldgAmt = Number(deleteCommaStr($pldgRow.find('[name="pldgAmt"]').val()));
		var pldgRcognRate = Number($pldgRow.find('[name="pldgRcognRate"]').val());
		var cdtlnAmt = pldgAmt * pldgRcognRate / 100;
// 		$pldgRow.find('[name="cdtlnAmt"]').val(addCommaStr(cdtlnAmt));
	}
	
	// 파일 추가
	function setClntFile(elem) {
		var tempFiles = elem.files;
		// 전역변수 배열에 선택된 파일 추가 
		$.each(tempFiles, function(idx, obj){
			var typeArr = obj.name.split(".");
			clntFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : typeArr[typeArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// input file 초기화
		$(elem).val("");
	}
	
	// 파일 삭제
	function deleteFile(rowIndex) {
		if(clntFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(clntFileArr[rowIndex].fileKey);
		}
		clntFileArr.splice(rowIndex, 1);
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	// 파일 다운로드
	function downloadFile(fileKey) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	// 등록
	function insertClnt() {
		if(inputValidation($('.popup_area [required]').not('#bizdeptFrameTable [required], #pldgFrameTable [required]'))){
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm02/insertClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	// 수정
	function updateClnt() {
		if(inputValidation($('.popup_area [required]').not('#bizdeptFrameTable [required], #pldgFrameTable [required]'))){
			var formData = makeFormData();
			filePutAjax("/admin/bm/bm02/updateClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	// 폼데이터 생성
	function makeFormData() {
		// 콤마 제거
		$.each($('input[comma]'), function(idx, elem){deleteComma(elem);});
		// 폼데이터 생성
		var formData = new FormData($('#clntForm')[0]);
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 사업부 추가
		var bizdeptArr = [];
		$.each($('#bizdeptTable tr[name="bizdeptRow"]'), function(idx, elem){
			var bizdeptObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				var elemName = elem.name;
				var elemValue = elem.value;
				bizdeptObj[elemName] = elemValue;
			});
			bizdeptArr.push(bizdeptObj);
		});
		formData.append("bizdeptArr", JSON.stringify(bizdeptArr));
			
		// 담보내역 추가
		var pldgArr = [];
		$.each($('#pldgTable tr[name="pldgRow"]'), function(idx, elem){
			var pldgObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				var elemName = elem.name;
				var elemValue = elem.value;
				
				if($(elem).is('[date]')){
					elemValue = deleteHyphenStr(elemValue);
				}
				
				if($(elem).is('[comma]')){
					elemValue = deleteCommaStr(elemValue);
				}
				
				pldgObj[elemName] = elemValue;
			});
			pldgArr.push(pldgObj);
		});
		formData.append("pldgArr", JSON.stringify(pldgArr));
		
		// 첨부파일 추가
		$.each(clntFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		// 수정시 삭제된 파일 추가
		var actionType = modalStack.last().paramObj.actionType;
		if(actionType == "U"){
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		
		return formData;
	}
	
	function countTot() {
		var pldgTotAmt = 0;
		var cdtlnTotAmt = 0;
		$.each($('#pldgTable tr[name="pldgRow"]'), function(idx, elem){
			var pldgAmt = Number(deleteCommaStr($(elem).find('input[name="pldgAmt"]').val())) || 0;
// 			var cdtlnAmt = Number(deleteCommaStr($(elem).find('input[name="cdtlnAmt"]').val())) || 0;
			
			pldgTotAmt += pldgAmt;
// 			cdtlnTotAmt += cdtlnAmt;
		});
		
		$('#pldgTotAmt').val(addCommaStr(pldgTotAmt));
// 		$('#cdtlnTotAmt').val(addCommaStr(cdtlnTotAmt));

	}
</script>

<style>
	input[comma] {text-align: right;}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">거래처관리(여신)</h4>
    </div>

	<div class="popup_table">
		<div class="form-group">
			<input type="file" id="clntFile" style="display:none" multiple="multiple" onchange="setClntFile(this);"/>
			<form id="clntForm">
				<input type="hidden" id="pgmId" name="pgmId" value="BM0602P01">
				<input type="hidden" id="clntCd" name="clntCd">
				<!-- 기본정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="15%">
						<col width="18%">
						<col width="15%">
						<col width="18%">
						<col width="15%">
						<col width="19%">
					</colgroup>
					<thead>
						<tr>
							<td colspan="5" style="text-align: left;">기본정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th class="hit">거래처명</th>
							<td>
								<input type="text" class="form-control" id="clntNm" name="clntNm" maxlength="25" required>
							</td>
							<th>사업자등록번호</th>
							<td>
								<input type="text" class="form-control" id="crn" name="crn" onkeyup="crnFormatter(this);" maxlength="12">
							</td>
							<th>법인번호</th>
							<td>
								<input type="text" class="form-control" id="coprtNo" name="coprtNo" maxlength="14">
							</td>

						</tr>
						<tr>
							<th>대표자명</th>
							<td>
								<input type="text" class="form-control" id="repstNm" name="repstNm" maxlength="5">
							</td>
							<th>업태</th>
							<td>
								<input type="text" class="form-control" id="bizconNm" name="bizconNm" maxlength="25">
							</td>
							<th>종목</th>
							<td>
								<input type="text" class="form-control" id="bstyNm" name="bstyNm" maxlength="25">
							</td>
						</tr>
						<tr>
							<th rowspan="2">주소</th>
							<td>
								<div class="search_form">
									<input type="text" id="bizZip" name="bizZip" placeholder="우편번호" readonly>
									<button type="button" onclick="openDaumPostcode();"><i class="i_search_w"></i></button>
								</div>
							</td>
							<th>거래처구분</th>
							<td>
								<select class="form-control input-sm" id="clntDivCd" name="clntDivCd" data-kind="CLNTDIV">
									<option value="">선택</option>
								</select>
							</td>
							<th>사용여부</th>
							<td>
								<select class="form-control input-sm" id="useYn" name="useYn">
									<option value="Y">사용</option>
									<option value="N">미사용</option>
								</select>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<div class="form-inline" style="text-align: left;">
									<input type="text" class="form-control" id="bizAddr" name="bizAddr" style="width:49.5%;" placeholder="주소" readonly>
									<input type="text" class="form-control" id="bizAddrDtl" name="bizAddrDtl" style="width:49.5%;" placeholder="상세주소" maxlength="100">
								</div>
							</td>
							<td colspan="2"></td>
						</tr>
						<tr>
							<th>전화번호</th>
							<td>
								<input type="text" class="form-control" id="bizTelNo" name="bizTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">
							</td>
							<th>FAX</th>
							<td>
								<input type="text" class="form-control" id="bizFaxNo" name="bizFaxNo" onkeyup="telNumberFormatter(this);" maxlength="13">
							</td>
							<th>URL</th>
							<td>
								<input type="text" class="form-control" id="subRmkUrl" name="subRmkUrl" onkeyup="exceptKorean(this);" maxlength="100">
							</td>
						</tr>
						<tr>
							<th>주거래은행</th>
							<td>
								<select class="form-control input-sm" id="bankCd" name="bankCd" data-kind="BANK">
									<option value="">선택</option>
								</select>
							</td>
							<th>계좌번호</th>
							<td>
								<input type="text" class="form-control" id="bkacNo" name="bkacNo" onkeyup="onlyBkac(this);" maxlength="20">
							</td>
							<th>계좌소유주</th>
							<td>
								<input type="text" class="form-control" id="bkacOwner" name="bkacOwner" maxlength="5">
							</td>
						</tr>
						<tr>
							<th>신용연계여부</th>
							<td>
								<select class="form-control input-sm" id="linkGrpYn" name="linkGrpYn" data-kind="YN" onchange="ctrlLinkGrp();">
									<option value="">선택</option>
								</select>
							</td>
	                    	<th>연계거래처</th>
	                        <td>
	                            <div class="search_form" id="drctArea">
									<input type="hidden" id="linkGrpClntCd" name="linkGrpClntCd">
									<input type="text" id="linkGrpClntNm" name ="linkGrpClntNm" readonly> 
									<button type="button" onclick="openSecondClntSearch();"><i class="i_search_w"></i></button>
		                        </div>
	                        </td>  
							<th>기본여신금액</th>
							<td>
								<input type="text" class="form-control" id="basisCdtlnAmt" name="basisCdtlnAmt" onkeyup="addComma(this);" comma>
							</td>
						</tr>							
						<tr>
							<th>메모</th>
							<td colspan="5">
								<textarea class="form-control" id="clntRmk" name="clntRmk" style="height: 60px;" maxlength="500"></textarea>
							</td>
						</tr>
					</tbody>
				</table>
				<br>
				<!-- 매입/매출정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="20%">
						<col width="20%">
						<col width="20%">
						<col width="20%">
						<col width="20%">
					</colgroup>
					<thead>
						<tr>
							<td colspan="4" style="text-align: left;">매입/매출정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>구분</th>
							<th>지급구분</th>
							<th>수금조건</th>
							<th>결제방법</th>
							<th>부가세</th>
						</tr>
						<tr>
							<td>매출</td>
							<td>
								<select class="form-control input-sm" id="pchsPayDivCd" name="pchsPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsClmnDivCd" name="pchsClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsPmntMtdCd" name="pchsPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsVatCd" name="pchsVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
						<tr>
							<td>매입</td>
							<td>
								<select class="form-control input-sm" id="sellPayDivCd" name="sellPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellClmnDivCd" name="sellClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellPmntMtdCd" name="sellPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellVatCd" name="sellVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
					</tbody>
				</table>
			</form>
			<br>
			<!-- 담보내역 테이블 -->
			<table class="popup_table" id="pldgTable">
				<colgroup>
					<col width="3%">
					<col width="11%">
					<col width="11%">
					<col width="11%">
					<col width="11%">
					<col width="11%">
					<col width="11%">
					<col width="11%">
					<col width="12%">
					<col width="8%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="9" style="text-align: left;">담보내역</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr name="pldgHead">
						<td colspan="10">
							<div class="add_btn">
								<a onclick="addPldgRow();">+</a> 
								<a onclick="removePldgRow();">-</a>
							</div>
						</td>
					</tr>
					<tr>
						<th></th>
						<th>회사</th>
						<th>구분</th>
						<th>금액</th>
						<th>인정비율(%)</th>
						<th>여신금액</th>
						<th>보험만기일</th>
						<th>부동산설정일</th>
						<th>비고</th>
						<th>사용여부</th>
					</tr>
				</tbody>
			</table>
			<table id="pldgFrameTable" style="display: none;">
				<tr name="pldgRow">
					<td>
						<input type="checkbox" name="pldgChkBox">
					</td>
					<td>
				 		<select class="form-control input-sm" name="coCd" data-kind="CO" required>
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="pldgDivCd" data-kind="PLDG" required>
				 			<option value="">선택</option>
				 		</select>
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="pldgAmt" onkeyup="addComma(this); calCdtlnAmt(this);" comma>
				 	</td>
				 	<td>
				 		<input type="text" class="form-control tr" name="pldgRcognRate" onkeyup="onlyNumber(this); calCdtlnAmt(this);" maxlength="3">
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="cdtlnAmt" comma readOnly>
				 	</td>
				 	<td>
				 		<input type="text" class="input_calendar" name="exprtnDt" date>
				 	</td>
				 	<td>
				 		<input type="text" class="input_calendar" name="setupDt" date>
				 	</td>
				 	<td>
				 		<input type="text" class="form-control" name="pldgRmk" maxlength="127">
				 	</td>
				 	<td>
				 		<select class="form-control input-sm" name="useYn">
							<option value="Y">Y</option>
							<option value="N">N</option>
						</select>
				 	</td>
				 </tr>
			</table>
			<br>
			<!-- 첨부파일 테이블 -->
			<table class="popup_table">
				<colgroup>
					<col width="12%">
					<col width="">
				</colgroup>
				<thead>
					<tr>
						<td style="text-align: left;">첨부파일</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>
							<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="clntFile.click();">첨부파일</button>
						</th>
						<td>
							<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<div>
	    <button type="button" class="btn btn-default btn-sm" id="actionBtn"></button>
	    <button type="button" class="btn btn-default btn-sm" onclick="modal.close();">닫기</button>
    </div>
</div>
<script type="text/javascript">
	var clntFileArr = [];
	var deleteFileArr = [];
	var fileGridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showRowSelector: true,
	        	multipleSelect: true,
				header: {selector: false},
				body: {
		            onDBLClick: function () {
		            	if(this.item.fileKey){
							downloadFile(this.item.fileKey);
						}
		            }
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 500},
	                {key: "fileType", label: "파일타입", width: 100},
	                {key: "fileSize", label: "파일크기", width: 100},
	                {
						key:"fileDelete", label: "삭제", width:60,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>'
						}
					}
	            ]
			});
			return this;
		},
		setData: function() {
			var targetObj = this.target;
			targetObj.setData({
				list: clntFileArr,
				page : {
					totalElements : clntFileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		
		// 공통코드 set
		setCommonSelect($(".popup_area select[data-kind]"));
		
		// 그리드 초기화
		fileGridView.initView().setData();
		
		if(actionType == "C"){
			$('#linkGrpYn').val("N");
			addPldgRow();
			$('#actionBtn').text("등록");
			$('#actionBtn').on("click", function(){insertClnt();});
		}else if(actionType == "U"){
			selectClntInfo();
			$('#actionBtn').text("저장");
			$('#actionBtn').on("click", function(){updateClnt();});
		}
		
		// 연계그룹 컨트롤
		ctrlLinkGrp();
	});
	
	function selectClntInfo() {
		var row = gridView.target.getList("selected")[0];
		var paramObj = {"clntCd": row.clntCd};
		postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function(data){
			setClntInfo(data.clntInfo);
		});
	}
	
	function setClntInfo(clntInfo) {
		// 기본정보 set
		$.each(clntInfo, function(key, value){
			if($('#'+key)[0]){
				$('#'+key).val(value);
				// 금액 콤마 set
				if($('#'+key).is('[comma]')){
					addComma($('#'+key)[0]);
				}
			}
		});
		
		// 담보내역 set
		var pldgList = clntInfo.pldgList;
		if(pldgList.length > 0){
			$.each(pldgList, function(idx, obj){
				var $pldgRow = addPldgRow();
				for(var i=0;i<$pldgRow.find('[name]').length;i++){
					var pldgItem = $pldgRow.find('[name]')[i];
					var itemValue = obj[pldgItem.name];
					
					if(itemValue){
						if($(pldgItem).is('[date]')){
							$(pldgItem).datepicker("setDate", moment(itemValue, 'YYYY-MM-DD').toDate());
						}else{
							if($(pldgItem).is('[comma]')){
								itemValue = addCommaStr(itemValue);
							}
							$(pldgItem).val(itemValue);
						}
					}
				}
			});
		}else{
			addPldgRow();
		}
		
		// 첨부파일 set
		var clntFileList = clntInfo.clntFileList;
		$.each(clntFileList, function(idx, obj){
			clntFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#bizZip').val(data.zonecode);
				$('#bizAddr').val(data.roadAddress || data.address  + ' ' + data.buildingName);
			}
		}).open();
	}
	
	// 연계그룹 컨트롤
	function ctrlLinkGrp() {
		var linkGrpYn = $('#linkGrpYn').val();	
		if(linkGrpYn == "Y"){
			$("#drctArea button").prop("disabled", false);
	   } else {
			$("#drctArea input").val("");
	   		$("#drctArea button").prop("disabled", true);
	   }
	}
	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "연계거래처", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#linkGrpClntCd').val(row.clntCd);
			$('#linkGrpClntNm').val(row.clntNm);
		});
	}
	
	// 담보내역 추가
	function addPldgRow(){
		var $pldgRow = $('#pldgFrameTable tr[name="pldgRow"]').clone();
		$('#pldgTable tbody').append($pldgRow[0]);
		
		// datepicker bind
		$pldgRow.find('.input_calendar').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		
		return $pldgRow;
	}
	
	// 담보내역 삭제
	function removePldgRow(){
		var $checkedPldgs = $('#pldgTable input[name="pldgChkBox"]:checked');
		if($checkedPldgs.length > 0){
			$.each($checkedPldgs, function(idx, elem){
				$(elem).closest('tr[name="pldgRow"]').remove();
			});
		}else{
			alert("삭제할 담보내역을 선택해주세요.");
		}
	}
	
	// 여신금액 계산
	function calCdtlnAmt(elem){
		var $pldgRow = $(elem).closest('tr[name="pldgRow"]');
		var pldgAmt = Number(deleteCommaStr($pldgRow.find('[name="pldgAmt"]').val()));
		var pldgRcognRate = Number($pldgRow.find('[name="pldgRcognRate"]').val());
		var cdtlnAmt = pldgAmt * pldgRcognRate / 100;
		$pldgRow.find('[name="cdtlnAmt"]').val(addCommaStr(cdtlnAmt));
	}
	
	// 파일 추가
	function setClntFile(elem) {
		var tempFiles = elem.files;
		// 전역변수 배열에 선택된 파일 추가 
		$.each(tempFiles, function(idx, obj){
			var typeArr = obj.name.split(".");
			clntFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : typeArr[typeArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// input file 초기화
		$(elem).val("");
	}
	
	// 파일 삭제
	function deleteFile(rowIndex) {
		if(clntFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(clntFileArr[rowIndex].fileKey);
		}
		clntFileArr.splice(rowIndex, 1);
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	// 파일 다운로드
	function downloadFile(fileKey) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	// 등록
	function insertClnt() {
		if(inputValidation($('.popup_area [required]').not('#pldgFrameTable [required]'))){
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm02/insertClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modal.close();
				}
			});
		}
	}
	
	// 수정
	function updateClnt() {
		if(inputValidation($('.popup_area [required]').not('#pldgFrameTable [required]'))){
			var formData = makeFormData();
			filePutAjax("/admin/bm/bm02/updateClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modal.close();
				}
			});
		}
	}
	
	// 폼데이터 생성
	function makeFormData() {
		// 콤마 제거
		$.each($('input[comma]'), function(idx, elem){deleteComma(elem);});
		// 폼데이터 생성
		var formData = new FormData($('#clntForm')[0]);
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 담보내역 추가
		var pldgArr = [];
		$.each($('#pldgTable tr[name="pldgRow"]'), function(idx, elem){
			var pldgObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				var elemName = elem.name;
				var elemValue = elem.value;
				
				if($(elem).is('[date]')){
					elemValue = deleteHyphenStr(elemValue);
				}
				
				if($(elem).is('[comma]')){
					elemValue = deleteCommaStr(elemValue);
				}
				
				pldgObj[elemName] = elemValue;
			});
			pldgArr.push(pldgObj);
		});
		formData.append("pldgArr", JSON.stringify(pldgArr));
		
		// 첨부파일 추가
		$.each(clntFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		// 수정시 삭제된 파일 추가
		if(actionType == "U"){
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		
		return formData;
	}
</script>

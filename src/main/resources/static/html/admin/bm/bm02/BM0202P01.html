<div class="container-fluid">
	<div class="form-group">
		<input type="file" id="clntFile" style="display:none" multiple="multiple" onchange="setClntFile(this);"/>
		<form id="clntForm">
			<!-- 기본정보 테이블 -->
			<table class="popup_table">
				<colgroup>
					<col width="15%">
					<col >
					<col width="15%">
					<col >
					<col width="15%">
					<col >
				</colgroup>
				<thead>
					<tr>
						<td colspan="5" style="text-align: left;">기본정보</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th class="hit">거래처명</th>
						<td>
							<input type="text" class="form-control" id="clntNm" name="clntNm" maxlength="25" required>
						</td>
						<th>사업자등록번호</th>
						<td>
							<input type="text" class="form-control" id="crn" name="crn" onkeyup="crnFormatter(this);" maxlength="12">
						</td>
						<th>거래처구분</th>
						<td>
							<select class="form-control input-sm" id="clntDivCd" name="clntDivCd" data-kind="CLNTDIV">
								<option value="">선택</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>대표자명</th>
						<td>
							<input type="text" class="form-control" id="repstNm" name="repstNm" maxlength="5">
						</td>
						<th>업태</th>
						<td>
							<input type="text" class="form-control" id="bizconNm" name="bizconNm" maxlength="25">
						</td>
						<th>종목</th>
						<td>
							<input type="text" class="form-control" id="bstyNm" name="bstyNm" maxlength="25">
						</td>
					</tr>
					<tr>
						<th rowspan="2">주소</th>
						<td>
							<div class="input-group">
								<input type="text" class="form-control" id="bizZip" name="bizZip" placeholder="우편번호" readonly>
								<span class="input-group-btn">
									<button type="button" class="btn btn-primary btn-sm" onclick="openDaumPostcode();">검색</button>
								</span>
							</div>
						</td>
						<td colspan="2"></td>
						<th>기본여신금액</th>
						<td colspan="3">
							<input type="text" class="form-control" id="basisCdtlnAmt" name="basisCdtlnAmt" onkeyup="addComma(this);" comma>
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<div class="form-inline" style="text-align: left;">
								<input type="text" class="form-control" id="bizAddr" name="bizAddr" style="width:49.5%;" placeholder="주소" readonly>
								<input type="text" class="form-control" id="bizAddrDtl" name="bizAddrDtl" style="width:49.5%;" placeholder="상세주소" maxlength="100">
							</div>
						</td>
						<th>사용여부</th>
						<td>
							<select class="form-control input-sm" id="useYn" name="useYn">
								<option value="Y">사용</option>
								<option value="N">미사용</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>전화번호</th>
						<td>
							<input type="text" class="form-control" id="bizTelNo" name="bizTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">
						</td>
						<th>FAX</th>
						<td>
							<input type="text" class="form-control" id="bizFaxNo" name="bizFaxNo" onkeyup="telNumberFormatter(this);" maxlength="13">
						</td>
						<th>URL</th>
						<td>
							<input type="text" class="form-control" id="subRmkUrl" name="subRmkUrl" onkeyup="exceptKorean(this);" maxlength="100">
						</td>
					</tr>
					<tr>
						<th>주거래은행</th>
						<td>
							<select class="form-control input-sm" id="bankCd" name="bankCd" data-kind="BANK">
								<option value="">선택</option>
							</select>
						</td>
						<th>계좌번호</th>
						<td>
							<input type="text" class="form-control" id="bkacNo" name="bkacNo" onkeyup="onlyNumber(this);" maxlength="20">
						</td>
						<th>계좌소유주</th>
						<td>
							<input type="text" class="form-control" id="bkacOwner" name="bkacOwner" maxlength="5">
						</td>
					</tr>
					<tr>
						<th>메모</th>
						<td colspan="5">
							<textarea class="form-control" id="clntRmk" name="clntRmk" style="height: 60px;" maxlength="500"></textarea>
						</td>
					</tr>
					<tr>
						<th class="tc">
							<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="clntFile.click();">첨부파일</button>
						</th>
						<td colspan="5">
							<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
						</td>
					</tr>
				</tbody>
			</table>
			<!-- 매입/매출정보 테이블 -->
			<table class="popup_table">
				<colgroup>
					<col width="20%">
					<col width="20%">
					<col width="20%">
					<col width="20%">
					<col width="20%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="4" style="text-align: left;">매입/매출정보</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>구분</th>
						<th>지급구분</th>
						<th>수금조건</th>
						<th>결제방법</th>
						<th>부가세</th>
					</tr>
					<tr>
						<td>매출</td>
						<td>
							<select class="form-control input-sm" id="pchsPayDivCd" name="pchsPayDivCd" data-kind="PAYDIV">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="pchsClmnDivCd" name="pchsClmnDivCd" data-kind="CLMNDIV">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="pchsPmntMtdCd" name="pchsPmntMtdCd" data-kind="PMNTMTD">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="pchsVatCd" name="pchsVatCd" data-kind="VAT">
								<option value="">선택</option>
							</select>
						</td>
					</tr>
					<tr>
						<td>매입</td>
						<td>
							<select class="form-control input-sm" id="sellPayDivCd" name="sellPayDivCd" data-kind="PAYDIV">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="sellClmnDivCd" name="sellClmnDivCd" data-kind="CLMNDIV">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="sellPmntMtdCd" name="sellPmntMtdCd" data-kind="PMNTMTD">
								<option value="">선택</option>
							</select>
						</td>
						<td>
							<select class="form-control input-sm" id="sellVatCd" name="sellVatCd" data-kind="VAT">
								<option value="">선택</option>
							</select>
						</td>
					</tr>
				</tbody>
			</table>
		</form>
		<!-- 사업부 테이블 -->
		<table class="popup_table">
			<colgroup>
				<col width="20%">
				<col width="20%">
				<col width="20%">
				<col width="20%">
				<col width="20%">
			</colgroup>
			<thead>
				<tr>
					<td colspan="4" style="text-align: left;">사업부</td>
					<td style="text-align: right;">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td colspan="5">
						<div class="add_btn">
							<a>+</a>
							<a>-</a>
						</div>
					</td>
				</tr>
				<tr>
					<th>사업부명</th>
					<th>사업구분</th>
					<th>담당자명</th>
					<th>담당자전화번호</th>
					<th>담당자휴대전화</th>
				</tr>
				<tr>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<select class="form-control input-sm" id="" name="">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
				</tr>
				<tr>
					<th>담당자이메일</th>
					<th>담당자부서명</th>
					<th>담당자직위</th>
					<th>영업회사</th>
					<th>영업사원</th>
				</tr>
				<tr>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<select class="form-control input-sm" id="" name="">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<select class="form-control input-sm" id="" name="">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<div class="input-group">
							<input type="text" class="form-control" id="" name="" readonly>
							<span class="input-group-btn">
								<button type="button" class="btn btn-primary btn-sm" onclick="">검색</button>
							</span>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
		<!-- 담보내역 테이블 -->
		<table class="popup_table">
			<colgroup>
				<col width="20%">
				<col width="20%">
				<col width="20%">
				<col width="20%">
				<col width="20%">
			</colgroup>
			<thead>
				<tr>
					<td colspan="4" style="text-align: left;">담보내역</td>
					<td style="text-align: right;">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td colspan="5">
						<div class="add_btn">
							<a>+</a>
							<a>-</a>
						</div>
					</td>
				</tr>
				<tr>
					<th>회사</th>
					<th>구분</th>
					<th>금액</th>
					<th>인정비율</th>
					<th>비고</th>
				</tr>
				<tr>
					<td>
						<select class="form-control input-sm" id="" name="">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<select class="form-control input-sm" id="" name="">
							<option value="">선택</option>
						</select>
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">
					</td>
					<td>
						<input type="text" class="form-control" id="" name="">	
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>
<div>
	<button type="button" class="btn btn-default btn-sm" id="actionBtn" onclick="insertClnt();"></button>
	<button type="button" class="btn btn-default btn-sm" onclick="modal.close();">닫기</button>
</div>

<script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" ></script>
<script type="text/javascript">

	var clntFileArr = [];
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
	            columns: [
	                {key: "fileName", label: "파일명", width: 517},
	                {key: "fileType", label: "파일타입", width: 100},
	                {key: "fileSize", label: "파일크기", width: 100},
	                {
						key:"fileDelete", label: "삭제", width:50,
						formatter:function() {
							return '<button type="button" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData: function(){
			this.target.setData(clntFileArr);
		}
	}
	
	$(document).ready(function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function(){
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		
		// 공통코드 set
		setCommonCode();
		
		// 그리드 초기화
		fileGridView.initView();
		
		if(actionType == "C"){
			$('#actionBtn').text("등록");
		}else if(actionType == "U"){
			$('#actionBtn').text("저장");
		}
	});
	
	function setCommonCode(){
		$.each($('select[data-kind]'), function(idx, elem){
			var codeKind = $(elem).data('kind');
			postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : codeKind}, null, function(data){
				var optionHtml = '';
				$.each(data.childCodeList, function(idx, obj){
					optionHtml += '<option value="'+obj.codeId+'">'+obj.codeNm+'</option>';
				});
				$(elem).append(optionHtml);
			});
		});
	}
	
	function openDaumPostcode(){
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#bizZip').val(data.zonecode);
				$('#bizAddr').val(data.roadAddress || data.address);
			}
		}).open();
	}
	
	function setClntFile(elem){
		var tempFiles = elem.files;
		
		// 전역변수 배열에 선택된 파일 추가 
		$.each(tempFiles, function(idx, obj){
			var testArr = obj.name.split(".");
			clntFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : testArr[testArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// input file 초기화
		$('#clntFile').val("");
	}
	
	function deleteFile(rowIndex){
		fileGridView.target.removeRow(rowIndex);
		clntFileArr.splice(rowIndex, 1);
	}
	
	function insertClnt(){
		if(inputValidation($('#clntForm input[required]'))){
			var formData = new FormData($('#clntForm')[0]);
			// 유저아이디 추가
			formData.append("userId", jwt.userId);
			
			// 첨부파일 추가
			$.each(clntFileArr, function(idx, obj){
				// 신규파일만 추가
				if(obj.fileKey == 0){
					formData.append("files", obj.file);
				}
			});
			
			fileAjax("/admin/bm/bm02/insertClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modal.close();
				}
			});
		}
	}
</script>

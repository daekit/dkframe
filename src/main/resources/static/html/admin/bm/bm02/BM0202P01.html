<div id="popup_area">
	<div class="container-fluid">
		<div class="form-group">
			<input type="file" id="clntFile" style="display:none" multiple="multiple" onchange="setClntFile(this);"/>
			<form id="clntForm">
				<input type="hidden" id="pgmId" name="pgmId" value="BM0202P01">
				<input type="hidden" id="clntCd" name="clntCd">
				<!-- 기본정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="15%">
						<col >
						<col width="15%">
						<col >
						<col width="15%">
						<col >
					</colgroup>
					<thead>
						<tr>
							<td colspan="5" style="text-align: left;">기본정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th class="hit">거래처명</th>
							<td>
								<input type="text" class="form-control" id="clntNm" name="clntNm" maxlength="25" required>
							</td>
							<th>사업자등록번호</th>
							<td>
								<input type="text" class="form-control" id="crn" name="crn" onkeyup="crnFormatter(this);" maxlength="12">
							</td>
							<th>거래처구분</th>
							<td>
								<select class="form-control input-sm" id="clntDivCd" name="clntDivCd" data-kind="CLNTDIV">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>대표자명</th>
							<td>
								<input type="text" class="form-control" id="repstNm" name="repstNm" maxlength="5">
							</td>
							<th>업태</th>
							<td>
								<input type="text" class="form-control" id="bizconNm" name="bizconNm" maxlength="25">
							</td>
							<th>종목</th>
							<td>
								<input type="text" class="form-control" id="bstyNm" name="bstyNm" maxlength="25">
							</td>
						</tr>
						<tr>
							<th rowspan="2">주소</th>
							<td>
								<div class="input-group">
									<input type="text" class="form-control" id="bizZip" name="bizZip" placeholder="우편번호" readonly>
									<span class="input-group-btn">
										<button type="button" class="btn btn-primary btn-sm" onclick="openDaumPostcode();">검색</button>
									</span>
								</div>
							</td>
							<td colspan="2"></td>
							<th>기본여신금액</th>
							<td colspan="3">
								<input type="text" class="form-control" id="basisCdtlnAmt" name="basisCdtlnAmt" onkeyup="addComma(this);" comma readonly>
							</td>
						</tr>
						<tr>
							<td colspan="3">
								<div class="form-inline" style="text-align: left;">
									<input type="text" class="form-control" id="bizAddr" name="bizAddr" style="width:49.5%;" placeholder="주소" readonly>
									<input type="text" class="form-control" id="bizAddrDtl" name="bizAddrDtl" style="width:49.5%;" placeholder="상세주소" maxlength="100">
								</div>
							</td>
							<th>사용여부</th>
							<td>
								<select class="form-control input-sm" id="useYn" name="useYn">
									<option value="Y">사용</option>
									<option value="N">미사용</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>전화번호</th>
							<td>
								<input type="text" class="form-control" id="bizTelNo" name="bizTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">
							</td>
							<th>FAX</th>
							<td>
								<input type="text" class="form-control" id="bizFaxNo" name="bizFaxNo" onkeyup="telNumberFormatter(this);" maxlength="13">
							</td>
							<th>URL</th>
							<td>
								<input type="text" class="form-control" id="subRmkUrl" name="subRmkUrl" onkeyup="exceptKorean(this);" maxlength="100">
							</td>
						</tr>
						<tr>
							<th>주거래은행</th>
							<td>
								<select class="form-control input-sm" id="bankCd" name="bankCd" data-kind="BANK">
									<option value="">선택</option>
								</select>
							</td>
							<th>계좌번호</th>
							<td>
								<input type="text" class="form-control" id="bkacNo" name="bkacNo" onkeyup="onlyBkac(this);" maxlength="20">
							</td>
							<th>계좌소유주</th>
							<td>
								<input type="text" class="form-control" id="bkacOwner" name="bkacOwner" maxlength="5">
							</td>
						</tr>
						<tr>
							<th>메모</th>
							<td colspan="5">
								<textarea class="form-control" id="clntRmk" name="clntRmk" style="height: 60px;" maxlength="500"></textarea>
							</td>
						</tr>
					</tbody>
				</table>
				<!-- 매입/매출정보 테이블 -->
				<table class="popup_table">
					<colgroup>
						<col width="20%">
						<col width="20%">
						<col width="20%">
						<col width="20%">
						<col width="20%">
					</colgroup>
					<thead>
						<tr>
							<td colspan="4" style="text-align: left;">매입/매출정보</td>
							<td style="text-align: right;">
								<a class="tbody_more_btn"></a>
							</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th>구분</th>
							<th>지급구분</th>
							<th>수금조건</th>
							<th>결제방법</th>
							<th>부가세</th>
						</tr>
						<tr>
							<td>매출</td>
							<td>
								<select class="form-control input-sm" id="pchsPayDivCd" name="pchsPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsClmnDivCd" name="pchsClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsPmntMtdCd" name="pchsPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="pchsVatCd" name="pchsVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
						<tr>
							<td>매입</td>
							<td>
								<select class="form-control input-sm" id="sellPayDivCd" name="sellPayDivCd" data-kind="PAYDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellClmnDivCd" name="sellClmnDivCd" data-kind="CLMNDIV">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellPmntMtdCd" name="sellPmntMtdCd" data-kind="PMNTMTD">
									<option value="">선택</option>
								</select>
							</td>
							<td>
								<select class="form-control input-sm" id="sellVatCd" name="sellVatCd" data-kind="VAT">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
					</tbody>
				</table>
			</form>
			<!-- 사업부 테이블 -->
			<table class="popup_table" id="bizdeptTable">
				<colgroup>
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="11%">
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="12%">
					<col width="5%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="10" style="text-align: left;">사업부</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="11">
							<div class="add_btn">
								<a onclick="addBizdeptRow();">추가</a>
							</div>
						</td>
					</tr>
					<tr>
						<th>사업부명</th>
						<th>사업구분</th>
						<th>담당자명</th>
						<th>담당자전화번호</th>
						<th>담당자휴대전화</th>
						<th>담당자이메일</th>
						<th>담당자부서명</th>
						<th>담당자직위</th>
						<th>영업회사</th>
						<th>영업사원</th>
						<th class="tc">삭제</th>
					</tr>
				</tbody>
			</table>
			<!-- 담보내역 테이블 -->
			<table class="popup_table" id="pldgTable">
				<colgroup>
					<col width="19%">
					<col width="19%">
					<col width="19%">
					<col width="19%">
					<col width="19%">
					<col width="5%">
				</colgroup>
				<thead>
					<tr>
						<td colspan="5" style="text-align: left;">담보내역</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="6">
						<!--
							<div class="add_btn">
								<a onclick="addPldgRow();" >추가</a>
							</div>
	 					-->
						</td>
					</tr>
					<tr>
						<th>회사</th>
						<th>구분</th>
						<th>금액</th>
						<th>인정비율(%)</th>
						<th>비고</th>
						<th class="tc">삭제</th>
					</tr>
				</tbody>
			</table>
			<!-- 첨부파일 테이블 -->
			<table class="popup_table">
				<thead>
					<tr>
						<td style="text-align: left;">첨부파일</td>
						<td style="text-align: right;">
							<a class="tbody_more_btn"></a>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td colspan="2">
							<div class="add_btn">
								<a onclick="clntFile.click();">추가</a>
							</div>
						</td>
					</tr>
					<tr>
						<td colspan="2">
							<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div>
	<button type="button" class="btn btn-default btn-sm" id="actionBtn"></button>
	<button type="button" class="btn btn-default btn-sm" onclick="modal.close();">닫기</button>
</div>

<script type="text/javascript" src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" ></script>
<script type="text/javascript">
	var $targetRow = null;
	var clntFileArr = [];
	var deleteFileArr = [];
	var fileGridView = {
		initView: function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		            onDBLClick: function () {
		            	if(this.item.fileKey){
							downloadFile(this.item.fileKey);
						}
		            }
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 500},
	                {key: "fileType", label: "파일타입", width: 100},
	                {key: "fileSize", label: "파일크기", width: 100},
	                {
						key:"fileDelete", label: "삭제", width:50,
						formatter:function() {
							return '<button type="button" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData: function() {
			var targetObj = this.target;
			targetObj.setData({
				list: clntFileArr,
				page : {
					totalElements : clntFileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		
		// 공통코드 set
		setCommonSelect($('#popup_area [data-kind]'));
		
		// 그리드 초기화
		fileGridView.initView();
		fileGridView.setData();
		
		if(actionType == "C"){
			$('#actionBtn').on("click", function(){insertClnt();});
			$('#actionBtn').text("등록");
		}else if(actionType == "U"){
			selectClntInfo();
			$('#actionBtn').on("click", function(){updateClnt();});
			$('#actionBtn').text("저장");
		}
	});
	
	function selectClntInfo() {
		var row = gridView.target.getList("selected")[0];
		var paramObj = {"clntCd": row.clntCd};
		postAjax("/admin/bm/bm02/selectClntInfo", paramObj, null, function(data){
			setClntInfo(data.clntInfo);
		});
	}
	
	function setClntInfo(clntInfo) {
		// 기본정보 set
		$.each(clntInfo, function(key, value){
			if($('#'+key)[0]){
				$('#'+key).val(value);
				// 금액 콤마 set
				if($('#'+key).is('[comma]')){
					addComma($('#'+key)[0]);
				}
			}
		});
		
		// 첨부파일 set
		var clntFileList = clntInfo.clntFileList;
		$.each(clntFileList, function(idx, obj){
			clntFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// 사업부 set
		var bizdeptList = clntInfo.bizdeptList;
		$.each(bizdeptList, function(idx, obj){
			var bizdeptRow = addBizdeptRow();
			for(var i=0;i<$(bizdeptRow).find('[name]').length;i++){
				var bizdeptItem = $(bizdeptRow).find('[name]')[i];
				if(obj[bizdeptItem.name]){
					bizdeptItem.value = obj[bizdeptItem.name];
				}
			}
		});
		
		// 담보내역 set
		var pldgList = clntInfo.pldgList;
		$.each(pldgList, function(idx, obj){
			var pldgRow = addPldgRow();
			for(var i=0;i<$(pldgRow).find('[name]').length;i++){
				var pldgItem = $(pldgRow).find('[name]')[i];
				if(obj[pldgItem.name]){
					pldgItem.value = obj[pldgItem.name];
				}
				if($(pldgItem).is('[comma]')){
					addComma(pldgItem);
				}
			}
		});
	}
	
	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#bizZip').val(data.zonecode);
				$('#bizAddr').val(data.roadAddress || data.address);
			}
		}).open();
	}
	
	function setClntFile(elem) {
		var tempFiles = elem.files;
		// 전역변수 배열에 선택된 파일 추가 
		$.each(tempFiles, function(idx, obj){
			var typeArr = obj.name.split(".");
			clntFileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : typeArr[typeArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// input file 초기화
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		if(clntFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(clntFileArr[rowIndex].fileKey);
		}
		clntFileArr.splice(rowIndex, 1);
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function insertClnt() {
		if(inputValidation($('[required]'))){
			var formData = makeFormData();
			filePostAjax("/admin/bm/bm02/insertClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modal.close();
				}
			});
		}
	}
	
	function updateClnt() {
		if(inputValidation($('[required]'))){
			var formData = makeFormData();
			filePutAjax("/admin/bm/bm02/updateClnt", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modal.close();
				}
			});
		}
	}
	
	function makeFormData() {
		// 콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		var formData = new FormData($('#clntForm')[0]);
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 첨부파일 추가
		$.each(clntFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		// 수정시 삭제된 파일 추가
		if(actionType == "U"){
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		
		// 사업부 추가
		var bizdeptArr = [];
		$.each($('#bizdeptTable tr[name="bizdeptRow"]'), function(idx, elem){
			var bizdeptObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				bizdeptObj[elem.name] = elem.value;
			});
			bizdeptArr.push(bizdeptObj);
		});
		formData.append("bizdeptArr", JSON.stringify(bizdeptArr));
		
		// 담보내역 추가
		var pldgArr = [];
		$.each($('#pldgTable tr[name="pldgRow"]'), function(idx, elem){
			var pldgObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				pldgObj[elem.name] = elem.value;
			});
			pldgArr.push(pldgObj);
		});
		formData.append("pldgArr", JSON.stringify(pldgArr));
		
		return formData;
	}
	
	function addBizdeptRow(){
		var bizdeptRow = '';
		bizdeptRow += '<tr name="bizdeptRow">';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="bizdeptNm" maxlength="15" required>';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<select class="form-control input-sm" name="bizdeptDivCd" required>';
		bizdeptRow += '<option value="">선택</option>';
		bizdeptRow += makeCommonSelect("BIZDIV");
		bizdeptRow += '</select>';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="mngNm" maxlength="5">';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="mngTelNo" onkeyup="telNumberFormatter(this);" maxlength="13">';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="mngMoblphonNo" onkeyup="telNumberFormatter(this);" maxlength="13">';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="mngEmail" onkeyup="exceptKorean(this)" maxlength="50">';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<input type="text" class="form-control" name="mngDeptNm" maxlength="15">';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<select class="form-control input-sm" name="mngPstCd">';
		bizdeptRow += '<option value="">선택</option>';
		bizdeptRow += makeCommonSelect("PST");
		bizdeptRow += '</select>';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<select class="form-control input-sm" name="salesCoCd" onchange="initSalesEmp(this);">';
		bizdeptRow += '<option value="">선택</option>';
		bizdeptRow += makeCommonSelect("CO");
		bizdeptRow += '</select>';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<div class="input-group">';
		bizdeptRow += '<input type="hidden" class="form-control" name="salesEmpId">';
		bizdeptRow += '<input type="text" class="form-control" name="salesEmpNm" readonly>';
		bizdeptRow += '<span class="input-group-btn">';
		bizdeptRow += '<button type="button" class="btn btn-primary btn-sm" onclick="openSecondUserSearch(this);">검색</button>';
		bizdeptRow += '</span>';
		bizdeptRow += '</div>';
		bizdeptRow += '</td>';
		bizdeptRow += '<td>';
		bizdeptRow += '<button type="button" class="btn btn-danger btn-sm delete_btn" onclick="deleteRow(this);">삭제</button>';
		bizdeptRow += '</td>';
		bizdeptRow += '</tr>';
		$('#bizdeptTable').append(bizdeptRow);
		return $('#bizdeptTable tr[name="bizdeptRow"]:last')[0];
	}
	
	function initSalesEmp(elem){
		var changedRow = $(elem).closest('tr[name="bizdeptRow"]');
		changedRow.find('[name="salesEmpId"]').val("");
		changedRow.find('[name="salesEmpNm"]').val("");
	}
	
	function openSecondUserSearch(elem){
		$targetRow = $(elem).closest('tr[name="bizdeptRow"]');
		
		if(!$targetRow.find('[name="salesCoCd"]').val()){
			alert("영업회사를 선택해주세요.");
			$targetRow.find('[name="salesCoCd"]').focus();
			return false;
		}
		
		var paramObj = {
			"coCd" : $targetRow.find('[name="salesCoCd"]').val(),
			"userId": $targetRow.find('[name="salesEmpId"]').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$targetRow.find('[name=salesEmpId]').val(checkedNode.id);
			$targetRow.find('[name=salesEmpNm]').val(checkedNode.text);
		});
	}
	
	function addPldgRow(){
		var pldgRow = '';
		pldgRow += '<tr name="pldgRow">';
		pldgRow += '<td>';
		pldgRow += '<select class="form-control input-sm" name="coCd" required>';
		pldgRow += '<option value="">선택</option>';
		pldgRow += makeCommonSelect("CO");
		pldgRow += '</select>';
		pldgRow += '</td>';
		pldgRow += '<td>';
		pldgRow += '<select class="form-control input-sm" name="pldgDivCd" required>';
		pldgRow += '<option value="">선택</option>';
		pldgRow += makeCommonSelect("PLDG");
		pldgRow += '</select>';
		pldgRow += '</td>';
		pldgRow += '<td>';
		pldgRow += '<input type="text" class="form-control" name="pldgAmt" onkeyup="addComma(this);" comma>'
		pldgRow += '</td>';
		pldgRow += '<td>';
		pldgRow += '<input type="text" class="form-control" name="pldgRcognRate" onkeyup="onlyNumber(this);">';
		pldgRow += '</td>';
		pldgRow += '<td>';
		pldgRow += '<input type="text" class="form-control" name="pldgRmk" maxlength="127">';
		pldgRow += '</td>';
		pldgRow += '<td>';
	//	pldgRow += '<button type="button" class="btn btn-danger btn-sm delete_btn" onclick="deleteRow(this);">삭제</button>';
		pldgRow += '</td>';
		pldgRow += '</tr>';
		$('#pldgTable').append(pldgRow);
		return $('#pldgTable tr[name="pldgRow"]:last')[0];
	}
	
	function makeCommonSelect(codeKind){
		var optionHtml = '';
		postAjaxSync("/admin/cm/cm05/selectChildCodeList", {"codeKind" : codeKind}, null, function(data){
			$.each(data.childCodeList, function(idx, obj){
				optionHtml += '<option value="'+obj.codeId+'">'+obj.codeNm+'</option>';
			});
		});
		return optionHtml;
	}
	
	function deleteRow(elem){
		$(elem).closest('tr').remove();	
	}
	
	function downloadFile(fileKey) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
</script>

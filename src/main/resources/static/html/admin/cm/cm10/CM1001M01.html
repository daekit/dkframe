<!DOCTYPE html>
<html lang="ko">
	<style>
		.th_title{
		    text-align: left;
		    position: relative;
		    color: #888888;
		    font-size: 13px;
		    padding: 1px 0 1px 15px;
		    font-weight: normal;
		}
	</style>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css" />
	<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
	<link rel="stylesheet" href="/static/css/gnb.css" />
	<link rel="stylesheet" href="/static/css/main.css" />
	<link rel="stylesheet" href="/static/css/sub.css" />
	<link rel="stylesheet" href="/static/css/common.css" />
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area">

		<!-- 콘텐츠 -->
		<div class="contents">
			<!-- 리스트 -->
			<table class="form-group popup_table" id="scndTable">
				<colgroup>
					<col width="32%">
					<col width="32%">
					<col width="32%">
				</colgroup>
				<thead>
					<tr>
						<td style="text-align: left;">
							<h3 class="location"><span class="page_tit">구매요청 미확정 현황</span>
								<select id="coCd1" data-kind="CO" onchange="reqGridView.setData(); gridView.setData();">
									<option value="">전체</option>
								</select>
							</h3> <!-- <span id="ordrgTotCnt"></span> -->
						</td>
						<td style="text-align: left;">
							<h3 class="location"><span class="page_tit">발주 미확정 현황</span>
								<select id="coCd2" data-kind="CO" onchange="setByCoCd(this); ordrgGridView.setData();">
									<option value="">전체</option>
								</select>
							</h3> <!-- <span id="ordrgTotCnt"></span> -->
						</td>
						<td style="text-align: left;">
							<h3 class="location"><span class="page_tit">출하 미확정 현황</span>
								<select id="coCd3" data-kind="CO" onchange="setByCoCd(this); shipGridView.setData();">
									<option value="">전체</option>
								</select>
							</h3> <!-- <span id="ordrgTotCnt"></span> -->
						</td>
					</tr>
					<tr>
						<td>
		                <span class="th_title">제품그룹</span>
		                <select id="prdtGrp_S1" data-kind="PRDTGRP" data-search="prdtGrp1" onchange="reqGridView.setData();" style="width:140px;margin-left: 35px;margin-bottom: 10px;">
			                <option value="">전체</option>
		                </select>
		                </td>
		                <td>
		                <span class="th_title">판매법인</span>
		                <select id="taxivcCoprt2" data-kind="ESTCOPRT" data-search="taxivcCoprt2" onchange="ordrgGridView.setData();" style="width:140px;margin-left: 35px;margin-bottom: 10px;">
			                <option value="">전체</option>
		                </select>
		                <span class="th_title">제품그룹</span>
		                <select id="prdtGrp_S2" data-kind="PRDTGRP" data-search="prdtGrp2" onchange="ordrgGridView.setData();" style="width:140px;margin-left: 30px;margin-bottom: 10px;">
			                <option value="">전체</option>
		                </select>
		                </td>
		                <td>
		                <span class="th_title">판매법인</span>
		                <select id="taxivcCoprt3" data-kind="ESTCOPRT" data-search="taxivcCoprt3" onchange="shipGridView.setData();" style="width:140px;margin-left: 35px;margin-bottom: 10px;">
			                <option value="">전체</option>
		                </select>
		                <span class="th_title">제품그룹</span>
		                <select id="prdtGrp_S3" data-kind="PRDTGRP" data-search="prdtGrp3" onchange="shipGridView.setData();" style="width:140px;margin-left: 30px;margin-bottom: 10px;">
			                <option value="">전체</option>
		                </select>
		                </td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>
							<div class="contents" style="margin:0px;padding:0px;width:100%;min-width:300px">
								<div data-ax5grid="req-grid" data-ax5grid-config="{}" style="height: 345px; width: 100%"></div>
								<h3><span class="page_tit">세금계산서 미처리 현황</span>
								<div data-ax5grid="tax-grid" data-ax5grid-config="{}" style="height: 365px; width: 100%"></div>
							</div>
						</td>
						<td>
							<div class="contents" style="margin:0px;padding:0px;width:100%;min-width:300px">
								<div data-ax5grid="ordrg-grid" data-ax5grid-config="{}" style="height: 725px; width: 100%"></div>
							</div>
						</td>
						<td>
							<div class="contents" style="margin:0px;padding:0px;width:100%; min-width:300px">
								<div data-ax5grid="ship-grid" data-ax5grid-config="{}" style="height: 725px; width: 100%"></div>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</body>
</html>

<script type="text/javascript">
	var odrSeq = null;
	var odrDtlSeqArr = [];
	
	ax5.ui.grid.formatter["bilgYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E"){
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};
	
	// 구매요청 그리드
	var reqGridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect : false,
				sortable : true,
				target : $('[data-ax5grid="req-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					onClick : function() {
						this.self.select(this.dindex);
					},
		            onDBLClick: function () {
		            	insertReqModal(this.item.reqSeq);
		            },
				},
				page : {
					display : true,
				},
				footSum: [
			    	[
			    		{label: "합계", align: "center", colspan: 7},
	                    {key: "reqQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "realDlvrQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "remainQty", collector: "sum", formatter:"money", align: "right"}
			    	]
			    ],
				columns: [
		          	{key: "reqSeq",   	 label: "구매요청일련번호", align: "center", hidden: true},
		          	{key: "reqDt",   	 label: "구매요청일자",    align: "center", hidden: true},
		          	{key: "recptYn",     label: "접수",   	align: "center",  width: 60,styleClass: function () {
	                     return (this.item.recptYn == "N") ? "grid-font-red-bold":"";}},
		          	{key: "ordrgYn",     label: "발주",   	align: "center",  width: 60},
		          	{key: "reqDt",       label: "요청일",   	align: "center",  width: 100},
		          	{key: "prdtNm",      label: "거래처",   	align: "left",    width: 140},
		          	{key: "siteNm",      label: "현장",   	align: "left",    width: 140},
		          	{key: "whNm",    	 label: "창고",   	align: "left",    width: 110},
		          	{key: "reqCreatDiv", label: "구분",  		align: "center",  width: 60, styleClass: function () {
	                     return (this.item.odrCreatDiv == "MES") ? "grid-font-blue":"";}},
		          	{key: "reqQty",      label: "요청량",   	align: "right",   width: 80, formatter: "money"},
		          	{key: "ordrgQty",    label: "발주량",   	align: "right",   width: 80, formatter: "money"},
		          	{key: "remainQty",   label: "잔량",   	align: "right",   width: 80, formatter: "money"}
		        ]
			});
			return this;
		},
		setData : function() {
			var targetObj = this.target;
			var paramObj = {
					"coCd1"       : $("#coCd1").val(),
					"prdtGrp1"     : $("#prdtGrp_S1").val()
			};
			postAjax("/user/cm/cm10/selectReqNList", paramObj, null, function(data) {
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						totalElements : list.length
						/* totalElements : data.paginationInfo.totalRecordCount */
					}
				});
			});				
		}
	}
	
	// 발주 그리드
	var ordrgGridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect : false,
				sortable : true,
				target : $('[data-ax5grid="ordrg-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					onClick : function() {
						this.self.select(this.dindex);
					},
		            onDBLClick: function () {
		            	viewOrderModal(this.item.ordrgSeq);
		            },
				},
				page : {
					display : true,
				},
				footSum: [
			    	[
			    		{label: "합계", align: "center", colspan: 6},
	                    {key: "ordrgQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "realDlvrQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "remainQty", collector: "sum", formatter:"money", align: "right"}
			    	]
			    ],
				columns: [
		          	{key: "ordrgSeq",   label: "발주일련번호",  align: "center",  hidden: true},
		          	{key: "ordrgYn",    label: "확정",   		align: "center",  width: 50},
		          	{key: "reqDt",      label: "요청일",   	align: "center",  width: 80},
		          	{key: "clntNm",     label: "거래처",   	align: "left",    width: 120},
		          	{key: "siteNm",     label: "현장",	   	align: "left",    width: 120},
		          	{key: "whNm",     	label: "창고",   		align: "left",    width: 100},
		          	{key: "odrCreatDiv",label: "구분",   		align: "center",  width: 60, styleClass: function () {return (this.item.odrCreatDiv == "MES") ? "grid-font-blue":"";}},
		          	{key: "ordrgQty",   label: "요청량",   	align: "right",   width: 70, formatter: "money"},
		          	{key: "realDlvrQty",label: "출하량",   	align: "right",   width: 70, formatter: "money"},
		          	{key: "remainQty",  label: "잔량",   		align: "right",   width: 70, formatter: "money"}
		        ]
			});
			return this;
		},
		setData : function() {
			var targetObj = this.target;
			var paramObj = {
					"coCd2"       : $("#coCd2").val(),
					"prdtGrp2"     : $("#prdtGrp_S2").val(),
					"taxivcCoprt2" : $("#taxivcCoprt2").val()
			};
			postAjax("/user/cm/cm10/selectOrdrgNList", paramObj, null, function(data) {
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						totalElements : list.length
						/* totalElements : data.paginationInfo.totalRecordCount */
					}
				});
			});				
		}
	}
	
	// 출하 그리드
	var shipGridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect : false,
				sortable : true,
				target : $('[data-ax5grid="ship-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					onClick : function() {
						this.self.select(this.dindex);
					},
		            onDBLClick: function () {
		            	viewShipModal(this.item.shipSeq);
		            },
				},
				page : {
					display : true,
				},
				footSum: [
			    	[
			    		{label: "합계", align: "center", colspan: 7},
	                    {key: "shipTotQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "realTotQty", collector: "sum", formatter:"money", align: "right"},
	                    {key: "remainQty", collector: "sum", formatter:"money", align: "right"}
			    	]
			    ],
				columns: [
		          	{key: "shipSeq",    label: "출하일련번호",  align: "center",  hidden: true},
		          	{key: "shipYn",     label: "확정",   		align: "center",  width: 50},
		          	{key: "recptYn",    label: "접수",   		align: "center",  width: 50, styleClass: function () {return (this.item.recptYn == "N") ? "grid-font-red-bold":"";}},
		          	{key: "reqDt",      label: "요청일", 		align: "center",  width: 80},
		          	{key: "clntNm",     label: "거래처", 		align: "left",    width: 120},
		          	{key: "siteNm",     label: "현장",		align: "left",    width: 120},
		          	{key: "whNm",       label: "창고",   		align: "left",    width: 100},
		          	{key: "odrCreatDiv",label: "구분",   		align: "center",  width: 60, styleClass: function () {return (this.item.odrCreatDiv == "MES") ? "grid-font-blue":"";}},
		          	{key: "shipTotQty", label: "요청량",	 	align: "right",   width: 70, formatter: "money"},
		          	{key: "realTotQty", label: "출하량", 		align: "right",   width: 70, formatter: "money"},
		          	{key: "remainQty",  label: "잔량",   		align: "right",   width: 70, formatter: "money"}
		        ]
			});
			return this;
		},
		setData : function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {
					"coCd3"       : $("#coCd3").val(),
					"prdtGrp3"     : $("#prdtGrp_S3").val(),
					"taxivcCoprt3" : $("#taxivcCoprt3").val()
			};
			postAjax("/user/cm/cm10/selectShipNList", paramObj, null, function(data) {
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						totalElements : list.length
						/* totalElements : data.paginationInfo.totalRecordCount */
					}
				});
			});				
		}
	}
	
	// 세금계산서 그리드
	var gridView = {
		initView : function() {

			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector : true,
				multipleSelect : false,
				sortable : true,
				target : $('[data-ax5grid="tax-grid"]'),
				header : {
					align : "center",
					selector : false
				},
				body : {
					onClick : function() {
						this.self.select(this.dindex);
					},
		            onDBLClick: function () {
							var list = gridView.target.getList("selected");
							$.each(list, function(idx, obj){
								gridView.target.select(obj.__index);
							});
							this.self.select(this.dindex);
							viewTaxBilgDetailModal("U");
		            },
				},
				page : {
					display : true,
				},
				footSum: [
			    	[
			    		{label: "합계", align: "center", colspan: 7},
	                    {key: "taxMoa523", collector: "sum", formatter:"money", align: "right"},
	                    {key: "taxMoa5124", collector: "sum", formatter:"money", align: "right"},
	                    {key: "taxMoa5388", collector: "sum", formatter:"money", align: "right"}
			    	]
			    ],
				columns: [
					{key: "coCd", hidden: true},
					{key: "sndCheck",          label: "전송",   	     align: "center",  width: 45,	formatter: "bilgYn"},
		          	/*{key: "sndYn",          label: "전송",   	     align: "center",  width: 45,	formatter: "bilgYn"},*/
		          	{key: "cseqRcvYn",      label: "결과",   	     align: "center",  width: 45},
		          	{key: "rcvYn",          label: "접수",   	     align: "center",  width: 45, 	formatter: "bilgYn"},
		          	{key: "taxDt",          label: "발행일", 	     align: "center",  width: 75, hidden: true},
		          	{key: "taxCreatNm",     label: "발행자",       align: "center",   width: 70},
		          	{key: "bilgCertNo",     label: "청구번호",     align: "center",  width: 70, styleClass: function () {
	                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		          	{key: "sellDt",         label: "매출일자",	     align: "center",  width: 75, styleClass: function () {
	                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		          	{key: "clntNm",         label: "거래처명",	     align: "left",    width: 130, styleClass: function () {
	                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		          	{key: "taxMoa523",      label: "공급가액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                 return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		          	{key: "taxMoa5124",     label: "부가세액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                 return (this.item.taxMoa5124 < 0) ? "grid-font-red":"";}},
		          	{key: "taxMoa5388",     label: "총금액",   	 align: "right",   width: 95, formatter: "money", styleClass: function () {
                 return (this.item.taxMoa5124 < 0) ? "grid-font-red":"";}},
	                {key: "ftxac11",        label: "국세청신고비고1",    align: "left",  width: 200, styleClass: function () {
	                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		          	{key: "rffGn1",         label: "종류",		 align: "center",  width: 100, styleClass: function () {
	                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		        ]
			});
			return this;
		},
		setData : function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {
					"coCd"       : $("#coCd1").val()
			};
			postAjax("/user/cm/cm10/selectTaxNList", paramObj, null, function(data) {
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						totalElements : list.length
						/* totalElements : data.paginationInfo.totalRecordCount */
					}
				});
			});				
		}
	}
	
	$(document).ready(function() {
		
		// 패스워드 유효기간 체크
		var paramObj = {"id": jwt.userId};
		postAjax("/admin/cm/cm06/checkPwdDttm", paramObj, null, function(data) {
			if(data.isExpired == "Y"){
// 				updatePwModal();
                if (confirm("암호 변경 주기가 도래하였습니다. 변경하시겠습니까?")) {
                	openModal("/static/html/cmn/modal/updatePw.html", 500, 200, "비밀번호 변경");
    			}
			}
		});

		// 페이지 타이틀 set
		mainDefaultLoad("대시보드", "실무자");
		setCommonSelect($("#main_area select[data-kind]"));

		//메뉴 숨기기
		$('#head_area').toggleClass('off');
		$('#top_area').toggleClass('on');
		$('#main_area').toggleClass('on');
		
		$("#coCd1").val(jwt.coCd);
		$("#coCd2").val(jwt.coCd);
		$("#coCd3").val(jwt.coCd);
		
		setByCoCd(jwt.coCd);
		
		ordrgGridView.initView().setData();
		shipGridView.initView().setData();
		reqGridView.initView().setData();
		gridView.initView().setData();
		// grid init
	});
	
	function insertReqModal(reqSeq) {
		var paramObj = {
			"actionType": "U",
			"reqSeq": reqSeq
		};
		openModal("/static/html/user/od/od04/OD0402P01.html", 1200, 780, "", paramObj);
	}
	
	function viewOrderModal(ordrgSeq) {
		var paramObj = {'ordrgSeq' : ordrgSeq};
		openModal("/static/html/user/od/od01/OD0102V01.html", 1300, 780, "", paramObj);
	}
	
	function viewShipModal(shipSeq) {
		var paramObj = {'shipSeq' : shipSeq};
		openModal("/static/html/user/ar/ar01/AR0102V01.html", 1300, 780, "", paramObj);
	}

	// 세금계산서 수정 화면
	function viewTaxBilgDetailModal(actionType) {
		var rowLength = gridView.target.getList("selected").length;
		this.actionType = actionType;
		openModal("/static/html/user/ar/ar04/AR0401P01.html", 1000, 690, "");
	}
		
	// 판매법인 set
	function setByCoCd(data){
		//변경한 판매법인의 아이디를 통해 coCd기준 판매법인 변경
		var dataType = typeof data;
		var changedId = '';
		var gridNum = '';
		var corptId = '';
		var rprc = '';
		
		//coCd변경 시
		if(dataType == 'object'){  
			changedId = $(data).attr('id');
			gridNum = changedId.charAt(changedId.length-1);
			corptId = '#taxivcCoprt' + gridNum;	
			rprc = data.value;
		}else { //처음 load시
			corptId = '#taxivcCoprt2';  //발주 현황 set
			rprc = data;
			$(corptId).data("rprc", rprc);
			$(corptId +' option:not([value=""])').remove()
			setCommonSelect($(corptId));
			
			corptId = '#taxivcCoprt3'; //출하 현황 set
		}
		
		$(corptId).data("rprc", rprc);
		$(corptId +' option:not([value=""])').remove()
		setCommonSelect($(corptId));
	}
</script>

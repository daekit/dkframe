<style>
	input[comma] {text-align: right;}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">주문 조회</h4>
	</div>
	<div class="popup_table">
		<form id="orderForm">
			<input type="hidden" id="odrSeq" name="odrSeq">
			<table>
				<colgroup>
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
				</colgroup>
				<tr>
					<th>회사</th>
					<td>
						<input type="text" id="coNm" name="coNm" readonly>
					</td>
					<th>판매유형</th>
					<td>
						<input type="text" id="typNm" name="typNm" readonly>
					</td>
					<th>현장</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="siteCd" name="siteCd">
							<input type="text" id="siteNm" readonly> 
						</div>
					</td>
				</tr>
				<tr>
					<th>거래처</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="clntCd" name="clntCd">
							<input type="text" id="clntNm" readonly> 
						</div>
					</td>
					<th>재고주체</th>
					<td>
						<input type="text" id="ownerNm" name="ownerNm" readonly>
					</td>
					<th>영업담당자</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="salesMng" name="salesMng">
							<input type="text" id="salesMngNm" readonly>
						</div>
					</td>
				</tr>
				<tr>
					<th>수입여부</th>
					<td>
						<input type="text" id="impYn" name="impYn" readonly>
					</td>
					<th>입고창고</th>
					<td>
						<input type="text" id="whNm" name="whNm" readonly>
					</td>
					<th>계산서발행법인</th>
					<td>
						<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" readonly>
					</td>
				</tr>
				<tr>
					<th>Maker</th>
					<td>
						<input type="text" id="makrNm" name="makrNm" readonly>
					</td>
					<th>주문일자</th>
					<td>
						<input type="text" id="reqDt" name="reqDt" readonly>
					</td>
					<th>납기일자</th>
					<td>
						<input type="text" id="dlvrDttm" name="dlvrDttm" readonly>
					</td>
				</tr>
				<tr>
					<th rowspan="2">착지주소</th>
					<td>
						<div class="search_form">
							<input type="text" id="addrZip" name="addrZip" readonly> 
						</div>
					</td>
					<th>착지연락처</th>
					<td>
						<input type="text" id="mngTel" name="mngTel" readonly>
					</td>
					<th>종료여부</th>
					<td>
						<input type="text" id="closeYn" name="closeYn" readonly>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<input type="text" id="addrMain" name="addrMain" readonly>
					</td>
					<td colspan="2">
						<input type="text" id="addrSub" name="addrSub" maxlength="50" readonly>
					</td>
				</tr>
				<tr>
					<th>비고</th>
					<td colspan="5">
						<textarea class="form-control" id="odrRmk" name="odrRmk" style="height: 60px;" maxlength="500" readonly></textarea>
					</td>
				</tr>
				<tr>
					<th>총수량</th>
					<td>
						<input type="text" id="totQty" name="totQty" comma readonly>
					</td>
					<th>총금액</th>
					<td>
						<input type="text" id="totAmt" name="totAmt" comma readonly>
					</td>
					<th>총예상손익</th>
					<td>
						<input type="text" id="totEpctPal" name="totEpctPal" comma readonly>
					</td>
				</tr>
			</table>
		</form>
	</div>
	<br>
	<!-- 상세내역 테이블 -->
	<div class="popup_table">
		<table id="detailTable">
			<colgroup>
				<col width="2%">
				<col width="10%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="11%">
			</colgroup>
			<tr>
				<td colspan="14" style="text-align: LEFT; border-right: 0;">※상세내역</td>
			</tr>
			<tr>
				<th style="padding: 3px 5px;"> 
					<input type="checkbox" id="allChkBox" onchange="ctrlDetailChkBox(this);">
				</th>
				<th class="tc">제품명</th>
				<th class="tc">사이즈</th>
				<th class="tc">SPEC</th>
				<th class="tc">길이</th>
				<th class="tc">단위</th>
				<th class="tc">기준단가</th>
				<th class="tc">주문수량</th>
				<th class="tc">주문단가</th>
				<th class="tc">금액</th>
				<th class="tc">예상손익</th>
				<th class="tc">입고량</th>
				<th class="tc">출하량</th>
				<th class="tc">비고</th>
			</tr>
		</table>
		<table id="frameTable" style="display: none;">
			<tr name="detailRow">
				<input type="hidden" name="odrDtlSeq">
				<input type="hidden" name="stockUpr">
<!-- 				<input type="hidden" name="prdtStockCd"> -->
				<td>
					<input type="checkbox" name="detailChkBox" onchange="ctrlAllChkBox();">
				</td>
				<td>
					<div class="search_form">
						<input type="hidden" name="prdtCd">
						<input type="text" name="prdtNm" readonly> 
					</div>
				</td>
				<td>
					<input type="text" name="prdtSize" readonly>
				</td>
				<td>
					<input type="text" name="prdtSpec" readonly>
				</td>
				<td>
					<input type="text" name="prdtLen" comma readonly>
				</td>
				<td>
					<input type="hidden" name="prdtUnit">
					<input type="text" class="tc" name="prdtUnitNm" readonly>
				</td>
				<td>
					<input type="text" name="prdtUpr" comma readonly>
				</td>
				<td>
					<input type="text" name="odrQty" comma readonly>
				</td>
				<td>
					<input type="text" name="odrUpr" comma readonly>
				</td>
				<td>
					<input type="text" name="odrAmt" comma readonly>
				</td>
				<td>
					<input type="text" name="epctPal" comma readonly>
				</td>
				<td>
					<input type="text" name="ordrgQty" comma readonly>
				</td>
				<td>
					<input type="text" name="shipQty" comma readonly>
				</td>
				<td>
					<input type="text" name="odrDtlRmk" readonly>
				</td>
			</tr>
		</table>
		<table>
			<colgroup>
				<col width="2%">
				<col width="10%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="7%">
				<col width="11%">
			</colgroup>
			<tr>
				<th class="tc" colspan="7">합계</th>
				<td class="tr" id="totQtyDp" comma></td>
				<td>-</td>
				<td class="tr" id="totAmtDp" comma></td>
				<td class="tr" id="totEpctPalDp" comma></td>
				<td class="tr" id="totOrdrgQty" comma></td>
				<td class="tr" id="totShipQty" comma></td>
				<td>-</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 발주서 테이블 -->
	<div class="popup_table" id="ordrgTable">
		<table>
			<thead>
				<tr>
					<td class="tl">발주서</td>
					<td class="tr">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tr>
				<td colspan="2">
					<div class="ax5_grid" data-ax5grid="ordrg-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 출하요청서 테이블 -->
	<div class="popup_table" id="shipTable">
		<table>
			<thead>
				<tr>
					<td class="tl">출하요청서</td>
					<td class="tr">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tr>
				<td colspan="2">
					<div class="ax5_grid" data-ax5grid="ship-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 첨부파일 테이블 -->
	<div class="popup_table">
		<table>
			<colgroup>
				<col width="12%">
			</colgroup>
			<tr>
				<th>첨부파일</th>
				<td>
					<div class="ax5_grid" data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 130px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button type="button" name="actionBtn" onclick="openInsertOrdrg();" authchk>발주</button>
		<button type="button" name="actionBtn" onclick="openInsertShip()"   authchk>출하</button>
		<button type="button" name="actionBtn" onclick="openUpdateOrder();" authchk>수정</button>
		<button type="button" name="actionBtn" onclick="closeOrder()"       authchk>종료</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	var fileArr = [];
	var fileGridView = {
		initView : function() {
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target : $('[data-ax5grid="file-grid"]'),
				showLineNumber : true,
				showRowSelector : false,
				multipleSelect : false,
				header : {
					selector : false
				},
				body : {
					onDBLClick: function () {
						if(this.item.fileKey){
							downloadFile(this.item.fileKey);
						}
		            }
				},
				columns : [
					{key: "fileName", label: "파일명", align: "center", width: 580},
	                {key: "fileType", label: "파일타입", align: "center", width: 80},
	                {key: "fileSize", label: "파일크기", align: "center", width: 80}
				]
			});
			return this;
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}

	var ordrgGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		        target: $('[data-ax5grid="ordrg-grid"]'),
		        header: {
		        	align: "center",
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		                this.self.select(this.dindex); 
		            },
		            onDBLClick: function () {
		    			var paramObj = {
    						"ordrgSeq": this.item.ordrgSeq,
    						"openFrom": "SD0402V01" 
		    			};	
		            	openSecondModal("/static/html/user/od/od01/OD0102V01.html", 1300, 800, "", paramObj);
		            }
		        },
		        page: {
		            navigationItemCount: 10,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	ordrgGridView.setData(this.page.selectPage);
		            }
		        },
		        columns: [
		        	{key: "ordrgSeq", label: "발주일련번호", hidden: true},
		        	{key: "ordrgYn", label: "매입", align: "center", width: 60},
		        	{key: "sellYn", label: "매출", align: "center", width: 60},
		          	{key: "reqDt", label: "요청일자", align: "center", width: 90},
		            {key: "dirtrsYn", label: "직송", align: "center", width: 60},
		            {key: "clntNm", label: "매입거래처", align: "left", width: 150},
		        	{key: "prjctNm", label: "프로젝트", align: "left", width: 200},
		        	{key: "sellClntNm", label: "매출거래처", align: "left", width: 150},
		        	{key: "makrNm", label: "제조사", align: "left", width: 90},
		        	{key: "whNm", label: "창고", align: "left", width: 90},
		        	{
		        		label: "발주지시",  columns:[
				        	{key: "totQty", label: "수량", align: "right", width: 100, formatter: "money"},
				        	{key: "totWt", label: "중량", align: "right", width: 100, formatter: "money"},
				        	{key: "totAmt", label: "발주금액", align: "right", width: 100, formatter: "money"}
			       		]
		        	},
		        	{
		        		label: "실발주",  columns:[
				        	{key: "realTotQty", label: "수량", align: "right", width: 100, formatter: "money"},
				        	{key: "realTotWt", label: "중량", align: "right", width: 100, formatter: "money"},
				        	{key: "realTotAmt", label: "발주금액", align: "right", width: 100, formatter: "money"}
			       		]
		        	},
		        	{key: "typNm", label: "판매유형", align: "center", width: 90},
		        	{key: "impYn", label: "수입", align: "center", width: 60},
		        	{key: "addr", label: "착지주소", align: "left", width: 300},
		        	{key: "mngTel", label: "담당자연락처", align: "left", width: 100},
		        	{key: "dlvrDttm", label: "납기일자", align: "center", width: 90},
		        	{key: "ordrgRmk", label: "비고", align: "left", width: 200},
		        	{key: "salesMngNm", label: "발주담당자", align: "center", width: 90}
		        ]
		    });
			return this;
		},
		setData: function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {
				"pageNo": _pageNo + 1,
				"odrSeq": $('#odrSeq').val()
			};
			
			postAjax("/user/od/od01/selectOrdrgList", paramObj, null, function(data){
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
				
				if(data.paginationInfo.totalRecordCount == 0){
					$('#ordrgTable').hide()
				}
			});
		}
	}
	
	var shipGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		        target: $('[data-ax5grid="ship-grid"]'),
		        header: {
		        	align: "center",
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		                this.self.select(this.dindex); 
		            },
		            onDBLClick: function () {
		    			var paramObj = {
   							"shipSeq": this.item.shipSeq,
    						"openFrom": "SD0402V01" 
		    			};	
		    			openSecondModal("/static/html/user/ar/ar01/AR0102V01.html", 1300, 780, "", paramObj);
		            }
		        },
		        page: {
		            navigationItemCount: 10,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	AR01GridView.setData(this.page.selectPage);
		            }
		        },
		        columns: [
		        	{key: "shipSeq", label: "출하일련번호", hidden: true},
		        	{key: "shipYn", label: "출하", align: "center", width: 60},
		          	{key: "coNm", label: "회사", align: "left", width: 100},
		          	{key: "whNm", label: "창고", align: "left", width: 90},
		            {key: "clntNm", label: "거래처", align: "left", width: 150},
		            {key: "reqDt", label: "요청일자", align: "center", width: 90},
		        	{key: "dirtrsYn", label: "직송", align: "center", width: 60},
		        	{key: "dlvrDttm", label: "납기일시", align: "center", width: 90},
		        	{
		        		label: "출하요청",  columns:[
			          		{key: "shipTotQty", label: "수량", align: "right", width: 100, formatter: "money" },
				          	{key: "shipTotWt", label: "중량", align: "right", width: 100, formatter: "money" },
				          	{key: "shipTotAmt", label: "총금액", align: "right", width: 100,formatter: "money" }
		          		]
		        	},
		          	{
	        			label: "실출하",  columns:[
			          		{key: "realTotQty", label: "수량", align: "right", width: 100, formatter: "money" },
				          	{key: "realTotWt", label: "중량", align: "right", width: 100, formatter: "money" },
				          	{key: "realTotAmt", label: "총금액", align: "right", width: 100, formatter: "money" }
		          		]
		        	},
		        	{key: "shipDttm", label: "출하완료일", align: "center", width: 90},
		        	{key: "transAmt", label: "운송비", align: "right", width: 100, formatter: "money"},
		        	{key: "odrCreatDiv", label: "오더구분", align: "left", width: 100}
		        ]
		    });
			return this;
		},
		setData: function(_pageNo) {
			var targetObj = this.target;
			var paramObj = {
				"pageNo": _pageNo + 1,
				"odrSeq": $('#odrSeq').val()
			};
			
			postAjax("/user/ar/ar01/selectShipList", paramObj, null, function(data){
				var list = data.resultList;
				targetObj.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
				
				if(data.paginationInfo.totalRecordCount == 0){
					$('#shipTable').hide()
				}
			});
		}
	}

	$(document).ready(function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		selectOrderInfo();
		authChk();
	});
	
	function selectOrderInfo() {
		var paramObj = modalStack.last().paramObj;
		postAjax("/user/sd/sd04/selectOrderInfo", paramObj, null, function(data) {
			setOrderInfo(data.orderInfo);
		});
	}

	function setOrderInfo(orderInfo) {
		
		//메인정보 세팅
		$.each(orderInfo, function(key, value) {
			if($('#'+key)[0]){
				if($('#'+key).is('[comma]')){
					value = addCommaStr(value);
				}
				
				$('#'+key).val(value);
				
				// 합계 set
				if (key.indexOf('tot') != -1) {
					$('#'+key+"Dp").text(value);
				}
			}
		});
		
		//상세정보 세팅
		$.each(orderInfo.detailList, function(idx, obj) {
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
				}
			});
		});
		
		// 발주서 set
		ordrgGridView.initView().setData(0);
		
		// 출하요청서 set
		shipGridView.initView().setData(0);
		
		// 첨부파일 set
		$.each(orderInfo.fileList, function(idx, obj) {
			fileArr.push({
				'fileKey' : obj.fileKey,
				'fileName' : obj.fileName,
				'fileType' : obj.fileType,
				'fileSize' : obj.fileSize,
				'file' : obj
			});
		});
		// 첨부파일 그리드 set
		fileGridView.initView().setData();
		
		// 종료된 주문일 때 버튼 제어
		if(orderInfo.closeYn == "Y"){
			$('button[name="actionBtn"]').hide();
		}
		
	}
	
	function addDetailRow(){
		var $detailRow = $('#frameTable tr[name="detailRow"]').clone();
		$('#detailTable tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function ctrlDetailChkBox(elem){
		if($(elem).is(':checked')){
			$('#detailTable tr[name="detailRow"] input[name="detailChkBox"]').prop("checked", true);
		}else{
			$('#detailTable tr[name="detailRow"] input[name="detailChkBox"]').prop("checked", false);
		}
	}
	
	function ctrlAllChkBox(){
		var isAllChk = true;
		var $detailChkBoxes = $('#detailTable tr[name="detailRow"] input[name="detailChkBox"]');
		if($detailChkBoxes.length > 0){
			$.each($detailChkBoxes, function(idx, elem){
				if(!$(elem).is(':checked')){
					isAllChk = false;
				}
			});
			if(isAllChk){
				$('#allChkBox').prop("checked", true);
			}else{
				$('#allChkBox').prop("checked", false);
			}
		}else{
			$('#allChkBox').prop("checked", false);
		}
	}
	
	function downloadFile(fileKey) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	// 발주 등록
	function openInsertOrdrg(){
		var paramObj = orderSequenceSet();
		if(paramObj){
			paramObj.actionType = "O";
			modalStack.close();
			setTimeout(function(){
				openModal("/static/html/user/od/od01/OD0102P01.html", 1300, 800, "", paramObj);
			}, 500);
		}
	}

	// 출하 등록
	function openInsertShip(){
		var paramObj = orderSequenceSet();
		if(paramObj){
			paramObj.actionType = "O";
			modalStack.close();
			setTimeout(function(){
				openModal("/static/html/user/ar/ar01/AR0102P01.html", 1300, 780, "", paramObj);
			}, 500);
		}
	}
	
	// 수정
	function openUpdateOrder(){
		var paramObj = {
			"actionType": "U",
			"odrSeq": $('#odrSeq').val()
		};
		modalStack.close();
		setTimeout(function(){
			openModal("/static/html/user/sd/sd04/SD0402P01.html", 1300, 800, "", paramObj);
		}, 500);
	}
	
	// odrSeq, odrDtlSeq set
	function orderSequenceSet(){
		var odrDtlSeqArr = [];
		$.each($('tr[name="detailRow"]'), function(idx, elem){
			if($(elem).find('input[name="detailChkBox"]').is(':checked')) {
				odrDtlSeqArr.push($(elem).find('input[name="odrDtlSeq"]').val());
			}
		});
		
		if(odrDtlSeqArr.length > 0){
			var paramObj = {
				"odrSeq": $('#odrSeq').val(),
				"odrDtlSeqArr": odrDtlSeqArr
			}
			return paramObj;
		}else{
			alert("주문내역을 선택하세요.");
			return false;
		}
	}
	
	// 주문종료
	function closeOrder(){
		if (!confirm("주문을 종료하시겠습니까?")) return;
		
		var paramObjList = [];
		var paramObj = {};
		paramObj.odrSeq = $('#odrSeq').val();
		paramObj.userId = jwt.userId;
		paramObj.pgmId = "SD0402V01";
		paramObjList.push(paramObj);
		
		putAjax("/user/sd/sd04/closeOrder", paramObjList, null, function(data) {
			alert(data.resultMessage);
			
			// 그리드 재검색
			gridView.setData(gridView.target.page.currentPage);
			
			// 뷰페이지 재호출
			modalStack.close();
			var paramObj = {"odrSeq": $('#odrSeq').val()};
			openModal("/static/html/user/sd/sd04/SD0402V01.html", 1300, 800, "", paramObj);
		});
	}
</script>
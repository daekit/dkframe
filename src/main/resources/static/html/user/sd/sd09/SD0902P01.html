<div id="cplrUntpcDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">현장 관리</h4>
    </div>
    <div class="popup_table">
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th class="hit">회사</th>
	                <td>
	                    <select id="coCd" name="coCd" data-kind="CO" required="required" msg="회사">
	                    	<option value="">선택</option>
	                    </select>
	                </td>
	                <th class="hit">매출처</th>
	                <td>                                
                    	<input type="hidden" id="clntCd" name="clntCd">
		                <div class="search_form" style="width: 100%;">
				            <input type="text" id="clntNm" name="clntNm" disabled required="required">
				            <a id="btnClnt" onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	                <th>등록일</th>
	                <td>                                
	                    <input type="text" id="creatDttm" name="creatDttm" readOnly>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">현장명</th>
	                <td colspan="3">     
	                	<input type="hidden" id="siteCd" name="siteCd"/>
			            <input type="text" id="siteNm" name="siteNm" required="required" msg="현장명" maxLength="50"/>
	                </td>
	                <th>현장담당자</th>
	                <td>	              
			            <input type="text" id="siteMngNm" name="siteMngNm" maxLength="25"/>
	                </td>
	            </tr>
	            <tr>
	                <th>프로젝트</th>
	                <td colspan="1" style="border-left: 0px !important;">
	                    <input type="hidden" id="prjctCd" name="prjctCd">
		                <div class="search_form" style="width: 100%;">
				            <input type="text" id="prjctNm" name="prjctNm" disabled>
				            <a id="btnPrjct" onclick="openSecondPrjctSearch();"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	                <th class="hit">판매지역</th>
	                	<td>
	                		<select data-kind="SALESAREA" id="salesAreaCd" name="salesAreaCd" required="required" msg="판매지역">
	                			<option value="">전체</option>
	              			</select>  
	                	</td>
	                <th>전화번호</th>
	                <td style="border-left: 0px !important;">
	                    <input id="telNo" name="telNo" type="text" style="width: 100%;" onKeyUp="telNumberFormatter(this);" maxLength="50">
	                </td>
	            </tr>
	            <tr>
	            	<th>가공공장</th>
	            	<td>
	            		<select id="whCd" name="whCd" data-kind="WH">
	                    	<option value="">선택</option>
	                    </select>
	            	</td>
	            	<th>담당자</th>
					<td>
							<input type="hidden" id="mngId" name="mngId" style="width: 76%;" maxlength="20">
							<div class="search_form">
								<input type="text" id="mngNm" name="mngNm" readonly="readonly">
								<a onclick="openUserTree();"><i class="i_search_w"></i>
								</a>
							</div>
					</td>
	            	<th>사용여부</th>
	            	<td>
	            		<select id="useYn" name="useYn" data-kind="YN">
	                    	<option value="">선택</option>
	                    </select>
	            	</td>
	            </tr>	            
	            <tr>
	            	<th rowspan="1">주소</th>
	            	<td colspan="1">
	            		<div class="search_form">
							<input type="text" id="siteAddrZip" name="siteAddrZip" readonly> 
							<a onclick="openDaumPostcode();"><i class="i_search_w"></i>
							</a>
						</div>
	            	</td>
	            	<td colspan="2">
	            		<input type="text" id="siteAddr" name="siteAddr" placeholder="선택 주소지" readonly/>
	            	</td>
	            	<td colspan="2">
	            		<input type="text" id="siteAddrSub" name="siteAddrSub" placeholder="상세 주소 입력" maxLength="50"/>
	            	</td>
	            </tr>
	            <tr>
	            	<th>비고</th>
	                <td colspan="5">     
	                	<textarea class="form-control" id="rmk" name="rmk" style="height: 120px;" maxlength="500"></textarea>
	                </td>
	            </tr>     
	        </table>
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId" name="pgmId" value="SD0901P01">
	    </form>
    </div>

    <br>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionBtn"></button>
      <button class="close_btn" onclick="modalClose();">닫기</button>
    </div>
</div>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var selectedIdx = 0;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));

		setInit();
		//$(".popup_area input").prop("readonly", true);
		//$(".popup_area select").prop("disabled", true);
	});
	
	function setInit() {
		//selectOrderInfo();
		if(actionType == "C"){
			$('#actionBtn').on("click", function(){insertSite();});
			$('#actionBtn').text("등록");
			var format = new Date();
		    var year = format.getFullYear();
		    var month = format.getMonth() + 1;
		    if(month<10) month = '0' + month;
		    var date = format.getDate();
		    if(date<10) date = '0' + date;
			$("#creatDttm").val(year + "-" + month + "-" + date);
			$("#popForm #coCd").val(jwt.coCd);
			$("#popForm #useYn").val("Y");
		} else if(actionType == "U"){
			$('#actionBtn').on("click", function(){updateSite();});
			$('#actionBtn').text("저장");
			selectSiteDetail();
		}
	}
	
	function makeFormData(){
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		var formData = new FormData($("#popForm")[0]);
		return formData;
	}
	
	function selectSiteDetail(){
		var row = gridView.target.getList("selected")[0];
		var formData = {
				"siteCd" : row.siteCd,
				"coCd" : row.coCd,
		}
		postAjax("/user/sd/sd09/selectSiteDetail", formData, null, function(data){
			console.log(data);
			setSiteDetail(data.result);
		});
	}
	
	function setSiteDetail(obj){
		
		//메인정보 세팅
		$.each(obj, function(key, value){
			console.log(key + " : " + value)
			$('#popForm #'+key).val(value);
		});
		
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		

		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$('#popForm #coCd').prop("disabled", true);
		$('#popForm #clntNm').prop("disabled", true);
		$('#popForm #prjctNm').prop("disabled", true);
	}
	
	function insertSite() {
		if(inputValidation($('[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/sd/sd09/insertSite", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function updateSite() {
		if(inputValidation($('[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/sd/sd09/updateSite", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}

	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#popForm #clntCd').val(row.clntCd);
			$('#popForm #clntNm').val(row.clntNm);
		});
	}

	// 거래처 검색
	function openSecondPrjctSearch() {
		openSecondModal("/static/html/cmn/modal/prjctSearch.html", 600, 420, "프로젝트 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#popForm #prjctCd').val(row.prjctCd);
			$('#popForm #prjctNm').val(row.prjctNm);
			$("#popForm #siteAddrZip").val(row.prjctAddrZip);
			$("#popForm #siteAddr").val(row.prjctAddr);
			$("#popForm #siteAddrSub").val(row.prjctAddrSub);
		});
	}
	
	// 주소 검색
	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#siteAddrZip').val(data.zonecode);
				$('#siteAddr').val((data.roadAddress || data.address) + ' ' + data.buildingName);
			}
		}).open();
	}

	function modalClose(){
		modal.close();
	}
	
	function openUserTree() {
		var paramObj = {
				//	"coCd" : $('#coCd').val(),
			"userId": $('#mngId').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#mngId').val(checkedNode.id);
			$('#mngNm').val(checkedNode.text);
		});
	}
</script>
<body>
  <div class="popup_area of_a" style="width: 100%; height: 100%;">
  	<div class="tit_contents">
        <h4 class="tit">프로젝트 등록</h4>
    </div>
    <div class="form-group popup_table">
    	<input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/>
    	<form id="popForm">
        <table>
            <colgroup>
                <col width="12%">
                <col width="26%">
                <col width="13%">
                <col width="20%">
                <col width="13%">
                <col>
            </colgroup>
            <tr>
                <th class="hit">회사</th>
                <td>                                
                    <select id="coCd" name="coCd" data-kind="CO"  required="required">
                    <option value="">전체</option>
                    </select>
                </td>
                <th class="hit">법인</th>
                <td>
                	<select id="coprtCd" name="coprtCd" data-kind="ESTCOPRT"  required="required">
                    </select>
                </td>              

                <th class="hit">등록일</th>
                <td>
                	<input id="creatDttm2" name="creatDtDtl" disabled  required="required">
                </td>
            </tr>
            <tr>
                <th class="hit">프로젝트 기간</th>
                <td class="drctArea">
                	<div class="date_input">
                		<input id="strtDt2" name="strtDtDtl" class="input_calendar"  required="required"><span>~</span>
                		<input id="endDt2" name="endDtDtl" class="input_calendar"  required="required">
                	</div>
                </td>
                <th class="hit">매출처</th>
                <td class="drctArea">
                	<input type="hidden" id="clntCd" name="clntCd" style="width: 76%;">                   
                	<div class="search_form">
	                    <input type="text" id="clntNm" name="clntNm" readonly="readonly"  required="required">
                    	<a onclick="clntSearch();"><i class="i_search_w"></i></a>
                    </div>
                </td>               
                <th class="">제조사</th>
                <td>
                	<select id="makrCd" name="makrCdDtl" data-kind="MAKR">
                    </select>
                </td>

            </tr>
            <tr>
                <th class="hit">프로젝트명</th>
                <td colspan="3">   
                	<input id="prjctNm" name="prjctNmDtl" type="text" style="width: 100%;"  required="required">
                </td>
                <th class="hit">프로젝트 담당자</th>
                <td>                                
                    <input type="hidden" id="salesMng" name="salesMng" style="width: 76%;">
                    <div class="search_form">
	                    <input type="text" id="salesMngNm" name="salesMngNm" readonly="readonly" required="required">
                    	<a onclick="openUserTree();"><i class="i_search_w"></i></a>
                    </div>
                </td> 
            </tr>
            <tr>
                <th class="">주소</th>
                <td >   
					<div class="search_form" >
					    <input id="prjctAddrZip" name="prjctAddrZip" type="text" readonly="readonly">
					     <a onclick="openDaumPostcode();"><i class="i_search_w"></i></a>
					</div>
				</td>	     
				<td colspan="2">					    
                	    <input type="text" id="prjctAddr" name="prjctAddr" type="text" style="width: 80%;" placeholder="선택 주소지" readonly="readonly">
                </td>
             
                <th class="">로스율(%)</th>
                <td>                                
                    <input id="lossRate" name="lossRate" type="text">
                </td>            
            </tr>
            <tr>
                <th class="">주소</th>
                <td colspan="3">   
					<input id="prjctAddrSub" name="prjctAddrSub" type="text" style="width: 100%;" placeholder="상세 주소 입력" maxlength="100">
				</td>
            </tr>
            <tr>
                <th class="">현장담당자</th>
                <td>                                
                    <input id="prjctMngNm" name="prjctMngNm" type="text">
                </td>    
                <th class="">전화번호</th>
                <td>                                
                    <input id="telNo" name="telNo" type="text">
                </td>    
                <th class="">MES참조번호</th>
                <td>                                
                    <input id="prjctMesCd" name="prjctMesCd" type="text">
                </td>              
            
            </tr>
            <tr>
                <th class="">총중량(KG)</th>
                <td>                                
                    <input id="totWt" name="totWtDtl" type="text" onkeyup="addComma(this);" comma>
                </td>      
                <th class="">턴키여부</th>
                <td>   
                	<select id="tnkeyYn" name="tnkeyYnDtl" class="form-control">
                		<option value="Y" selected>Y</option>
						<option value="N">N</option>
		      		</select>
                </td>  
                <th class="">사용여부</th>
                <td>   
                	<select id="useYn" name="useYn" class="form-control">
                		<option value="Y" selected>Y</option>
						<option value="N">N</option>
		      		</select>
                </td>                                       
            </tr>
            <tr>
                <th class="">비고</th>
                <td colspan="5">     
                    <textarea id="rmk" name="rmkDtl" style="width: 100%;height: 120px;" ></textarea>
                </td>
            </tr>
                            
        </table>
        <input type="hidden" id="userId" name="userId">
	    <input type="hidden" id="pgmId" name="pgmId" value="SD0501M01">
	    <input type="hidden" id="prjctCd" name="prjctCd">
      </form>
    </div>
  <!-- 출하요청서 테이블 -->
	<table class="form-group popup_table" id="shipmentTable" style="display:none">
		<colgroup>
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
		</colgroup>
		<thead>
			<tr>
				<td colspan="6" style="text-align: left;">출하요청서<!-- <span id="shipTotCnt"></span> --></td>
				<td style="text-align: right;">
					<a class="tbody_more_btn"></a>
				</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td colspan="7">
					<div class="contents" style="margin:0px;padding:0px;">
						<div data-ax5grid="AR01-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
					</div>
				</td>
			</tr>
		</tbody>
	</table>
  <!-- 발주서 테이블 -->
	<table class="form-group popup_table" id="ordrgTable" style="display:none">
		<colgroup>
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
		</colgroup>
		<thead>
			<tr>
				<td colspan="6" style="text-align: left;">발주서<!-- <span id="ordrgTotCnt"></span> --></td>
				<td style="text-align: right;">
					<a class="tbody_more_btn"></a>
				</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td colspan="7">
					<div class="contents" style="margin:0px;padding:0px;">
						<div data-ax5grid="OD01-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
					</div>
				</td>
			</tr>
		</tbody>
	</table>
    <table class="form-group">
	  <colgroup>
	    <col width="12%">
	    <col>
	  </colgroup>
	    <tr>
	  		<th>
	  			<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="file.click();">첨부파일</button>
	  		</th>
	  		<td>
	  			<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
	  		</td>
	  	</tr>
	</table>
  	<div>
		<button id="prjctActionBtn">등록</button>
		<button type="button" class="btn btn-default btn-sm" onclick="modal.close();">닫기</button>
	</div> 
  </div>
  <!-- <div class="row">
		<div data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 600px; width: 100%"></div>
  </div> -->
</body>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	var openFrom = "SD0501P01";
	var clntType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 440},
	                {key: "fileType", label: "파일타입", width: 150},
	                {key: "fileSize", label: "파일크기", width: 150},
	                {
						key:"fileDelete", label: "삭제", width:80,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	
	var OD01Grid = null;
	var OD01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		        target: $('[data-ax5grid="OD01-grid"]'),
		        header: {
		        	align: "center",
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		                this.self.select(this.dindex); 
		            },
		            onDBLClick: function () {
		            	viewOrderModal();
		            },
		        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	OD01GridView.setData(this.page.selectPage);
		            }
		        },
		        columns: [
		          	{key: "ordrgSeq", label: "발주일련번호", align: "center", hidden: true},
		          	{key: "reqDt", label: "요청일자", align: "center", width: "10%"},
		            {key: "dirtrsYn", label: "직송구분", align: "center", width: "8%"},
		            {key: "clntNm", label: "매입거래처", align: "left", width: "14%"},
		        	{key: "prjctNm", label: "프로젝트", align: "left", width: "10%"},
		        	{key: "sellClntNm", label: "매출거래처", align: "center", width: "14%"},
		        	{key: "makrNm", label: "제조사", align: "left", width: "10%"},
		        	{key: "whNm", label: "창고", align: "center", width: "10%"},
		        	{key: "totQty", label: "수량(Kg)", align: "right", width: "8%", formatter: "money"},
		        	{key: "totAmt", label: "발주금액", align: "right", width: "10%", formatter: "money"},
		        	{key: "typNm", label: "판매유형", align: "center", width: "8%"},
		        	{key: "ordrgYn", label: "매입확정여부", align: "center", width: "10%"},
		        	{key: "sellYn", label: "매출확정여부", align: "center", width: "10%"},
		        	{key: "impYn", label: "수입구분", align: "center", width: "8%"},
		        	{key: "addr", label: "착지주소", align: "left", width: "30%"},
		        	{key: "mngTel", label: "담당자연락처", align: "center", width: "10%"},
		        	{key: "dlvrDttm", label: "납기일자", align: "center", width: "10%"},
		        	{key: "ordrgRmk", label: "비고", align: "center", width: "10%"},
		        	{key: "salesMngNm", label: "발주담당자", align: "center", width: "10%"},
		        ]
		    });
			return this;
		}, 
		setData: function(_pageNo) {
			OD01Grid = this.target;
			var formData = {
				"prjctCd" : $("#prjctCd").val(),
				"pageNo" : _pageNo + 1, 
				"recordCnt" : $("#recordCnt").val()
			}
			postAjax("/user/od/od01/selectOrderList", formData, null, function(data){
				var list = data.resultList;
				OD01Grid.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
				if(OD01Grid.list.length == 0){
					$("#ordrgTable").hide();
				}else{
					$("#ordrgTotCnt").html(" (총 " + OD01Grid.list.length +"건)");
				}
			});
		}
	}

	function viewOrderModal() {
		openSecondModal("/static/html/user/od/od01/OD0102V01.html", 920, 780, " ");
	}
	
	var AR01Grid = null;
	var AR01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		        target: $('[data-ax5grid="AR01-grid"]'),
		        header: {
		        	align: "center",
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		                this.self.select(this.dindex); 
		            },
		            onDBLClick: function () {
		            	viewShipModal();
		            },
		        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	AR01GridView.setData(this.page.selectPage);
		            }
		        },
		        columns: [
		          	{key: "coNm", label: "회사", align: "center", width: "10%"},
		          	{key: "whNm", label: "창고", align: "center", width: "10%"},
		            {key: "clntNm", label: "거래처", align: "left", width: "16%"},
		            {key: "reqDt", label: "요청일자", align: "center", width: "10%"},
		        	{key: "dirtrsYn", label: "직송구분", align: "center", width: "10%"},
		        	{key: "dlvrDttm", label: "납기일시", align: "center", width: "10%"},
		        	{label: "출하요청",  columns:[
		          		{key: "shipTotQty", label: "수량", align: "right", width: "10%", formatter: "money" },
			          	{key: "shipTotWt", label: "중량", align: "right", width: "10%", formatter: "money" },
			          	{key: "shipTotAmt", label: "총금액", align: "right", width: "10%",formatter: "money" }
		          	]},
		          	{label: "실 출하",  columns:[
		          		{key: "realTotQty", label: "수량", align: "right", width: "8%", formatter: "money" },
			          	{key: "realTotWt", label: "중량", align: "right", width: "8%", formatter: "money" },
			          	{key: "realTotAmt", label: "총금액", align: "right", width: "10%", formatter: "money" }
		          	]},
		        	{key: "shipYn", label: "출하상태", align: "center", width: "10%"},
		        	{key: "shipDttm", label: "출하완료일", align: "center", width: "10%"},
		        	{key: "transAmt", label: "운송비", align: "right", width: "10%", formatter: "money"},
		        	{key: "odrCreatDiv", label: "오더구분", align: "center", width: "10%"},
		        ]
		    });
			return this;
		}, 
		setData: function(_pageNo) {
			AR01Grid = this.target;
			var formData = {
				"prjctCd" : $("#prjctCd").val(),
				"pageNo" : _pageNo + 1, 
				"recordCnt" : $("#recordCnt").val()
			}
			postAjax("/user/ar/ar01/selectShipList", formData, null, function(data){
				var list = data.resultList;
				AR01Grid.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
				if(AR01Grid.list.length == 0){
					$("#shipmentTable").hide();
				}else{
					$("#shipTotCnt").html(" (총 " + AR01Grid.list.length +"건)");
				}
			});
		}
	}
	
	function viewShipModal() {
		openSecondModal("/static/html/user/ar/ar01/AR0102V01.html", 920, 780, " ");
	}
	
	$(document).ready( function() {
		// 영역 접기/열기 이벤트 바인딩
		$('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		});
		fileGridView.initView();
		setCommonSelect($(".popup_area select[data-kind]"));
		$("#userId").val(jwt.userId);
		$("#coCd").val(jwt.coCd);
		if(actionType == "C") {
			document.getElementById('creatDttm2').value= new Date().toISOString().slice(0, 10);
			$('#prjctActionBtn').on("click", function(){insertOrder();});
			$("#prjctActionBtn").text("등록");
		}else if(actionType == "U"){
			$("#ordrgTable").show();
			$("#shipmentTable").show();
			OD01GridView.initView();
			AR01GridView.initView();
			selectPrjInfo();
			$('#prjctActionBtn').on("click", function(){updateOrder();});
			$('#prjctActionBtn').text("수정");
		}
	    $('#strtDt2').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
	    $('#endDt2').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		$("#prjctCd").val();
	});
	
	/* function initData(){
		var selectSelpchCd = document.getElementById("coCd");
		document.getElementById("coCd").innerHTML = selectSelpchCd.innerHTML;
	} */
	
	function selectPrjInfo(){
		var row = gridView.target.getList("selected")[0];
		var formData = {
			"prjctCd" : row.prjctCd,
			"salesMng" : row.mngId
		}
		postAjax("/user/sd/sd05/selectPrjInfo", formData, null, function(data){
			setPrjInfo(data.result);
		});
	}
	
	function setPrjInfo(obj){
		var fileInfo = obj.fileList;
		var prjInfo = obj.prjInfo;
		var ordDtl = obj.ordDetail;
		var shipmentDtl = obj.shipmentDetail;
		
		//메인정보 세팅
		$.each(prjInfo, function(key, value){
			$('#'+key).val(value);
		});
		//발주서 세팅
		OD01GridView.setData(0);
		//출하요청서
		AR01GridView.setData(0);
		
		$.each(fileInfo, function(idx, obj){
			fileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
		
	function addRow() {
		var row = $("#ordrgTable > tbody:last > tr:last").clone();
		$("#ordrgTable > tbody:last").append(row);
		//countTot();
	}
	
	function addRow2() {
		var row = $("#shipmentTable > tbody:last > tr:last").clone();
		$("#shipmentTable > tbody:last").append(row);
		//countTot();
	}
	
	function setDtlcoCd(params){
		$("#coCd").val(params.coCd);
		$("#salesMngNm").val(params.name);
		$("#salesMng").val(params.salesMng);
	}
	function setDtlclntCd(params){
		$("#makrCdDtl").val(params.clntNm);
	}
	
	function setDetailInfo(data){
		$.each(data, function(key, value){
			if(key == 'coCd'){
				$("#coCd").val(value).attr("selected", "selected");
			}
		});
		
	}
	//사용자 검색
	function openUserTree() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#salesMng').val(checkedNode.id);
			$('#salesMngNm').val(checkedNode.text);
		});
	}
	//거래처
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
		});
	}
	
	/*select box 선택시*/
	/* function commonCodeList(param){
		var codeSelect = document.getElementById("coCd");
		var codeId = codeSelect.options[codeSelect.selectedIndex].value;
	} */
	
	function insertOrder() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/sd/sd05/insertProject", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function updateOrder() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/sd/sd05/updateProject", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function makeFormData() {
		$("#userId").val(jwt.userId);
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		var formData = new FormData($("#popForm")[0]);
		
		
		// 첨부파일 추가
		$.each(fileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		if(actionType == "U") {
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		} 
		
		return formData;
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function setFileInfo(fileInfo) {
		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			fileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
	}
	
	function setFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var testArr = obj.name.split(".");
			fileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : testArr[testArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		fileGridView.setData();
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		fileGridView.target.removeRow(rowIndex);
		
		if(fileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(fileArr[rowIndex].fileKey);
		}
		fileArr.splice(rowIndex, 1);
		fileGridView.setData();
	}
	

</script>
</html>
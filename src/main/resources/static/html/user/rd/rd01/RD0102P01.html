<style>
	input[comma] {text-align: right;}
</style>
<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">제품입고</h4>
	</div>
	<div class="popup_table">
		<table>
			<colgroup>
				<col width="13%">
				<col width="">
				<col width="13%">
				<col width="">
				<col width="13%">
				<col width="">
			</colgroup>
			<tr>
				<th>회사</th>
				<td>
					<select id="coCd" data-kind="CO" disabled></select>
				</td>
				<th>판매유형</th>
				<td>
					<select id="typCd" data-kind="SELLTYPE" disabled></select>
				</td>
				<th>Maker</th>
				<td>
					<select id="makrCd" data-kind="MAKR" disabled></select>
				</td>
			</tr>
			<tr>
				<th>매입거래처</th>
				<td>
					<input type="text" id="clntNm" readonly> 
				</td>
				<th>재고주체</th>
				<td>
					<select id="ownerCd" data-kind="OWNER" disabled></select>
				</td>
				<th>운송비</th>
				<td>
					<input type="text" id="transAmt" readonly comma>
				</td>
			</tr>
			<tr>
				<th>입고창고</th>
				<td>
					<select id="whCd" data-kind="WH" disabled></select>
				</td>
				<th>수입여부</th>
				<td>
					<select id="impYn" disabled>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select>
				</td>
				<th>입고처리완료여부</th>
				<td>
					<select id="ordrgYn" disabled>
						<option value="Y">Y</option>
						<option value="N">N</option>
					</select>
				</td>
			</tr>
			<tr>
				<th>주문번호</th>
				<td>
					<input id="odrSeq" type="text" readonly>
				</td>
				<th>발주번호</th>
				<td>
					<input id="ordrgSeq" type="text" readonly>
				</td>
				<th>입고예정일자</th>
				<td>
					<input id="dlvrDttm" type="text" readonly>
				</td>
			</tr>
			<tr>
				<th>현장명</th>
				<td colspan="3">
					<input type="text" id="siteNm" readonly> 
				</td>
				<th>입고처리완료일자</th>
				<td>
					<input id="ordrgProcDttm" type="text" readonly>
				</td>
			</tr>
			<tr>
				<th>비고</th>
				<td colspan="5">
					<textarea class="form-control" id="ordrgRmk" style="height: 60px;" maxlength="500" readonly></textarea>
				</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 테이블 -->
	<div class="popup_table">
		<table id="detailTable">
			<colgroup>
				<col width="3%">
				<col width="20%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
			</colgroup>
			<tr>
				<td colspan="9" style="text-align: LEFT; border-right: 0;">※상세내역</td>
			</tr>
			<tr>
				<th></th>
				<th class="tc">제품명</th>
				<th class="tc">강종</th>
				<th class="tc">SPEC</th>
				<th class="tc">단위</th>
				<th class="tc">길이</th>
				<th class="tc">발주수량</th>
				<th class="tc">누적입고량</th>
				<th class="tc">입고예정량</th>
			</tr>
		</table>
		<table id="frameTable" style="display: none;">
			<tr name="detailRow">
				<input type="hidden" name="ordrgDtlSeq"> 
				<input type="hidden" name="ordrgUpr">
				<input type="hidden" name="realDlvrUpr">
				<input type="hidden" name="prdtCnvrsnWt"> 
				<td>
					<input type="checkbox" name="detailChkBox">
				</td>
				<td>
					<input type="text" name="prdtNm" readonly> 
				</td>
				<td>
					<input type="text" class="tc" name="prdtStkn" readonly>
				</td>
				<td>
					<input type="text" class="tc" name="prdtSpec" readonly>
				</td>
				<td>
					<input type="text" class="tc" name="prdtUnit" readonly>
				</td>
				<td>
					<input type="text" class="tr" name="prdtLen" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="ordrgQty" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="realDlvrQty" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="intendDlvrQty" onkeyup="onlyNumber(this); countTot();" comma>
				</td>
			</tr>
		</table>
		<table id="fixedTable" style="display: none;">
			<tr name="detailRow">
				<td>
					<input type="checkbox" name="detailChkBox" disabled>
				</td>
				<td>
					<input type="text" name="prdtNm" readonly> 
				</td>
				<td>
					<input type="text" class="tc" name="prdtStkn" readonly>
				</td>
				<td>
					<input type="text" class="tc" name="prdtSpec" readonly>
				</td>
				<td>
					<input type="text" class="tc" name="prdtUnit" readonly>
				</td>
				<td>
					<input type="text" class="tr" name="prdtLen" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="ordrgQty" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="realDlvrQty" comma readonly>
				</td>
				<td>
					<input type="text" class="tr" name="intendDlvrQty" comma readonly>
				</td>
			</tr>
		</table>
		<table>
			<colgroup>
				<col width="3%">
				<col width="20%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
				<col width="10%">
			</colgroup>
			<tr>
				<th class="tc" colspan="6">합계</th>
				<td class="tr" id="totOrdrgQty"></td>
				<td class="tr" id="totRealDlvrQty"></td>
				<td class="tr" id="totIntendDlvrQty"></td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 발주서 테이블 -->
	<div class="popup_table" id="ordrgTable" style="display: none;">
		<table>
			<thead>
				<tr>
					<td class="tl">발주서</td>
					<td class="tr">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tr>
				<td colspan="2">
					<div class="ax5_grid" data-ax5grid="ordrg-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 출하요청서 테이블 -->
	<div class="popup_table" id="shipTable" style="display: none;">
		<table>
			<thead>
				<tr>
					<td class="tl">출하요청서</td>
					<td class="tr">
						<a class="tbody_more_btn"></a>
					</td>
				</tr>
			</thead>
			<tr>
				<td colspan="2">
					<div class="ax5_grid" data-ax5grid="ship-grid" data-ax5grid-config="{}" style="height: 150px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<br>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button type="button" id="inBtn" onclick="inOutPrdt('in');" authchk>제품입고</button>
		<button type="button" id="outBtn" onclick="inOutPrdt('out');" authchk>입고취소</button>
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function() {
		// 공통코드 SelectBox set
		setCommonSelect($(".popup_area select[data-kind]"));
		selectOrderInfo();
		
		authChk("RD0101M01");
	});
	
	function selectOrderInfo() {
		var row = inRsltsGridView.target.getList("selected")[0];
		var paramObj = {"ordrgSeq": row.ordrgSeq, "reqDt": deleteHyphenStr(row.reqDt)};
		postAjax("/user/od/od01/selectOrdrgInfo", paramObj, null, function(data) {
			setOrderInfo(data.result);
		});
	}

	function setOrderInfo(result) {
		// 메인정보 세팅
		$.each(result.orderInfo, function(key, value) {
			if($('#'+key)[0]){
				if($('#'+key).is('[comma]')){
					value = addCommaStr(value);
				}
				$('#'+key).val(value);
			}
		});
		
		// 상세정보 세팅
		$.each(result.orderDetail, function(idx, obj) {
			var $addedRow = null;
			if(obj.ordrgYn == "N") {
				$addedRow = addDetailRow();
			} else {
				$addedRow = addFixedRow();
			}
			
			for(var i=0;i<$addedRow.find('[name]').length;i++){
				var detailItem = $addedRow.find('[name]')[i];
				var itemValue = obj[detailItem.name];
				if(itemValue){
					if($(detailItem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					detailItem.value = itemValue;
				}
			}
		});
		countTot();
		
		// 모든 상세내역이 입고완료일 경우 버튼 숨김 처리
		if(result.orderInfo.ordrgYn == "Y"){
			$('#inBtn').hide(); 
			$('#outBtn').hide();
		}
		
	}
	
	function addDetailRow(){
		var $detailRow = $('#frameTable tr[name="detailRow"]').clone();
		$('#detailTable tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function addFixedRow(){
		var $fixedRow = $('#fixedTable tr[name="detailRow"]').clone();
		$('#detailTable tbody').append($fixedRow[0]);
		return $fixedRow;
	}
	
	function countTot() {
		var totOrdrgQty = 0;
		var totRealDlvrQty = 0;
		var totIntendDlvrQty = 0;
		
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem) {
			var ordrgQty = $(elem).find("input[name='ordrgQty']").val();
			var realDlvrQty = $(elem).find("input[name='realDlvrQty']").val();
			var intendDlvrQty = $(elem).find("input[name='intendDlvrQty']").val();
			
			totOrdrgQty += Number(deleteCommaStr(ordrgQty));
			totRealDlvrQty += Number(deleteCommaStr(realDlvrQty));
			totIntendDlvrQty += Number(deleteCommaStr(intendDlvrQty));
		});
		
		$("#totOrdrgQty").text(addCommaStr(totOrdrgQty));
		$("#totRealDlvrQty").text(addCommaStr(totRealDlvrQty));
		$("#totIntendDlvrQty").text(addCommaStr(totIntendDlvrQty));
	}
	
	function inOutPrdt(inOutType){
		
		var detailRows = $('#detailTable tr[name="detailRow"]');
		if(detailRows.find('[name="detailChkBox"]:checked').length == 0){
			alert("선택된 제품이 없습니다.");
			return false;
		}
		
		var cfrmMsg = null;
		if(inOutType == "in") {
			cfrmMsg = "선택된 제품을 입고하시겠습니까?";
		} else if (inOutType == "out") {
			cfrmMsg = "선택된 제품의 입고를 취소하시겠습니까?";
		}
		if (!confirm(cfrmMsg)) return false;
		
		var ordrgObjArr = [];
		var isValid = true;
		$.each(detailRows, function(idx, elem){
			var ordrgObj = {};
			if($(elem).find('[name="detailChkBox"]').is(':checked')){
				var ordrgDtlSeq = $(elem).find('[name="ordrgDtlSeq"]').val();
				
				var realDlvrQty = Number(deleteCommaStr($(elem).find('[name="realDlvrQty"]').val()));
				var intendDlvrQty = Number(deleteCommaStr($(elem).find('[name="intendDlvrQty"]').val()));
				
				var prdtCnvrsnWt = Number($(elem).find('[name="prdtCnvrsnWt"]').val());
				var realDlvrWt = 0;
				
				var ordrgUpr = Number($(elem).find('[name="ordrgUpr"]').val());
				var realDlvrUpr = Number($(elem).find('[name="realDlvrUpr"]').val());
				var realDlvrAmt = 0;
				
				// 유효성 check
				if(inOutType == "in"){
					realDlvrQty = realDlvrQty + intendDlvrQty;
				}else if(inOutType == "out"){
					realDlvrQty = realDlvrQty - intendDlvrQty;
					if(realDlvrQty < 0){
						isValid = false;
						alert("누적입고량 보다 많은 수량을 취소할 수 없습니다.");
					}
				}
				
				// 실중량
				realDlvrWt = realDlvrQty * prdtCnvrsnWt;
				
				// 실납품금액
				if(realDlvrUpr){
					// 실납품단가가 있을때 (실납품금액 = 계산된 수량 * 실납품단가)
					realDlvrAmt = realDlvrQty * realDlvrUpr;
				}else{
					// 실납품단가가 없을때 (실납품금액 = 계산된 수량 * 발주단가)
					realDlvrAmt = realDlvrQty * ordrgUpr;
					// 실납품단 0일때 발주단가로 update
					realDlvrUpr = ordrgUpr;
				}
				
				ordrgObj.ordrgDtlSeq = ordrgDtlSeq;
				ordrgObj.realDlvrQty = realDlvrQty;
				ordrgObj.realDlvrWt = realDlvrWt;
				ordrgObj.realDlvrUpr = realDlvrUpr;
				ordrgObj.realDlvrAmt = realDlvrAmt;
				ordrgObj.userId = jwt.userId;
				ordrgObj.pgmId = "RD0102P01";
				ordrgObjArr.push(ordrgObj);
			}
		});
		
		if(isValid){
			putAjax("/user/rd/rd01/inOutPrdt", ordrgObjArr, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
						// grid set
						inRsltsDtlGridView.setData(0);
						
						if($(elem).find('[name="detailChkBox"]').is(":checked")){
							var ordrgQty = Number(deleteCommaStr($(elem).find('[name="ordrgQty"]').val()));
							var realDlvrQty = Number(deleteCommaStr($(elem).find('[name="realDlvrQty"]').val()));
							var intendDlvrQty = Number(deleteCommaStr($(elem).find('[name="intendDlvrQty"]').val()));
							
							if(inOutType == "in"){
								realDlvrQty = realDlvrQty + intendDlvrQty;
							} else if (inOutType == "out"){
								realDlvrQty = realDlvrQty - intendDlvrQty;
							}
							
							$(elem).find('[name="realDlvrQty"]').val(addCommaStr(realDlvrQty));
							$(elem).find('[name="intendDlvrQty"]').val(addCommaStr(ordrgQty-realDlvrQty));
						}
					});
					countTot();
				}
			});
		}
	}
</script>
<body>
  <div id="arViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">발주서 등록</h4>
    </div>
    <div class="popup_table">
    	<input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/>
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th class="hit">회사</th>
	                <td>                                
	                    <select id="coCd" name="coCd" data-kind="CO" msg="회사" required></select>
	                </td>
	                <th class="hit">판매유형</th>
	                <td>                                
	                    <select id="typCd" name="typCd" data-kind="SELLTYPE" msg="판매유형" required>
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	                <th class="hit">직송여부</th>
	                <td>                                
	                    <select id="dirtrsYn" name="dirtrsYn" onchange="setData();" msg="직송여부" required>
		                  	<option value="N" selected="selected">N</option>
		                  	<option value="Y" >Y</option>
		                </select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">매입거래처</th>
	                <td>     
	                    <input type="hidden" id="clntCd" name="clntCd">
	                    <div class="search_form">
	                    	<input type="text" id="clntNm" msg="매입거래처" readonly required>
	                    	<a onclick="openSecondClntSearch('PUR');">
	                    		<i class="i_search_w"></i>
	                    	</a>
	                    </div>
	                </td>
	                <th  class="hit">재고주체</th>
	                <td>   
	                	<select id="ownerCd" name="ownerCd" data-kind="OWNER" msg="재고주체" required>
	                        <option value="">선택</option> 
	                    </select>               
	                </td>
	                <th>매출거래처</th>
	                <td class="drctArea">
	                	<input type="hidden" id="sellClntCd" name="sellClntCd">                   
	                	<div class="search_form">
		                    <input type="text" id="sellClntNm" name="sellClntNm" readonly>
	                    	<button type="button" onclick="openSecondClntSearch('SELL');">
	                    		<i class="i_search_w"></i>
	                    	</button>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	            	<th class="hit">수입여부</th>
	                <td>
		                <select id="impYn" name="impYn" onchange="setMaker(this.value);" msg="수입여부" required>
		                  	<option value="N" selected>N</option>
		                  	<option value="Y" >Y</option>
		                </select>
	                </td>
	                <th class="hit">입고창고</th>
	                <td>                                
	                    <select id="whCd" name="whCd" data-kind="WH" onchange="setTaxivcCoprt();" msg="입고창고" required>
		                  	<option value="">선택</option> 
		                </select>
	                </td>
	                <th class="hit">계산서발행법인</th>
	                <td>
	                	<select id="taxivcCoprt" name="taxivcCoprt" data-kind="ESTCOPRT" msg="계산서발행법인" required>
	                		<option value="">선택</option> 
	                	</select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">Maker</th>
	                <td>                                
	                    <select id="makrCd" name="makrCd" data-kind="MAKR" msg="Maker" required></select>
	                </td>
	                <th>현장명</th>
	                <td>
	                	<div class="search_form">
			              <input type="hidden" id="siteCd" name="siteCd" value="0">
			              <input type="text" id="siteNm" name="siteNm" readonly>
	              		  <a onclick="openOdSiteSearch();">
	              			<i class="i_search_w"></i>
			              </a>
			            </div>	                
	                </td>
	                <th>판매지역</th>
	                <td class="drctArea">                                
	                    <select id="salesAreaCd" name="salesAreaCd" data-kind="SALESAREA">
	                        <option value="">선택</option> 
	                    </select>
	                </td>	                
	            </tr>
	            <tr>
	                <th>주문번호</th>
	                <td>     
	                	<div class="search_form">
		                    <input type="text" id="odrSeq" name="odrSeq" readonly>
	                    	<a onclick="openSecondOrderSearch();">
	                    		<i class="i_search_w"></i>
	                    	</a>
	                    </div>
	                </td>
	                <th>착지연락처</th>
	                <td>
	                	<input type="text" id="mngTel" name="mngTel">
	                </td>
	                <th class="hit">납기일자</th>
	                <td>
	                	<input type="text" id="dlvrDttm" name="dlvrDttm" class="input_calendar" autocomplete="off" msg="납기일자" required>
	                </td>
	            </tr>
	            <tr>
	                <th rowspan="2">착지 주소</th>
	                <td>
	                	<div class="search_form">
		                    <input type="text" id="addrZip" name="addrZip" readonly>
	                    	<a onclick="openDaumPostcode();">
	                    		<i class="i_search_w"></i>
	                    	</a>
	                    </div>
	                </td>
	                <th>운송비</th>
	                <td>    
	                	<div class="search_form"> 
	                    	<input type="text" id="transAmt" name="transAmt" onkeyup="addComma(this);" comma>
	                    	<a onclick="transAmtModal();">
	                    		<i class="i_search_w"></i>
	                    	</a>
	                    </div>
	                </td>
	                <th>영업담당자</th>
	                <td>                                
	                    <div class="search_form">
	                    	<input type="hidden" id="salesMng" name="salesMng">
		                    <input type="text" id="salesMngNm" name="salesMngNm" readonly>
	                    	<a onclick="openSecondUserSearch(this, 'sales');">
	                    		<i class="i_search_w"></i>
	                    	</a>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	                <td colspan="3" style="border-left: 0px !important;">
	                    <input type="text" id="addrMain" name="addrMain" placeholder="선택 주소지" readonly>
	                </td>
	                <td colspan="2">
	                	<input type="text" id="addrSub" name="addrSub" placeholder="상세 주소 입력">
	                </td>
	            </tr>
	            <tr>
	            	<th>비고</th>
	                <td colspan="5">     
	                    <textarea class="form-control" id="ordrgRmk" name="ordrgRmk" type="text" style="height: 60px;" maxlength="500"></textarea>
	                </td>
	            </tr>
	        </table>
	        <input type="hidden" id="userId" 	name="userId">
	        <input type="hidden" id="pgmId" 	name="pgmId" value="OD0102P01">
	        <input type="hidden" id="ordrgSeq" 	name="ordrgSeq">
	        <input type="hidden" id="reqDt" 	name="reqDt">
	        <input type="hidden" id="whClntCd"  name="whClntCd">     <!--재고주체가 자사인경우 거래처 창고의 거래처-->
	        <input type="hidden" id="prjctCd" 	name="prjctCd" value="0">
            <input type="hidden" id="prjctNm" 	name="prjctNm">
            <input type="hidden" id="totQty" 	name="totQty">
            <input type="hidden" id="totWt" 	name="totWt">
            <input type="hidden" id="totAmt" 	name="totAmt">
	    </form>
    </div>
    <br>
    <!-- 테이블 -->
    <div class="popup_table">
      <table>
        <tr>
          <td class="tl" colspan="2" border-right: 0; ">※상세내역</td>
          <td colspan="14">
            <div class="add_btn">
              <a onclick="addDetailRow();">+</a>
              <a onclick="removeDetailRow();">-</a>
            </div>
          </td>
        </tr>
      </table>
      <div class="ofx_s" style="width:100%;">
	      <table id="detailTb" style="width: 1800px;">
	        <colgroup>
				<col width="2%">
	        	<col width="7%">    <!-- 제품명 -->
	      		<col width="5%">    <!-- SIZE -->
	      		<col width="5%">    <!-- SPEC-->
	      		<col width="3%">    <!-- 길이 -->
	      		<col width="3%">    <!-- 단위 -->
	      		<col width="5%">    <!-- 발주지시 수량-->
	      		<col width="5%">	<!-- 발주지시 단가-->
	      		<col width="5%">	<!-- 매출 단가-->
	      		<col width="5%">	<!-- 발주지시 금액-->
	      		<col width="5%">	<!-- 발주지시 손익-->
	      		<col width="5%">    <!-- 완료일자 -->
	      		<col width="7%">   <!-- 지고 -->
	        </colgroup>
	        <tr>
	            <th class="tc"></th>
	            <th class="tc hit">제품명</th>
	            <th class="tc">사이즈</th>
	            <th class="tc">SPEC</th>
	            <th class="tc">길이</th>
	            <th class="tc">단위</th>
	            <th class="tc hit">수량</th>
	            <th class="tc">발주단가</th>
	            <th class="tc">매출단가</th>
	            <th class="tc">금액</th>
	            <th class="tc">예상손익</th>
	            <th class="tc">완료일자</th>
	            <th class="tc">비고</th>
	        </tr>
	        </table>
	        <table id="frameTable" style="display: none;">
	          <tr class="detailRow">
	          	<td>
					<input type="checkbox" name="detailChkBox">
				</td>
	            <td>
	              <input type="hidden" name="ordrgDtlSeq">
	              <input type="hidden" name="odrDtlSeq">
	              <input type="hidden" name="prdtCd">
	              <input type="hidden" name="prdtDiv">
	              <input type="hidden" name="prdtStkn">
	              <input type="hidden" name="prdtErqkYn">
	              <input type="hidden" name="prdtCoilYn">
	              <input type="hidden" name="pchsUpr">
	              <input type="hidden" name="sellUpr">
	              <input type="hidden" name="stockUpr">
	              <input type="hidden" name="prdtUpr">
	              <input type="hidden" name="prdtCnvrsnWt">
	              <input type="hidden" name="ordrgWt">
	              <input type="hidden" name="prdtStockCd">
	              <input type="hidden" name="ordrgYn">
	              <input type="hidden" name="ordrgProcId">
		          <input type="hidden" name="ordrgProcNm">
	              <div class="search_form"> 
	                <input type="text" name="prdtNm" msg="제품명" readonly required>
	              	<button type="button" onclick="openSecondPrdtSearch(this);">
	              		<i class="i_search_w"></i>
	              	</button>
	              </div>
	            </td>
	            <td>
	            	<input type="text" class="tc" name="prdtSize">
	            </td>
	            <td>
	            	<input type="text" class="tc" name="prdtSpec">
	            </td>
	            <td><input type="text" class="tr" name="prdtLen"></td>
	            <td>
	            	<input type="hidden" name="prdtUnit" readonly="readonly">
	            	<input type="text" class="tc" name="prdtUnitNm" readonly="readonly">
	            </td>
	            <td>
		            <input type="text" class="tr" name="ordrgQty" onkeyup="addComma(this); calOdrWt(this); countAmt(this);" msg="수량" required comma>
		        </td>
	            <td>
	            	<input type="text" class="tr" name="ordrgUpr" onkeyup="addComma(this); countAmt(this);" comma>
	            </td>
	            <td>
	            	<input type="text" class="tr" name="shipUpr" onkeyup="addComma(this); countAmt(this);" comma>
	            </td>
	            <td>
	            	<input type="text" class="tr" name="ordrgAmt" value="0" readonly="readonly" comma>
	            	<input type="hidden" name="realDlvrQty">
	            	<input type="hidden" name="realDlvrWt">
	            	<input type="hidden" name="realDlvrUpr">
	            	<input type="hidden" name="realDlvrAmt">
	            </td>
	            <td>
	            	<input type="text" class="tr" name="plAmt" value="0" readonly comma>
	            </td>
	            <td>
	            	<input type="text" class="tc" name="ordrgProcDttm" readonly>
	            </td>
	            <td>
	            	<input type="text" name="ordrgDtlRmk">
	            </td>
	          </tr>
	      </table>
	      <table style="width: 1800px;">
	      	<colgroup>
				<col width="2%">
	        	<col width="7%">    <!-- 제품명 -->
	      		<col width="5%">    <!-- SIZE -->
	      		<col width="5%">    <!-- SPEC-->
	      		<col width="3%">    <!-- 길이 -->
	      		<col width="3%">    <!-- 단위 -->
	      		<col width="5%">    <!-- 발주지시 수량-->
	      		<col width="5%">	<!-- 발주지시 단가-->
	      		<col width="5%">	<!-- 매출 단가-->
	      		<col width="5%">	<!-- 발주지시 금액-->
	      		<col width="5%">	<!-- 발주지시 손익-->
	      		<col width="5%">    <!-- 완료일자 -->
	      		<col width="7%">   <!-- 지고 -->
	        </colgroup>
	      	<tr>
	            <th class="tc" colspan="6">합계</th>
	            <td class="tr" id="totQtyDp" comma></td>
	            <td>-</td>
	            <td>-</td>
	            <td class="tr" id="totAmtDp" comma></td>
	            <td class="tr" id="totPlAmtDp" comma></td>
	            <td></td>
	            <td></td>
	        </tr>
	      </table>
      </div>
    </div>
    <br>
    <div class="popup_table">
      <table>
        <colgroup>
        	<col width="12%">
        </colgroup>
	  	<tr>
	  		<th>
	  			<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="file.click();">첨부파일</button>
	  		</th>
	  		<td>
	  			<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
	  		</td>
	  	</tr>
	  </table>
    </div>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionOdBtn">저장</button>
      <button class="close_btn" onclick="modal.close();">닫기</button>
    </div>
  </div>
 
</body>
<script type="text/javascript">
	//매입매출구분
	var clntType = null;
	var treeType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var targetRow = null;
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 405},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	                {
						key:"fileDelete", label: "삭제", width:60,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		fileGridView.initView();
		setCommonSelect($(".popup_area select[data-kind]"));
		$('#dlvrDttm, #ordrgProcDttm').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		setInit();
		$("#dirtrsYn").change();
		$("#coCd").val(jwt.coCd);
	});
	
	function setInit() {
		if(actionType == "C"){
			addDetailRow();
			setMaker($('#impYn').val());
			$("#makrCd").val("MAKR09");
			$('#actionOdBtn').on("click", function(){insertOrder();});
			$('#actionOdBtn').text("등록");
			$("#reqDt").val(dateToStr(new Date()).replace(/\-/g,''));
		}else if(actionType == "U"){
			selectOrderInfo();
			$('#actionOdBtn').on("click", function(){updateOrder();});
			$('#actionOdBtn').text("저장");
		}else if (actionType == "O"){
			getOrderInfo();
			$('#odrSeq').siblings('a').remove();
			$('#actionOdBtn').on("click", function(){insertOrder();});
			$('#actionOdBtn').text("등록");
		}
	}
	
	function selectOrderInfo() {
		var row = gridView.target.getList()[selectedRowIdx];
		var formData = {
			"ordrgSeq" : row.ordrgSeq,
			"reqDt" : row.reqDt.replace(/-/g, "")
		}
		postAjaxSync("/user/od/od01/selectOrderInfo", formData, null, function(data){
			setOrderInfo(data.result);
		});
	}
	
	function getOrderInfo(){
		var formData = {
			"odrSeq": odrSeq,
			"odrDtlSeqArr": odrDtlSeqArr
		};
		postAjaxSync("/user/od/od01/getOrderInfo", formData, null, function(data){
			setOrderInfo(data.result);
		});
	}
	
	function setOrderInfo(obj) {
		var fileInfo = obj.fileList;
		var orderInfo = obj.orderInfo;
		var orderDetail = obj.orderDetail;
		if(orderInfo.ordrgYn == "Y") {
			$("#actionOdBtn").hide();
		}
		
		//메인정보 세팅
		$.each(orderInfo, function(key, value){
			$('#'+key).val(value);
			
			// 제조사 set
			if(key == "impYn"){
				setMaker(value);
			}
		});
		
		//상세정보 세팅
		$.each(orderDetail, function(idx, item){
			addDetailRow();
			$.each(item, function(key, value){
				if($(".detailRow").find("input[name="+key+"]")[idx] != undefined) {
					$(".detailRow").find("input[name="+key+"]")[idx].value = value;
				} 
			});
			
			if(item.ordrgYn == "Y") {
				$($("input[name='detailChkBox']")[idx]).prop("checked", true);
				$($("input[name='detailChkBox']")[idx]).prop("disabled", true);
				$($(".detailRow")[idx]).find("input").prop("disabled", true);
				$($(".detailRow")[idx]).find("button").prop("disabled", true);
			} else {
				$($("input[name='detailChkBox']")[idx]).prop("disabled", false);
			}
			
			countTot();
			countAmt($("input[name=prdtUpr]")[idx]);
		});
		
		//콤마 추가
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		
		if(actionType != "O"){
			$.each(fileInfo, function(idx, obj){
				fileArr.push({
					'fileKey' : obj.fileKey,
			      	'fileName' : obj.fileName,
			      	'fileType' : obj.fileType,
			      	'fileSize' : obj.fileSize,
			      	'file' : obj
				});
			});
			// 첨부파일 그리드 set
			fileGridView.setData();
		}
	}
	
	// 제조사 set
	function setMaker(value){
		$('#makrCd').data("rprc", value);
		$('#makrCd').empty();
		setCommonSelect($('#makrCd'));
	}
	
	// 계산서발행법인 set
	function setTaxivcCoprt(){
		$('#taxivcCoprt').val($("#whCd option:selected").data("etc"));
	}
	
	function addDetailRow() {
		var $detailRow = $("#frameTable tr.detailRow").clone();
		if($("#dirtrsYn").val() == "N"){
			$detailRow.find('input[name="shipUpr"]').prop("readonly", true);
		}else{
			$detailRow.find('input[name="shipUpr"]').prop("readonly", false);
		}
		$('#detailTb tbody').append($detailRow[0]);
		// countTot(); 
	}
	
	function removeDetailRow(){
		var $checkedDetails = $('input:checkbox[name="detailChkBox"]:checked');
		$.each($checkedDetails, function(idx, elem){
			if($($("input[name='ordrgYn']")[idx]).val() == "" || $($("input[name='ordrgYn']")[idx]).val() == "N"){
				$(elem).closest('.detailRow').remove();
			}
		});
		countTot();
	}

	function setData() {
		if($("#dirtrsYn").val() == "N") {
			$(".drctArea input").prop("disabled", true);
			$(".drctArea input").val("");
			$(".drctArea select").prop("disabled", true);
			$(".drctArea select").val("");
			$(".drctArea button").prop("disabled", true);
			$(".drctArea select").val("");
			$(".drctArea #sellClntCd").val("");
			$(".drctArea #sellClntNm").val("");
			$('#detailTb tr.detailRow input[name="shipUpr"]').prop("readonly", true);
		} else {
			$(".drctArea input").prop("disabled", false);
			$(".drctArea select").prop("disabled", false);
			$(".drctArea button").prop("disabled", false);
			$('#detailTb tr.detailRow input[name="shipUpr"]').prop("readonly", false);
		}
		
		$.each($('#detailTb tr.detailRow'), function(idx, elem){
			countAmt(elem);
		});
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function setFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var tempArr = obj.name.split(".");
			fileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : tempArr[tempArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		fileGridView.setData();
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		fileGridView.target.removeRow(rowIndex);
		
		if(fileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(fileArr[rowIndex].fileKey);
		}
		
		fileArr.splice(rowIndex, 1);
		
		fileGridView.setData();
	}
	
	// 사용자 검색
	function openSecondUserSearch(elem, callFrom) {
		
		if(callFrom == "ordrg"){
			$targetRow = $(elem).closest('tr.detailRow');
		}
		
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $(elem).closest('div').find('input:hidden').val(),
			"useYn": "Y",
			"callFrom": callFrom
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			
			if(commonModal.paramObj.callFrom == "sales"){
				$('#salesMng').val(checkedNode.id);
				$('#salesMngNm').val(checkedNode.text);
			}else if(commonModal.paramObj.callFrom == 'ordrg'){
				$targetRow.find("input[name=ordrgProcId]").val(checkedNode.id);
				$targetRow.find("input[name=ordrgProcNm]").val(checkedNode.text);
			}
		});
	}
	
	function calOdrWt(elem){
		$targetRow = $(elem).closest('tr.detailRow');
		var ordrgQty = Number(deleteCommaStr($targetRow.find('input[name="ordrgQty"]').val()));
		var prdtCnvrsnWt = Number($targetRow.find('input[name="prdtCnvrsnWt"]').val());
		var ordrgWt = ordrgQty * prdtCnvrsnWt;
		$targetRow.find('input[name="ordrgWt"]').val(ordrgWt);
		$targetRow.find('input[name="realDlvrWt"]').val(ordrgWt);
	}
	
	function countAmt(elem) {
		$targetRow = $(elem).closest('tr.detailRow');
		var prdtStockCd = $targetRow.find('input[name="prdtStockCd"]').val();
		var ordrgQty = Number(deleteCommaStr($targetRow.find('input[name="ordrgQty"]').val()));
		var ordrgUpr = Number(deleteCommaStr($targetRow.find('input[name="ordrgUpr"]').val()));
		var shipUpr = Number(deleteCommaStr($targetRow.find('input[name="shipUpr"]').val()));
		var stockUpr = Number($targetRow.find('input[name="stockUpr"]').val());
		
		if(prdtStockCd == "Y") {
			$targetRow.find('input[name="ordrgAmt"]').val(addCommaStr(ordrgQty * ordrgUpr))
			if($('#dirtrsYn').val() == "Y"){
				// 직송여부가 Y일때 예상손익 : 매출단가 * 수량 - 매입단가(발주단가) * 수량
				$targetRow.find('input[name="plAmt"]').val(addCommaStr((ordrgQty * shipUpr) - (ordrgQty * ordrgUpr)));
			}else{
				// 직송여부가 N일때 예상손익 : 재고단가 * 수량 - 매입단가(발주단가) * 수량
				$targetRow.find('input[name="plAmt"]').val(addCommaStr((ordrgQty * stockUpr) - (ordrgQty * ordrgUpr)));
			}
		}else{
			$targetRow.find('input[name="ordrgAmt"]').val(addCommaStr(ordrgUpr));
		}
		
		$targetRow.find('input[name="realDlvrQty"]').val(ordrgQty);
		$targetRow.find('input[name="realDlvrUpr"]').val(ordrgUpr);
		$targetRow.find('input[name="realDlvrAmt"]').val(ordrgQty * ordrgUpr);
		
		countTot();
	}
	
	function countTot() {
		var totOrdrgQty = 0;
		var totOrdrgWt = 0;
		var totOrdrgAmt = 0;
		var totPlAmt = 0;
		
		$.each($("#detailTable .detailRow"), function(idx, item){
			var ordrgQty = Number(deleteCommaStr($(elem).find('input[name="ordrgQty"]').val()));
			var ordrgWt = Number($(elem).find('input[name="ordrgWt"]').val());
			var ordrgAmt = Number(deleteCommaStr($(elem).find('input[name="ordrgAmt"]').val()));
			var plAmt = Number(deleteCommaStr($(elem).find('input[name="plAmt"]').val()));
			
			totOrdrgQty += ordrgQty;
			totOrdrgWt += ordrgWt;
			totOrdrgAmt += ordrgAmt; 
			totPlAmt += plAmt; 
		});
		
		$('#totQty').val(totOrdrgQty);
		$('#totWt').val(totOrdrgWt);
		$('#totAmt').val(totOrdrgAmt);
		
		$('#totQtyDp').text(addCommaStr(totOrdrgQty));
		$('#totAmtDp').text(addCommaStr(totOrdrgAmt));
		$('#totPlAmtDp').text(addCommaStr(totPlAmt));
	}

	function updateConfirm() {
		if(inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/od/od01/updateConfirm", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function openSecondOrderSearch(){
		openSecondModal("/static/html/cmn/modal/orderSearch.html", 700, 420, "주문서 검색", {}, function(grid){
			var row = grid.target.getList("selected")[0];
			$("#odrSeq").val(row.odrSeq);
		});
	}

	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#addrZip').val(data.zonecode);
				$('#addrMain').val((data.roadAddress || data.address) + ' ' + data.buildingName);
			}
		}).open();
	}
	
	// 제품 검색
	function openSecondPrdtSearch(elem) {
		$targetRow = $(elem).closest('tr.detailRow');
		
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $("#coCd").val(),
			"selpchCd": "SELPCH1",
			"impYn": $("#impYn").val(), 
			"clntCd" : $("#clntCd").val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 600, 420, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$.each(row, function(key, value){
				if($targetRow.find('[name="'+key+'"]')[0]){
					$targetRow.find('[name="'+key+'"]').val(value);
				}
			});
			$targetRow.find('input[name=prdtUpr]').val(row.ordrgUpr);
			countTot();
		});
	}

	// 현장 검색
	function openOdSiteSearch() {
		var paramObj = {
			"coCd": $('#popForm #coCd').val(), 
			"clntCd": $("#popForm #sellClntCd").val(),
			"clntNm": $("#popForm #sellClntNm").val()
		}
		openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (tree){
			var row = tree.target.getList("selected")[0];
			$("#siteCd").val(row.siteCd);
			$("#siteNm").val(row.siteNm);
			$("#prjctCd").val(row.prjctCd);
			$("#prjctNm").val(row.prjctNm);
			$('#addrZip').val(row.siteAddrZip);
			$('#addrMain').val(row.siteAddr);
			$('#addrSub').val(row.siteAddrSub);
			$('#mngTel').val(row.telNo);
			$('#salesAreaCd').val(row.salesAreaCd);
			$('#sellClntCd').val(row.clntCd);
			$('#sellClntNm').val(row.clntNm);
			$('#salesMng').val(row.salesEmpId);
			$('#salesMngNm').val(row.salesEmpNm);
		});
	}

	function transAmtModal() {
		openFrom = "OD0102P01";
		openSecondModal("/static/html/user/ar/ar03/AR0301P01.html", 800, 450, "");
	}
	
	// 거래처 검색
	function openSecondClntSearch(type) {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			if(type == "PUR") {
				$('#clntCd').val(row.clntCd);
				$('#clntNm').val(row.clntNm);
			} else {
				$('#sellClntCd').val(row.clntCd);
				$('#sellClntNm').val(row.clntNm);
				
				//거래처 영업담당자 조회
				var paramObj = {
					"coCd": $('#coCd').val(),
					"clntCd": row.clntCd
				}					
				postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function(data) {			
					if(data.mngInfo != null) {
						$('#salesMng').val(data.mngInfo.salesEmpId);     // "kyungmi.kuan"
						$('#salesMngNm').val(data.mngInfo.salesEmpNm);	 //  "권경미"	  
					}
				});	
			}
		});
	}
	
	function insertOrder() {
		if(!lengthValidation()) return false;
		if(inputValidation($('.popup_area [required]').not('#frameTable [required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/od/od01/insertOrder", formData, function(data){
				debugger;
				alert(data.resultMessage);
				debugger;
				if(data.resultCode == 200){
					debugger;
					gridView.setData(0);
					debugger;
					modal.close();	
					debugger;
				}
				debugger;
			});
		}
	}
	
	function updateOrder() {
		if(!lengthValidation()) return false;
		if(inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/od/od01/updateOrder", formData, function(data){
				alert(data.resultMessage);    
				if(data.resultCode == 200){
					gridView.setData(0);
					viewOrderModal(selectedRowIdx);
					modal.close();
				}
			});
		}
	}
	
	function lengthValidation() {
		var isValid = true;
		$.each($("#detailTb tr.detailRow"), function(idx, elem){
			var prdtDiv = $(elem).find('input[name="prdtDiv"]').val();
			var prdtCoilYn = $(elem).find('input[name="prdtCoilYn"]').val();
			var prdtStockCd = $(elem).find('input[name="prdtStockCd"]').val();
			var prdtLen = $(elem).find('input[name="prdtLen"]').val();
			
			// 철근이면서 코일여부가 N이고 재고관리 대상이면 길이가 있어야 한다.
			if(prdtDiv == "PRDTDIV11" && prdtCoilYn == "N" && prdtStockCd == "Y" && (prdtLen == 0 || prdtLen == "")){
				isValid = false;
				alert("길이가 0인 제품이 존재합니다.");
				return false;
			}
		});
		return isValid;
	}
	
	function makeFormData() {
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		if($("#prjctCd").val() == "") $("#prjctCd").val("0");
		
		//콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		var formData = new FormData($("#popForm")[0]);
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#detailTb tr.detailRow'), function(idx, elem){
			if($(elem).find("input[name='ordrgYn']").val() == "N" || $(elem).find("input[name='ordrgYn']").val() == "") {
				var detailObj = {};
				$.each($(elem).find('[name]'), function(idx, elem){
					detailObj[elem.name] = elem.value;
				});
				detailArr.push(detailObj);
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		// 첨부파일 추가
		$.each(fileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		// 수정시 삭제된 파일 추가
		if(actionType == "U") {
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		
		return formData;
	}
</script>

<div id="odViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">발주서 조회</h4>
	</div>
	<div class="popup_table">
		<form id="popForm">
			<input type="hidden" id="pgmId" name="pgmId" value="OD0102V01">
			<input type="hidden" id="ordrgSeq" name="ordrgSeq">
			<input type="hidden" id="reqDt" name="reqDt">
			<input type="hidden" id="whClntCd" name="whClntCd">
			<!--재고주체가 자사인경우 거래처 창고의 거래처-->
			<input type="hidden" id="trspTypCd" name="trspTypCd" value="TRSPTYP1">
			<!--정상거래로 인식-->
			<input type="hidden" id="prjctCd" name="prjctCd"> 
			<input type="hidden" id="prjctNm" name="prjctNm">
			<table>
				<colgroup>
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
				</colgroup>
				<tr>
					<th>회사</th>
					<td>
						<input type="hidden" id="coCd" name="coCd">
						<input type="text" id="coNm" name="coNm" readonly>
					</td>
					<th>판매유형</th>
					<td>
						<input type="hidden" id="typCd" name="typCd">
						<input type="text" id="typNm" name="typNm" readonly>
					</td>
					<th>직송여부</th>
					<td>
						<input type="text" id="dirtrsYn" name="dirtrsYn" readonly>
					</td>
				</tr>
				<tr>
					<th>매입거래처</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd">
						<input type="text" id="clntNm" name="clntNm" readonly>
					</td>
					<th>재고주체</th>
					<td>
						<input type="hidden" id="ownerCd" name="ownerCd">
						<input type="text" id="ownerNm" name="ownerNm" readonly>
					</td>
					<th>매출거래처</th>
					<td>
						<input type="hidden" id="sellClntCd" name="sellClntCd">
						<input type="text" id="sellClntNm" name="sellClntNm" readonly>
					</td>
				</tr>
				<tr>
					<th>Maker</th>
					<td>
						<input type="hidden" id="makrCd" name="makrCd">
						<input type="text" id="makrNm" name="makrNm" readonly>
					</td>
					<th>입고창고</th>
					<td>
						<input type="hidden" id="whCd" name="whCd">
						<input type="text" id="whNm" name="whNm" readonly>
					</td>
					<th>계산서발행법인</th>
					<td>
						<input type="hidden" id="taxivcCoprt" name="taxivcCoprt">
						<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" readonly>
					</td>
				</tr>
				<tr>
					<th>수입여부</th>
					<td>
						<input type="text" id="impYn" name="impYn" readonly>
					</td>
					<th>현장명</th>
					<td>
						<input type="hidden" id="siteCd" name="siteCd">
						<input type="text" id="siteNm" name="siteNm" readonly>
					</td>
					<th>판매지역</th>
					<td>
						<input type="hidden" id="salesAreaCd" name="salesAreaCd">
						<input type="text" id="salesAreaNm" name="salesAreaNm" readonly>
					</td>
				</tr>
				<tr>
					<th>주문번호</th>
					<td>
						<input type="text" id="odrSeq" name="odrSeq" readonly>
					</td>
					<th>착지연락처</th>
					<td>
						<input type="text" id="mngTel" name="mngTel" readonly>
					</td>
					<th>납기일자</th>
					<td>
						<input type="text" id="dlvrDttm" name="dlvrDttm" readonly>
					</td>
				</tr>
				<tr>
					<th rowspan="2">착지 주소</th>
					<td>
						<input type="text" id="addrZip" name="addrZip" readonly>
					</td>
					<th>운송비</th>
					<td>
						<input type="text" id="transAmt" name="transAmt" comma readonly>
					</td>
					<th>영업담당자</th>
					<td>
						<input type="hidden" id="salesMng" name="salesMng">
						<input type="text" id="salesMngNm" name="salesMngNm" readonly>
					</td>
				</tr>
				<tr>
					<td colspan="3" style="border-left: 0px !important;">
						<input type="text" id="addrMain" name="addrMain" readonly>
					</td>
					<td colspan="2">
						<input type="text" id="addrSub" name="addrSub" readonly>
					</td>
				</tr>
				<tr>
					<th>비고</th>
					<td colspan="5">
						<textarea class="form-control" id="ordrgRmk" name="ordrgRmk" style="height: 60px;" maxlength="500" readonly></textarea>
					</td>
				</tr>
			</table>
		</form>
	</div>

	<br>
	<!-- 테이블 -->
	<div class="popup_table">
		<table>
			<tr>
				<td colspan="13" style="text-align: LEFT; border-right: 0;">※상세내역</td>
			</tr>
		</table>
		<div class="ofx_s" style="width: 100%;">
			<table id="detailTb" style="width: 1600px;">
				<colgroup>
					<col width="2%">
					<col width="15%"> <!-- 제품명 -->
					<col width="7%">  <!-- SIZE -->
					<col width="7%">  <!-- SPEC-->
					<col width="5%">  <!-- 길이 -->
					<col width="5%">  <!-- 단위 -->
					<col width="5%">  <!-- 발주지시 수량-->
					<col width="5%">  <!-- 발주지시 중량-->
					<col width="5%">  <!-- 발주지시 단가-->
					<col width="5%">  <!-- 매출 단가-->
					<col width="7%">  <!-- 발주지시 금액-->
					<col width="7%">  <!-- 발주지시 손익-->
					<col width="7%">  <!-- 완료일자 -->
					<col width="18%"> <!-- 비고 -->
				</colgroup>
				<tr>
					<th class="tc"></th>
					<th class="tc">제품명</th>
					<th class="tc">사이즈</th>
					<th class="tc">SPEC</th>
					<th class="tc">길이</th>
					<th class="tc">단위</th>
					<th class="tc">수량</th>
					<th class="tc">중량</th>
					<th class="tc">발주단가</th>
					<th class="tc">매출단가</th>
					<th class="tc">금액</th>
					<th class="tc">예상손익</th>
					<th class="tc">완료일자</th>
					<th class="tc">비고</th>
				</tr>
			</table>
			<table id="frameTable" style="display: none;">
				<tr class="detailRow">
					<input type="hidden" name="ordrgDtlSeq">
					<input type="hidden" name="odrDtlSeq"> 
					<input type="hidden" name="prdtDiv">
					<input type="hidden" name="prdtStkn">
					<input type="hidden" name="prdtErqkYn">
					<input type="hidden" name="prdtCoilYn">
					<input type="hidden" name="pchsUpr">
					<input type="hidden" name="sellUpr">
					<input type="hidden" name="stockUpr">
					<input type="hidden" name="prdtUpr">
					<input type="hidden" name="prdtCnvrsnWt">
					<input type="hidden" name="ordrgWt">
					<input type="hidden" name="prdtStockCd">
					<input type="hidden" name="ordrgYn">
					<input type="hidden" name="ordrgProcId">
					<input type="hidden" name="ordrgProcNm">
					<input type="hidden" name="realDlvrQty">
					<input type="hidden" name="realDlvrWt">
					<input type="hidden" name="realDlvrUpr">
					<input type="hidden" name="realDlvrAmt">
					<td>
						<input type="checkbox" name="detailChkBox">
					</td>
					<td>
						<input type="hidden" name="prdtCd">
						<input type="text" name="prdtNm" readonly>
					</td>
					<td>
						<input type="text" class="tc" name="prdtSize" readonly>
					</td>
					<td>
						<input type="text" class="tc" name="prdtSpec" readonly>
					</td>
					<td>
						<input type="text" class="tr" name="prdtLen" readonly>
					</td>
					<td>
						<input type="hidden" name="prdtUnit">
						<input type="text" class="tc" name="prdtUnitNm" readonly>
					</td>
					<td>
						<input type="text" class="tr" name="ordrgQty" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="ordrgWt" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="ordrgUpr" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="shipUpr" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="ordrgAmt" value="0" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="epctPal" value="0" readonly comma>
					</td>
					<td>
						<input type="text" class="tc" name="ordrgProcDttm" readonly>
					</td>
					<td>
						<input type="text" name="ordrgDtlRmk" readonly>
					</td>
				</tr>
			</table>
			<table style="width: 1600px;">
				<colgroup>
					<col width="2%">
					<col width="15%"> <!-- 제품명 -->
					<col width="7%">  <!-- SIZE -->
					<col width="7%">  <!-- SPEC-->
					<col width="5%">  <!-- 길이 -->
					<col width="5%">  <!-- 단위 -->
					<col width="5%">  <!-- 발주지시 수량-->
					<col width="5%">  <!-- 발주지시 중량-->
					<col width="5%">  <!-- 발주지시 단가-->
					<col width="5%">  <!-- 매출 단가-->
					<col width="7%">  <!-- 발주지시 금액-->
					<col width="7%">  <!-- 발주지시 손익-->
					<col width="7%">  <!-- 완료일자 -->
					<col width="18%"> <!-- 비고 -->
				</colgroup>
				<tr>
					<th class="tc" colspan="6">합계</th>
					<td class="tr" id="totQtyDp" comma></td>
					<td class="tr" id="totWtDp" comma></td>
					<td>-</td>
					<td>-</td>
					<td class="tr" id="totAmtDp" comma></td>
					<td class="tr" id="totEpctPalDp" comma></td>
					<td></td>
					<td></td>
				</tr>
			</table>
		</div>
	</div>
	<br>
	<div class="popup_table">
		<table>
			<colgroup>
				<col width="12%">
			</colgroup>
			<tr>
				<th>첨부파일</th>
				<td>
					<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionBtn"></button>
		<button id="ordrgYnBtn" style="display: none;" onclick="updateConfirm();">확정</button>
		<button id="cancelBtn" onclick="updateCancel();" style="background-color: red;">발주취소</button>
		<button class="close_btn" onclick="commonModal.closeTarget.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	var targetRow = null;
	var fileArr = [];
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            }
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 460},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		// 파일 그리드 초기화
		fileGridView.initView();
		
		selectOrderInfo();
		
		if(openFrom == "SD0502P01" || openFrom == "SD0402V01" || openFrom == "SD0402P01"){
			$("#actionBtn").hide();
			$("#ordrgYnBtn").hide();
		}else{
			$('#actionBtn').on("click", function(){updateOrderModal();});
			$('#actionBtn').text("수정");
			$("#ordrgYnBtn").show();
		}
	});
	
	function selectOrderInfo() {
		var row = null;
		if(openFrom == "SD0502P01"){
			row = OD01GridView.target.getList("selected")[0];
		}else if(openFrom == "SD0402V01" || openFrom == "SD0402P01"){
			row = ordrgGridView.target.getList("selected")[0];
		}else{
			row = gridView.target.getList()[selectedRowIdx];
		}
		
		var formData = {
			"ordrgSeq" : row.ordrgSeq
		}
		postAjax("/user/od/od01/selectOrderInfo", formData, null, function(data){
			setOrderInfo(data.result);
		});
	}
	
	function setOrderInfo(obj) {
		var fileInfo = obj.fileList;
		var orderInfo = obj.orderInfo;
		var orderDetail = obj.orderDetail;
		
		// 메인정보 세팅
		$.each(orderInfo, function(key, value){
			var itemValue = value;
			if($('#'+key).is('[comma]')){
				itemValue = addCommaStr(itemValue);
			}
			$('#'+key).val(itemValue);
		});
		
		// 상세정보 세팅
		$.each(orderDetail, function(idx, obj){
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
				}
			});
			
			if(obj.ordrgYn == "Y") {
				$addedRow.find('input[name="detailChkBox"]').prop("checked", true);
				$addedRow.find('input[name="detailChkBox"]').prop("disabled", true);
			}
		});
		countTot();
		
		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			fileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// 확정된 상세가 없을경우 취소버튼 hide
		if(orderInfo.confirmCnt == 0){
			$("#cancelBtn").hide();
		}
		
		// 전체 발주확정시 확정 및 수정버튼 hide
		if(orderInfo.ordrgYn == "Y") {
			$("#ordrgYnBtn").hide();
			$("#actionBtn").hide();
		}
	}
	
	function addDetailRow() {
		var $detailRow = $("#frameTable tr.detailRow").clone();
		$('#detailTb tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function countTot() {
		var totOrdrgQty = 0;
		var totOrdrgWt = 0;
		var totOrdrgAmt = 0;
		var totEpctPal = 0;
		
		$.each($("#detailTb tr.detailRow"), function(idx, elem){
			var ordrgQty = Number(deleteCommaStr($(elem).find('input[name="ordrgQty"]').val()));
			var ordrgWt = Number(deleteCommaStr($(elem).find('input[name="ordrgWt"]').val()));
			var ordrgAmt = Number(deleteCommaStr($(elem).find('input[name="ordrgAmt"]').val()));
			var epctPal = Number(deleteCommaStr($(elem).find('input[name="epctPal"]').val()));
			
			totOrdrgQty += ordrgQty;
			totOrdrgWt += ordrgWt;
			totOrdrgAmt += ordrgAmt; 
			totEpctPal += epctPal; 
		});
		
		$('#totQtyDp').text(addCommaStr(totOrdrgQty));
		$('#totWtDp').text(addCommaStr(totOrdrgWt));
		$('#totAmtDp').text(addCommaStr(totOrdrgAmt));
		$('#totEpctPalDp').text(addCommaStr(totEpctPal));
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}

	function updateConfirm() {
		var checkCount = 0;
		$.each($('#detailTb tr.detailRow'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='ordrgYn']").val() == "N") {
				checkCount++;
			}
		});
		if(checkCount == 0){
			alert("발주내역을 선택해주세요");
			return;
		}
		
		var formData = makeFormData('CONFIRM');
		filePutAjax("/user/od/od01/updateConfirm", formData, function(data){
			alert(data.resultMessage);           
			if(data.resultCode == 200){
				gridView.setData(0);
				modal.close();
			}
		});
	}
	
	function updateCancel() {
		var checkCount = 0;
		$.each($('#detailTb tr.detailRow'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='ordrgYn']").val() == "Y") {
				checkCount++;
			}
		});
		if(checkCount == 0){
			alert("확정 건이 존재하지 않습니다.");
			return;
		}
		
		var formData = makeFormData('CANCEL');
		filePutAjax("/user/od/od01/updateCancel", formData, function(data){
			alert(data.resultMessage);
			if(data.resultCode == 200) {
				gridView.setData(0);
				modal.close();
			}
		});
	}
	
	function makeFormData(type) {
		//콤마 제거
		$.each($('.popup_area input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#detailTb tr.detailRow'), function(idx, elem){
			if(type == "CONFIRM") {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='ordrgYn']").val() == "N") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						if(elem.name == "ordrgProcId" && elem.value == "") elem.value = jwt.userId;
						if(elem.name == "ordrgProcNm" && elem.value == "") elem.value = jwt.userNm;
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			} else {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='ordrgYn']").val() == "Y") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}
</script>
<body>
  <div id="arViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="popup_table">
    	<input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/>
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="15%">
	                <col width="">
	                <col width="15%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th class="hit">거래처</th>
	                <td>                             
	                    <input type="hidden" id="clntCd" name="clntCd">
		                <div class="search_form">
			                <input type="text" id="clntNm" name="clntNm">
			              	<a onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	                <th class="hit">회사</th>
	                <td>                                
	                    <select id="coCd" name="coCd" data-kind="CO"  onchange="setCodeSelectByCocd(this.value);">
	                 	</select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">판매법인</th>
	                <td>                             
	                    <select id="estCoprt" name="estCoprt" data-kind="ESTCOPRT" required="required" msg="판매법인">
<!-- 	                    	<option value="">선택</option>  -->
	                 	</select>
	                </td>
	                <th class="hit">거래유형</th>
	                <td>                             
	                    <select id="trspTypCd" name="trspTypCd" data-kind="TRSPTYP" required="required"  msg="거래유형">
	                    	<option value="">선택</option> 
	                 	</select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">매입일자</th>
	                <td>                             
	                    <input type="text" id="trstDt" name="trstDt" class="input_calendar" required="required"  msg="매입일자">
	                </td>
	                <th>수입여부</th>
	                <td>                             
	                    <select id="impYn" name="impYn" required="required">
		                  	<option value="N" selected="selected">N</option>
		                  	<option value="Y" >Y</option>
		                </select>
	                </td>
                
	            </tr>
	            <tr>
	                <th class="hit">판매유형</th>
	                <td>                             
	                    <select id="typCd" name="typCd" data-kind="SELLTYPE" onchange="setBySellType(this.value);" required="required" msg="판매유형">
<!-- 	                        <option value="">선택</option>  -->
	                    </select>
	                </td>
 	                <th>메이커</th>
	                <td>                                
	                    <select id="makrCd" name="makrCd" data-kind="MAKR" required="required" msg="메이커">
	                    </select>
	                </td>   
	            </tr>
	            <tr>
	                <th>재고주체</th>
	                <td>   
	                	<select id="ownerCd" name="ownerCd" data-kind="OWNER" required="required" msg="재고주체">
	                    </select>               
	                </td>
  	                <th>담당자연락처</th>
	                <td>                                
	                    <input type="text" id="mngTel" name="mngTel" style="width: 100%;" onkeyup="telNumberFormatter(this);" maxlength=13>
	                </td>	

	            </tr>
	            <tr>

	                <th class="hit">창고</th>
	                <td>                                
	                    <select id="whCd" name="whCd" data-kind="WH" required="required" msg="창고">
<!-- 		                  	<option value="">선택</option>  -->
		                </select>
	                </td>	                
	                <th>현장</th>
	                <td>                             
	                    <div class="search_form">
			              <input type="hidden" id="prjctCd" name="prjctCd" value="0">		              
			              <input type="hidden" id="siteCd" name="siteCd" value="0">
			              <input type="text" id="siteNm" name="siteNm" readonly="readonly">			              
			              <a onclick="openSecondSiteSearch();"><i class="i_search_w"></i></a>
			            </div>
	                </td>	
	            </tr>
	            <tr>
	                <th>제품명</th>
	                <td>                                
	                    <div class="search_form">
	                    	<input type="hidden" name="prdtCd">
	                    	<input type="hidden" name="prdtUnit">
	                    	<input type="hidden" name="prdtCnvrsnWt">
	                    	<input type="hidden" name="prdtStockCd">
	                        <input type="hidden" name="prdtDiv">
	                        <input type="hidden" name="prdtDivNm">
	                        <input type="hidden" name="prdtStkn">
	                        <input type="hidden" name="prdtStknNm">
	                    	<input type="hidden" name="dirtrsYn" value="N">
			                <input type="text" name="prdtNm" readonly="readonly" required="required"   msg="제품명">
			              	<a onclick="openSecondPrdtSearch(this);"><i class="i_search_w"></i></a>
			            </div>
	                </td>	            
<!--	                <th>제품구분</th>
	                <td>                             
	                    <input type="hidden" name="prdtDiv" readonly="readonly">
	                    <input type="text" name="prdtDivNm" readonly="readonly">
	                </td>
-->	                <th>사이즈</th>
	                <td>                                
	                    <input type="hidden" name="prdtSizeNm" readonly="readonly">
	                    <input type="text" name="prdtSize">
	                </td>
	            </tr>
	            <tr>
	                <th>SPEC</th>
	                <td>                                
	                    <input type="text" name="prdtSpec">
	                </td>
	                <th>길이</th>
	                <td>                             
	                    <input type="text" name="prdtLen" onkeyup="onlyNumber(this);" comma>
	                </td>
	            </tr>
	            <tr>
	                <th id="bilgHit" class="hit">매입수량</th>
	                <td>                     
	                	<input type="hidden" name="realTrstQty" readonly="readonly">        
	                    <input type="text" name="bilgQty" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" required comma minus>
	                </td>
	                <th>매입중량</th>
	                <td>                                
	                	<input type="hidden" name="realTrstWt" readonly="readonly">
	                    <input type="text" name="bilgWt" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" required comma minus>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">매입단가</th>
	                <td>                             
	                	<input type="hidden" name="realTrstUpr" readonly="readonly">
	                    <input type="text" name="bilgUpr" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" required comma  msg="매입단가">
	                </td>
	                <th>제품기준단가</th>
	                <td>                                
	                    <input type="text" name="prdtUpr" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" required comma  msg="제품기준단가">
	                </td>
	            </tr>
	            <tr>
	            	<th>할인금액</th>
	                <td>                             
	                    <input type="text" name="trstDcAmt" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" comma minus value="0">
	                </td>
	                <th>운송비</th>
	                <td>                             
	                    <div class="search_form"> 
	                    	<input id="transAmt" name="transAmt" type="text" style="text-align: right; width: 88% !important; margin-left: -23px;" onkeyup="onlyNumber(this);countAmt(this);" comma >
	                    	<a onclick="transAmtModal();"><i class="i_search_w"></i></a>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	            	<th>기타금액</th>
	                <td>                             
	                    <input type="text" name="etcAmt" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" comma minus value="0">
	                </td>
	                <th class="hit">영업담당</th>
	                <td>                                
	                    <input type="hidden" id="salesMng" name="salesMng" style="width: 76%;">
	                    <div class="search_form">
		                    <input type="text" id="salesMngNm" name="salesMngNm" readonly="readonly" style="text-align: center;">
	                    	<a onclick="openSecondUserSearch();"><i class="i_search_w"></i></a>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	                <th>매입금액</th>
	                <td>                             
	                	<input type="hidden" name="realTrstAmt" readonly="readonly" minus>
	                    <input type="text" name="bilgAmt" style="text-align: right;" onkeyup="onlyNumber(this);countAmt(this);" required comma minus  msg="매입금액">
	                </td>
	                <th>전표발행여부</th>
	                <td>                                
	                    <input type="text" name="bilgYn" style="text-align: center;" readonly="readonly" value="N">
	                </td>
	            </tr>
	            <tr>  
	                <th>비고</th>
	                <td colspan="3">                             
	                    <textarea class="form-control" id="trspRmk" name="trspRmk" type="text" style="height: 60px;" maxlength="500"></textarea>
	                </td>
	            </tr>
	        </table>
	        <input type="hidden" id="selpchCd" name="selpchCd" value="SELPCH1">
	        <input type="hidden" id="stockChgCd" name="stockChgCd" value="STOCKCHG01">
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId" name="pgmId" value="OD0202P01">
	        <input type="hidden" id="trstQty" name="trstQty">
	        <input type="hidden" id="trstUpr" name="trstUpr">
	        <input type="hidden" id="trstWt" name="trstWt">
	        <input type="hidden" id="trstAmt" name="trstAmt">
	    </form>
    </div>
    <br>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionOdBtn">등록</button>
      <button class="close_btn" onclick="modal.close();">닫기</button>
    </div>
  </div>
 
</body>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$('#trstDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		setInit();
	});
	
	function setInit() {		
		if(actionType == "C"){
			$('#actionOdBtn').on("click", function(){insertPchsSell();});
			$('#actionOdBtn').text("등록");
			$("input[name='rjctTransAmt']").prop("disabled", true);
			$("#ownerCd").val("OWNER1");
			$("#makrCd").val("MAKR09");
			$("#trspTypCd").val("TRSPTYP1");
			$("#trstDcAmt").val("0");
			$("#etcAmt").val("0");;
			selectSellInfoBase();
			setCodeSelectByCocd($("#coCd").val())
		}else if(actionType == "U"){
			selectSellInfo();
			$('#actionOdBtn').on("click", function(){insertPchsSell();});
			$('#actionOdBtn').text("저장");
		}else if(actionType == "O"){
			getOrderInfo();
			$('#actionOdBtn').on("click", function(){insertShip();});
			$('#actionOdBtn').text("등록");
		}
	}
	
	function selectSellInfo() {
		var row = subGridView.target.getList("selected")[0];
		var formData = {
			"trstCertiNo" : row.trstCertiNo
		}
		$("#coCd").val(row.coCd);
		setCodeSelectByCocd($("#coCd").val());
		postAjax("/user/ar/ar02/selectSellInfo", formData, null, function(data){
			setSellInfo(data.result);
		});
	}
	
	function setSellInfo(obj) {
		//메인정보 세팅
		$.each(obj, function(key, value){
			$("input[name="+key+"]").val(value);
			$("#"+key).val(value);
		});
		
		// 반품의 경우 직송여부 'N'
		$("dirtrsYn").val("N");
		
		//재고사유 반품등록 세팅
		var stockChgCd = Math.sign($("input[name=bilgQty]").val()) == -1 ? "STOCKCHG10" : "STOCKCHG03";
		$("#stockChgCd").val(stockChgCd);
		
		//마이너스 값으로 변경
		$.each($('input[minus]'), function(idx, elem){
			if(elem.value != "0") {
				elem.value = Number(elem.value) * -1;	
			}
		});
		
		// 운반비는 제거 .. 운송비는 (-) 발생하지 않음
		$("#transAmt").val(0);  
			
		//콤마 추가
		$.each($('input[comma]'), function(idx, elem){
			onlyNumber(elem);
		});
	}
	
	function selectSellInfoBase() {
	
    	var row = subGridView.target.getList("selected");
		if(row.length == 0){
			row = subGridView.target.getList();
		}
		$("#coCd").val(row[0].coCd); 
		$("#clntCd").val(row[0].trstClntCd); 
		$("#clntNm").val(row[0].clntNm); 
		$("#estCoprt").val(row[0].taxivcCoprt); 
		$("#trstDt").val(dateToStr(new Date()));
		$("#siteCd").val(row[0].siteCd);
		$("#siteNm").val(row[0].siteNm);
		$("#prjctCd").val(row[0].prjctCd);
	}
		
	// 제품 검색
	function openSecondPrdtSearch(elem) {
		$targetRow = $(elem).closest('tr.detailRow');
		
		// selpchCd - SELPCH1: 매입
		var paramObj = {
			"selpchCd": "SELPCH1",
			"impYn": $("#impYn").val(), 
			"clntCd" : $("#clntCd").val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$.each(row, function(key, value){
				if($("input[name="+key+"]") != undefined)
					$("input[name="+key+"]").val(value);
			});
			$('input[name="prdtUpr"]').val(row.ordrgUpr);
			$('input[name="bilgUpr"]').val(row.ordrgUpr);
			if(row.prdtStockCd == "N") {
				$('input[name="prdtSizeNm"]').prop("readonly", true);
				$('input[name="prdtSpec"]').prop("readonly", true);
				$('input[name="prdtLen"]').prop("readonly", true);
				$('input[name="bilgQty"]').prop("readonly", true);
				$('input[name="bilgQty"]').val("0");
				$('input[name="bilgAmt"]').val(row.ordrgUpr);
				$("#bilgHit").removeClass();
			} else {
				$('input[name="prdtSizeNm"]').prop("readonly", false);
				$('input[name="prdtSpec"]').prop("readonly", false);
				$('input[name="prdtLen"]').prop("readonly", false);
				$('input[name="bilgQty"]').prop("readonly", false);
				$('input[name="bilgUpr"]').val(row.ordrgUpr);
				$("#bilgHit").addClass("hit");
			}
		});
	}
	
	function makeFormData() {
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		$("#trstDt").val($("#trstDt").val().replace(/-/g, ""));
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		$("input[name='realTrstQty']").val($("input[name='bilgQty']").val()); 
		$("input[name='realTrstUpr']").val($("input[name='bilgUpr']").val()); 
		$("input[name='realTrstWt']").val($("input[name='bilgWt']").val());
		$("input[name='trstQty']").val($("input[name='realTrstQty']").val()); 
		$("input[name='trstUpr']").val($("input[name='realTrstUpr']").val()); 
		$("input[name='trstWt']").val($("input[name='realTrstWt']").val()); 
		$("input[name='trstAmt']").val($("input[name='realTrstAmt']").val());
		var formData = $("#popForm").serializeObject();
		
		return formData;
	}
	
	function insertPchsSell() {
		debugger;
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			postAjax("/user/ar/ar02/insertPchsSell", formData, null, function(data){
				alert(data.resultMessage);
				if (data.resultCode == 200) {
					subGridView.setData(0);
					modal.close();
				}
			});
		}
	}
	
	// 사용자 검색
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : "GUM", // $('#coCd').val(),
			"userId": $('#salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#salesMng').val(checkedNode.id);
			$('#salesMngNm').val(checkedNode.text);
		});
	}
	
	function countAmt(el) {
		var bilgQty = $("input[name='bilgQty']").val();
		var bilgUpr = $("input[name='bilgUpr']").val();
		var trstDcAmt = $("input[name='trstDcAmt']").val();
		var prdtCnvrsnWt = $("input[name='prdtCnvrsnWt']").val();
		var prdtStockCd  = $("input[name='prdtStockCd']").val();
		
		if(prdtStockCd == "N") {
			$("input[name='bilgWt']")[0].value = deleteCommaStr(bilgQty);
			$("input[name='bilgAmt']")[0].value = deleteCommaStr(bilgUpr) - deleteCommaStr(trstDcAmt);
			$("input[name='realTrstAmt']")[0].value = deleteCommaStr(bilgUpr);
		} else {
			$("input[name='bilgWt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(prdtCnvrsnWt)));
			$("input[name='bilgAmt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(bilgUpr) - deleteCommaStr(trstDcAmt)));
			$("input[name='realTrstAmt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(bilgUpr)));
		}
		
		if($("input[name='bilgQty']").val().length>2){
			onlyNumber($("input[name='bilgQty']"));	
		}
		onlyNumber($("input[name='bilgWt']"));
		onlyNumber($("input[name='bilgAmt']"));
	}

	function transAmtModal() {
		openFrom = "OD0202P01";
//		openSecondModal("/static/html/user/ar/ar03/AR0301P01.html", 800, 450, "");
		
		 var clntCd = $("#clntCd").val();
	     var clntNm = $("#clntNm").val();
	     var whCd = $("#whCd").val();

    	 var url = "/static/html/user/ar/ar03/AR0301M01.html?clntCd=" + clntCd + "&clntNm=" + clntNm+ "&whCd=" + whCd;
    	 var win = window.open(url, '_blank');
         win.focus();
	}
	
	// 코드 set
	function setCodeSelectByCocd(value){

			$('#whCd').data("desc", value);
			$('#whCd option:not([value=""])').remove()
			setCommonSelect($('#whCd'));  

			$('#estCoprt').data("rprc", value);
			$('#estCoprt option:not([value=""])').remove()
			setCommonSelect($('#estCoprt'));  
	}
	
	// 현장 검색
	function openSecondSiteSearch(type) {
		var paramObj = {
			"coCd"  : $('#popForm #coCd').val()
// 	매입은 거래처가 필요 없음.		, 
// 			"clntCd": $("#popForm #clntCd").val(),
// 			"clntNm": $("#popForm #clntNm").val()
		}
		openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (tree){
			var row = tree.target.getList("selected")[0];
				$("#siteCd").val(row.siteCd);
				$("#siteNm").val(row.siteNm);
				$("#prjctCd").val(row.prjctCd);
		});
	}
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);	
		});
	}	
	function setBySellType(value){
		// 판매유형
		// SELLTYPE1: 유통
		// SELLTYPE2: 가공
		// SELLTYPE4: 임가공
		
		// 재고주체
		// OWNER1: 자사
		// OWNER2: 제강사
		// OWNER3: 건설사
		// OWNER4: 기타
		
		if(value == "" || value == "SELLTYPE1" || value == "SELLTYPE2"){
		// 판매유형이 선택, 유통, 가공일때
			
			// 재고주체 초기화
			$('#ownerCd option:not([value=""])').remove();
			setCommonSelect($('#ownerCd'));
			
			if(value == ""){
			// 판매유형이 선택일때
				// 재고주체 활성화
				$('#ownerCd').prop("disabled", false);
			}else if(value == "SELLTYPE1" || value == "SELLTYPE2"){
			// 판매유형이 유통, 가공일때
				// 재고주체 자사 set, 비활성화
				$('#ownerCd').val("OWNER1");
				$('#ownerCd').prop("disabled", true);
			}
		}else if(value == "SELLTYPE4"){
		// 판매유형이 임가공일때
			// 재고주체에서 자사 삭제
			$('#ownerCd option[value="OWNER1"]').remove();
			$('#ownerCd').prop("disabled", false);
		}
	}
		
</script>

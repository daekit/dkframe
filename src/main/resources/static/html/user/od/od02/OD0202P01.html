<div id="arViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="popup_table">
		<form id="popForm">
			<table>
				<colgroup>
					<col width="15%">
					<col width="">
					<col width="15%">
					<col width="">
				</colgroup>
				<tr>
					<th class="hit">거래처</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="clntCd" name="clntCd" msg="거래처" required>
							<input type="text" id="clntNm" name="clntNm"> 
							<a onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th class="hit">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" onchange="setByCocd(this.value);" msg="회사" required></select>
					</td>
				</tr>
				<tr>
					<th class="hit">매입법인</th>
					<td>
						<select id="taxivcCoprt" name="taxivcCoprt" data-kind="ESTCOPRT" msg="판매법인" required></select>
					</td>
					<th class="hit">거래유형</th>
					<td>
						<select id="trspTypCd" name="trspTypCd" data-kind="TRSPTYP" msg="거래유형" required></select>
					</td>
				</tr>
				<tr>
					<th class="hit">매입일자</th>
					<td>
						<input type="text" class="input_calendar" id="trstDt" name="trstDt" autocomplete="off" msg="매입일자" required>
					</td>
					<th>수입여부</th>
					<td>
						<select id="impYn" name="impYn">
							<option value="N" selected>N</option>
							<option value="Y">Y</option>
						</select>
					</td>
				</tr>
				<tr>
					<th class="hit">판매유형</th>
					<td>
						<select id="typCd" name="typCd" data-kind="SELLTYPE" onchange="setBySellType(this.value);" msg="판매유형" required></select>
					</td>
					<th>메이커</th>
					<td>
						<select id="makrCd" name="makrCd" data-kind="MAKR"></select>
					</td>
				</tr>
				<tr>
					<th>재고주체</th>
					<td>
						<select id="ownerCd" name="ownerCd" data-kind="OWNER"></select>
					</td>
					<th class="hit">영업담당</th>
					<td>
						<input type="hidden" id="salesMng" name="salesMng">
						<div class="search_form">
							<input type="text" id="salesMngNm" name="salesMngNm" msg="영업담당" readonly required>
							<a onclick="openSecondUserSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				<tr>

					<th class="hit">창고</th>
					<td>
						<select id="whCd" name="whCd" data-kind="WH" msg="창고" required></select>
					</td>
					<th>현장</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="prjctCd" name="prjctCd" value="0">
							<input type="hidden" id="siteCd" name="siteCd" value="0">
							<input type="text" id="siteNm" name="siteNm" onkeyup="if(event.keyCode == 8){prjctCd.value = '0'; siteCd.value = '0'; this.value = '';}">
							<a onclick="openSecondSiteSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				<tr>
					<th></th>
					<td></td>
					<th>담당자연락처</th>
					<td>
						<input type="text" id="mngTel" name="mngTel" onkeyup="telNumberFormatter(this);" maxlength="13">
					</td>
				</tr>
				<tr>
					<th class="hit">제품명</th>
					<td>
						<input type="hidden" name="prdtCd">
						<input type="hidden" name="prdtGrp">
						<input type="hidden" name="prdtUnit">
						<input type="hidden" name="prdtCnvrsnWt">
						<input type="hidden" name="prdtStockCd">
						<input type="hidden" name="prdtDiv">
						<input type="hidden" name="prdtDivNm"> 
						<input type="hidden" name="prdtStkn"> 
						<input type="hidden" name="prdtStknNm"> 
						<input type="hidden" name="dirtrsYn" value="N">
						<div class="prdtSearch">
							<div class="search_form">
								<input type="text" name="prdtNm" msg="제품명" readonly required> 
								<a onclick="openSecondPrdtSearch(this);"><i class="i_search_w"></i></a>
							</div>
						</div>	
					</td>
					<th>사이즈</th>
					<td>
						<input type="hidden" name="prdtSizeNm">
						<input type="text" class="tr" name="prdtSize">
					</td>
				</tr>
				<tr>
					<th>SPEC</th>
					<td>
						<input type="text" class="tr" name="prdtSpec">
					</td>
					<th>길이</th>
					<td>
						<input type="hidden" id="mngPrdtLen" name="mngPrdtLen">
						<input type="text" class="tr" name="prdtLen" value="0" onkeyup="onlyPositive(this);" comma>
					</td>
				</tr>
				<tr>
					<th class="hit" name="toggleReq">매입수량</th>
					<td>
						<input type="hidden" name="realTrstQty"> 
						<input type="text" class="tr" name="bilgQty" value="0" msg="매입수량" onkeyup="onlyNumber(this); countAmt(this);" required comma minus>
					</td>
					<th class="hit" name="toggleReq">매입중량</th>
					<td>
						<input type="hidden" name="realTrstWt"> 
						<input type="text" class="tr" name="bilgWt" value="0" msg="매입중량" onkeyup="onlyNumber(this);" required comma minus>
					</td>
				</tr>
				<tr>
					<th class="hit" name="toggleReq">매입단가</th>
					<td>
						<input type="hidden" name="realTrstUpr"> 
						<input type="text" class="tr" name="bilgUpr" value="0" msg="매입단가" onkeyup="onlyNumber(this); if(this.value == ''){this.value = '0'}  countAmt(this);" required comma>
					</td>
					<th>제품기준단가</th>
					<td>
						<input type="text" class="tr" name="prdtUpr" value="0" readonly comma>
					</td>
				</tr>
				<tr>
					<th>할인금액</th>
					<td>
						<input type="text" class="tr" name="trstDcAmt" value="0" onkeyup="onlyNumber(this); if(this.value == ''){this.value = '0'} countAmt(this);" comma minus>
					</td>
					<th>운송비</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="transSeq" name="transSeq">
							<a onclick="openSecondTransAmt();" style="left:0;"><i class="i_search_w"></i></a>
							<input type="text" class="tr" id="transAmt" name="transAmt" value="0" onkeyup="onlyNumber(this); countAmt(this);" comma> 
						</div>
					</td>
				</tr>
				<tr>
					<th>기타금액</th>
					<td>
						<input type="text" class="tr" name="etcAmt" value="0" onkeyup="onlyNumber(this);  if(this.value == ''){this.value = '0'} countAmt(this);" comma minus>
					</td>
					<th>매입금액</th>
					<td>
						<input type="hidden" name="realTrstAmt" readonly="readonly" minus>
						<input type="text" class="tr" name="bilgAmt" value="0" onkeyup="onlyNumber(this);  if(this.value == ''){this.value = '0'} countBilgAmt(this);" readonly comma minus>
					</td>
				</tr>
				<tr>
					<th>비고</th>
					<td colspan="3">
						<textarea class="form-control" id="trspRmk" name="trspRmk" style="height: 60px;" maxlength="500"></textarea>
					</td>
				</tr>
			</table>
			<input type="hidden" id="trstCertiNo" name="trstCertiNo">
			<input type="hidden" id="selpchCd" name="selpchCd" value="SELPCH1">
			<input type="hidden" id="stockChgCd" name="stockChgCd" value="STOCKCHG01"> 
			<input type="hidden" id="userId" name="userId"> 
			<input type="hidden" id="pgmId" name="pgmId" value="OD0202P01">
			<input type="hidden" id="trstQty" name="trstQty">
			<input type="hidden" id="trstUpr" name="trstUpr">
			<input type="hidden" id="trstWt" name="trstWt">
			<input type="hidden" id="trstAmt" name="trstAmt">
		</form>
	</div>
	<br>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionOdBtn" authchk>등록</button>
		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$('#trstDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		setInit();
		
		authChk("OD0201M01");
	});
	
	function setInit() {	
		debugger;
		if(actionType == "C"){
			$('#actionOdBtn').on("click", function(){insertPchsSell();});
			$('#actionOdBtn').text("등록");
			$("#ownerCd").val("OWNER1");
			$("#makrCd").val("MAKR09");
			$("#trspTypCd").val("TRSPTYP1");
			selectSellInfoBase();
			setByCocd($("#coCd").val())
		}else if(actionType == "U"){
			selectSellInfo();
			$('#actionOdBtn').on("click", function(){insertPchsSell();});
			$('#actionOdBtn').text("저장");
		}else if(actionType == "I"){ // 조회 및 수정
			selectSellInfo();
			$('#actionOdBtn').on("click", function(){updatePchsSellPart();});
			$('#actionOdBtn').text("저장");
		}
	}
	
	function selectSellInfo() {
		if(actionType == "U"){ // 반품
			var row = subGridView.target.getList("selected")[0];
			var trstCertiNo = row.trstCertiNo			
		}else if(actionType == "I"){ // 조회 및 수정
			var trstCertiNo = modalStack.last().paramObj.trstCertiNo;
		}
		
		var formData = {
			"trstCertiNo" : trstCertiNo
		}
		postAjax("/user/ar/ar02/selectSellInfo", formData, null, function(data){
			setSellInfo(data.result);
		});
	}
	
	function setSellInfo(obj) {
		// 메인정보 set
		$.each(obj, function(key, value){
			if($('[name="'+key+'"]')[0]){
				
				if(actionType == "U"){ // 반품은  -1을 곱한다.
					if($('[name="'+key+'"]').is('[minus]')){
						value = -1 * Number(value);
					}
				}
				if($('[name="'+key+'"]').is('[comma]')){
					value = addCommaStr(value);
				}
				
				// 창고, 판매법인 set
				if(key == "coCd"){
					setByCocd(value);
				}
				if(actionType == "U"){ // 반품
					// 반품시 재고변동사유 set
					if(key == "bilgQty"){
						var stockChgCd = Math.sign(deleteCommaStr(value)) == -1 ? "STOCKCHG10" : "STOCKCHG03";
						$("#stockChgCd").val(stockChgCd);
					}
					
					// 반품시 운반비 제거
					if(key == "transAmt"){
						value = "0";
					}
				}
				
				$('[name="'+key+'"]').val(value);
			}
		});
		
		if(actionType == "I"){ // 조회 및 수정일 경우 dom 변경

			    $('#popForm #coCd').prop("disabled", true);
				$('input[name="clntNm').prop("disabled", true);
				$('#popForm #clntNm').siblings('a').remove();
				
				$('#popForm #taxivcCoprt').prop("disabled", true);
				$('input[name="trstDt"]').prop("disabled", true);
				$('#popForm #whCd').prop("disabled", true);
				$('#popForm #typCd').prop("disabled", true);
				$('#popForm #ownerCd').prop("disabled", true);
				$('#popForm #impYn').prop("disabled", true);
				$('#popForm #makrCd').prop("disabled", true);
				
				$('input[name="prdtNm"]').prop("disabled", true);
				$('#popForm #prdtNm').siblings('a').remove();
				$('#popForm .prdtSearch a').removeAttr("onclick");

				$('input[name="prdtSizeNm"]').prop("disabled", true);
				$('input[name="prdtSpec"]').prop("disabled", true);
				$('input[name="prdtSize"]').prop("disabled", true);
				$('input[name="prdtLen"]').prop("disabled", true);
				
				$('[name="toggleReq"]').removeClass("hit");
				$('[name="toggleReq"]').next().find('input:text:not([name="bilgUpr"])').prop("readonly", true);
				$('[name="toggleReq"]').next().find('input:text').prop("required", false);

				$('input[name="bilgQty"]').prop("disabled", true);	
				$('input[name="bilgWt"]').prop("disabled", true);	
				$('input[name="prdtUpr"]').prop("disabled", true);		
				$('input[name="bilgUpr"]').prop("disabled", true);	
				$('input[name="bilgAmt"]').prop("disabled", true);	
				$('input[name="trstDcAmt"]').prop("disabled", true);	
				$('input[name="etcAmt"]').prop("disabled", true);	
			
		}
	}
	
	function selectSellInfoBase() {
    	var row = subGridView.target.getList("selected");
		if(row.length == 0){
			row = subGridView.target.getList();
		}
		
		// 검색조건의 회사 set
 		$("#coCd").val($('#coCd_S').val()); 
		// 매입일자 set
		$('#trstDt').datepicker("setDate", new Date())
		
		if(row.length > 0){
			// 거래처
			$("#clntCd").val(row[0].clntCd); 
			$("#clntNm").val(row[0].clntNm); 
			// 판매법인
			$("#taxivcCoprt").val(row[0].taxivcCoprt); 
			// 현장
			$("#siteCd").val(row[0].siteCd);
			$("#siteNm").val(row[0].siteNm);
			// 프로젝트
			$("#prjctCd").val(row[0].prjctCd);
		}
		// 출고관련 항목 삭제
		$("#trspTypCd option[value='TRSPTYP4']").remove();
		$("#trspTypCd option[value='TRSPTYP5']").remove();
		
	}
	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);	
		});
	}
	
	// 창고, 판매법인 set
	function setByCocd(value){
		$('#whCd').data("desc", value);
		$('#whCd option:not([value=""])').remove()
		setCommonSelect($('#whCd'));  
	
		$('#taxivcCoprt').data("rprc", value);
		$('#taxivcCoprt option:not([value=""])').remove()
		setCommonSelect($('#taxivcCoprt'));  
	}
	
	// 판매유형에 따른 재고주체 ctrl
	function setBySellType(value){
		// 판매유형
		// SELLTYPE1: 유통
		// SELLTYPE2: 가공
		// SELLTYPE4: 임가공
		// SELLTYPE5: 관수
		
		// 재고주체
		// OWNER1: 자사
		// OWNER2: 제강사
		// OWNER3: 건설사
		// OWNER4: 기타
		
		if(value == "SELLTYPE1" || value == "SELLTYPE2" || value == "SELLTYPE5"){
		// 판매유형이 선택, 유통, 가공일때
			
			// 재고주체 초기화
			$('#ownerCd option').remove();
			setCommonSelect($('#ownerCd'));
			
			if(value == "SELLTYPE5"){
			// 판매유형이 관수일때
				// 재고주체 활성화
				$('#ownerCd').prop("disabled", false);
			}else if(value == "SELLTYPE1" || value == "SELLTYPE2"){
			// 판매유형이 유통, 가공일때
				// 재고주체 자사 set
				$('#ownerCd').val("OWNER1");
				// 재고주체 비활성화
				$('#ownerCd').prop("disabled", true);
			}
			
			if(value == "SELLTYPE2"){
			// 판매유형이 가공일때
				// 관리길이 8로 고정
				$('#mngPrdtLen').val("8");
			}else{
				// 관리길이 초기화
				$('#mngPrdtLen').val("");
			}
			
		}else if(value == "SELLTYPE4"){
		// 판매유형이 임가공일때
			// 재고주체에서 자사 삭제
			$('#ownerCd option[value="OWNER1"]').remove();
			// 재고주체 활성화
			$('#ownerCd').prop("disabled", false);
			// 관리길이 초기화
			$('#mngPrdtLen').val("");
		}
	}
	
	// 사용자 검색
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : "GUM", // $('#coCd').val(),
			"userId": $('#salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#salesMng').val(checkedNode.id);
			$('#salesMngNm').val(checkedNode.text);
		});
	}
	
	// 현장 검색
	function openSecondSiteSearch(type) {
		// 매입은 거래처가 필요 없음.
		var paramObj = {
			"coCd": $('#popForm #coCd').val(),
			"insertYn": "Y",
			"isClntReq": "N"
		}
		openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (grid){
			var row = grid.target.getList("selected")[0];
			$("#siteCd").val(row.siteCd);
			$("#siteNm").val(row.siteNm);
			$("#prjctCd").val(row.prjctCd);
		});
	}
		
	// 제품 검색
	function openSecondPrdtSearch(elem) {
		// selpchCd - SELPCH1: 매입
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"selpchCd": "SELPCH1",
			"impYn": $("#impYn").val(), 
			"clntCd" : $("#clntCd").val(),
			"prjctCd" : $("#prjctCd").val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$.each(row, function(key, value){
				if($("input[name="+key+"]") != undefined)
					$("input[name="+key+"]").val(value);
			});
			$('input[name="prdtUpr"]').val(row.ordrgUpr);
			$('input[name="bilgUpr"]').val(row.ordrgUpr);
			
			if(row.prdtStockCd == "N") {
				$('input[name="prdtSizeNm"]').prop("readonly", true);
				$('input[name="prdtSpec"]').prop("readonly", true);
				$('input[name="prdtLen"]').prop("readonly", true);
				
				$('[name="toggleReq"]').removeClass("hit");
				$('[name="toggleReq"]').next().find('input:text:not([name="bilgUpr"])').prop("readonly", true);
				$('[name="toggleReq"]').next().find('input:text').prop("required", false);
				
				$('input[name="bilgAmt"]').prop("readonly", false);
			} else {
				$('input[name="prdtSizeNm"]').prop("readonly", false);
				$('input[name="prdtSpec"]').prop("readonly", false);
				$('input[name="prdtLen"]').prop("readonly", false);
				
				$('[name="toggleReq"]').addClass("hit");
				$('[name="toggleReq"]').next().find('input:text').prop("readonly", false);
				$('[name="toggleReq"]').next().find('input:text').prop("required", true);
				
				$('input[name="bilgAmt"]').prop("readonly", true);
			}
		});
	}
	
	function countAmt(el) {
		var bilgQty = $("input[name='bilgQty']").val();
		var bilgUpr = $("input[name='bilgUpr']").val();
		var trstDcAmt = $("input[name='trstDcAmt']").val();
		var prdtCnvrsnWt = $("input[name='prdtCnvrsnWt']").val();
		var prdtStockCd  = $("input[name='prdtStockCd']").val();
		
		if(prdtStockCd == "N") {
			$("input[name='bilgWt']")[0].value = deleteCommaStr(bilgQty);
			$("input[name='bilgAmt']")[0].value = deleteCommaStr(bilgUpr) - deleteCommaStr(trstDcAmt);
			$("input[name='realTrstAmt']")[0].value = deleteCommaStr(bilgUpr);
		} else {
			$("input[name='bilgWt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(prdtCnvrsnWt)));
			$("input[name='bilgAmt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(bilgUpr) - deleteCommaStr(trstDcAmt)));
			$("input[name='realTrstAmt']").val((deleteCommaStr(bilgQty) * deleteCommaStr(bilgUpr)));
		}
		
		if($("input[name='bilgQty']").val().length>2){
			onlyNumber($("input[name='bilgQty']"));	
		}
		onlyNumber($("input[name='bilgWt']"));
		onlyNumber($("input[name='bilgAmt']"));
	}
	
	function countBilgAmt(el) {
		
		var bilgQty   = Number(deleteCommaStr($("input[name='bilgQty']").val()));
		var bilgUpr   = Number(deleteCommaStr($("input[name='bilgUpr']").val()));
		var trstDcAmt = Number(deleteCommaStr($("input[name='trstDcAmt']").val()));
		var bilgAmt   = Number(deleteCommaStr($("input[name='bilgAmt']").val()));

		$("input[name='trstAmt']").val(bilgAmt + trstDcAmt);
		$("input[name='realTrstAmt']").val(bilgAmt + trstDcAmt);
		
	}
	
	// 추후 수정 필요
	// 등록된 운송비가 있을경우 수정창으로 오픈해야함.
	function openSecondTransAmt() {
		openFrom = "OD0202P01";
		var paramObj ={
			transSeq :$('#transSeq').val(),
			coCd :$('#coCd').val()
		}
		if(!$('#transSeq').val()) {actionType = 'C';} 
		openSecondModal("/static/html/cmn/modal/trspInsert.html", 800, 450, "", paramObj);
	}
	
	function insertPchsSell() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			postAjax("/user/ar/ar02/insertPchsSell", formData, null, function(data){
				alert(data.resultMessage);
				if (data.resultCode == 200) {
					subGridView.setData(0);
					modalStack.close();
				}
			});
		}
	}

	function updatePchsSellPart() {
		debugger;
		if(inputValidation($('.popup_area [required]'))) {
			var formData = makeFormData();
			putAjax("/user/ar/ar02/updatePchsSellPart", formData, null, function(data){
				alert(data.resultMessage);
				if (data.resultCode == 200) {
					subGridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	function makeFormData() {
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		$("#trstDt").val($("#trstDt").val().replace(/-/g, ""));
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		$("input[name='realTrstQty']").val($("input[name='bilgQty']").val()); 
		$("input[name='realTrstUpr']").val($("input[name='bilgUpr']").val()); 
		$("input[name='realTrstWt']").val($("input[name='bilgWt']").val());
		$("input[name='trstQty']").val($("input[name='realTrstQty']").val()); 
		$("input[name='trstUpr']").val($("input[name='realTrstUpr']").val()); 
		$("input[name='trstWt']").val($("input[name='realTrstWt']").val()); 
		$("input[name='trstAmt']").val($("input[name='realTrstAmt']").val());
		var formData = $("#popForm").serializeObject();
		
		return formData;
	}
</script>
<body>
  <div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="popup_table">
    	<input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/>
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="15%">
	                <col width="">
	                <col width="15%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th>거래처</th>
	                <td>                             
	                    <input type="hidden" id="clntCd">
		                <div class="search_form">
			                <input type="text" id="clntNm">
			              	<a onclick="clntSearch('PUR');"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	                <th>회사</th>
	                <td>                                
	                    <select id="coCd" data-kind="CO">
	                 	</select>
	                </td>
	            </tr>
	            <tr>
	                <th>판매법인</th>
	                <td>                             
	                    <select id="estCoprt" data-kind="ESTCOPRT" required="required">
	                    	<option value="">선택</option> 
	                 	</select>
	                </td>
	                <th>메이커</th>
	                <td>                                
	                    <select id="makrCd" name="makrCd" data-kind="MAKR" required="required">
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	            </tr>
	            <tr>
	                <th>매출일자</th>
	                <td>                             
	                    <input type="text" id="dlvrDttm" name="dlvrDttm" class="input_calendar">
	                </td>
	                <th>담당자연락처</th>
	                <td>                                
	                    <input type="text" id="mngTel" name="mngTel" style="width: 100%;">
	                </td>
	            </tr>
	            <tr>
	                <th>판매유형</th>
	                <td>                             
	                    <select id="typCd" name="typCd" data-kind="SELLTYPE" required="required">
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	                <th>프로젝트</th>
	                <td>                             
	                    <div class="search_form">
			              <input type="hidden" id="prjctCd" name="prjctCd">
			              <input type="text" id="prjctNm" name="prjctNm" readonly="readonly">
			              <a onclick="prjctSearch();"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	            </tr>
	            <tr>
	            	<th>제품명</th>
	                <td>                                
	                    <div class="search_form">
	                    	<input type="hidden" name="prdtCd">
			                <input type="text" name="prdtNm" readonly="readonly" required="required" >
			              	<button type="button" onclick="prdtSearch(this);"><i class="i_search_w"></i></button>
			            </div>
	                </td>
	                <th>제품구분</th>
	                <td>                             
	                    <input type="hidden" name="prdtDiv" readonly="readonly">
	                    <input type="text" name="prdtDivNm" readonly="readonly">
	                </td>
	            </tr>
	            <tr>
	                <th>강종</th>
	                <td>                                
	                    <input type="hidden" name="prdtStkn" readonly="readonly">
	                    <input type="text" name="prdtStknNm" readonly="readonly">
	                </td>
	                <th>사이즈</th>
	                <td>                                
	                    <input type="hidden" name="prdtSize" readonly="readonly">
	                    <input type="text" name="prdtSizeNm" readonly="readonly">
	                </td>
	            </tr>
	            <tr>
	                <th>청구수량</th>
	                <td>                             
	                    <input type="text" name="bilgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	                <th>청구중량</th>
	                <td>                                
	                    <input type="text" name="bilgWt" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	            </tr>
	            <tr>
	                <th>청구단가</th>
	                <td>                             
	                    <input type="text" name="bilgUpr" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	                <th>제품기준단가</th>
	                <td>                                
	                    <input type="text" name="prdtUpr" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	            </tr>
	            <tr>
	                <th>기타금액</th>
	                <td>                             
	                    <input type="text" name="ordrgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	                <th>실거래수량</th>
	                <td>                                
	                    <input type="text" name="ordrgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	            </tr>
	            <tr>
	                <th>운송비</th>
	                <td>                             
	                    <input type="text" name="ordrgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	                <th>영업담당</th>
	                <td>                                
	                    <input type="hidden" id="salesMng" name="salesMng" style="width: 76%;">
	                    <div class="search_form">
		                    <input type="text" id="salesMngNm" name="salesMngNm" readonly="readonly">
	                    	<a onclick="openUserTree(this);"><i class="i_search_w"></i></a>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	                <th>청구금액</th>
	                <td>                             
	                    <input type="text" name="ordrgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	                <th>전표발행여부</th>
	                <td>                                
	                    <input type="text" name="ordrgQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	                </td>
	            </tr>
	            <tr>
	                <th>비고</th>
	                <td colspan="3">                             
	                    <textarea class="form-control" id="ordrgRmk" name="ordrgRmk" type="text" style="height: 60px;" maxlength="500"></textarea>
	                </td>
	            </tr>
	        </table>
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId" name="pgmId" value="AR0201P01">
	    </form>
    </div>
    <br>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionBtn">등록</button>
      <button class="close_btn" onclick="modal.close();">닫기</button>
    </div>
  </div>
 
</body>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$('#dlvrDttm').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		setInit();
	});
	
	function setInit() {
		if(actionType == "C"){
			$('#actionBtn').on("click", function(){insertShip();});
			$('#actionBtn').text("등록");
			$("#reqDt").val(dateToStr(new Date()));
		}else if(actionType == "U"){
			selectShipInfo();
			$('#actionBtn').on("click", function(){updateShip();});
			$('#actionBtn').text("저장");
		}else if(actionType == "O"){
			getOrderInfo();
			$('#odrSeq').siblings('a').remove();
			$('#actionBtn').on("click", function(){insertShip();});
			$('#actionBtn').text("등록");
		}
	}
	
	function selectShipInfo() {
		var row = gridView.target.getList("selected")[0];
		var formData = {
			"shipSeq" : row.shipSeq,
			"reqDt" : row.reqDt.replace(/-/g, "")
		}
		postAjax("/user/ar/ar01/selectShipInfo", formData, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function getOrderInfo(){
		var formData = {
			"odrSeq": odrSeq,
			"odrDtlSeqArr": odrDtlSeqArr
		};
		postAjax("/user/ar/ar01/getOrderInfo", formData, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var fileInfo = obj.fileList;
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		if(shipInfo.shipYn == "Y") {
			$("#actionBtn").hide();
		}
		//메인정보 세팅
		$.each(shipInfo, function(key, value){
			$('#'+key).val(value);
		});
		
		//상세정보 세팅
		$.each(shipDetail, function(idx, item){
			if(idx != 0) addRow();
			$.each(item, function(key, value){
				if($(".detailRow").find("input[name="+key+"]")[idx] != undefined) {
					$(".detailRow").find("input[name="+key+"]")[idx].value = value;
				}
			});
			if(item.shipYn == "Y") {
				$($("input[name='detailChkBox']")[idx]).prop("checked", true);
				$($("input[name='detailChkBox']")[idx]).prop("disabled", true);
				$($(".detailRow")[idx]).find("input").prop("disabled", true);
				$($(".detailRow")[idx]).find("button").prop("disabled", true);
			} else {
				$($("input[name='detailChkBox']")[idx]).prop("disabled", false);
			}
			countTot();
		});
		
		//콤마 추가
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
	}
	
	function prdtSearch(el) {
		openSecondModal("/static/html/user/ar/ar02/AR0202P02.html", 500, 400, "제품검색");
	}
	
	function makeFormData() {
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		$("#reqDt").val($("#reqDt").val().replace(/-/g, ""));
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		var formData = new FormData($("#popForm")[0]);
		
		// 첨부파일 추가
		$.each(fileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('.detailRow'), function(idx, elem){
			if($(elem).find("input[name='shipYn']").val() == "N" || $(elem).find("input[name='shipYn']").val() == "") {
				var detailObj = {};
				$.each($(elem).find('[name]'), function(idx, elem){
					detailObj[elem.name] = elem.value;
				});
				detailArr.push(detailObj);
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		if(actionType == "U") {
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		} 
		
		return formData;
	}
	
	function insertShip() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/ar/ar01/insertShip", formData, function(data){
				alert(data.resultMessage);
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function updateShip() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/ar/ar01/updateShip", formData, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			});
		}
	}
	
	function openUserTree(el, type) {
		treeType = type; 
		selectedIdx = $(el).closest('tr').prevAll().length;
		openSecondModal("/static/html/user/od/od01/OD0102P04.html", 300, 500, "사용자 검색");
	}
	
	function countAmt(el) {
		var ordrgQty     = $("input[name='ordrgQty']")[rowIdx].value;
		var ordrgUpr     = $("input[name='ordrgUpr']")[rowIdx].value;
		var prdtCnvrsnWt = $("input[name='prdtCnvrsnWt']")[rowIdx].value;
		var realDlvrQty  = $("input[name='realDlvrQty']")[rowIdx].value;
		var realDlvrUpr  = $("input[name='realDlvrUpr']")[rowIdx].value;
   // 실발주 단가가 없을 경우 지시단가로 초기값 정함.
		if(realDlvrUpr == 0 && realDlvrQty != 0) 
		 { $("input[name='realDlvrUpr']")[rowIdx].value = ordrgUpr; 
		    realDlvrUpr  = ordrgUpr; }
		
		$("input[name='ordrgWt']")[rowIdx].value     = (deleteCommaStr(ordrgQty)    * deleteCommaStr(prdtCnvrsnWt));
		$("input[name='ordrgAmt']")[rowIdx].value    = (deleteCommaStr(ordrgQty)    * deleteCommaStr(ordrgUpr));
		$("input[name='realDlvrWt']")[rowIdx].value  = (deleteCommaStr(realDlvrQty) * deleteCommaStr(prdtCnvrsnWt));
		$("input[name='realDlvrAmt']")[rowIdx].value = (deleteCommaStr(realDlvrQty) * deleteCommaStr(realDlvrUpr));
		addComma($("input[name='ordrgAmt']")[rowIdx]);
		addComma($("input[name='realDlvrAmt']")[rowIdx]);
		countTot();
	}
	
	function countTot() {
		
	}
	
</script>

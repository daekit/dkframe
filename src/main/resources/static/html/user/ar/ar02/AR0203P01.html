<div class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="pdb5">
		<div class="form-inline tr">
			<label>거래처</label>
			<div class="form-group">
				<div class="search_form">
					<input type="hidden" id="clntCd"> <input type="text" id="clntNm" disabled> 
					<a onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
				</div>
			</div>
			<div class="form-group mgl10">
				<label>분할비율</label>
				<input type="text" class="tc" id="leftPer" value="100" style="width: 40px;" onkeyup="onlyDecimal(this); calPercent(this, 'rightPer');" maxlength="2">
				: 
				<input type="text" class="tc" id="rightPer" value="0" style="width: 40px;" onkeyup="onlyDecimal(this); calPercent(this, 'leftPer');" maxlength="2">
			</div>
			<div class="add_btn_small pdl10" style="float: none !important;">
				<a style="height: 27px; line-height: 25px; width: 60px;" onclick="applyPercent();">비율적용</a>
			</div>
			<div class="form-group mgl10">
				<label>분할금액</label>
				<input type="text" class="tr" id="divisionAmt"  style="width: 100px;" onkeyup="onlyPositive(this);">
			</div>
			<div class="add_btn_small pdl10">
				<a style="height: 27px; line-height: 25px; width: 60px;" onclick="applyAmt();">금액적용</a>
			</div>
		</div>
	</div>
	<div>
		<div class="ax5_grid" data-ax5grid="sales-grid" data-ax5grid-config="{}" style="height: 750px; width: 100%"></div>
	</div>
	<br>
	<div class="popup_bottom_btn">
		<button type="button" onclick="insertSalesDivision();">저장</button>
		<button type="button" class="close_btn" onclick="modal.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	var orgRows = JSON.parse(JSON.stringify(commonModal.paramObj.selectedRows));
	var orgTotBilgAmt = 0;
	var salesGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		        target: $('[data-ax5grid="sales-grid"]'),
		        header: {
		        	align: "center"
		        },
		        page: {
		        	display: false,
		        },
		        columns: [
		          	{key: "trstCertiNo",    label: "거래지시번호",  hidden: true},
		        	{key: "clntCd",    	 	label: "거래처",		hidden: true},
		        	{
		        		label: "매출", columns: [
		        			{key: "clntNm",    	 	label: "거래처명",		align: "left", 		width: 120},
				        	{key: "prdtNm",    	 	label: "제품", 		    align: "left", 		width: 140},
				        	{key: "realTrstQty",    label: "수량", 		    align: "right", 	width: 80, 	formatter: "money"},
				        	{key: "realTrstWt", 	label: "중량", 		    align: "right", 	width: 80, 	formatter: "money"},
				        	{key: "realTrstAmt",    label: "금액",		    align: "right", 	width: 80, 	formatter: "money"},
		 		        	{key: "bilgQty",        label: "청구수량", 	    align: "right", 	width: 80, 	formatter: "money"},
		 		        	{key: "bilgWt",         label: "청구중량",   	align: "right", 	width: 80, 	formatter: "money"},
				        	{key: "bilgAmt", 	    label: "청구금액",  	align: "right", 	width: 80,	formatter: "money"},
				        	{key: "bilgVatAmt", 	label: "부가세",  	    align: "right", 	width: 80,	formatter: "money"},
				        	{key: "totAmt", 	    label: "합계",  		align: "right", 	width: 80,	formatter: "money"},
				        	{key: "trstDcAmt", 	    label: "할인금액",  	align: "right", 	width: 80, 	formatter: "money"}
		        		]
		        	},
		        	{key: "newClntCd",    	  label: "거래처",		hidden: true},
		        	{
		        		label: "분할", columns: [
		        			{key: "newClntNm",    	   label: "거래처명",		align: "left", 		width: 120},
		        			{key: "newRealTrstQty",    label: "수량", 		    align: "right", 	width: 80, 	formatter: "money"},
				        	{key: "newRealTrstWt", 	   label: "중량", 		    align: "right", 	width: 80, 	formatter: "money"},
				        	{key: "newRealTrstAmt",    label: "금액",		    align: "right", 	width: 80, 	formatter: "money"},
		  		        	{key: "newBilgQty",        label: "청구수량", 	    align: "right", 	width: 80,  formatter: "money"},
		  		        	{key: "newBilgWt",         label: "청구중량",   	align: "right", 	width: 80,  formatter: "money"},
				        	{key: "newBilgAmt", 	   label: "청구금액",  	    align: "right", 	width: 80,  formatter: "money"},
				        	{key: "newBilgVatAmt", 	   label: "부가세",  	    align: "right", 	width: 80,  formatter: "money"},
				        	{key: "newTotAmt", 	       label: "합계",  			align: "right", 	width: 80,  formatter: "money"},
				        	{key: "newTrstDcAmt", 	   label: "할인금액",  		align: "right", 	width: 80,  formatter: "money"}
		        		]
		        	}
		        ]
		    });
			return this;
		}, 
		setData: function() {
			var targetObj = this.target;
			var selectedRows = commonModal.paramObj.selectedRows;
			
			$.each(selectedRows, function(idx, obj){
				obj.newClntCd = "";
				obj.newClntNm = "";
				obj.newRealTrstQty = 0;
				obj.newRealTrstWt = 0;
				obj.newRealTrstAmt = 0;
				obj.newBilgQty = 0;
				obj.newBilgWt = 0;
				obj.newBilgAmt = 0;
				obj.newBilgVatAmt = 0;
				obj.newTrstDcAmt = 0;
			});
			
			targetObj.setData(commonModal.paramObj.selectedRows);
		}
	}
	
	$(document).ready(function(){
		salesGridView.initView().setData();
		
		// 원본데이터 총 청구금액 계산
		$.each(orgRows, function(idx, obj){
			orgTotBilgAmt += Number(obj.bilgAmt);
		});
	});
	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "연계거래처", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
		});
	}
	
	// 백분율 자동 계산
	function calPercent(elem, target){
		$('#'+target).val(100 - Number(elem.value));
	}
	
	// 비율 적용
	function applyPercent(){
		var rightRatio = Number($('#rightPer').val()) / 100;
		var salesRows = salesGridView.target.getList();
		$.each(salesRows, function(idx, obj){
			// 원본데이터
			var orgRealTrstQty = Number(orgRows[idx].realTrstQty);
			var orgRealTrstWt = Number(orgRows[idx].realTrstWt);
			var orgRealTrstAmt = Number(orgRows[idx].realTrstAmt);
			var orgBilgQty = Number(orgRows[idx].bilgQty);
			var orgBilgWt = Number(orgRows[idx].bilgWt);
			var orgBilgAmt = Number(orgRows[idx].bilgAmt);
			var orgBilgVatAmt = Number(orgRows[idx].bilgVatAmt);
			var orgTotAmt = Number(orgRows[idx].totAmt);
			var orgTrstDcAmt = Number(orgRows[idx].trstDcAmt);
			
			// 분할데이터 계산
			var newRealTrstQty = Math.round(orgRealTrstQty * rightRatio);
			var newRealTrstWt = Math.round(orgRealTrstWt * rightRatio);
			var newRealTrstAmt = Math.round(orgRealTrstAmt * rightRatio);
			var newBilgQty = Math.round(orgBilgQty * rightRatio);
			var newBilgWt = Math.round(orgBilgWt * rightRatio);
			var newBilgAmt = Math.round(orgBilgAmt * rightRatio);
			var newBilgVatAmt = Math.round(orgBilgVatAmt * rightRatio);
			var newTotAmt = newBilgAmt + newBilgVatAmt;
			var newTrstDcAmt = Math.round(orgTrstDcAmt * rightRatio);
			
			// 분할데이터 수정
			salesGridView.target.setValue(idx, "newRealTrstQty", newRealTrstQty);
			salesGridView.target.setValue(idx, "newRealTrstWt", newRealTrstWt);
			salesGridView.target.setValue(idx, "newRealTrstAmt", newRealTrstAmt);
			salesGridView.target.setValue(idx, "newBilgQty", newBilgQty);
			salesGridView.target.setValue(idx, "newBilgWt", newBilgWt);
			salesGridView.target.setValue(idx, "newBilgAmt", newBilgAmt);
			salesGridView.target.setValue(idx, "newBilgVatAmt", newBilgVatAmt);
			salesGridView.target.setValue(idx, "newTotAmt", newTotAmt);
			salesGridView.target.setValue(idx, "newTrstDcAmt", newTrstDcAmt);
			
			// 매출데이터 수정
			salesGridView.target.setValue(idx, "realTrstQty", orgRealTrstQty - newRealTrstQty);
			salesGridView.target.setValue(idx, "realTrstWt", orgRealTrstWt - newRealTrstWt);
			salesGridView.target.setValue(idx, "realTrstAmt", orgRealTrstAmt - newRealTrstAmt);
			salesGridView.target.setValue(idx, "bilgQty", orgBilgQty - newBilgQty);
			salesGridView.target.setValue(idx, "bilgWt", orgBilgWt - newBilgWt);
			salesGridView.target.setValue(idx, "bilgAmt", orgBilgAmt - newBilgAmt);
			salesGridView.target.setValue(idx, "bilgVatAmt", orgBilgVatAmt - newBilgVatAmt);
			salesGridView.target.setValue(idx, "totAmt", orgTotAmt - newTotAmt);
			salesGridView.target.setValue(idx, "trstDcAmt", orgTrstDcAmt - newTrstDcAmt);
		});
	}
	
	// 금액 적용
	function applyAmt(){
		var divisionAmt = deleteCommaStr($('#divisionAmt').val());
		debugger;
	}
</script>

<style>
	input[comma] {text-align: right;}
</style>
<div class="popup_area of_a" style="height: 90%;">
	<div class="tit_contents">
		<h4 class="tit"></h4>
	</div>
	<ul class="dp_ib" >
		<li style="width: 40%; vertical-align: top;">
			<!-- 수금 테이블 -->
			<div class="popup_table" id="etrdpsTableDiv">
				<form id="etrdpsData">
					<input type="hidden" id="pgmId" name="pgmId" value="AR0502P01">
					<input type="hidden" id="etrdpsSeq" name="etrdpsSeq">
					<table>
						<colgroup>
							<col width="15%">
							<col width="">
							<col width="15%">
							<col width="">
						</colgroup>
						<tr>
							<th class="hit">회사</th>
							<td>
								<select id="coCd" name="coCd" data-kind="CO"  onchange="setTaxivcCoprt(this.value)"  msg="회사" required>
									<option value="">선택</option>
								</select>
							</td>
							<th class="hit">판매법인</th>
							<td>
								<select id="taxivcCoprt" name="taxivcCoprt" data-kind="ESTCOPRT"  onchange="setEtrdpsBkac(this.value); selectEtrdpsDtlList();"  msg="계산서발행법인" required>
		<!-- 							<option value="">선택</option> -->
								</select>
							</td>
						</tr>
						
						<tr>
							<th class="hit">거래처</th>
							<td>
								<div class="search_form">
									<input type="hidden" id="clntCd" name="clntCd"  msg="거래처" required>
									<input type="text" id="clntNm" disabled> 
									<a id="btnClntSearch" onclick="openSecondClntSearch();"><i class="i_search_w"></i></a>
								</div> 
							</td>
							<th class="hit">일자</th>
							<td>
								<input type="text" class="input_calendar" autocomplete="off" id="etrdpsDt" name="etrdpsDt"  msg="일자" date required>
							</td>
						</tr>
						<tr>
							<th class="hit">구분</th>
							<td>
								<select id="etrdpsTyp" name="etrdpsTyp" data-kind="ETRDPS"  onchange="etrdpsTypTable(); selectEtrdpsDtlList(); setSummary();"  msg="구분" required>
									<option value="">선택</option>
								</select>
							</td>
							<th>잡이익여부</th>
							<td>
								<select id="msclPrftYn" name="msclPrftYn" msg="잡이익 여부" >
									<option value="">선택</option>
									<option value="Y">잡이익</option>
									<option value="N">잡손실</option>
								</select>
							</td>
		
						</tr>
						<tr>
							<th class="hit">입금계좌</th>
							<td>
								<select id="etrdpsBkacCd" name="etrdpsBkacCd" data-kind="BKAC"  msg="입금계좌" required>
									<option value="">선택</option>
								</select>
							</td>
						
							<th class="hit">결제방법</th>
							<td>
								<select id="setleTypCd" name="setleTypCd" data-kind="PMNTMTD" onchange="ctrlBillTable(this);"  msg="결제방법"required>
									<option value="">선택</option>
								</select>
							</td>
						</tr>
						<tr>	
							<th class="hit">금액</th>
							<td>
								<input type="text" id="etrdpsAmt" name="etrdpsAmt" onkeyup="onlyNumber(this); event.keyCode == 13 ? enterRemote(this) : ''; resetTable();" msg="금액"  comma required >
							</td>
							<th class="hit">제품그룹</th>
							<td>
								<select id="prdtGrp" name="prdtGrp" data-kind="PRDTGRP" msg="제품그룹" required onchange="selectEtrdpsDtlList();">
								</select>
							</td>
						</tr>
						<tr>	
							<th class="hit">자동매핑</th>
							<td>
								<select id="autoMatchFlag" name="autoMatchFlag" data-kind="AUTOMATCHFLAG" msg="자동매핑" required>
									<option value="Y" selected>Y</option>
									<option value="N">N</option>
								</select>
							</td>
							<th></th>
							<td>

							</td>
						</tr>
						<tr>
							<th>적요</th>
							<td colspan="3">
								<textarea class="form-control" id="sumry" name="sumry" style="height: 60px;" maxlength="100"></textarea>
							</td>
						</tr>
					</table>
				</form>
			</div>
			
			<br>
			<!-- 어음 테이블 -->
			<div class="popup_table" id="billTableDiv" style="display: none;">
				<form id="billData">
					<input type="hidden" id="pgmId" name="pgmId" value="AR0502P01">
					<table>
						<colgroup>
							<col width="15%">
							<col width="">
							<col width="15%">
							<col width="">
						</colgroup>
						<tr>
							<th class="hit">어음종류</th>
							<td>
								<select id="bilTypCd" name="bilTypCd" data-kind="BIL" required>
									<option value="">선택</option>
								</select>
							</td>
							<th class="hit">어음번호</th>
							<td>
								<input type="text" id="bilNo" name="bilNo" required onkeyup=" event.keyCode == 13 ? enterRemote(this) : ''"> 
							</td>
						</tr>
						<tr>
							<th class="hit">만기일</th>
							<td>
								<input type="text" class="input_calendar" autocomplete="off" id="exprtnDt" name="exprtnDt" date required>
							</td>
							<th>지급은행</th>
							<td>
								<select id="pymntBankCd" name="pymntBankCd" data-kind="BANK">
									<option value="">선택</option>
								</select>
							</td>
						</tr>
						<tr>
							<th>발행자</th>
							<td>
								<input type="text" id="bilPblsPsn" name="bilPblsPsn" maxlength="25" onkeyup=" event.keyCode == 13 ? enterRemote(this) : ''">
							</td>
							<th>배서인 수</th>
							<td>
								<input type="text" id="endrsPsnCnt" name="endrsPsnCnt" onkeyup="onlyNumber(this); event.keyCode == 13 ? enterRemote(this) : ''">
							</td>
						</tr>
						<tr>
							<th>어음금액</th>
							<td>
								<input type="text" id="bilAmt" name="bilAmt" onkeyup="onlyNumber(this); event.keyCode == 13 ? enterRemote(this) : ''" comma>
							</td>
							<th>발행일</th>
							<td>
								<input type="text" class="input_calendar" autocomplete="off" id="bilPblsDt" name="bilPblsDt" date>
							</td>
						</tr>
						<tr>
							<th>전배서인</th>
							<td>
								<input type="text" id="endrsPsn" name="endrsPsn" maxlength="25"  onkeyup=" event.keyCode == 13 ? enterRemote(this) : ''">
							</td>
							<th>
							</th>
							<td>
							</td>
						</tr>
						<tr>
							<th>비고</th>
							<td colspan="3">
								<textarea class="form-control" id="sumry" name="sumry" style="height: 60px;" maxlength="100"></textarea>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</li>
		<li style="width: 58%; vertical-align: top;">
			<!-- 데이터 테이블 -->
			<div class="popup_table" id="etrdpsTb">
				<table>
					<tr>
						<td colspan="2" style="text-align: LEFT; border-right: 0;">입금 - 매출</td>
						<td colspan="9">
						</td>
					</tr>
				</table>
				<table id="detailTb">
					<colgroup>
						<col width="3%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="11%">
						<col width="11%">
						<col width="11%">
					</colgroup>
					<tr>
						<th></th>
						<th class="tc">거래처</th>
						<th class="tc">매출일자</th>
						<th class="tc">프로젝트</th>
						<th class="tc">결제방법</th>
						<th class="tc">수급조건</th>
						<th class="tc">결제일</th>
						<th class="tc">결제예정일</th>
						<th class="tc">채권금액</th>
						<th class="tc">수금액</th>
					</tr>
					<!-- // -->
					<tr class="detailRow" name="tableEtrdps">
						<td>
							<input type="checkbox" name="detailChkBox" onchange="setEtrdpsAmt(this); setTot();">
							<input type="hidden" name="prjctSeq">
							<input type="hidden" name="coCd">
							<input type="hidden" name="trstClntCd">
							<input type="hidden" name="clmnDivCd">
							<input type="hidden" name="pmntMtdCd">
							<input type="hidden" name="prjctCd">
							<input type="hidden" name="trstCertiNo">
							<input type="hidden" name="bilgCertNo">
							<input type="hidden" name="taxBilgNo">
							<input type="hidden" name="prdtGrp">
						</td>
						<td>
							<input class="tc" name="clntNm" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="trstDt" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="prjctNm" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="pmntMtdNm" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="clmnDivNm" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="clmnDay" type="text" readonly>
						</td>
						<td>
							<input class="tc" name="expDay" type="text" readonly>
						</td>
						<td>
							<input class="tr" name="bilgTot" type="text" readonly comma>
						</td>
						<td>
							<input class="tr" name="etrdpsAmt" type="text" onkeyup="onlyNumber(this); setTot();" comma>
						</td>
					</tr>
				</table>
				<table>
					<colgroup>
						<col width="3%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="10%">
						<col width="11%">
						<col width="11%">
						<col width="11%">
					</colgroup>
					<tr>
						<th class="tc" colspan="8">합계</th>
						<td class="tr" id="totBilgAmt"></td>
						<td class="tr" id="totEtrdpsAmt"></td>
					</tr>
				</table>
			</div>
		</li>
	</ul>
</div>
<!-- 하단 버튼 -->
<div class="popup_bottom_btn">
	<button id="actionBtn" authchk></button>
	<button id="calcelMatchBtn" style="display: none;" onclick="calcelMatch();"  authchk>매핑삭제</button>
<!-- 		<button id="ordrgYnBtn"   style="display: none;" onclick="updateConfirm();" authchk>더존전송</button> -->
	<button class="close_btn" onclick="modalStack.close();">닫기</button>
</div>
	
<script type="text/javascript">
   var calcelMatchType = 'U';
	
	$(document).ready(function() {
		
		// 공통코드 SelectBox set
		setCommonSelect($(".popup_area select[data-kind]"));
		
		
	     
		// 입금일 datepicker bind
		$('#etrdpsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		
		// 만기일 datepicker bind
		$('#exprtnDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		
		// 어음 발행일 datepicker bind
		$('#bilPblsDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		if (actionType == "C") {
			// 입금일자 오늘날짜 set
			$('#etrdpsDt').datepicker("setDate", new Date());
			$('#actionBtn').on("click", function() {insertEtrdps();});
			$('.tit_contents .tit').text("입/출금 등록");
			$('#actionBtn').text("등록");			
			$('#coCd').val($('[data-search="coCd"]').val());	
			setTaxivcCoprt($('[data-search="coCd"]').val());
		} else if (actionType == "U") {
			// 입금정보 set
			selectEtrdpsInfo();
			// 거래처 변경 disable				
			$('#coCd').prop("readonly", true);
			$('#coCd').prop("disabled", true);
			$('#clntCd').prop("readonly", true);
			$('#clntCd').prop("disabled", true);
			$('#btnClntSearch').remove();
			//$('#etrdpsTb').hide();
			// 조회시에는 수정 불가
			$('[name=etrdpsTyp]').prop("disabled", true);
			$('[name=detailChkBox]').prop("disabled", true);
			$('[name=etrdpsAmt]').prop("disabled", true);
			// 제품그룹변경
			$('[name=prdtGrp]').prop("disabled", true);
			// 판매법인변경
			$('[name=taxivcCoprt]').prop("disabled", true);
			// 금액 변경 disable
			$('#etrdpsAmt').prop("disabled", true);
			// 결제방법 변경 disable
			$('#setleTypCd').prop("disabled", true);
			// 어음번호 변경 readonly (어음 업데이트 시 필요)
			$('#bilNo').prop("readonly", true);
			
			$('#actionBtn').on("click", function() {updateEtrdps();});
			$('.tit_contents .tit').text("입/출금 수정");
			$('#actionBtn').text("수정");
		}
		authChk("AR0501M01");
		
	   /* select 태그 keypress catch */
	   $('td select').keypress(function(e){
		   var tagId = $(e.target).attr('id');
    	   var keyCode = e.keyCode;
    	   var idx=keyCode-48; 
    	   var target = e.target;
            $("select#"+tagId+" option:eq("+idx+")").prop("selected", true);
		   if(tagId == 'setleTypCd'){ctrlBillTable(target);}
           /*if(keyCode == 13){
			   e.preventDefault();
			   $("#"+tagId).next('select').focus();
		   } */
       });
		
	});
	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = clntGridView.target.getList("selected")[0];
			$("#clntCd").val(row.clntCd);
			$("#clntNm").val(row.clntNm);
			selectEtrdpsDtlList();
		});
	}
	
	function selectEtrdpsDtlList(){
		$.each($('input:checkbox[name="detailChkBox"]'), function(idx, elem){
			var detailObj = {};
			if(idx != 0){
				var $closestRow = $(elem).closest('.detailRow');
				detailObj["coCd"]     = $('#coCd').val();
				detailObj["prjctCd"]  = $('#prjctCd').val();
				detailObj["prjctSeq"] = $closestRow.find('[name="prjctSeq"]').val();
				
				if(detailObj.prjctSeq){
					detailArr.push(detailObj);
				}				
 				$(elem).closest('.detailRow').remove();
			} else {
				$(elem).closest('.detailRow').find('input').val("");
			}			
		});		

		if(!$("#etrdpsData #coCd").val() || !$("#etrdpsData #clntCd").val() ||  !$("#etrdpsData #taxivcCoprt").val() || !($("#etrdpsData #etrdpsTyp").val())){
			$('#etrdpsTb').hide();
			return false;
		}
		if($("#etrdpsTyp option:selected").attr("data-rprc") == "SELPCH1"){
			$('#etrdpsTb').hide();
			return false;
		}
		
		// 매핑삭제 후 선택할 수 있는 매출리스트 출력
		var paramObj = {
				"coCd": $("#etrdpsData #coCd").val(),
				"clntCd": $("#etrdpsData #clntCd").val(),
				"taxivcCoprt": $("#etrdpsData #taxivcCoprt").val(),
				"prdtGrp": $("#etrdpsData #prdtGrp").val(),
				"selpchCd": "SELPCH2"  // 매출만 매핑한다.
				};

		postAjax("/user/ar/ar05/selectEtrdpsDtlList", paramObj, null, function(data){
			$('#etrdpsTb').show();
			console.log(data.resultList);
			$.each(data.resultList, function(idx, item){
				if(idx != 0) addRow();
				$.each(item, function(key, value){
					setBilgList(idx, item);
				});
			});
		});
	}
	
	function clntSearch() {
		openSecondModal("/static/html/user/ar/ar05/AR0502P02.html", 500, 420, "거래처");
	}
	
	function ctrlBillTable(elem){
		var pmntMtd   = $(elem).find('option:selected').data("etc");
		var etrdpsTyp = $('[name=etrdpsTyp]').val();
		
		if(!pmntMtd || pmntMtd == "CASH"){
			$('#etrdpsBkacCd').attr("required");
			$('#etrdpsBkacCd').closest('td').prev().addClass("hit");
			$('#billTableDiv').hide();
		}else{
			$('#etrdpsBkacCd').removeAttr("required");
			$('#etrdpsBkacCd').closest('td').prev().removeClass("hit");
			$('#billTableDiv').show();
		}
		
		if((!pmntMtd || pmntMtd == "CASH") && etrdpsTyp =="ETRDPS01" ){
			$('#etrdpsBkacCd').attr("required");
			$('#etrdpsBkacCd').closest('td').prev().addClass("hit");
		}else{
			$('#etrdpsBkacCd').removeAttr("required");
			$('#etrdpsBkacCd').closest('td').prev().removeClass("hit");
		}	
		
	}

	function etrdpsTypTable() {
		var pmntMtd   = $("#setleTypCd").find('option:selected').data("etc");
		var etrdpsTyp = $("#etrdpsTyp").val();

		//  지급/상계일 경우 혹은 현금이 아닐결우 입금계좌 필수 제거
		if((!pmntMtd || pmntMtd == "CASH") && ( !etrdpsTyp || etrdpsTyp =="ETRDPS01" )){
			$('#etrdpsBkacCd').attr("required");
			$('#etrdpsBkacCd').closest('td').prev().addClass("hit");
		}else{
			$('#etrdpsBkacCd').removeAttr("required");
			$('#etrdpsBkacCd').closest('td').prev().removeClass("hit");
		}
		//  상계일 경우 지급방법이 필수가 아님. 수금/지급은 필수 나머지는 아님.
		if((etrdpsTyp =="ETRDPS01" || etrdpsTyp =="ETRDPS02" )){
			$('#setleTypCd').attr("required");
			$('#setleTypCd').closest('td').prev().addClass("hit");
			if (actionType != "U") { $('#setleTypCd').val(""); }
		}else{
			$('#setleTypCd').removeAttr("required");
			$('#setleTypCd').closest('td').prev().removeClass("hit");
			if (actionType != "U") { $('#setleTypCd').val("PMNTMTD06"); }
		}				
	}
	
	
	
	function selectEtrdpsInfo(){
		
		var paramRpw = modalStack.last().paramObj.row;
		var row = gridView.target.getList()[paramRpw];
		var paramObj = {
				"etrdpsSeq": row.etrdpsSeq,
				"coCd": row.coCd,
				"clntCd": row.clntCd,
				"taxivcCoprt": row.taxivcCoprt
				};
		
		postAjax("/user/ar/ar05/selectEtrdpsInfo", paramObj, null, function(data){
			setEtrdpsInfo(data.etrdpsInfo);
		});
		
		// selectEtrdpsDtlList();
	}
	
	function setEtrdpsInfo(etrdpsInfo){
		var etrdpsData = etrdpsInfo.etrdpsData;
		var billData = etrdpsInfo.billData;
		var etrdpsList = etrdpsInfo.etrdpsList;

		$.each(etrdpsData, function(key, value){
			if($('#etrdpsData').find('#'+key)[0]){				
				// 판매법인 Set
				if(key == 'coCd'){
					setTaxivcCoprt(value);
				}			
				// 은행계좌  Set
				if(key == 'taxivcCoprt'){
					setEtrdpsBkac(value);
				}
				$('#etrdpsData').find('#'+key).val(value);
				
				if($('#etrdpsData').find('#'+key).is("[comma]")){
					onlyNumber($('#etrdpsData').find('#'+key)[0]);
				}
				
				if($('#etrdpsData').find('#'+key).is("[date]")){
					$('#etrdpsData').find('#'+key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
				}

			}
		});
		
		$.each(etrdpsList, function(idx, value){
			if(idx != 0) addRow();
			setBilgList(idx, value);
		});

		// 구분에 따른 필수지정 관리
		etrdpsTypTable();
		
		if(billData){
			$('#billTableDiv').show();
			$.each(billData, function(key, value){
				if($('#billData').find('#'+key)[0]){
					$('#billData').find('#'+key).val(value);
					
					if($('#billData').find('#'+key).is("[comma]")){
						onlyNumber($('#billData').find('#'+key)[0]);
					}
					
					if($('#billData').find('#'+key).is("[date]")){
						$('#billData').find('#'+key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
					}
					
					
				}
			});
		}
	}
	
	function setBilgList(idx, item){

		$.each(item, function(key, value){
			if($(".detailRow").find("[name="+key+"]")[idx] != undefined) {
				var itemValue = value;
				if($(".detailRow").find("[name="+key+"]").eq(idx).is('[comma]')){
					itemValue = addCommaStr(itemValue);
				}
				$(".detailRow").find("[name="+key+"]")[idx].value = itemValue;
			}
		});
		setTot();
	}
	
	function insertEtrdps() {
		if (inputValidation($('.popup_table table:visible [required]'))) {

			var etrdpsAmt = Number(deleteCommaStr($("#etrdpsAmt").val()));
			var totEtrdpsAtm = 0;
			var isAdvPay = false;
			var diffAmt = 0;
			$.each($(".detailRow [name=etrdpsAmt]"), function(idx, elem){
				if($(".detailRow [name=detailChkBox]").eq(idx).prop("checked")){
					console.log("???");
					console.log(Number(deleteCommaStr($(elem).val())));
					totEtrdpsAtm += Number(deleteCommaStr($(elem).val()));
				}
			});
			
			if(Math.abs(totEtrdpsAtm) > Math.abs(Number(deleteCommaStr($("#etrdpsAmt").val())))){
				alert("금액을 확인해주세요");
				return false;
			} else if (totEtrdpsAtm == $("#etrdpsAmt").val()){
				isAdvPay = false;
			} else {
				isAdvPay = true;	
				diffAmt = Number(deleteCommaStr($("#etrdpsAmt").val())) - totEtrdpsAtm;
			}
			
			var formData = makeFormData();
			formData.calcelMatchType = calcelMatchType; // 매핑정보를 추가할 것인지 구분
			formData.isAdvPay = isAdvPay;  // 매핑금액 합계
			formData.diffAmt = diffAmt;    // 수금과 매핑금액의 차액
			console.log(formData);
			postAjax("/user/ar/ar05/insertEtrdps", formData, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}

	function updateEtrdps() {
		if (inputValidation($('.popup_table table:visible [required]'))) {
			var formData = makeFormData();
			
			var etrdpsAmt = Number(deleteCommaStr($("#etrdpsAmt").val()));
			var totEtrdpsAtm = 0;
			var isAdvPay = false;
			var diffAmt = 0;
			
			//  매핑 취소 후 수정일 경우 아래의 작업 진행
			//--------------------------------------------------------------------------
			if(calcelMatchType == 'C'){
				$.each($(".detailRow [name=etrdpsAmt]"), function(idx, elem){
					if($(".detailRow [name=detailChkBox]").eq(idx).prop("checked")){
						totEtrdpsAtm += Number(deleteCommaStr($(elem).val()));
					}
				});
				
				if(totEtrdpsAtm > Number(deleteCommaStr($("#etrdpsAmt").val()))){
					alert("금액을 확인해주세요");
					return false;
				} else if (totEtrdpsAtm == $("#etrdpsAmt").val()){
					isAdvPay = false;
				} else {
					isAdvPay = true;	
					diffAmt = Number(deleteCommaStr($("#etrdpsAmt").val())) - totEtrdpsAtm;
				}
			}
			//--------------------------------------------------------------------------
			
			formData.calcelMatchType = calcelMatchType; // 매핑정보를 추가할 것인지 구분
			formData.isAdvPay = isAdvPay;  // 매핑금액 합계
			formData.diffAmt = diffAmt;    // 수금과 매핑금액의 차액			
			
			putAjax("/user/ar/ar05/updateEtrdps", formData, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	// 입금-매출 매칭정보  삭제
	function calcelMatch() {
		if (selectGridValidation(gridView.target)) return;
		if (!confirm("매출 매핑정보를삭제하시겠습니까?")) return;
		var row = gridView.target.getList("selected")[0];
		
		var formData = makeFormData();
		
		var etrdpsAmt = Number(deleteCommaStr($("#etrdpsAmt").val()));
		var isAdvPay = true;
		var diffAmt = etrdpsAmt;
		
		formData.etrdpsData.etrdpsSeq = row.etrdpsSeq;
		formData.etrdpsData.diffAmt = diffAmt;
		formData.isAdvPay = true; 
		// var paramObj = {"etrdpsSeq": row.etrdpsSeq};
		
		// console.log(formData);
		
		// 매핑 취소하고 신규로 할때는 수정 가능
		$('.detailRow [name=detailChkBox]').prop("disabled", false);
		$('.detailRow [name=etrdpsAmt]').prop("disabled", false);
		
		calcelMatchType ='C'; // 매핑정보는 추가로 등록한다.
		
		putAjax("/user/ar/ar05/calcelMatch", formData, null, function(data) {
			alert(data.resultMessage);
			if (data.resultCode == 200) {
				gridView.setData(0);
				selectEtrdpsDtlList();
			}
		});
		//매핑 삭제 후 제품그룹 disabled false
		$('[name=etrdpsTyp]').prop("disabled", false);
	//	$('[name=setleTypCd]').prop("disabled", false);
		$('[name=prdtGrp]').prop("disabled", false);
		$('[name=taxivcCoprt]').prop("disabled", false);
		
	}
	function makeFormData(){
		var formData = {};
		for(var i=0;i<$('.popup_table:visible form').length;i++){
			var tempForm = $('.popup_table:visible form')[i];
			
			// 금액 콤마 제거
			$.each($(tempForm).find('[comma]'), function(idx, elem){
				deleteComma(elem);
			});
			
			// 날짜 하이픈 제거
			$.each($(tempForm).find('[date]'), function(idx, elem){
				deleteHyphen(elem);		
			});
			
			// 객체 생성
			var tempObj = $(tempForm).serializeObject();
			tempObj.coCd = $('#coCd').val();
			tempObj.clntCd = $("#clntCd").val();
			tempObj.prdtGrp = $("#etrdpsData #prdtGrp").val();
			tempObj.etrdpsTyp = $("#etrdpsData #etrdpsTyp").val();
			tempObj.taxivcCoprt = $("#etrdpsData #taxivcCoprt").val();			
			
			tempObj.userId = jwt.userId;
			formData[tempForm.id] = tempObj;
		}
		// 프로젝트Dtl 추가
		var detailArr = [];
		$.each($("#detailTb tr[name='tableEtrdps']"), function(idx, elem){
			var detailObj = {};
			if($(elem).find('[name=detailChkBox]').prop("checked")){
				$.each($(elem).find('[comma]'), function(idx, elem){
					deleteComma(elem);
				});
				$.each($(elem).find('[name]'), function(idx, elem){
					detailObj[elem.name] = elem.value;
				});
				detailArr.push(detailObj);
			}
		});
		formData.detailArr = JSON.stringify(detailArr);
		return formData;
	}
	// 판매법인 set
	function setTaxivcCoprt(value){
		$('#taxivcCoprt').data("rprc", value);
		$('#taxivcCoprt option:not([value=""])').remove()
		setCommonSelect($('#taxivcCoprt'));  
		// 은행계좌 Set
		setEtrdpsBkac($('#taxivcCoprt').val());

	}
	// 은행계좌 Set
	function setEtrdpsBkac(value){
		$('#etrdpsBkacCd').data("etc", value);
		$('#etrdpsBkacCd option:not([value=""])').remove()
		setCommonSelect($('#etrdpsBkacCd'));  		
	}	
	
	//input창에서 enter입력 이벤트
	function enterRemote(val){
		var tagId = $(val).attr('id');
		if(tagId == 'etrdpsAmt'){
			$('#sumry').focus();
		}
		if(tagId == 'bilNo'){
			$('#exprtnDt').focus();
		}
		if(tagId == 'bilPblsPsn'){
			$('#endrsPsnCnt').focus();
		}
		if(tagId == 'endrsPsnCnt'){
			$('input#bilAmt').focus();
		}
		if(tagId == 'bilAmt'){
			$('#bilPblsDt').focus();
		}
		if(tagId == 'endrsPsn'){
			$('textarea#sumry.form-control').focus();
		}
	}
	

	//list 행추가
	function addRow() {
		var row = $("#detailTb > tbody:last > tr:last").clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			this.value = '';
			this.checked = '';
		});
		return $("tr[name='tableEtrdps']:last")[0];
	}
	
	function setEtrdpsAmt(elem){
		
		if($(elem).prop("checked")){
			$targetRow = $(elem).closest('tr[name="tableEtrdps"]');
			if($targetRow.find('input[name="pmntMtdNm"]').val() && $targetRow.find('input[name="clmnDivCd"]').val()){
				$targetRow.find('input[name="etrdpsAmt"]').val($targetRow.find('input[name="bilgTot"]').val());
			} else {
				if($targetRow.find('input[name="prjctCd"]').val() != 0 ){
					alert("프로젝트 관리 화면에서 결제방법과 수금조건을 설정해주세요.");
				} else {
					alert("거래처 화면에서 결제방법과 수금조건을 설정해주세요.");
				}
				$(elem).prop("checked", false);
				return false;
			}
		} else {
			$targetRow = $(elem).closest('tr[name="tableEtrdps"]');
			$targetRow.find('input[name="etrdpsAmt"]').val("0");
		}
	}
	
	function setTot(){
		var totBilgAmt   = 0;
		var totEtrdpsAmt = 0;
 		var etrdpsAmt = deleteCommaStr($("#etrdpsAmt").val()); // 전체 금액
 		
 		
		$.each($('#detailTb tr[name="tableEtrdps"]'), function(idx, elem) { // 하나를 체크해도 모든 행을 확인한다.
			var tableBilgAmt = Number(deleteCommaStr($(elem).find("input[name='bilgTot']").val())); // 채권금액
			if($(elem).find("input[name='detailChkBox']").prop("checked")){ // 이번 행의 체크박스가 체크되어있는가?
				
				var tableEtrdpsAmt = Number(deleteCommaStr($(elem).find("input[name='etrdpsAmt']").val())); // 수금액 = 채권금액

				if(!tableEtrdpsAmt){
					tableEtrdpsAmt = 0;
				} 
				
				if(tableEtrdpsAmt > 0) {
					// 전체금액 > 누적금액 + 수금액(채권금액)
					if(etrdpsAmt > Number(totEtrdpsAmt) + Number(tableEtrdpsAmt)){
							totEtrdpsAmt += tableEtrdpsAmt;
					} else {
	 					$(elem).find("input[name='etrdpsAmt']").val(addCommaStr(Number(etrdpsAmt) - Number(totEtrdpsAmt)));
						totEtrdpsAmt = etrdpsAmt;
					}
				// 마이너스 금액의 케이스를 if문으로 빼고 마이너스 일 경우 0을 하드코딩해서 넣어준 뒤 계산에서 빼는 형식
				}else if(tableEtrdpsAmt < 0){
					// $(elem).find("input[name='etrdpsAmt']").val(addCommaStr(Number(etrdpsAmt) - Number(totEtrdpsAmt)));
					$(elem).find("input[name='etrdpsAmt']").val(0);
					// totEtrdpsAmt = etrdpsAmt;
				}else{
					
				}
					
			}
			
			totBilgAmt += tableBilgAmt;
		});
		$("#totBilgAmt").text(addCommaStr(totBilgAmt));
		$("#totEtrdpsAmt").text(addCommaStr(totEtrdpsAmt));
	}
	
	function resetTable(){
		$.each($('#detailTb tr[name="tableEtrdps"]'), function(idx, elem) {
			$(elem).find("input[name='detailChkBox']").prop("checked", false);
			$(elem).find("input[name='etrdpsAmt']").val("");
		});
		setTot();
	}
	
	function setSummary(){
		if($("#etrdpsTyp option:selected").attr("data-rprc") == "SELPCH1"){
			$("#sumry").val("월분 물품대 지급");
		} else{
			$("#sumry").val("월분 물품대 입금");
		}
	}
</script>

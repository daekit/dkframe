<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="/static/bootstrap/css/dashboard.css">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-datepicker.css">
	<link rel="stylesheet" href="/static/fontawesome/css/all.css">
	<link rel="stylesheet" href="/static/css/ax5/ax5grid.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5mask.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5modal.css" />
	<link rel="stylesheet" href="/static/css/ax5/ax5toast.css" />
	<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
	<link rel="stylesheet" href="/static/css/gnb.css" />
	<link rel="stylesheet" href="/static/css/main.css" />
	<link rel="stylesheet" href="/static/css/sub.css" />
	<link rel="stylesheet" href="/static/css/common.css" />
	
	<script src="/static/js/jquery-latest.min.js"></script>
	<script src="/static/js/jquery.serializeObject.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap-datepicker.ko.min.js"></script>
	<script src="/static/js/moment/moment-with-locales.js"></script>
	<script src="/static/js/ax5/ax5core.min.js"></script>
	<script src="/static/js/ax5/ax5grid.min.js"></script>
	<script src="/static/js/ax5/ax5mask.min.js"></script>
	<script src="/static/js/ax5/ax5modal.min.js"></script>
	<script src="/static/js/ax5/ax5toast.min.js"></script>
	<script src="/static/js/jstree/jstree.min.js"></script>
	<script src="/static/js/global.js"></script>
</head>

<body>
	<div id="head_area"></div>
	<div id="top_area"></div>
	<div id="main_area">
		<!-- 페이지 상단 -->
		<div class="contents no_bg">
			<ul class="btn_ul">
				<li class="btn_r">
					<a onclick="initSearch();">
						<button type="button" class="bg_gray">초기화</button>
					</a> 
					<a onclick="gridView.setData(0);">
						<button type="button" class="bg_gray">검 색</button>
					</a>
				</li>
			</ul>
		</div>
		<!-- 검색 콘텐츠 -->
		<div class="contents search" id="searchDiv">
			<input type="hidden" id="selectedData" name="selectedData"/>
			<div class="">
				<!-- 테이블 인풋 3분할 -->
				<table class="table_input type03">
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd_S" data-kind="CO" data-search="coCd" onchange="setByCoCd(this.value); gridView.setData(0);" required msg="회사">
							</select>
						</td>
						<th class="hit">기준일자</th>
						<td>
							<div class="date_input">
								<input type="text" class="input_calendar" autocomplete="off" id="startDt" data-search="startDt" required="required" msg="조회시작일자"> 
								<span>~</span> 
								<input type="text" class="input_calendar" autocomplete="off" id="endDt" data-search="endDt" required="required" msg="조회종료일자">
							</div>
						</td>
						<th>거래처</th>
		                <td>
		                  <input type="hidden" id="clntCd">
		                  <div class="search_form" style="width: 50%;">
			                <input type="text" id="clntNm" data-search="clntNm" onkeyup="event.keyCode == 8 ? clntCd.value = '' : event.keyCode == 13 ? gridView.setData(0) : ''">
			              	<a onclick="clntSearch('S');"><i class="i_search_w"></i></a>
			              </div>
		                </td>
					</tr>
					<tr>
						<th>매입/매출 구분</th>
						<td>
							<select data-kind="SELPCH" id="selpchCd" data-search="selpchCd">
								<option value="">전체</option>
							</select>
						</td>
						<th>세금계산서 번호</th>
						<td>
							<input type="text" id="taxBilgNo" data-search="taxBilgNo"> 
						</td>
						<th>접수여부</th>
						<td>
							<select data-search="rcvYn">
								<option value="" selected>전체</option>
								<option value="N">미접수</option>
								<option value="Y">접수완료</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>전송구분</th>
						<td>
							<select data-search="sndYn" id="sndYn">
								<option value="" selected>전체</option>
								<option value="N">미전송</option>
								<option value="Y">전송</option>
							</select>
						</td>
						<th>작성자명</th>
						<td>
							<input type="text" id="taxCreatNm" data-search="taxCreatNm"> 
						</td>
						<th>판매법인</th>
						<td>
						  <select id="taxivcCoprt_S" data-kind="ESTCOPRT" data-search="taxivcCoprt" onchange="gridView.setData(0);">
						 	 <option value="">전체</option>
						  </select>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<!-- 콘텐츠 -->
		<div class="contents no_bg">
			<!-- 콘텐츠 타이틀 -->
			<div class="contents_tit">
				<div class="add_btn_small pdl10">
						<a onclick="viewTaxBilgDetailModal('E');" style="height: 30px; line-height: 28px; width: 80px;" authchk><i class="fas fa-user-check"></i>이메일입력</a>
						<a onclick="openTaxManagerTap();" style="height: 30px; line-height: 28px; width: 100px;" authchk><i class="fas fa-address-card"></i>수신담당자관리</a>
						<a onclick="insertTaxHd();" style="height: 30px; line-height: 28px; width: 90px;" authchk; title="1. Case1:정상 세금계산서 처리
   1) 발주서관리화면의 직송 또는 출하요청서관리 화면에서 확정 처리를 하면 매출리스트화면에 출하자료가 생성됨
   2) 매출리스트 화면에서 매출확정(계산서생성) 처리를 하면 세금계산서관리화면에 세금계산서 발행대상 자료가 생성됨
   3) 세금계산서관리 화면에서 계산서정발행 처리를 하면 계산서번호가 생성되면서 전자세금계산서 자동 전송처리가 됨 
   4) 국세청에서 접수처리가 완료되면 국세청 승인번호와 결과 Flag 처리 됨
   
2. Case2: 국세청 사이트에서 계산서를 직접 발행 처리한 경우 
   1) Case1번의 내용중 2번까지 수행
   2) 세금계산서관리 화면에서 &quot;계산서정발행&quot; 튼을 클릭
   3) &quot;세금계산서 발행일자 선택&quot; Pop-up화면에서 국세청 발송여부를 아니오로 선택하고 &quot;세금계산서 발행/전송처리&quot; 버튼을 클릭한다.
   4) 세금계산서 번호가 부여되고 전송플래그가 처리되나 국세청 전송은 되지 않습니다."><i class="fas fa-file-alt"></i>계산서정발행</a>
<!-- 						재전송은 이미 발행된 건에 대해서 메일을 재전송하려고 사용중이지만 현재 메일이 재전송되지 않으므로 주석처리 - 2021/08/11 -->
<!-- 						재전송은 이미 발행된 건중 오류건(CSEQ_RCV_YN='E')에 대해서  재전송처리 - 2021/09/01 -->
						<a onclick="insertTaxHdReSend();" style="height: 30px; line-height: 28px; width: 80px;" authchk; title="5. Case5: 세금계산서관리화면에서 결과 코드가 'E'인경우 처리 방법
   1) 해당 계산서 상세화면에서 에러내용을 확인하고 자료를 수정하여 저장한다.
      (계산서 정발행이후 오류에 대한 처리만 가능합니다.)
   2) 계산선 선택후 &quot;재전송&quot; 버튼을 클릭하면 수정된 내용으로 계산서가 재전송 처리됨
   3) 국세청에서 접수처리가 완료되면 국세청 승인번호와 결과 Flag 처리됨"><i class="fas fa-file-export"></i>재전송</a>
<!-- 						<a onclick="insertTaxHdCancel();" style="height: 30px; line-height: 28px; width: 90px;" authchk><i class="fas fa-redo"></i>정발행취소</a> -->
						<a onclick="insertTaxHdUpdate();" style="height: 30px; line-height: 28px; width: 100px;" authchk; title="3. Case3:수정세금계산서 처리 (매출리스트화면에서 수정처리하는 경우)
   1) &quot;수정세금계산서&quot; 버튼을 클리하면 Minus 수정세금계산서가 생성되고 매출리스트화면의 해당 출하건에 수정사유, 원본계산서번호가 입력되면서 청구번호가 지워짐
   2) 매출리스트화면에서 단가, 수량, 금액 수정 후 매출확정시 세금계산서는 수정세금계산서로 수정사유, 원본계산서번호가 자동 생성됨
   3) 세금계산서관리화면에서 해당 수정세금계산서 선택후 &quot;계산서정발행&quot; 클릭하면 계산서번호가 생성되면서 전자세금계산서 자동 전송처리가 됨
   4) 국세청에서 접수처리가 완료되면 국세청 승인번호와 결과 Flag 처리됨
			 
4. Case4: 수정세금계산서 처리 (출하요청서 또는 발주서에서 수정처리하는경우)
   1) &quot;수정세금계산서&quot; 버튼을 클리하면 Minus 수정세금계산서가 생성되고 매출리스트화면의 해당 출하건에 수정사유, 원본계산서번호가 입력되면서 청구번호가 지워짐
   2) 발주서관리화면에서 매출취소 또는 출하요청서관리 화면에서 출하취소 처리하고 수정후 매출확정, 출하확정 처리  (세금계산서관리화면에서 수정사유, 수정세금계산서, 원본계산서번호를 수기 등록하여야 함)
   3) 매출리스트 화면에서 매출확정(계산서생성) 처리를 하면 세금계산서관리화면에 세금계산서 발행대상 자료가 생성됨 (한건씩 또는 여러건을 묶어서 확정(계산서생성) 가능)
   4) 세금계산서관리화면에서 해당건 선택후 수신담당자 정보와 함께 수정사유, 수정세금계산서, 원본계산서번호를 수기 등록하여야 함
   5) 해당 계산서 선택후 &quot;계산서정발행&quot; 클릭하면 계산서번호가 생성되면서 전자세금계산서 자동 전송처리가 됨 
   6) 국세청에서 접수처리가 완료되면 국세청 승인번호와 결과 Flag 처리 됨"><i class="fas fa-file-signature"></i>수정세금계산서</a>
						<a onclick="updateTaxHdRvrs();" style="height: 30px; line-height: 28px; width: 90px;" authchk;  title="6. Case6: 역발행-고객사에서 세금계산서를 발행하는 경우
   1) 발주서관리화면의 직송 또는 출하요청서관리 화면에서 확정 처리를 하면 매출리스트화면에 출하자료가 생성됨
   2) 매출리스트 화면에서 매출확정(계산서생성) 처리를 하면 세금계산서관리화면에 세금계산서 발행대상 자료가 생성됨
   3) 고객사에서 발급한 계산서 국세청 사이트가지 최종 확인 완료
   4) 세금계산서관리 화면에서 &quot;역발행확인&quot; 버튼을 클릭 (계산서 번호란에 &quot;역발행&quot;이라고 표기되며 전송플래그 처리가됨)
   5) 역발행 계산서는 국세청으로 전송하지 않습니다."><i class="fas fa-file-download"></i>역발행확인</a>
						<a onclick="updateTaxHdRvrsCancel();" style="height: 30px; line-height: 28px; width: 90px;" authchk><i class="fas fa-redo"></i>역발행취소</a>
						<a onclick="updateTaxHdRvrsCancel2();" style="height: 30px; line-height: 28px; width: 100px;" authchk; title="7. Case7: 세금계산서관리화면에서 결과 코드가 'E'인 경우면서 국세청오류인 경우
   1) 올바른 과정을 거쳤지만 국세청 에러가 나는 경우
   2) 원본계산서의 계산서 번호를 복사 후 (Ctrl + c) 붙여넣어야함
   3) 원하는 계산서 종류를 필히 선택해야함"><i class="fas fa-redo"></i>국세청오류정정</a>
						<a onclick="setReportMain();" style="height: 30px; line-height: 28px; width: 90px;" authchk><i class="fas fa-print"></i>계산서인쇄</a>
<!-- 						<a onclick="" style="height: 30px; line-height: 28px; width: 60px;" authchk>회계 전송</a> -->
						<a onclick="excelDown();" style="height: 30px; line-height: 28px; width: 90px;"><i class="fas fa-file-excel"></i> 엑셀다운로드</a>
				</div>
				<select class="prae_select" data-search="recordCnt">
					<option value="20">20</option>
					<option value="50" selected>50</option>
					<option value="100">100</option>
					<option value="1000">1000</option>
					<option value="9999999">전체</option>
				</select> 
			</div>
		</div>
		<!-- 콘텐츠 -->
		<div class="contents">
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="first-grid" data-ax5grid-config="{}" style="height: 490px; width: 100%"></div>
			<div class="ax5_grid" data-ax5grid="excel-grid" data-ax5grid-config="{}" style="display: none;"></div>
		</div>
		<div class="contents">
			<!-- 리스트 -->
			<div class="ax5_grid" data-ax5grid="detail-grid" data-ax5grid-config="{}" style="height: 240px; width: 100%"></div>
			
		</div>
	</div>
</body>
</html>

<script type="text/javascript">
	var actionType = null;
	var odrSeq = null;
	var odrDtlSeqArr = [];

	ax5.ui.grid.formatter["bilgYn"] = function () {
		var color = this.value == "Y" ? "color-circle_02.png" : "color-circle_01.png";
		if (this.value == "E"){
			return 'E';
		} else {
			return '<img src="/static/img/'+color+'" style="width: 10px;height: 10px;"></img>';
		}
	};

	ax5.ui.grid.formatter["bttonOn"] = function () {
		if (!this.value) {
		    return '';
		} else {
			if (this.value == "역발행") {
				return '역발행';
			} else {
//				return '<button type="button" class="btn btn-default btn-sm" class title="발행완료된 세금계산서" onclick="";">'+this.value+'</button>';
				return '<A type="text" class title="발행완료된 세금계산서" onclick="";">'+this.value+'</A>';
			}
		}
	};
	
	var gridView = {
			initView : function() {
				this.target = new ax5.ui.grid();
				this.target.setConfig({
					showRowSelector : true,
					multipleSelect : true,
					sortable : true,
					target : $('[data-ax5grid="first-grid"]'),
					header : {
						align : "center",
						selector : true
					},
					body : {
						onClick : function() {
							//this.self.select(this.dindex);
							gridDetailView.setData(0, this.dindex);
						},
						onDBLClick : function() {
							var list = gridView.target.getList("selected");
							$.each(list, function(idx, obj){
								gridView.target.select(obj.__index);
							});
							this.self.select(this.dindex);
							viewTaxBilgDetailModal("U");
						}
					},
					page : {
						navigationItemCount : 10,
						height : 30,
						display : true,
						firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
						prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
						nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
						lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
						onChange : function() {
							gridView.setData(this.page.selectPage);
						}
					},
			        footSum: [
				    	[
				    		{label: "총계", colspan:14, align:"center"},
				    		{key:"taxDms57240", collector: "sum", formatter:"money", align: "right"},
				    		{key: "taxMoa523", collector: "sum", formatter:"money", align: "right"},
		                    {key: "taxMoa5124", collector: "sum", formatter:"money", align: "right"},
		                    {key: "taxMoa5388", collector: "sum", formatter:"money", align: "right"},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
				          	{key: "bilgQty",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgWt",         collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgUpr",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgAmt",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "transAmt",       collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "trstDcAmt",      collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "etcAmt",         collector: "sum",   	     align: "right",  formatter: "money"},
				    	]
				    ],
					columns: [
						{key: "coCd", hidden: true},

			          	{key: "sndYn",          label: "전송",   	     align: "center",  width: 45,	formatter: "bilgYn"},
			          	{key: "cseqRcvYn",      label: "결과",   	     align: "center",  width: 45},
// 			          	{key: "taxAdmsYn",      label: "승인",   	 	 align: "center",  width: 45},
			          	{key: "rcvYn",          label: "접수",   	     align: "center",  width: 45, 	formatter: "bilgYn"},
			          	{key: "taxDt",          label: "발행일", 	     align: "center",  width: 80},
			          	{key: "taxCreatNm",     label: "발행자",       align: "center",   width: 90},
			          	{key: "taxBilgNo",      label: "계산서번호",    align: "center",  width: 150, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "invSndYn",       label: "명세서",   	 align: "center",  width: 60},
			          	{key: "bilgCertNo",     label: "청구번호",     align: "center",  width: 80, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "sellDt",         label: "매출일자",	     align: "center",  width: 90, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "clntNm",         label: "거래처명",	     align: "left",    width: 160, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		                {key: "ftxac11",        label: "국세청신고비고1",    align: "left",  width: 200, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "selpchNm",       label: "매입/매출",   	 align: "center",  width: 80, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "rffGn1",         label: "종류",		 align: "center",  width: 100, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "bgm1225",        label: "전송구분",		 align: "center",  width: 80, styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxDms57240",    label: "품목수",		 align: "right",   width: 60, formatter: "money", styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa523",      label: "공급가액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa5124",     label: "부가세액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa5124 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa5388",     label: "총금액",   	 align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa5388 < 0) ? "grid-font-red":"";}},
			          	{key: "rcvProcId",      label: "국세청접수번호",  align: "left",    width: 120},
			          	{key: "rffAea",         label: "계산서수정사유",  align: "left",   width: 120},
			          	{key: "orgnTaxBilgNo",  label: "원본계산서번호",  align: "left",   width: 150},
			          	{key: "bgm4343",        label: "전송회차",   	 align: "center",  width: 80},
			          	{key: "rffCno",         label: "영수/청구",   	     align: "center",  width: 80},
			          	{key: "rffVa",          label: "부가세",           align: "center",  width: 80},
			          	{key: "taxDivNm",       label: "계산서발행종류",   	 align: "center",  width: 110},
			          	{key: "rffGn2",         label: "세금계산서분류",      align: "center",  width: 100},
			          	{key: "xmlFlow",        label: "송수신구분",         align: "center", width: 80},
			          	{key: "taxivcCoprt",    label: "공급자발행법인",   	 align: "left",    width: 130, hidden:true},
			          	{key: "taxivcCoprtNo",  label: "공급자발행법인",   	 align: "center",  width: 100},
			          	{key: "taxivcCoprtCeo", label: "공급자대표자",   	 align: "left",    width: 100},
			          	{key: "taxivcCoprtNm",  label: "공급자상호",        align: "left",    width: 200},
			          	{key: "taxCoprtBizcon", label: "공급자업태",    	 align: "left",    width: 120},
			          	{key: "taxvicCoprtBsty",label: "공급자업종",    	 align: "left",    width: 120},
			          	{key: "ctaivBj1",       label: "공급받는자타입",   	 align: "center",  width: 100},
			          	{key: "taxivcRcvCrn",   label: "공급받는자사업자번호",  align: "left",  width: 150},
			          	{key: "taxivcRcvCeo",   label: "공급받는자대표자",   	 align: "left",  width: 100},
			          	{key: "taxivcRcvAddr",  label: "공급받는자주소",   	 align: "left",  width: 200},
			          	{key: "taxivcRcvBizcon",label: "공급받는자업태",   	 align: "left",  width: 120},
			          	{key: "taxivcRcvBsty",  label: "공급받는자업종",   	 align: "left",  width: 120},
			          	{key: "taxRcvNm",       label: "수신담당자",       align: "left",  width: 130},
			          	{key: "taxRcvEmail",    label: "수신자이메일",      align: "left",  width: 180},
			          	{key: "taxRcvEmail2",   label: "수신자이메일2",     align: "left",  width: 180},
			          	{key: "taxRcvFax",      label: "수신자팩스",        align: "center",  width: 100},
			          	{key: "taxRcvTel",      label: "수신자전화",        align: "center",  width: 100},
			          	{key: "taxMoblphon",    label: "수신자휴대폰",       align: "center",  width: 100},
			          	{key: "ftxac21",        label: "국세청신고비고2",    align: "left",  width: 200},
			          	{key: "ftxac31",        label: "국세청신고비고3",    align: "left",  width: 200},
			          	{key: "bilgQty",        label: "청구수량",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgQty < 0) ? "grid-font-red":"";}},
			          	{key: "bilgWt",         label: "청구중량",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgWt < 0) ? "grid-font-red":"";}},
			          	{key: "bilgUpr",        label: "청구단가",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgUpr < 0) ? "grid-font-red":"";}},
			          	{key: "bilgAmt",        label: "청구금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgAmt < 0) ? "grid-font-red":"";}},
			          	{key: "transAmt",       label: "운송비",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.transAmt < 0) ? "grid-font-red":"";}},
			          	{key: "trstDcAmt",      label: "할인금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.trstDcAmt < 0) ? "grid-font-red":"";}},
			          	{key: "etcAmt",         label: "기타금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.etcAmt < 0) ? "grid-font-red":"";}},
			          	{key: "sndDttm",        label: "전송일시",   	     align: "center",  width: 140},
			          	{key: "sndProcId",      label: "계산서전송ID",   	 align: "left",    width: 120},
			          	{key: "cseqRcvDttm",    label: "계산서처리결과회신일시",align: "center",  width: 140},
			          	{key: "taxAdmsDttm",    label: "승인처리일시", 	 align: "center",  width: 140},
			          	{key: "rcvDttm",        label: "국세청접수일자",	 align: "center",  width: 80},
			          	{key: "accSlipNo",      label: "회계전표참조번호",   align: "left",     width: 120},
			          	{key: "accSlipYn",      label: "회계반영여부",   	align: "center",   width: 100},
			          	{key: "accSlipDttm",    label: "회계반영일시",   	align: "center",   width: 140},
			          	{key: "accProcId",      label: "회계처리작업자ID",   align: "left",  width: 120}
			        ]
				});
				return this;
			},
			setData : function(_pageNo) {
				var targetObj = this.target;
				var paramObj = {"pageNo" : _pageNo + 1};
				if(inputValidation($('#searchDiv [required]'))){
					for(var i=0;i<$('[data-search]').length;i++){
						var tempElem = $('[data-search]')[i];
						paramObj[$(tempElem).data("search")] = $(tempElem).val();
					}
					postAjax("/user/ar/ar04/selectTaxBilgList", paramObj, null, function(data) {
						var list = data.resultList;
						targetObj.setData({
							list : list,
							page : {
								currentPage : _pageNo,
								pageSize : data.paginationInfo.pageSize,
								totalElements : data.paginationInfo.totalRecordCount,
								totalPages : data.paginationInfo.totalPageCount
							}
						});
						if(gridView.target.list.length > 0 ){
							gridDetailView.setData(0, 0);
						}
					});
				}
			}
		}
	var gridDetailView = {
			initView : function() {
				this.target = new ax5.ui.grid();
				this.target.setConfig({
					showRowSelector : true,
					multipleSelect : true,
					sortable : true,
					target : $('[data-ax5grid="detail-grid"]'),
					header : {
						align : "center",
						selector : true
					},
					body : {
						onClick : function() {
							//this.self.select(this.dindex);
						}
					},
					page : {
						navigationItemCount : 10,
						height : 30,
						display : true,
						firstIcon : '<i class="fa fa-step-backward" aria-hidden="true"></i>',
						prevIcon : '<i class="fa fa-caret-left" aria-hidden="true"></i>',
						nextIcon : '<i class="fa fa-caret-right" aria-hidden="true"></i>',
						lastIcon : '<i class="fa fa-step-forward" aria-hidden="true"></i>',
						onChange : function() {
							gridView.setData(this.page.selectPage);
						}
					},
			        footSum: [
				    	[
				    		{label: "총계", colspan:8, align:"center"},
				    		{key:"realTrstWt", collector: "sum", formatter:"money", align: "right"},
				    		{key: "bilgWt", collector: "sum", formatter:"money", align: "right"},
		                    {key: "", collector: "", formatter:"money", align: "right"},
		                    {key: "bilgAmt", collector: "sum", formatter:"money", align: "right"},
		                    {key: "bilgVatAmt", collector: "sum", formatter:"money", align: "right"},
		                    {key: "realTrstQty", collector: "sum", formatter:"money", align: "right"}
				    	]
				    ],
					columns: [
						{key: "coCd", hidden: true},
			          	{key: "trstDt",       label: "출고일",   	align: "center",  width: 90},
			          	{key: "selpchNm",     label: "구분",   	align: "center",  width: 45},
			          	{key: "prdtNm",       label: "품명",   	align: "left",    width: 125},
			          	{key: "prdtStknNm",   label: "재질",   	align: "center",  width: 95},
			          	{key: "prdtSpec",     label: "규격",   	align: "left",   width: 80},
			          	{key: "makrNm",       label: "메이커",   	align: "left",    width: 115},
			          	{key: "prdtLen",      label: "출고길이",  	align: "right",   width: 70, formatter: "money"},
			          	{key: "prdtUnitNm",   label: "단위",   	align: "center",  width: 45},
			          	{key: "realTrstWt",   label: "출하중량",  	align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.realTrstWt < 0) ? "grid-font-red":"";}},
			          	{key: "bilgWt",       label: "청구중량",  	align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgWt < 0) ? "grid-font-red":"";}},
			          	{key: "bilgUpr",      label: "청구단가",  	align: "right",   width: 95, formatter: "money"},
			          	{key: "bilgAmt",      label: "공급 가액",  align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgAmt < 0) ? "grid-font-red":"";}},
			          	{key: "bilgVatAmt",   label: "부가세",   	align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgVatAmt < 0) ? "grid-font-red":"";}},
			          	{key: "realTrstQty",  label: "출하수량",  	align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.realTrstQty < 0) ? "grid-font-red":"";}},
			          	{key: "trspRmk",      label: "비고",   	align: "left",   width: 95},
			          	{key: "trspTypNm",     label: "거래유형", 	align: "left",   width: 60},
			          	{key: "clntNm",       label: "수요가/북킹",align: "left",   width: 125},
			          	{key: "whNm",         label: "창고",   	align: "left",   width:115}
			        ]
				});
				return this;
			},
			setData : function(_pageNo, _dindex) {
				var targetObj = this.target;
				row = gridView.target.getList();
				var paramObj = {"pageNo" : _pageNo + 1,
								"bilgCertNo" : row[_dindex].bilgCertNo,
								"coCd" : row[_dindex].coCd
							}	
				postAjax("/user/ar/ar04/selectTaxBilgDetailList", paramObj, null, function(data) {
					var list = data.resultList;
					targetObj.setData({
						list : list,
						page : {
							currentPage : _pageNo,
							pageSize : data.paginationInfo.pageSize,
							totalElements : data.paginationInfo.totalRecordCount,
							totalPages : data.paginationInfo.totalPageCount
						}
					});
				});
			}
		}

	var excelView = {
			initView: function(){
				this.target = new ax5.ui.grid();
				this.target.setConfig({
			        target: $('[data-ax5grid="excel-grid"]'),
			        footSum: [
				    	[
				    		{label: "총계", colspan:14, align:"center"},
				    		{key:"taxDms57240", collector: "sum", formatter:"money", align: "right"},
				    		{key: "taxMoa523", collector: "sum", formatter:"money", align: "right"},
		                    {key: "taxMoa5124", collector: "sum", formatter:"money", align: "right"},
		                    {key: "taxMoa5388", collector: "sum", formatter:"money", align: "right"},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
		                    {key: ""},
				          	{key: "bilgQty",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgWt",         collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgUpr",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "bilgAmt",        collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "transAmt",       collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "trstDcAmt",      collector: "sum",   	     align: "right",  formatter: "money"},
				          	{key: "etcAmt",         collector: "sum",   	     align: "right",  formatter: "money"},
				    	]                                                                 
				    ],
			       columns: [
						{key: "coCd", hidden: true},
						{key: "coNm", 			label: "회사",   	    align: "center",  		width: 45},
			          	{key: "sndYn",          label: "전송",   	    align: "center",  		width: 45},
			          	{key: "cseqRcvYn",      label: "결과",   	    align: "center",  		width: 45},
// 			          	{key: "taxAdmsYn",      label: "승인",   	 	align: "center",  		width: 45},
			          	{key: "rcvYn",          label: "접수",   	    align: "center",  		width: 45},
			          	{key: "taxDt",          label: "발행일", 	    align: "center",  		width: 80},
			          	{key: "taxCreatNm",     label: "발행자",		align: "center",   		width: 90},
			          	{key: "taxBilgNo",      label: "계산서번호",   align: "center",  		width: 15, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "invSndYn",       label: "명세서",   	align: "center",  		width: 60},
			          	{key: "bilgCertNo",     label: "청구번호",    	align: "center",  		width: 80, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "sellDt",         label: "매출일자",	    align: "center",  		width: 90, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "clntNm",         label: "거래처명",	    align: "left",    		width: 160, 	styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
		                {key: "ftxac11",        label: "국세청신고비고1", align: "left",  		width: 200, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "selpchNm",       label: "매입/매출",   	 align: "center",  		width: 80, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "rffGn1",         label: "종류",		 align: "center",  		width: 100, 	styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "bgm1225",        label: "전송구분",		 align: "center",  		width: 80, 		styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxDms57240",    label: "품목수",		 align: "right",   		width: 60, formatter: "money", styleClass: function () {
		                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa523",      label: "공급가액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa523 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa5124",     label: "부가세액합계",   align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa5124 < 0) ? "grid-font-red":"";}},
			          	{key: "taxMoa5388",     label: "총금액",   	 align: "right",   width: 95, formatter: "money", styleClass: function () {
                     return (this.item.taxMoa5388 < 0) ? "grid-font-red":"";}},
			          	{key: "rcvProcId",      label: "국세청접수번호",  align: "left",    width: 120},
			          	{key: "rffAea",         label: "계산서수정사유",  align: "left",   width: 120},
			          	{key: "orgnTaxBilgNo",  label: "원본계산서번호",  align: "left",   width: 150},
			          	{key: "bgm4343",        label: "전송회차",   	 align: "center",  width: 80},
			          	{key: "rffCno",         label: "영수/청구",   	     align: "center",  width: 80},
			          	{key: "rffVa",          label: "부가세",           align: "center",  width: 80},
			          	{key: "taxDivNm",       label: "계산서발행종류",   	 align: "center",  width: 110},
			          	{key: "rffGn2",         label: "세금계산서분류",      align: "center",  width: 100},
			          	{key: "xmlFlow",        label: "송수신구분",         align: "center", width: 80},
			          	{key: "taxivcCoprt",    label: "공급자발행법인",   	 align: "left",    width: 130, hidden:true},
			          	{key: "taxivcCoprtNo",  label: "공급자발행법인",   	 align: "center",  width: 100},
			          	{key: "taxivcCoprtCeo", label: "공급자대표자",   	 align: "left",    width: 100},
			          	{key: "taxivcCoprtNm",  label: "공급자상호",        align: "left",    width: 200},
			          	{key: "taxCoprtBizcon", label: "공급자업태",    	 align: "left",    width: 120},
			          	{key: "taxvicCoprtBsty",label: "공급자업종",    	 align: "left",    width: 120},
			          	{key: "ctaivBj1",       label: "공급받는자타입",   	 align: "center",  width: 100},
			          	{key: "taxivcRcvCrn",   label: "공급받는자사업자번호",  align: "left",  width: 150},
			          	{key: "taxivcRcvCeo",   label: "공급받는자대표자",   	 align: "left",  width: 100},
			          	{key: "taxivcRcvAddr",  label: "공급받는자주소",   	 align: "left",  width: 200},
			          	{key: "taxivcRcvBizcon",label: "공급받는자업태",   	 align: "left",  width: 120},
			          	{key: "taxivcRcvBsty",  label: "공급받는자업종",   	 align: "left",  width: 120},
			          	{key: "taxRcvNm",       label: "수신담당자",       align: "left",  width: 130},
			          	{key: "taxRcvEmail",    label: "수신자이메일",      align: "left",  width: 180},
			          	{key: "taxRcvEmail2",   label: "수신자이메일2",     align: "left",  width: 180},
			          	{key: "taxRcvFax",      label: "수신자팩스",        align: "center",  width: 100},
			          	{key: "taxRcvTel",      label: "수신자전화",        align: "center",  width: 100},
			          	{key: "taxMoblphon",    label: "수신자휴대폰",       align: "center",  width: 100},
			          	{key: "ftxac21",        label: "국세청신고비고2",    align: "left",  width: 200},
			          	{key: "ftxac31",        label: "국세청신고비고3",    align: "left",  width: 200},
			          	{key: "bilgQty",        label: "청구수량",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgQty < 0) ? "grid-font-red":"";}},
			          	{key: "bilgWt",         label: "청구중량",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgWt < 0) ? "grid-font-red":"";}},
			          	{key: "bilgUpr",        label: "청구단가",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgUpr < 0) ? "grid-font-red":"";}},
			          	{key: "bilgAmt",        label: "청구금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.bilgAmt < 0) ? "grid-font-red":"";}},
			          	{key: "transAmt",       label: "운송비",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.transAmt < 0) ? "grid-font-red":"";}},
			          	{key: "trstDcAmt",      label: "할인금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.trstDcAmt < 0) ? "grid-font-red":"";}},
			          	{key: "etcAmt",         label: "기타금액",   	     align: "right",  width: 95, formatter: "money", styleClass: function () {
                     return (this.item.etcAmt < 0) ? "grid-font-red":"";}},
			          	{key: "sndDttm",        label: "전송일시",   	     align: "center",  width: 140},
			          	{key: "sndProcId",      label: "계산서전송ID",   	 align: "left",    width: 120},
			          	{key: "cseqRcvDttm",    label: "계산서처리결과회신일시",align: "center",  width: 140},
			          	{key: "taxAdmsDttm",    label: "승인처리일시", 	 align: "center",  width: 140},
			          	{key: "rcvDttm",        label: "국세청접수일자",	 align: "center",  width: 80},
			          	{key: "accSlipNo",      label: "회계전표참조번호",   align: "left",     width: 120},
			          	{key: "accSlipYn",      label: "회계반영여부",   	align: "center",   width: 100},
			          	{key: "accSlipDttm",    label: "회계반영일시",   	align: "center",   width: 140},
			          	{key: "accProcId",      label: "회계처리작업자ID",   align: "left",  width: 120}
			        ]
			    });
				return this;
			}
		}	
	
	$(document).ready(function() {
		// 페이지 타이틀 set
		mainDefaultLoad("세금계산서관리", "세금계산서관리");
		// 공통코드 set
		setCommonSelect($("#main_area select[data-kind]"));
		// 접속자 회사 set
		$('[data-search="coCd"]').val(jwt.coCd);
		setByCoCd(jwt.coCd);
		$('[data-search="selpchCd"]').val('SELPCH2');

		// 시작일 (시작일 기준 -3개월)
		$('#startDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).startOf("month").toDate())
		.on("changeDate", function(){
			if($('#startDt').val() > $('#endDt').val()){
				alert("날짜를 확인해주세요");
				$('#startDt').datepicker("setDate", new Date($('#endDt').val()));
			}
			authChk();
		});

		// 종료일
		$('#endDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		.datepicker("setDate", moment(new Date()).endOf("month").toDate())
		.on("changeDate", function(){
			if($('#startDt').val() > $('#endDt').val()){
				alert("날짜를 확인해주세요");
				$('#endDt').datepicker("setDate", new Date($('#startDt').val()));
			}
		});
		
		// 검색조건 이벤트 bind
		$('[data-search]').on("change", function(){
			gridView.setData(0);
		});

		// grid init
		gridView.initView().setData(0);
		gridDetailView.initView()
		excelView.initView();
		authChk();
	});
	
	// 검색조건 초기화
	function initSearch() {
		// 기간
		$('#startDt').datepicker("setDate", moment(new Date()).subtract(7, "day").toDate());
		$('#endDt').datepicker("setDate", new Date());
		var selpchCd = $('select#selpchCd').val();
		var sndYn = $('#sndYn').val();
		
		// 조건
		$(".contents.search [data-search]").not('.input_calendar').val("");
		$('[data-search="coCd"]').val(jwt.coCd);
		$('select#selpchCd').val(selpchCd);
		$('[data-search="sndYn"]').val(sndYn);
		
		// 재검색
		gridView.initView().setData(0);
	}
	
	//엑셀 다운로드
	function excelDown() {
		excelView.initView();
		var paramObj = {"pageNo" : 1,"recordCnt"   : 9999999};
		if(inputValidation($('[required]'))){
			for(var i=0;i<$('[data-search]').length;i++){
 				var tempElem = $('[data-search]')[i];
				paramObj[$(tempElem).data("search")] = $(tempElem).val();
			}

			postAjax("/user/ar/ar04/selectTaxBilgList", paramObj, null, function(data){
				var list = data.resultList;
				excelView.target.setData({
					list : list,
					page : {
						totalElements : list.length,
					}
				});
				var todayDate = new Date().format('yyyyMMddHHmmss');
				excelView.target.exportExcel("세금계산서_"+todayDate+".xls");
			});	
		}
	}
	
	// 판매법인 set
	function setByCoCd(value){
		$('#main_area #taxivcCoprt_S').data("rprc", value);
		$('#main_area #taxivcCoprt_S option:not([value=""])').remove()
		setCommonSelect($('#main_area #taxivcCoprt_S'));  
	}

	// 거래처 검색창
	function clntSearch(type) {
		actionTp = type;
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
		});
	}
	
	// 세금계산서 수정 화면
	function viewTaxBilgDetailModal(actionType) {
		var rowLength = gridView.target.getList("selected").length;
		var msg = "";
		if(actionType == "E"){
			msg = "이메일 입력은 한건 씩 가능합니다.";
		} else {
			msg = "세금계산서 관리는 한건 씩 가능합니다.";
		}
		
		if(rowLength == 0) {
			alert("세금계산서를 선택해 주세요.");
			return;
		} else if(rowLength > 1) {
			alert(msg);
			return;
		}
		this.actionType = actionType;
		openModal("/static/html/user/ar/ar04/AR0401P01.html", 1000, 690, "");
	}
	
	// 수신담당자 관리
	function openTaxManagerTap(){
		row = gridView.target.getList("selected")[0];
    	var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("세금계산서를 선택해 주세요.");
			return;
		} else if(rowLength > 1) {
			alert("거래처 담당자 관리는 한건 씩 가능합니다.");
			return;
		}
    	var url = "/static/html/user/ar/ar06/AR0601M01.html?clntCd=" + row.clntCd + "&clntNm=" + row.clntNm;
    	var win = window.open(url, '_blank');
        win.focus();
	}
	
	// 세금계산서정발행
	function insertTaxHd(){
		var flag = false;
		var clntFlag = false;
		var list = gridView.target.getList("selected");
		var bilgCertNoArr = [];
		var coCdArr = [];
		var emailChk = true;
		var emailIdx;
		var arrGnChk = true;
		var rvrsChk = true;
		var selpchChk = true;
		var selectDt;
		$.each(list, function(idx, obj){
			if(obj.taxBilgNo) {
				flag = true;
				if(obj.taxBilgNo == "역발행"){
					rvrsChk = false;
				}
				return false;
			}

			//세금계산서 발행일자 초기값 설정
			selectDt = obj.sellDt;

			// 매입매출 체크
			if(obj.selpchCd == "SELPCH1" || obj.selpchCd == "SELPCH3"){
				selpchChk = false;
				alert("매출계산서만 정발행 가능합니다!");
				return false;
			}

			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);
			// 정발행의 경우 rffgn1 : 01, rffAea : null 인 건만 가능
			/* if((obj.rffGn1Cd != "01")){ // 세금계산서 종류가 세금계산서면 pass 
				if((obj.bgm1225Cd != 'BGM12259' && obj.rffAeaCd != "03")){ // 최초발행(BGM12259)이 아닐 경우 rffAeaCd가 환입(03)이어야 pass 아닐 경우 종류 확인 alert
					arrGnChk = false;
					alert("세금계산서 종류를 확인 해 주세요.");
					return false;
				} 
				if(obj.rffGn1Cd == "02 " && !obj.rffAeaCd){ // 수정세금계산서인데 수정사유코드(rffAeaCd)가 없을 경우 사유 확인 alert
					arrGnChk = false;
					alert("수정 세금 계산서 사유를 확인 해 주세요.");
					return false;
				}
			} else { // 세금계산서일 경우
				if((obj.rffAeaCd == "03" && (obj.bgm1225Cd != 'BGM12254' || obj.bgm1225Cd != 'BGM12253'))){ // 환입
					arrGnChk = false;
					alert("세금계산서 종류를 확인 해 주세요.");
					return false;
				}
			} */ //20210715 주석처리 아래 로직으로 변경
			
			if(obj.bgm1225Cd == 'BGM12259') { //'BGM12259' 문서전송구분 최초 발행 “9”
				if(obj.rffGn1Cd != "01") {    //세금계산서(01)가 아니면 수정사유가 반드시 있어야 함
					if (!obj.rffAeaCd) {
						arrGnChk = false;
						alert("세금계산서 종류를 확인 해 주세요.");
						return false;
					}
				}
			} else if ( obj.rffAeaCd != "03") { //'BGM12254,BGM12253,BGM12251'정정(4)/삭제(3)/철회(1) 발행 시 환입(03)만 처리 아니면 오류처리
				arrGnChk = false;
				alert("세금계산서 종류를 확인 해 주세요.");
				return false;
			}
				
			//e-Mail 체크
			if(!obj.taxRcvEmail){
				emailChk = false;
				alert("수신자 성명, Email 필수입니다. 입력 후 발행해 주세요.");
				emailIdx = obj.__index;
				return false;
			}
			
			//coCdArr.push(obj.coCd);
		});
		
		if(!arrGnChk){
			return false;
		}
		if(!rvrsChk){
			alert("역발행 확인된 세금계산서입니다. 정발행 처리 불가!");
			return;
		}
		if(!emailChk){
			$.each(list, function(idx, obj){
				gridView.target.select(obj.__index);
			});
			gridView.target.select(emailIdx);
			viewTaxBilgDetailModal("U");
			return false;
		}
		if(flag) {
			alert("세금계산서 발행된 건이 있습니다.");
			return;
		}; 
		if(!selpchChk){
			return false;
		}
		var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("정발행 세금계산서 대상자료를 선택해 주세요.");
			return;
		}
		if(rowLength > 1) {
			alert("발행일자 선택 1건씩 처리만 가능합니다..");
			return;
		}
		if(!confirm(rowLength + "건을 발행하시겠습니까?")){
			return;
		}
		var paramObj = {
			"selectDt": selectDt,
			"sndYnDp": "Y"
		}
		openModal("/static/html/user/ar/ar04/AR0401P05.html", 600, 240, "", paramObj, function (callbackObj) {
			callbackObj.bilgCertNoArr = bilgCertNoArr;
			callbackObj.userId = jwt.userId;
			callbackObj.userNm = jwt.userNm;
			callbackObj.deptId = jwt.deptId;
			callbackObj.pgmId = "AR0401M01";
			
			postAjax("/user/ar/ar04/insertTaxHd", callbackObj, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
	 				modalStack.close();
				}
			});
		});
	}

	//세금계산서재전송
	function insertTaxHdReSend(index){
		var flag = false;
		var clntFlag = false;
		var list = gridView.target.getList("selected");
		var bilgCertNoArr = [];
		var coCdArr = [];
		var emailChk = true;
		var selpchChk = true;
		var emailIdx;
		var selectDt;
		debugger;
		$.each(list, function(idx, obj){
			// 매입매출 체크
			if(obj.selpchCd == "SELPCH1" || obj.selpchCd == "SELPCH3"){
				selpchChk = false;
				alert("매출계산서만 전송 가능합니다!");
				return false;
			}
			//세금계산서 발행일자 초기값 설정
			selectDt = obj.sellDt;
			if(!obj.taxBilgNo) {
				flag = true;
				alert("세금계산서 발행된 건이 아닙니다.");
				return false;
			}
	
// 			if(obj.sndYn == "Y" && ((obj.cseqRcvYn == "E") || (obj.rcvYn == "E"))){
			if(obj.sndYn == "Y" && obj.cseqRcvYn != "E"){
			}else {
				flag = true;
				alert("오류난 세금계산서만 수정해서 재전송 처리 가능합니다.");
				return false;
			}
			//국세청 접수 오류처리 건
			if (obj.rcvYn == "E"){
				flag = true;
				alert("국세청 접수 오류건은  1.상세화면에서 오류 수정, 2.국세청오류정정 실행, 3.계산서정발행 처리 단계로 처리하세요.");
				return false;				
			}
			
			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);
			if(!obj.taxRcvEmail){
				emailChk = false;
				alert("수신자 Email 입력 후 발행해 주세요.");
				emailIdx = obj.__index;
				return false;
			}

		});
		
		if(flag) {
			return;
		}; 
		var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("세금계산서를 선택해 주세요.");
			return;
		}
		if(rowLength > 1) {
			alert("세금계산서 재전송은 1건씩만 처리 가능합니다.");
			return;
		}
		if(!emailChk){
			$.each(list, function(idx, obj){
				gridView.target.select(obj.__index);
			});
			gridView.target.select(emailIdx);
			viewTaxBilgDetailModal("U");
			return false;
		}
		if(!selpchChk){
			return false;
		}
		if(!confirm(rowLength + "건을 재전송 하시겠습니까?")){
			return;
		}
		var paramObj = {
			"selectDt": selectDt,
			"sndYnDp": "Y"
		}
		openModal("/static/html/user/ar/ar04/AR0401P05.html", 600, 240, "", paramObj, function (callbackObj) {
			callbackObj.bilgCertNoArr = bilgCertNoArr;
			callbackObj.userId = jwt.userId;
			callbackObj.userNm = jwt.userNm;
			callbackObj.deptId = jwt.deptId;
			callbackObj.pgmId = "AR0401M01";
			
			postAjax("/user/ar/ar04/insertTaxHdReSend", callbackObj, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
	 				modalStack.close();
				}
			});
		});
	}
	
	// 세금계산서 발행취소
	function insertTaxHdCancel(){
		var flag = false;
		var clntFlag = false;
		var list = gridView.target.getList("selected");
		var bilgCertNoArr = [];
		var coCdArr = [];
		var emailChk = true;
		var emailIdx;
		var arrGnChk = true;
		var taxBilgChk = true;
		var eFlag = true;
		var selpchChk = true;
		$.each(list, function(idx, obj){
			if(obj.taxBilgNo) flag = true;
			if((obj.taxAdmsYn =="Y") || (obj.rcvYn == "Y" )) {
			    eFlag = false;
				alert("승인완료건은 정발행취소 처리 불가!");
				return false;
			}
			if((obj.sndYn =="Y") && (!obj.cseqRcvYn)) {
			    eFlag = false;
				alert("전송결과 확인 후 진행 가능!");
				return false;
			}
		
			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);
			// 취소의 경우 계산서 번호가 있을 경우 가능
			if(!obj.taxBilgNo){
				alert("발행된 계산서가 없습니다.");
				taxBilgChk = false;
				return false;
			}
			
			// 취소는 정발행 세금계산서만 가능
			if((obj.rffGn1Cd != "01" && obj.rffAeaCd)  || obj.bgm1225Cd != 'BGM12259'){
				arrGnChk = false;
				alert("세금계산서 종류를 확인 해 주세요.");
				return false;
			}
			
			//e-Mail 체크
			if(!obj.taxRcvEmail){
				emailChk = false;
				alert("수신자 Email 입력 후 발행해 주세요.");
				emailIdx = obj.__index;
				return false;
			}
			
			// 매입매출 체크
			if(obj.selpchCd == "SELPCH1" || obj.selpchCd == "SELPCH3"){
				selpchChk = false;
				alert("매입 매출 구분을 확인 해 주세요.");
				return false;
			}
		});
		if(!eFlag){
			return false;
		}
		if(!taxBilgChk){
			return false;
		}
		if(!arrGnChk){
			return false;
		}
		if(!emailChk){
			$.each(list, function(idx, obj){
				gridView.target.select(obj.__index);
			});
			gridView.target.select(emailIdx);
			viewTaxBilgDetailModal("U");
			return false;
		}
		if(!selpchChk){
			return false;
		}
		/* if(flag) {
			alert("이미 발행된 건이 있습니다.");
			return;
		}; */
		var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("세금계산서를 선택해 주세요.");
			return;
		}
		
		if(!confirm(rowLength + "건을 취소하시겠습니까?")){
			return;
		}
		var formData = {
			"bilgCertNoArr" : bilgCertNoArr,
			"userId" : jwt.userId,
			"userNm" : jwt.userNm,
			"deptId" : jwt.deptId,
			"pgmId" : "AR0401M01"
		}
		postAjax("/user/ar/ar04/insertTaxHdCancel", formData, null, function(data){
			alert(data.resultMessage);
			gridView.setData(0);
		});
	}

	// 수정세금계산서 발행
	var updateRffAea = "";
	function insertTaxHdUpdate(){
		var flag = false;
		var clntFlag = false;
		var list = gridView.target.getList("selected");
		var bilgCertNoArr = [];
		var coCdArr = [];
		var emailChk = true;
		var emailIdx;
		var arrGnChk = true;
		var taxBilgChk = true;
		var selectDt;
		$.each(list, function(idx, obj){
			if(!obj.taxBilgNo){
				flag = true;
				alert("정발행 계산서만 수정가능합니다!");
				return false;
			}

			//세금계산서 발행일자 초기값 설정
			selectDt = obj.sellDt;
			//gridView.target.select(obj.__index);
			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);

			// 매입매출 체크
			if(obj.selpchCd == "SELPCH1" || obj.selpchCd == "SELPCH3"){
				arrGnChk = false;
				alert("매출계산서 정발행 계산서만 수정가능합니다!");
				return false;
			}

			//역발행 체크			
			if(obj.taxBilgNo == "역발행"){
				arrGnChk = false;
				alert("역발행 확인된 세금계산서입니다 확인하세요!");
				return false;
			}

			// 수정의 경우 rffgn1 : 01, rffAea : null 이 아닌 건만 가능
			if(obj.orgnTaxBilgNo){
				arrGnChk = false;
				alert("수정발행처리된 세금계산서입니다 확인하세요!");
				return false;
			}
			if(!obj.rcvYn){
				// rcvYn값이 'NULL'이면
				arrGnChk = false;
				alert("전송 대기 중인 세금계산서입니다 확인하세요!");
				return false;
			}
			//e-Mail 체크
			if(!obj.taxRcvEmail){
				emailChk = false;
				alert("수신자 Email 입력 후 발행해 주세요.");
				emailIdx = obj.__index;
				return false;
			}
		});
		if(!arrGnChk){
			return false;
		}
		if(flag) {
				return;
		}
		if(!emailChk){
			$.each(list, function(idx, obj){
				gridView.target.select(obj.__index);
			});
			gridView.target.select(emailIdx);
			viewTaxBilgDetailModal("U");
			return false;
		}
		var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("세금계산서를 선택해 주세요.");
			return;
		}
		
		if(!confirm(rowLength + "건을 수정발행 하시겠습니까?")){
			return;
		}
		var paramObj = {
			"selectDt": selectDt
		}
		openModal("/static/html/user/ar/ar04/AR0401P04.html", 600, 340, "", paramObj, function (callbackObj) {
			callbackObj.bilgCertNoArr = bilgCertNoArr;
			callbackObj.userId = jwt.userId;
			callbackObj.userNm = jwt.userNm;
			callbackObj.deptId = jwt.deptId;
			callbackObj.pgmId = "AR0401M01";
			
			postAjax("/user/ar/ar04/insertTaxHdUpdate", callbackObj, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
	 				modalStack.close();
				}
			});
		});
	}
	
	// 역발행 확인
	function updateTaxHdRvrs(){
		var rowLength = gridView.target.getList("selected").length;
		var flag = false;
		var bilgCertNoArr = [];
		var coCdArr = [];
		var selectDt = "";
		var list = gridView.target.getList("selected");
		if(rowLength > 1){
			alert("세금계산서 역발행은 한건씩 가능합니다.");
			return false;
		}
		$.each(list, function(idx, obj){
			
			if(obj.taxBilgNo) {
				flag = true;
				alert("처리 완료된 계산서 입니다. 역발행 처리 불가!");
				return false;
			}
			
			// 수정세금계산서일때 세금계산서 번호가 없으면 역발행 가능하도록 조건 변경!
			if(obj.rffAea && obj.taxBilgNo) {
				flag = true;
				alert("수정세금계산서는 역발행 처리할 수 없습니다.");
				return false;
			}
			
			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);

			//세금계산서 발행일자 초기값 설정
			if (!selectDt) {
				selectDt = obj.sellDt;
			}
			
			if (selectDt.slice(0, 7) != obj.sellDt.slice(0, 7)){
				flag = true;
				alert("매출년월이 다릅니다. 동일 년월로 계산서 처리 불가!");
				return false;
			}
		});
		
		if(flag) {
			return;
		};
		var rowLength = gridView.target.getList("selected").length;
		if(rowLength == 0) {
			alert("역발행 확정 대상 자료를 선택해 주세요.");
			return;
		}
		
// 		if(!confirm(rowLength + "건을 역발행 처리 하시겠습니까?")){
// 			return;
// 		}
		
		var paramObj = {
			"selectDt": selectDt,
			"sndYnDp": "N"
		}
		openModal("/static/html/user/ar/ar04/AR0401P05.html", 600, 240, "", paramObj, function (callbackObj) {
			callbackObj.bilgCertNoArr = bilgCertNoArr;
			callbackObj.userId = jwt.userId;
			callbackObj.userNm = jwt.userNm;
			callbackObj.deptId = jwt.deptId;
			callbackObj.pgmId = "AR0401M01";
			
			postAjax("/user/ar/ar04/updateBilgRvrs", callbackObj, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					gridView.setData(0);
	 				modalStack.close();
				}
			});
		});
	}
	
	// 역발행 취소
	function updateTaxHdRvrsCancel(){
		var flag = false;
		var bilgCertNoArr = [];
		var coCdArr = [];
		var list = gridView.target.getList("selected");
		$.each(list, function(idx, obj){
			if(obj.taxBilgNo == "역발행") flag = true;

			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);
		});
		

		if(!flag) {
			alert("역발행 확인 계산서만 역발행 취소 처리 가능합니다!");
			return;
		};
		
		var rowLength = gridView.target.getList("selected").length;
		
		if(rowLength == 0) {
			alert("역발행 확정 대상 세금계산서를 선택해 주세요.");
			return;
		}
		
		if(!confirm(rowLength + "건을 역발행 취소 처리 하시겠습니까?")){
			return;
		}
		var formData = {
			"bilgCertNoArr" : bilgCertNoArr,
			"userId" : jwt.userId,
			"userNm" : jwt.userNm,
			"deptId" : jwt.deptId,
			"pgmId" : "AR0401M01"
		}
		postAjax("/user/ar/ar04/updateBilgRvrsCancel", formData, null, function(data){
			alert(data.resultMessage);
			gridView.setData(0);
		});
	}
	
	// 국세청오류 정정
	function updateTaxHdRvrsCancel2(){
		var flag = false;
		var bilgCertNoArr = [];
		var coCdArr = [];
		var list = gridView.target.getList("selected");
		debugger;
		
		$.each(list, function(idx, obj){
			if(obj.rcvYn != "E") {
				alert("국세청 오류 확인 계산서만 취소 처리 가능합니다!");
				flag = false;
				return false;
			}
			if(obj.rcvYn == "E") flag = true; 
			bilgCertNoArr.push(obj.bilgCertNo + "," + obj.coCd);
		});
		
		if(!flag) {
			return;
		};
		
		var rowLength = gridView.target.getList("selected").length;
		
		if(rowLength == 0) {
			alert("국세청 오루 확인 대상 세금계산서를 선택해 주세요.");
			return;
		}
		
		if(rowLength > 1) {
			alert("국세청 오루 확인은 1건식 처리 가능합니다.");
			return;
		}
		
		if(!confirm(rowLength + "건을 국체청 오류 확정 처리 하시겠습니까?")){
			return;
		}
		var formData = {
			"bilgCertNoArr" : bilgCertNoArr,
			"userId" : jwt.userId,
			"userNm" : jwt.userNm,
			"deptId" : jwt.deptId,
			"pgmId" : "AR0401M01"
		}
		postAjax("/user/ar/ar04/updateBilgRvrsCancel", formData, null, function(data){
			alert(data.resultMessage);
			gridView.setData(0);
		});
	}
	
	// 계산서 인쇄
	function setReportMain() {
		var flag = false;
		var coFlag = false;
		var errFlag = false;
		var list = gridView.target.getList("selected");
		var bilgCertNoArr = "";
	
		$.each(list, function(idx, obj) {
			if (obj.taxBilgNo == "역발행" ) {
				errFlag = true;
				alert("역발행 세금계산서는 발행할 수 없습니다!");
				return;
			}
			if (!obj.taxBilgNo) {
				errFlag = true;
				alert("세금계산서 정발행 후 출력 할 수 있습니다.");
				return;
			}
			if (!flag){
				flag = true;
				bilgCertNoArr = obj.bilgCertNo;

			} else {
				bilgCertNoArr = bilgCertNoArr + "," + obj.bilgCertNo;
			}
		});

		if (errFlag) {
			return;
		}

		if (!flag) {
			alert("세금계산서 발행대상이 선택되지 않았습니다.");
			return;
		}
		
		var fileName = "AR0401M01.jrf";
		var arg =  "#ar_idx#"		+ bilgCertNoArr
		         + "#";

		callReport(fileName, arg, 1040, 720);
	}
</script>

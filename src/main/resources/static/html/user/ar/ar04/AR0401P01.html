<body>
  <div id="cplrUntpcDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">계산서 관리</h4>
    </div>

    <div class="popup_table">
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="4%">
	                <col width="12%">
	                <col width="">
	                <col width="4%">
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th colspan="2" class="hit">매출일자</th>
	                <td>
	                	<input type="text" id="sellDt" name="sellDt" class="" required="required" readonly="readonly">
	                </td>
	                <th colspan="2" class="hit">매입/매출구분</th>
	                <td>                                
                    	<select id="selpchCd" name="selpchCd" data-kind="SELPCH" required="required" disabled>
	                    	<option value="">선택</option>
	                    </select>
	                </td>
	                <th class="hit">거래처명</th>
	                <td>                                
	                    <input type="hidden" id="clntCd" name="clntCd" required="required" disabled>
		                <div class="search_form" style="width: 100%;">
				            <input type="text" id="clntNm" name="clntNm" readonly="readonly" disabled>
				            <a id="btnClnt" onclick="clntSearch('S');"><i class="i_search_w"></i></a>
			            </div>
	                </td>
	            </tr>
	            <tr>
	                <th colspan="2">세금계산서번호</th>
	                <td>     
	                	<input type="text" id="taxBilgNo" name="taxBilgNo" style="width: 100%;" maxlength="20"readonly="readonly">   
	                </td>
	                <th colspan="2" class="hit">영수/청구 구분</th>
	                <td>	                    
	                    <select id="rffCno" name="rffCno" data-kind="PAYDIV" required="required">
	                    	<option value="">선택</option>
	                    </select>
	                </td>
	                <th id="rffAeaTh" class="hit">전자세금계산서 수정사유 코드</th>
	                <td>             
	                    <select id="rffAea" name="rffAea" data-kind="RFFAEA" required="required">
	                    	<option value="">선택</option>
	                    </select>
	                </td>
	            </tr>
	            <tr>
	                <th colspan="2" class="hit">공급가액 합계</th>
	                <td style="border-left: 0px !important;">
	                	<input type="text" id="taxMoa523" name="taxMoa523" style="width: 100%;" onkeyup="addComma(this);" comma required="required" readonly="readonly">   
	                </td>
	                <th colspan="2" class="hit">부가세액 합계</th>
	                <td style="border-left: 0px !important;">
	                	<input type="text" id="taxMoa5124" name="taxMoa5124" style="width: 100%;" onkeyup="addComma(this);" comma required="required" readonly="readonly">  
	                </td>
	                <th class="hit">총금액</th>
	                <td style="border-left: 0px !important;">
	                	<input type="text" id="taxMoa5388" name="taxMoa5388" style="width: 100%;" onkeyup="addComma(this);" comma required="required" readonly="readonly">  
	                </td>
	            </tr>
	            <tr>
	            	<th rowspan="6">공급자</th>
	            	<th class="hit">발행법인</th>
	            	<td>
	            		<input type="text" id="taxivcCoprt" name="taxivcCoprt" style="width: 100%;" required="required" onkeyup="onlyNumber(this)" maxlength="22"> 
	            	</td>
	            	<th rowspan="6">공급받는자</th>
	            	<th class="hit">타입</th>
	            	<td>
	            		<select id="ctaivBj1" name="ctaivBj1" style="width: 100%;" required="required"> 
	            			<option value="">선택</option> 
	            			<option value="01">사업자등록번호</option> 
	            			<option value="02">주민등록번호</option> 
	            			<option value="03">외국인</option>
	            		</select>
	            	</td>
	            	<th  class="hit">수신담당자명</th>
	            	<td>
	                    <input type="hidden" id="taxRcvSn" name="taxRcvSn">
	            		<div class="search_form" style="width: 100%;">
				            <input type="text" id="taxRcvNm" name="taxRcvNm" required="required">
				            <a id="btnRcv" onclick="rcvNmSearch();"><i class="i_search_w"></i></a>
			            </div>
			        </td>
	            </tr>
	            <tr>
	            	<th class="hit">사업자번호</th>
	            	<td>
	            		<input type="text" id="taxivcCoprtNo" name="taxivcCoprtNo" style="width: 100%;" required="required" maxlength="20" onkeyup="crnFormatter(this)"> 
	            	</td>
	            	<th class="hit">사업자번호</th>
	            	<td>
	            		<input type="text" id="taxivcRcvCrn" name="taxivcRcvCrn" style="width: 100%;" required="required" maxlength="12" onkeyup="crnFormatter(this)"> 
	            	</td>
	            	<th  class="hit">수신자 이메일</th>
	            	<td>
	            		<input type="text" id="taxRcvEmail" name="taxRcvEmail" style="width: 100%;" maxlength="40" required="required"> 
	            	</td>
	            </tr>
	            <tr>
	            	<th class="hit">대표자</th>
	            	<td>
	            		<input type="text" id="taxivcCoprtCeo" name="taxivcCoprtCeo" style="width: 100%;" required="required" maxlength="10"> 
	            	</td>
	            	<th class="hit">대표자</th>
	            	<td>
	            		<input type="text" id="taxivcRcvCeo" name="taxivcRcvCeo" style="width: 100%;" required="required" maxlength="10"> 
	            	</td>
	            	<th>수신자 이메일2</th>
	            	<td>
	            		<input type="text" id="taxRcvEmail2" name="taxRcvEmail2" style="width: 100%;" maxlength="40"> 
	            	</td>
	            </tr>
	            <tr>
	            	<th class="hit">상호</th>
	            	<td>
	            		<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" style="width: 100%;" required="required" maxlength="35"> 
	            	</td>
	            	<th class="hit">주소</th>
	            	<td>
	            		<input type="text" id="taxivcRcvAddr" name="taxivcRcvAddr" style="width: 100%;" required="required" maxlength="50"> 
	            	</td>
	            	<th>수신자팩스번호</th>
	            	<td>
	            		<input type="text" id="taxRcvFax" name="taxRcvFax" style="width: 100%;" maxlength="50" onkeyup="onlBkac(this)"> 
	            	</td>
	            </tr>
	            <tr>
	            	<th class="hit">업태명</th>
	            	<td>
	            		<input type="text" id="taxCoprtBizcon" name="taxCoprtBizcon" style="width: 100%;" required="required" maxlength="25"> 
	            	</td>
	            	<th class="hit">업태명</th>
	            	<td>
	            		<input type="text" id="taxivcRcvBizcon" name="taxivcRcvBizcon" style="width: 100%;" required="required" maxlength="25"> 
	            	</td>
	            	<th>수신자전화번호</th>
	            	<td>
	            		<input type="text" id="taxRcvTel" name="taxRcvTel" style="width: 100%;" maxlength="20" onkeyup="telNumberFormatter(this)"> 
	            	</td>
	            </tr>
	            <tr>
	            	<th class="hit">업종명</th>
	            	<td>
	            		<input type="text" id="taxvicCoprtBsty" name="taxvicCoprtBsty" style="width: 100%;" required="required" maxlength="20"> 
	            	</td>
	            	<th class="hit">업종명</th>
	            	<td>
	            		<input type="text" id="taxivcRcvBsty" name="taxivcRcvBsty" style="width: 100%;" required="required" maxlength="20"> 
	            	</td>
	            	<th>수신자휴대전화</th>
	            	<td>
	            		<input type="text" id="taxMoblphon" name="taxMoblphon" style="width: 100%;" maxlength="20" onkeyup="telNumberFormatter(this)"> 
	            	</td>
	            </tr>
	            <tr>
	            	<th colspan="2">비고1</th>
	            	<td colspan="6"><input type="text" id="ftxac11" name="ftxac11" style="width: 100%;" maxlength="75"> </td>
	            </tr>
	            <tr>
	            	<th colspan="2">비고2</th>
	            	<td colspan="6"><input type="text" id="ftxac21" name="ftxac21" style="width: 100%;" maxlength="75" > </td>
	            </tr>
	            <tr>
	            	<th colspan="2">비고3</th>
	            	<td colspan="6"><input type="text" id="ftxac31" name="ftxac31" style="width: 100%;"  maxlength="75"> </td>
	            </tr>
	        </table>
			<table>
				<tr>
					<td colspan="2" style="text-align: LEFT; border-right: 0;">세금계산서 상세 내역</td>
					<td colspan="9">
						<div class="add_btn">
							<a onclick="addRow();">+</a> 
							<a onclick="removeDetailRow();">-</a>
						</div>
					</td>
				</tr>
			</table>
			<table id="detailTb">
	            <colgroup>
	            	<col width="2%">
	                <col width="6%">
	                <col width="12%">
	                <col width="13%">
	                <col width="6%">
	                <col width="6%">
	                <col width="10%">
	                <col width="10%">
	                <col width="10%">
	                <col width="10%">
	                <col width="10%">
	                <col width="4%">
	            </colgroup>
				<tr>
					<th class="tc"></th>
					<th class="hit">순번</th>
					<th class="tc">구입일자</th>
					<th class="tc">품목명</th>
					<th class="tc">코드</th>
					<th class="tc">규격</th>
					<th class="tc">수량</th>
					<th class="tc">단가</th>
					<th class="tc">공급가액</th>
					<th class="tc">세액</th>
					<th class="tc">비고</th>
					<th class="tc"></th>
				</tr>
				<tr class="detailRow" name="detailRow">
					<td><input type="checkbox" name="detailChkBox"></td>
					<td><input type="text" id="ard113a" name="ard113a" style="text-align:center" comma onkeyup="addComma(this);" readonly></td>
					<td><input type="text" class="input_calendar" id="moa95004" name="moa95004" style="text-align:center"></td>
					<td><input type="text" id="ard5006" name="ard5006" style="text-align:left" maxLength="50"></td>
					<td><input type="text" id="mea106154" name="mea106154" style="text-align:center" maxLength="25"></td>
					<td><input type="text" id="dms1056" name="dms1056" style="text-align:center" maxLength="30"></td>
					<td><input type="text" id="mea106314" name="mea106314" style="text-align:right" comma onkeyup="addComma(this);" maxLength="9"></td>
					<td><input type="text" id="moa10146" name="moa10146" style="text-align:right" comma onkeyup="addComma(this);" maxLength="13"></td>
					<td><input type="text" id="moa1023" name="moa1023" style="text-align:right" comma onkeyup="addComma(this);" maxLength="13"></td>
					<td><input type="text" id="moa10124" name="moa10124" style="text-align:right" comma onkeyup="addComma(this);" maxLength="13"></td>
					<td><input type="text" id="dms1000" name="dms1000" style="text-align:left" maxLength="50"></td>
					<td><div><a name="copyRow" onclick="copyRow(this);">복사</a></div> </td>
				</tr>
			</table>	        
			
			<table>
	            <colgroup>
	                <col width="16%">
	                <col width="*">
	            </colgroup>
				<tr>
					<th>에러내용</th>
					<td><input type="text" id="errCnts" name="errCnts" readonly/></td>
				</tr>
			</table>
	        
    		<input type="hidden" id="coCd" name="coCd">
    		<input type="hidden" id="clntCd" name="clntCd">
    		<input type="hidden" id="bilgCertNo" name="bilgCertNo">
    		<input type="hidden" id="cseqRcvYn" name="cseqRcvYn">
	        <input type="hidden" id="userId" name="userId">
	        <input type="hidden" id="pgmId" name="pgmId" value="AR0401P01">
	    </form>
    </div>

    <br>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionBtn"></button>
      <button class="close_btn" onclick="taxReport();">계산서출력</button>
      <button class="close_btn" onclick="modalClose();">닫기</button>
    </div>
  </div>
 
</body>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var selectedIdx = 0;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));

		$('[name=moa95004]').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		setInit();
	});
	
	function setInit() {
		$('#actionBtn').on("click", function(){updateTaxBilg();});
		$('#actionBtn').text("저장");
		selectTaxBilg();
	}
		
	function makeFormData(){
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		var formData = new FormData($("#popForm")[0]);
		

		// 상세 추가
		var detailArr = [];
		$.each($(".detailRow"), function(idx, elem){
			var detailObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				detailObj[elem.name] = elem.value;
			});
			detailArr.push(detailObj);
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}
	
	function selectTaxBilg(){
		var row = gridView.target.getList("selected")[0];
		$('#popForm #bilgCertNo').val(row.bilgCertNo);
		var formData = {
				"bilgCertNo" : row.bilgCertNo
		}
		if(row.rffGn1 != "RFFGN102"){
			$("#popForm #rffAea").removeAttr("required");
			$("#popForm #rffAeaTh").removeClass("hit");
			$("#popForm #rffAea").removeAttr("disabled");
		} else {
			$("#popForm #rffAea").attr("disabled", "disabled");
		}
		postAjax("/user/ar/ar04/selectTaxBilg", formData, null, function(data){
			setTaxBilgInfo(data.result);
			setTaxBilgDetailInfo(data.dtlResult);
		});
	}
	
	function setTaxBilgInfo(obj){
		
		//메인정보 세팅
		$.each(obj, function(key, value){
			$('#popForm #'+key).val(value);
		});
		
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		if(obj.taxAdmsYn == "Y"){
			$("#popForm #rffAea").removeAttr("disabled");
		} else {
			$("#popForm #rffAea").attr("disabled", "disabled");
		}
		
		if(obj.sndYn == "Y"){
			$("#popForm input").prop("disabled", true);
			$("#popForm select").prop("disabled", true);
			$("#popForm #btnClnt").removeAttr("onclick");
			$("#popForm #taxRcvNm").prop("disabled", false);
			$("#popForm #taxRcvEmail").prop("disabled", false);
			$("#popForm #taxRcvEmail2").prop("disabled", false);
			$("#popForm #taxRcvFax").prop("disabled", false);
			$("#popForm #taxRcvTel").prop("disabled", false);
			$("#popForm #taxMoblphon").prop("disabled", false);
			$("#popForm #rffAea").prop("disabled", false);
		}
	}
	
	function setTaxBilgDetailInfo(obj){
		for(var i = 0; i < obj.length; i++){
			//메인정보 세팅
			if(i != 0) addRow();
			$.each(obj[i], function(key, value){
				$('#popForm #'+key).eq(i).val(value);
			});
		}
		
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		setDetailRowNum();
	}
	
	//문자열 자르기
	function cutStr(str, maxByte) {
	
		for(b=i=0;c=str.charCodeAt(i);) {
	      b+=c>>7?2:1;
	      if (b > maxByte)
	      break;
	      i++;
	    }
	  	return str.substring(0,i);
	 }
	function updateTaxBilg() {
		if ($("#popForm #taxRcvEmail").val() == "") {
			alert("수신담당자는 정보는 필수입니다.");
			return;
		}
		if ($("#popForm #taxRcvNm").val() == "") {
			alert("수신담당자 이름 정보는 필수입니다.");
			return;
		}
		var moa1023Sum = 0;
		var moa10124Sum = 0;
		$.each($('#detailTb tr[name="detailRow"]'), function(idx, elem) {
			moa1023Sum += Number(deleteCommaStr($(elem).find("input[name='moa1023']").val()));
			moa10124Sum += Number(deleteCommaStr($(elem).find("input[name='moa10124']").val()));
			$(elem).find("input[name='dms1000']").val(cutStr($(elem).find("input[name='dms1000']").val(),100));  
		});

		//비고 문자열 길이 150byte로 자르기
		$("#ftxac11").val(cutStr($("#ftxac11").val(),150));
		$("#ftxac21").val(cutStr($("#ftxac21").val(),150));
		$("#ftxac31").val(cutStr($("#ftxac31").val(),150));

		if(Number(deleteCommaStr($("#taxMoa523").val())) != moa1023Sum){
			alert("공급가액 합계가 상세 내역과 불일치 합니다.");
			return false;
		}
		
		if(Number(deleteCommaStr($("#taxMoa5124").val())) != moa10124Sum){
			alert("공급세액 합계가 상세 내역과 불일치 합니다.");
			return false;
		}
		if(inputValidation($('[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/ar/ar04/updateTaxBilg", formData, function(data){
				alert(data.resultMessage);    
				if(data.resultCode == "200"){
					gridView.setData(0);
					modal.close();
				}
			});
		}
		
	}

	// 수신담당자검색
	function rcvNmSearch() {
		/* if($("#popForm #coCd").val() == ""){
			
		}
		if($("#popForm #coCd").val() == ""){
			
		} */
		openSecondModal("/static/html/user/ar/ar04/AR0401P03.html", 1000, 420, "수신담당자검색");
		
	}
	
	// 거래처
	function clntSearch(type) {
		actionTp = type;
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#popForm #taxivcRcvCrn').val(row.crn);
			$('#popForm #taxivcRcvCeo').val(row.repstNm);
			$('#popForm #taxivcRcvAddr').val(row.bizAddr);
			$('#popForm #taxivcRcvBizcon').val(row.bizconNm);
			$('#popForm #taxivcRcvBsty').val(row.bstyNm);
			$('#popForm #clntCd').val(row.clntCd);
			$('#popForm #clntNm').val(row.clntNm);
		});
	}

	function modalClose(){
		gridView.setData(0);
		modal.close();
	}

	function taxReport() {

		var fileName = "AR0401M01.jrf";
		var arg =  "#ar_idx#"		+ $('#bilgCertNo').val()
		         + "#";

		callReport(fileName, arg, 1040, 720);
	}	

	
	//list 행추가
	function addRow() {
		if($("[name=detailRow]").length > 3){
			alert("상세 내역은 4건 까지 입력 할 수 있습니다.");
			return false;
		}
		var row = $("#detailTb > tbody:last > tr:last").clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			this.value = '';
			this.checked = '';
			$(this).prop("disabled", false);
		});
		setDetailRowNum();
		return $("tr[name='tableCd']:last")[0];
	}
	
	//list 행추가
	function copyRow(elem) {
		if($("[name=detailRow]").length > 3){
			alert("상세 내역은 4건 까지 입력 할 수 있습니다.");
			return false;
		}
		var row = $(elem).closest('tr').clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			$(this).prop("disabled", false);
		});
		setDetailRowNum()
		return $("tr[name='tableCd']:last")[0];
	}
	
	//list 행삭제	
	function removeDetailRow(){
		$.each($('input:checkbox[name="detailChkBox"]'), function(idx, elem){
			if($(elem).is(":checked")){
				$(elem).closest('.detailRow').remove();
			}
		});
		setDetailRowNum();
	}
	
	function setDetailRowNum(){
		$.each($('input[name="ard113a"]'), function(idx, elem){
			$(elem).val(idx+1);
		});
	}
</script>

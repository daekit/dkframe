<div id="cplrUntpcDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">계산서 관리</h4>
	</div>
	<div class="popup_table">
		<form id="popForm">
			<span style="text-align: right">※거래명세서 전송 여부 :
				<select id="invSndYn" name="invSndYn">
					<option value="Y">전송</option>
					<option value="N">미전송</option>
				</select>
			</span>
			<table>
				<colgroup>
					<col width="4%">
					<col width="12%">
					<col width="">
					<col width="4%">
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
				</colgroup>
				<tr>
					<th colspan="2" class="hit">매출일자</th>
					<td>
						<input type="text" id="sellDt" name="sellDt" required readonly>
					</td>
					<th colspan="2" class="hit">매입/매출구분</th>
					<td>
						<select id="selpchCd" name="selpchCd" data-kind="SELPCH" required disabled>
							<option value="">선택</option>
						</select>
					</td>
					<th class="hit">거래처명</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd" required>
						<div class="search_form">
							<input type="text" id="clntNm" name="clntNm" readonly> 
						</div>
					</td>
				</tr>
				<tr>
					<th colspan="2">원본계산서번호</th>
					<td>
						<input type="text" id="orgnTaxBilgNo" name="orgnTaxBilgNo">
					</td>
					<th colspan="2" class="hit">계산서종류</th>
					<td>
						<select id="rffGn1" name="rffGn1" required>
							<option value="RFFGN101" data-etc="01" data-desc="세금계산서종류">세금계산서</option>
							<option value="RFFGN102" data-etc="02" data-desc="세금계산서종류">수정세금계산서</option>
						</select>
					</td>
					<th id="rffAeaTh">전자세금계산서 수정사유 코드</th>
					<td>
						<select id="rffAea" name="rffAea" data-kind="RFFAEA">
							<option value="">선택</option>
						</select>
					</td>
				</tr>
				<tr>
					<th colspan="2">세금계산서번호</th>
					<td>
						<input type="text" id="taxBilgNo" name="taxBilgNo" style="width: 100%;" maxlength="20" readonly>
					</td>
					<th colspan="2" class="hit">영수/청구 구분</th>
					<td>
						<select id="rffCno" name="rffCno" data-kind="PAYDIV" required>
							<option value="">선택</option>
						</select>
					</td>
					<th>국세청승인번호</th>
					<td>
						<input type="text" id="rcvProcId" name="rcvProcId" readonly />
					</td>
				</tr>
				<tr>
					<th colspan="2" class="hit">공급가액 합계</th>
					<td style="border-left: 0px !important;">
						<input type="text" id="taxMoa523" name="taxMoa523" required readonly comma>
					</td>
					<th colspan="2" class="hit">부가세액 합계</th>
					<td style="border-left: 0px !important;">
						<input type="text" id="taxMoa5124" name="taxMoa5124" required readonly comma>
					</td>
					<th class="hit">총금액</th>
					<td style="border-left: 0px !important;">
						<input type="text" id="taxMoa5388" name="taxMoa5388" required readonly comma>
					</td>
				</tr>
				<tr>
					<th rowspan="6">공급자</th>
					<th class="hit">발행법인</th>
					<td>
						<input type="hidden" id="taxivcCoprt" name="taxivcCoprt" required>
						<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" required readonly>
					</td>
					<th rowspan="6">공급받는자</th>
					<th class="hit">타입</th>
					<td>
						<select id="ctaivBj1" name="ctaivBj1" required>
							<option value="">선택</option>
							<option value="01">사업자등록번호</option>
							<option value="02">주민등록번호</option>
							<option value="03">외국인</option>
						</select>
					</td>
					<th class="hit">수신담당자명</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="taxRcvSn" name="taxRcvSn">
							<input type="text" id="taxRcvNm" name="taxRcvNm" required> 
							<a id="btnRcv" onclick="rcvNmSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				<tr>
					<th class="hit">사업자번호</th>
					<td>
						<input type="text" id="taxivcCoprtNo" name="taxivcCoprtNo" maxlength="20" onkeyup="crnFormatter(this)" required>
					</td>
					<th class="hit">사업자번호</th>
					<td>
						<input type="text" id="taxivcRcvCrn" name="taxivcRcvCrn" maxlength="12" onkeyup="crnFormatter(this)" required>
					</td>
					<th class="hit">수신자 이메일</th>
					<td>
						<input type="text" id="taxRcvEmail" name="taxRcvEmail" maxlength="40" onkeyup="exceptKorean(this);" required>
					</td>
				</tr>
				<tr>
					<th class="hit">대표자</th>
					<td>
						<input type="text" id="taxivcCoprtCeo" name="taxivcCoprtCeo" maxlength="10" required>
					</td>
					<th class="hit">대표자</th>
					<td>
						<input type="text" id="taxivcRcvCeo" name="taxivcRcvCeo" maxlength="10" required>
					</td>
					<th>수신자 이메일2</th>
					<td>
						<input type="text" id="taxRcvEmail2" name="taxRcvEmail2" maxlength="40">
					</td>
				</tr>
				<tr>
					<th class="hit">상호</th>
					<td>
						<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" maxlength="35" required>
					</td>
					<th class="hit">주소</th>
					<td>
						<input type="text" id="taxivcRcvAddr" name="taxivcRcvAddr" maxlength="50" required>
					</td>
					<th>수신자팩스번호</th>
					<td>
						<input type="text" id="taxRcvFax" name="taxRcvFax" maxlength="50" onkeyup="telNumberFormatter(this);">
					</td>
				</tr>
				<tr>
					<th class="hit">업태명</th>
					<td>
						<input type="text" id="taxCoprtBizcon" name="taxCoprtBizcon" maxlength="25" required>
					</td>
					<th class="hit">업태명</th>
					<td>
						<input type="text" id="taxivcRcvBizcon" name="taxivcRcvBizcon" maxlength="25" required>
					</td>
					<th>수신자전화번호</th>
					<td>
						<input type="text" id="taxRcvTel" name="taxRcvTel" maxlength="20" onkeyup="telNumberFormatter(this)">
					</td>
				</tr>
				<tr>
					<th class="hit">업종명</th>
					<td>
						<input type="text" id="taxvicCoprtBsty" name="taxvicCoprtBsty" maxlength="20" required>
					</td>
					<th class="hit">업종명</th>
					<td>
						<input type="text" id="taxivcRcvBsty" name="taxivcRcvBsty" maxlength="20" required>
					</td>
					<th>수신자휴대전화</th>
					<td>
						<input type="text" id="taxMoblphon" name="taxMoblphon" maxlength="20" onkeyup="telNumberFormatter(this)">
					</td>
				</tr>
				<tr>
					<th colspan="2">비고1</th>
					<td colspan="6">
						<input type="text" id="ftxac11" name="ftxac11" maxlength="75">
					</td>
				</tr>
				<tr>
					<th colspan="2">비고2</th>
					<td colspan="6">
						<input type="text" id="ftxac21" name="ftxac21" maxlength="75">
					</td>
				</tr>
				<tr>
					<th colspan="2">비고3</th>
					<td colspan="6">
						<input type="text" id="ftxac31" name="ftxac31" maxlength="75">
					</td>
				</tr>
			</table>
			<table>
				<tr>
					<td colspan="2" style="text-align: LEFT; border-right: 0;">세금계산서 상세 내역</td>
					<td colspan="9">
						<div class="add_btn">
							<a onclick="addRow();" authchk>+</a> 
							<a onclick="removeDetailRow();" authchk>-</a>
						</div>
					</td>
				</tr>
			</table>
			<table id="detailTb">
				<colgroup>
					<col width="2%">
					<col width="6%">
					<col width="12%">
					<col width="14%">
					<col width="6%">
					<col width="6%">
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="9%">
					<col width="14%">
					<col width="4%">
				</colgroup>
				<tr>
					<th class="tc"></th>
					<th class="tc">순번</th>
					<th class="tc">구입일자</th>
					<th class="tc hit">품목명</th>
					<th class="tc">코드</th>
					<th class="tc">규격</th>
					<th class="tc hit">수량</th>
					<th class="tc">단가</th>
					<th class="tc">공급가액</th>
					<th class="tc">세액</th>
					<th class="tc">비고</th>
					<th class="tc"></th>
				</tr>
				<tr class="detailRow" name="detailRow">
					<td>
						<input type="checkbox" name="detailChkBox">
					</td>
					<td>
						<input type="text" class="tc" id="ard113a" name="ard113a" readonly>
					</td>
					<td>
						<input type="text" class="input_calendar" id="moa95004" name="moa95004">
					</td>
					<td>
						<input type="text" id="ard5006" name="ard5006" maxLength="50" msg="품목명" required>
					</td>
					<td>
						<input type="text" class="tc" id="mea106154" name="mea106154" maxLength="25">
					</td>
					<td>
						<input type="text" class="tc" id="dms1056" name="dms1056" maxLength="30">
					</td>
					<td>
						<input type="text" class="tr" id="mea106314" name="mea106314" onkeyup="onlyNumber(this);" maxLength="9"  msg="수량" comma required>
					</td>
					<td>
						<input type="text" class="tr" id="moa10146" name="moa10146" onkeyup="onlyNumber(this);" maxLength="13" comma>
					</td>
					<td>
						<input type="text" class="tr" id="moa1023" name="moa1023" onkeyup="onlyNumber(this); calMoa10124(this);" maxLength="13" comma>
					</td>
					<td>
						<input type="text" class="tr" id="moa10124" name="moa10124" onkeyup="onlyNumber(this);" maxLength="13" comma>
					</td>
					<td>
						<input type="text" id="dms1000" name="dms1000" maxLength="50">
					</td>
					<td>
						<div>
							<a name="copyRow" onclick="copyRow(this);" authchk>복사</a>
						</div>
					</td>
				</tr>
			</table>

			<table>
				<colgroup>
					<col width="16%">
					<col width="*">
				</colgroup>
				<tr>
					<th>에러내용</th>
					<td><input type="text" id="errCnts" name="errCnts" readonly /></td>
				</tr>
			</table>

			<input type="hidden" id="coCd" name="coCd"> 
			<input type="hidden" id="clntCd" name="clntCd">
			<input type="hidden" id="bilgCertNo" name="bilgCertNo">
			<input type="hidden" id="cseqRcvYn" name="cseqRcvYn">
			<input type="hidden" id="userId" name="userId"> 
			<input type="hidden" id="pgmId" name="pgmId" value="AR0401P01">
		</form>
	</div>

	<br>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="actionBtn" authchk></button>
		<button class="close_btn" onclick="taxReport();" authchk>계산서출력</button>
		<button class="close_btn" onclick="modalClose();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var selectedIdx = 0;
	
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));

		$('[name=moa95004]').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		})
		setInit();
		
		authChk("AR0401M01");
	});
	
	function setInit() {
		$('#actionBtn').on("click", function(){updateTaxBilg();});
		$('#actionBtn').text("저장");
		selectTaxBilg();
	}
		
	function makeFormData(){
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		var formData = new FormData($("#popForm")[0]);
		

		// 상세 추가
		var detailArr = [];
		$.each($(".detailRow"), function(idx, elem){
			var detailObj = {};
			$.each($(elem).find('[name]'), function(idx, elem){
				detailObj[elem.name] = elem.value;
			});
			detailArr.push(detailObj);
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}
	
	function selectTaxBilg(){
		var row = gridView.target.getList("selected")[0];
		$('#popForm #bilgCertNo').val(row.bilgCertNo);
		var formData = {
			"bilgCertNo" : row.bilgCertNo
		}
		postAjax("/user/ar/ar04/selectTaxBilg", formData, null, function(data){
			setTaxBilgInfo(data.result);
			setTaxBilgDetailInfo(data.dtlResult);
		});
	}
	
	function setTaxBilgInfo(obj){
		
		//메인정보 세팅
		$.each(obj, function(key, value){
			$('#popForm #'+key).val(value);
		});
		
		$.each($('input[comma]'), function(idx, elem){
			onlyNumber(elem);
		});
		
		
		// 공급받는자 담당자의 승인여부 : 현재는 사용안함 bypass
// 		if(obj.taxAdmsYn == "Y"){
// 			$("#popForm #rffAea").prop("disabled", false);
// 		}
		
		// 수정세금계산서 수정사유 코드 필수값 설정
// 		if(obj.rffGn1 == "RFFGN102"){
// 			$('#rffAeaTh').addClass("hit");
// 			$('#rffAea').prop("required", true);
// 			$('#rffAea').prop("disabled", false);
// 		}
		
		// sndYn: 전송여부
		// cseqRcvYn: 계산서 전송결과 여부
// 		if(obj.sndYn == "Y" && obj.cseqRcvYn == "Y"){
		if(obj.sndYn == "Y" && obj.cseqRcvYn != "E"){
			$("#popForm input").prop("disabled", true);
			$("#popForm select").prop("disabled", true);
			$("#actionBtn").hide();
// 			$("#popForm #btnClnt").removeAttr("onclick");
// 			$("#popForm #taxRcvNm").prop("disabled", false);
// 			$("#popForm #taxRcvEmail").prop("disabled", false);
// 			$("#popForm #taxRcvEmail2").prop("disabled", false);
// 			$("#popForm #taxRcvFax").prop("disabled", false);
// 			$("#popForm #taxRcvTel").prop("disabled", false);
// 			$("#popForm #taxMoblphon").prop("disabled", false);
		}
		
		if(obj.selpchCd == "SELPCH1" || obj.selpchCd == "SELPCH3"){
			$("#popForm input").prop("disabled", true);
			$("#popForm select").prop("disabled", true);
			$("#actionBtn").hide();
		}
	}
	
	function setTaxBilgDetailInfo(obj){
		for(var i = 0; i < obj.length; i++){
			//메인정보 세팅
			if(i != 0) addRow();
			$.each(obj[i], function(key, value){
				$('#popForm #'+key).eq(i).val(value);
			});
		}
		
		$.each($('input[comma]'), function(idx, elem){
			onlyNumber(elem);
		});
		setDetailRowNum();
	}
	
	//문자열 자르기
	function cutStr(str, maxByte) {
	
		for(b=i=0;c=str.charCodeAt(i);) {
	      b+=c>>7?2:1;
	      if (b > maxByte)
	      break;
	      i++;
	    }
	  	return str.substring(0,i);
	 }
	function updateTaxBilg() {
		if ($("#popForm #taxRcvEmail").val() == "") {
			alert("수신담당자는 정보는 필수입니다.");
			return;
		}
		if ($("#popForm #taxRcvNm").val() == "") {
			alert("수신담당자 이름 정보는 필수입니다.");
			return;
		}
		debugger;
		if (($("#popForm #rffGn1").val() == "RFFGN101" || $("#popForm #rffGn1").val() == "RFFGN103" ) && $("#popForm #rffAea").val() != "") {
			alert("세금계산서는 수정사유가 필요없습니다.");
			return;
		}
		if (($("#popForm #rffGn1").val() == "RFFGN102" || $("#popForm #rffGn1").val() == "RFFGN104" ) && $("#popForm #rffAea").val() == "") {
			alert("수정세금계산서는 수정사유가 필수입니다.");
			return;
		}
		var moa1023Sum = 0;
		var moa10124Sum = 0;
		$.each($('#detailTb tr[name="detailRow"]'), function(idx, elem) {
			moa1023Sum += Number(deleteCommaStr($(elem).find("input[name='moa1023']").val()));
			moa10124Sum += Number(deleteCommaStr($(elem).find("input[name='moa10124']").val()));
			$(elem).find("input[name='dms1000']").val(cutStr($(elem).find("input[name='dms1000']").val(),100));  
		});

		//비고 문자열 길이 150byte로 자르기
		$("#ftxac11").val(cutStr($("#ftxac11").val(),150));
		$("#ftxac21").val(cutStr($("#ftxac21").val(),150));
		$("#ftxac31").val(cutStr($("#ftxac31").val(),150));

		if(Number(deleteCommaStr($("#taxMoa523").val())) != moa1023Sum){
			alert("공급가액 합계가 상세 내역과 불일치 합니다.");
			return false;
		}
		
		if(Number(deleteCommaStr($("#taxMoa5124").val())) != moa10124Sum){
			alert("공급세액 합계가 상세 내역과 불일치 합니다.");
			return false;
		}
		if(inputValidation($('[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/ar/ar04/updateTaxBilg", formData, function(data){
				alert(data.resultMessage);    
				if(data.resultCode == "200"){
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
		
	}

	// 수신담당자검색
	function rcvNmSearch() {
		openSecondModal("/static/html/user/ar/ar04/AR0401P03.html", 1000, 420, "수신담당자검색");
	}
	
	function modalClose(){
		gridView.setData(0);
		modalStack.close();
	}

	function taxReport() {

		var fileName = "AR0401M01.jrf";
		var arg =  "#ar_idx#"		+ $('#bilgCertNo').val()
		         + "#";

		callReport(fileName, arg, 1040, 720);
	}	

	//list 행추가
	function addRow() {
		if($("[name=detailRow]").length > 3){
			alert("상세 내역은 4건 까지 입력 할 수 있습니다.");
			return false;
		}
		var row = $("#detailTb > tbody:last > tr:last").clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			this.value = '';
			this.checked = '';
			$(this).prop("disabled", false);
		});
		setDetailRowNum();
		return $("tr[name='tableCd']:last")[0];
	}
	
	//list 행추가
	function copyRow(elem) {
		if($("[name=detailRow]").length > 3){
			alert("상세 내역은 4건 까지 입력 할 수 있습니다.");
			return false;
		}
		var row = $(elem).closest('tr').clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			$(this).prop("disabled", false);
		});
		setDetailRowNum()
		return $("tr[name='tableCd']:last")[0];
	}
	
	//list 행삭제	
	function removeDetailRow(){
		$.each($('input:checkbox[name="detailChkBox"]'), function(idx, elem){
			if($(elem).is(":checked")){
				$(elem).closest('.detailRow').remove();
			}
		});
		setDetailRowNum();
	}
	
	function setDetailRowNum(){
		$.each($('input[name="ard113a"]'), function(idx, elem){
			$(elem).val(idx+1);
		});
	}
	
	//세액 계산
	function  calMoa10124(elem){
		console.log("calMoa10146");
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		var moa1023 = Number(deleteCommaStr($targetRow.find('input[name="moa1023"]').val())) || 0;
		$targetRow.find('input[name="moa10124"]').val(addCommaStr(Math.floor(moa1023 * 0.1)));
	}
</script>
<style>
	.th_btn{
		margin-left: 5px; 
		height: 14px; 
		vertical-align: baseline;
		display: none;
	}
	
	.th_btn.on{
		display: inline-block;
	}
</style>
<div id="shipView" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit">출하요청서 조회</h4>
	</div>
	<div class="popup_table">
		<form id="popForm">
			<input type="hidden" id="pgmId"       name="pgmId" value="AR0102V01">
			<input type="hidden" id="reqDt"       name="reqDt">
			<input type="hidden" id="selpchCd"    name="selpchCd" value="SELPCH2">
			<input type="hidden" id="shipSeq"     name="shipSeq"> 
			<input type="hidden" id="ordrgSeq"    name="ordrgSeq"> <!-- 발주번호 -->
			<input type="hidden" id="ordrgDtlSeq" name="ordrgDtlSeq"> <!-- 발주상세번호 -->
			<input type="hidden" id="odrDtlSeq"   name="odrDtlSeq"> <!-- 주문상세번호 -->
			<input type="hidden" id="whClntCd"    name="whClntCd"> <!--재고주체가 자사인경우 거래처 창고의 거래처-->
			<input type="hidden" id="whType"      name="whType"> <!--공장여부 확인-->
			<input type="hidden" id="trspTypCd"   name="trspTypCd" value="TRSPTYP1"> <!--정상거래로 인식-->
			<input type="hidden" id="prjctCd"     name="prjctCd"> 
			<input type="hidden" id="prjctNm"     name="prjctNm">
			<table>
				<colgroup>
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
					<col width="12%">
					<col width="">
				</colgroup>
				<tr>
					<th>회사명</th>
					<td>
						<input type="hidden" id="coCd" name="coCd"> 
						<input type="text" id="coNm" name="coNm" readonly>
					</td>
					<th>판매유형</th>
					<td>
						<input type="hidden" id="typCd" name="typCd"> 
						<input type="text" id="typNm" name="typNm" readonly>
					</td>
					<th>직송여부</th>
					<td>
						<input type="text" id="dirtrsYn" name="dirtrsYn" readonly>
					</td>
				</tr>
				<tr>
					<th>매출거래처</th>
					<td>
						<input type="hidden" id="clntCd" name="clntCd"> 
						<input type="text" id="clntNm" name="clntNm" readonly></td>
					<th>재고주체</th>
					<td>
						<input type="hidden" id="ownerCd" name="ownerCd">
						<input type="text" id="ownerNm" name="ownerNm" readonly>
					</td>
					<th>
						영업담당자
						<a class="fs-12 th_btn on" style="color: #3860f8;" onclick="updateSalesMng(this);">수정</a>
						<a class="fs-12 th_btn" style="color: #3860f8;" onclick="saveSalesMng(this);">저장</a>
						<a class="fs-12 th_btn" style="color: #f00;" onclick="cancelSalesMng(this);">취소</a>
					</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="salesMng" name="salesMng" org>
							<input type="text" id="salesMngNm" name="salesMngNm" org readonly>
							<a onclick="openSecondUserSearch();" style="display: none;">
								<i class="i_search_w"></i>
							</a>
						</div>
					</td>
				</tr>
				<tr>
					<th>현장명</th>
					<td>
						<input type="hidden" id="siteCd" name="siteCd">
						<input type="text" id="siteNm" name="siteNm" readonly>
					</td>
					<th>출하창고</th>
					<td>
						<input type="hidden" id="whCd" name="whCd">
						<input type="text" id="whNm" name="whNm" readonly></td>
					<th>계산서발행법인</th>
					<td>
						<input type="hidden" id="taxivcCoprt" name="taxivcCoprt">
						<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" readonly>
					</td>
				</tr>
				<tr>
					<th>판매지역</th>
					<td class="drctArea">
						<input type="hidden" id="salesAreaCd" name="salesAreaCd">
						<input type="text" id="salesAreaNm" name="salesAreaNm" readonly>
					</td>
					<th>착지연락처</th>
					<td>
						<input type="text" id="mngTel" name="mngTel" readonly>
					</td>
					<th>매출 / 실출하 일자</th>
					<td>
						<input type="hidden" id="dlvrDttm" name="dlvrDttm">
						<input type="hidden" id="realDlvrDttm" name="realDlvrDttm">
						<input type="text" id="catDlvrDttm" name="catDlvrDttm" readonly>
					</td>
				</tr>
				<tr>
					<th>주문번호</th>
					<td>
						<div class="search_form">
							<input type="text" id="odrSeq" name="odrSeq" readonly>
						</div>
					</td>
					<th>운송비</th>
					<td>
						<input type="text" id="transAmt" name="transAmt" onkeypress="onlyNumber(this);" comma readonly>
					</td>
					<th>운송차수</th>
					<td>
						<input type="text" id="shipCnt" name="shipCnt" readonly>
					</td>
				</tr>
				<tr>
					<th>착지주소</th>
					<td>
						<input type="text" id="addrZip" name="addrZip" readonly>
					</td>
					<td colspan="2" style="border-left: 0px !important;">
						<input type="text" id="addrMain" name="addrMain" readonly>
					</td>
					<td colspan="2">
						<input type="text" id="addrSub" name="addrSub">
					</td>
				</tr>
				<tr>
					<th>
						납기비고
						<a class="fs-12 th_btn on" style="color: #3860f8;" onclick="updateShipRmk(this);">수정</a>
						<a class="fs-12 th_btn" style="color: #3860f8;" onclick="saveShipRmk(this);">저장</a>
						<a class="fs-12 th_btn" style="color: #f00;" onclick="cancelShipRmk(this);">취소</a>
					</th>
					<td colspan="5">
						<textarea class="form-control" id="dlvrRmk" name="dlvrRmk" style="height: 60px;" maxlength="500" org readonly></textarea>
					</td>
				</tr>
				<tr>
					<th>
						출하비고
						<a class="fs-12 th_btn on" style="color: #3860f8;" onclick="updateShipRmk(this);">수정</a>
						<a class="fs-12 th_btn" style="color: #3860f8;" onclick="saveShipRmk(this);">저장</a>
						<a class="fs-12 th_btn" style="color: #f00;" onclick="cancelShipRmk(this);">취소</a>
					</th>
					<td colspan="5">
						<textarea class="form-control" id="shipRmk" name="shipRmk" style="height: 60px;" maxlength="500" org readonly></textarea>
					</td>
				</tr>
			</table>
		</form>
	</div>

	<br>
	<!-- 테이블 -->
	<div class="popup_table">
		<table>
			<tr>
				<td colspan="2" style="text-align: LEFT; border-right: 0;">※상세내역</td>
				<td colspan="17"></td>
			</tr>
		</table>

		<div class="ofx_s" style="width: 100%;">
			<table id="detailTable" style="width: 1700px;">
				<colgroup>
					<col width="2%">
					<col width="2%">
					<col width="13%"> <!-- 제품명 -->
					<col width="6%">  <!-- SIZE -->
					<col width="6%">  <!-- SPEC-->
					<col width="5%">  <!-- 길이 -->
					<col width="5%">  <!-- 단위 -->
					<col width="5%">  <!-- 출하지시 수량-->
					<col width="5%">  <!-- 출하지시 중량-->
					<col width="5%">  <!-- 번들 -->
					<col width="5%">  <!-- 출하지시 단가-->
					<col width="6%">  <!-- 출하지시 금액-->
					<col width="6%">  <!-- 출하지시 손익-->
					<col width="4%">  <!-- 수입여부 -->
					<col width="5%">  <!-- Maker -->
					<col width="6%">  <!-- 완료일자 -->
					<col width="6%">  <!-- 차량번호 -->
					<col width="8%">  <!-- 비고 -->
				</colgroup>
				<tr>
					<th class="tc" style="padding: 3px;"> 
						<input type="checkbox" id="allChkBox" onchange="ctrlDetailChkBox(this);">
					</th>
				    <th class="tc pd0">매출</th>
					<th class="tc hit">제품명</th>
					<th class="tc">사이즈</th>
					<th class="tc">SPEC</th>
					<th class="tc">길이</th>
					<th class="tc">단위</th>
					<th class="tc">번들/본수</th>
					<th class="tc hit">수량</th>
					<th class="tc hit">중량(KG)</th>
					<th class="tc">매출단가</th>
					<th class="tc">금액</th>
					<th class="tc">예상손익</th>
					<th class="tc">수입</th>
					<th class="tc">Maker</th>
					<th class="tc">완료일자</th>
					<th class="tc">차량번호</th>
					<th class="tc">비고</th>
				</tr>
			</table>
			<table id="frameTable" style="display: none;">
				<tr name="detailRow">
					<input type="hidden" name="shipDtlSeq"> 
					<input type="hidden" name="odrDtlSeq"> 
					
			   <!-- <input type="hidden" name="shipYn"> -->
					<input type="hidden" name="shipProcId">
					
					<input type="hidden" name="prdtGrp">
					<input type="hidden" name="prdtDiv">
					<input type="hidden" name="prdtStkn">
					<input type="hidden" name="prdtStockCd">
					<input type="hidden" name="prdtCoilYn"> 
					<input type="hidden" name="prdtCnvrsnWt">
					<input type="hidden" name="prdtDt">
					
					<input type="hidden" name="pchsUpr" value="0">
					<input type="hidden" name="sellUpr" value="0">
					<input type="hidden" name="stockUpr" value="0">
					<input type="hidden" name="prdtUpr" value="0">
					
					<input type="hidden" name="realShipQty" value="0">
					<input type="hidden" name="realShipWt" value="0">
					<input type="hidden" name="realShipUpr" value="0">
					<input type="hidden" name="realShipAmt" value="0">
					<td>
						<input type="checkbox" name="detailChkBox" onclick="ctrlAllChkBox();">
					</td>
					<td>
						<input type="text" class="tc" name="shipYn" readonly>
					</td>
					<td>
						<input type="hidden" name="prdtCd">
						<input type="text" name="prdtNm" readonly>
					</td>
					<td>
						<input type="text" class="tc" name="prdtSize" readonly>
					</td>
					<td>
						<input type="text" class="tc" name="prdtSpec" readonly>
					</td>
					<td>
						<input type="text" class="tr" name="prdtLen" comma readonly>
					</td>
					<td>
						<input type="hidden" name="prdtUnit">
						<input type="text" class="tc" name="prdtUnitNm" readonly>
					</td>
					<td>
						<input type="text" class="tr" name="bdCnt" maxlength="5" comma readonly>
					</td>					
					<td>
						<input type="text" class="tr" name="shipQty" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="shipWt" comma readonly>
					</td>

					<td>
						<input type="text" class="tr" name="shipUpr" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="shipAmt" comma readonly>
					</td>
					<td>
						<input type="text" class="tr" name="epctPal" comma readonly>
					</td>
					<td>
						<input type="text" class="tc" name="impYn" readonly>
					</td>
					<td>
						<input type="hidden" name="makrCd">
						<input type="text" class="tc" name="makrNm" readonly>
					</td>
					<td>
						<input type="text" class="tc" name="shipDttm" readonly>
					</td>
					<td>
						<input type="text" name="shipVehNo" readonly>
					</td>
					<td>
						<input type="text" name="shipDtlRmk" readonly>
					</td>
				</tr>
			</table>
			<table style="width: 1700px;">
				<colgroup>
					<col width="2%">
					<col width="2%">
					<col width="13%"> <!-- 제품명 -->
					<col width="6%">  <!-- SIZE -->
					<col width="6%">  <!-- SPEC-->
					<col width="5%">  <!-- 길이 -->
					<col width="5%">  <!-- 단위 -->
					<col width="5%">  <!-- 출하지시 수량-->
					<col width="5%">  <!-- 출하지시 중량-->
					<col width="5%">  <!-- 번들 -->
					<col width="5%">  <!-- 출하지시 단가-->
					<col width="6%">  <!-- 출하지시 금액-->
					<col width="6%">  <!-- 출하지시 손익-->
					<col width="4%">  <!-- 수입여부 -->
					<col width="5%">  <!-- Maker -->
					<col width="6%">  <!-- 완료일자 -->
					<col width="6%">  <!-- 차량번호 -->
					<col width="8%">  <!-- 비고 -->
				</colgroup>
				<tr>
					<th class="tc" colspan="7">합계</th>
					<td>
						<input class="tr" type="text" id="shipTotBdCnt" name="shipTotBdCnt" comma readonly>
					</td>					
					<td>
						<input class="tr" type="text" id="shipTotQty" name="shipTotQty" comma readonly>
					</td>
					<td>
						<input class="tr" type="text" id="shipTotWt" name="shipTotWt" comma readonly>
					</td>
					<td>-</td>
					<td>
						<input class="tr" type="text" id="shipTotAmt" name="shipTotAmt" comma readonly>
					</td>
					<td>
						<input class="tr" type="text" id="totEpctPal" name="totEpctPal" comma readonly>
					</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</table>
		</div>
	</div>
	<br>
	<div class="popup_table">
		<table>
			<colgroup>
				<col width="12%">
			</colgroup>
			<tr>
				<th>첨부파일</th>
				<td>
					<div data-ax5grid="ship-file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
				</td>
			</tr>
		</table>
	</div>
	<!-- 하단 버튼 -->
	<div class="popup_bottom_btn">
		<button id="allocVehltBtn" style="display: none;" onclick="openAllocVehltPopup();" title="배차조회.">
			<i class="fas fa-print"></i>배차
		</button>
		<button id="reportBtn" onclick="setReportPopup();" title="제품만 출력합니다.">
			<i class="fas fa-print"></i>납품서
		</button>
		<button id="actionBtn" onclick="updateShipModal();" authchk>수정</button>
		<button id="recptYnBtn" onclick="updateRecptYnPopup(this);" authchk>접수</button>
		<button id="shipYnBtn" onclick="updateConfirm(this);" authchk>출하처리</button>
		<button id="cancelBtn" onclick="updateCancel(this);" style="background-color: red;" authchk>출하취소</button>
		<button class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	var shipFileArr = [];
	var shipFileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="ship-file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 460},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	            ]
			});
			return this;
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: shipFileArr,
				page : {
					totalElements : shipFileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		selectShipInfo();
		authChk("AR0101M01");
	});
	
	function selectShipInfo() {
		var paramObj = {"shipSeq": modalStack.last().paramObj.shipSeq};
		postAjax("/user/ar/ar01/selectShipInfo", paramObj, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var fileInfo = obj.fileList;
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		
		// 메인정보 세팅
		$.each(shipInfo, function(key, value){
			var itemValue = value;
			if($('#shipView #'+key).is('[org]')){
				$('#shipView #'+key).data("org", value);
			}
			if($('#shipView #'+key).is('[comma]')){
				itemValue = addCommaStr(itemValue);
			}
			$('#shipView #'+key).val(itemValue);
		});
		
		//상세정보 세팅
		$.each(shipDetail, function(idx, obj){
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
						//itemValue = addCommaStr(Math.round(itemValue));
					}
					$(elem).val(itemValue);
					if(elem.name == "shipYn" && itemValue == "N") { //red
						$(elem).css({"color": "red"});
					}
					
				}
			});
			
// 			if(obj.shipYn == "Y") {
// 				$addedRow.find('input[name="detailChkBox"]').prop("disabled", true);
// 				$addedRow.find('input[name="detailChkBox"]').prop("checked", true);
// 				$addedRow.find('a').remove();
// 			}
		});
		countTot();

		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			shipFileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		shipFileGridView.initView().setData();
		
		// 창고담당자가 확인한경우 접수버튼 hide
		if(shipInfo.recptYn == "Y") {
			$("#shipView #recptYnBtn").hide();
		}
		
		// 전체 출하확정시 출하처리 및 수정버튼 hide
		if(shipInfo.shipYn == "Y") {
			$("#shipView #shipYnBtn").hide();
			$("#shipView #actionBtn").hide();
		}
		
		// 확정된 상세가 없을경우 취소버튼 hide
		if(shipInfo.confirmCnt == 0){
			$("#shipView #cancelBtn").hide();
		}
	}
	
	// 영업담당자 수정
	function updateSalesMng(btnElem){
		var $tdElem = $(btnElem).closest('th').next('td');
		// 사용자 검색버튼 show
		$tdElem.find('a').css("display", "inline-block");
		// 버튼 toggle
		toggleThBtn(btnElem);
	}
	
	// 영업담당자 저장
	function saveSalesMng(btnElem){
		var $tdElem = $(btnElem).closest('th').next('td');
		var salesMngElem = $tdElem.find('#salesMng')[0];
		var paramObj = {
			"shipSeq": $('#shipView #shipSeq').val(),
			"userId": jwt.userId,
			"pgmId": "AR0102V01"
		}
		paramObj[salesMngElem.name] = salesMngElem.value;
		
		
		putAjax("/user/ar/ar01/updateSalesMng", paramObj, null, function(data){
			alert(data.resultMessage);           
			if(data.resultCode == 200){
				// 원본 데이터 set
				$.each($tdElem.find('input'), function(idx, elem){
					$(elem).data("org", elem.value);
				});
				// 사용자 검색버튼 hide
				$tdElem.find('a').css("display", "none");
				// 버튼 toggle
				toggleThBtn(btnElem);
				// grid 조회
				var targetGrid = modalStack.last().paramObj.targetGrid;
				if(targetGrid){
					targetGrid.setData(targetGrid.target.page.currentPage);
				}else{
					shipGridView.setData(shipGridView.target.page.currentPage);
				}
			}
		});
	}
	
	// 영업담당자 취소
	function cancelSalesMng(btnElem){
		var $tdElem = $(btnElem).closest('th').next('td');
		// 원본 데이터 set
		$.each($tdElem.find('input'), function(idx, elem){
			$(elem).val($(elem).data("org"));
		});
		// 사용자 검색버튼 hide
		$tdElem.find('a').css("display", "none");
		// 버튼 toggle
		toggleThBtn(btnElem);
	}
	
	// 사용자 검색
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : "GUM",
			"userId": $('#shipView #salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#shipView #salesMng').val(checkedNode.id);
			$('#shipView #salesMngNm').val(checkedNode.text);
		});
	}
	
	// 비고 수정
	function updateShipRmk(btnElem){
		// 비고 수정모드로 변경
		var $rmkElem = $(btnElem).closest('th').next('td').find('textarea');
		$rmkElem.prop("readonly", false);
		// 버튼 toggle
		toggleThBtn(btnElem);
	}
	
	// 비고 저장
	function saveShipRmk(btnElem){
		var rmkElem = $(btnElem).closest('th').next('td').find('textarea')[0];
		var paramObj = {
			"shipSeq": $('#shipView #shipSeq').val(),
			"userId": jwt.userId,
			"pgmId": "AR0102V01"
		}
		paramObj[rmkElem.name] = rmkElem.value;
		
		putAjax("/user/ar/ar01/updateShipRmk", paramObj, null, function(data){
			alert(data.resultMessage);           
			if(data.resultCode == 200){
				// 원본 데이터 set
				$(rmkElem).data("org", rmkElem.value);
				// 비고 조회모드로 변경
				$(rmkElem).prop("readonly", true);
				// 버튼 toggle
				toggleThBtn(btnElem);
				// grid 조회
				var targetGrid = modalStack.last().paramObj.targetGrid;
				if(targetGrid){
					targetGrid.setData(targetGrid.target.page.currentPage);
				}else{
					shipGridView.setData(shipGridView.target.page.currentPage);
				}
			}
		});
	}
	
	// 비고 취소
	function cancelShipRmk(btnElem){
		var $rmkElem = $(btnElem).closest('th').next('td').find('textarea');
		// 원본 데이터 set
		$rmkElem.val($rmkElem.data('org'));
		// 비고 읽기모드로 변경
		$rmkElem.prop("readonly", true);
		// 버튼 toggle
		toggleThBtn(btnElem);
	}
	
	// 버튼 toggle
	function toggleThBtn(btnElem){
		var $thElem = $(btnElem).closest('th');
		$thElem.find('a').toggleClass('on');
	}
	
	function addDetailRow() {
		var $detailRow = $('#shipView #frameTable tr[name="detailRow"]').clone();
		$('#shipView #detailTable tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function ctrlAllChkBox(){
		var isAllChk = true;
		var $detailChkBoxes = $('#shipView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)');
		if($detailChkBoxes.length > 0){
			$.each($detailChkBoxes, function(idx, elem){
				if(!$(elem).is(':checked')){
					isAllChk = false;
				}
			});
			if(isAllChk){
				$('#shipView #allChkBox').prop("checked", true);
			}else{
				$('#shipView #allChkBox').prop("checked", false);
			}
		}else{
			$('#shipView #allChkBox').prop("checked", false);
		}
	}
	
	function ctrlDetailChkBox(elem){
		if($(elem).is(':checked')){
			$('#shipView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", true);
		}else{
			$('#shipView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", false);
		}
	}
	
	function countTot() {
		var shipTotQty = 0;
		var shipTotWt = 0;
		var shipTotAmt = 0;
		var totEpctPal = 0;
		var shipTotBdCnt = 0;
		
		$.each($('#shipView #detailTable tr[name="detailRow"]'), function(idx, elem){
			var shipQty = Number(deleteCommaStr($(elem).find('input[name="shipQty"]').val()));
			var shipWt = Number(deleteCommaStr($(elem).find('input[name="shipWt"]').val()));
			var shipAmt = Number(deleteCommaStr($(elem).find('input[name="shipAmt"]').val()));
			var epctPal = Number(deleteCommaStr($(elem).find('input[name="epctPal"]').val()));
			var bdCnt = Number(deleteCommaStr($(elem).find('input[name="bdCnt"]').val())) || 0;
			
			shipTotQty += shipQty;
			shipTotWt += shipWt;
			shipTotAmt += shipAmt; 
			totEpctPal += epctPal;
			shipTotBdCnt += bdCnt;
		});
		
		$('#shipView #shipTotQty').val(addCommaStr(shipTotQty));
		$('#shipView #shipTotWt').val(addCommaStr(shipTotWt));
		$('#shipView #shipTotAmt').val(addCommaStr(shipTotAmt));
		$("#shipView #totEpctPal").val(addCommaStr(totEpctPal));
		$('#shipView #shipTotBdCnt').val(addCommaStr(shipTotBdCnt));
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": shipFileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function updateShipModal() {
		var paramObj = modalStack.last().paramObj;
		modalStack.close();
		setTimeout(function(){
			paramObj.actionType = "U";
			openModal("/static/html/user/ar/ar01/AR0102P01.html", 1300, 780, "", paramObj);
		}, 500);
	}
	
	function updateRecptYnPopup(btnElem) {
		// confirm
		var isConfirmed = confirmBefore(btnElem);
		if(!isConfirmed) return false;
		
		var detailArr = [];
		var detailObj = {};
		detailObj["shipSeq"] = $('#shipView #shipSeq').val();
		detailObj["recptYn"] = "Y";
		detailObj["pgmId"] = "AR0101M01";
		detailObj["userId"] = jwt.userId;
		detailArr.push(detailObj);
		
		var formData = {
			"detailArr" : detailArr
		}
		
		putAjax("/user/ar/ar01/updateRecptYn", formData, null, function(data){
			alert(data.resultMessage);
			if(data.resultCode == 200){
				// 접수버튼 숨김처리
				$("#recptYnBtn").hide();
				// grid 조회
				var targetGrid = modalStack.last().paramObj.targetGrid;
				if(targetGrid){
					targetGrid.setData(targetGrid.target.page.currentPage);
				}else{
					shipGridView.setData(shipGridView.target.page.currentPage);
				}
			}
		});
	}
	
	function updateConfirm(btnElem) {
		// confirm
		var isConfirmed = confirmBefore(btnElem);
		if(!isConfirmed) return false;
		
		var checkCount = 0;
		$.each($('#shipView #detailTable tr[name="detailRow"]'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "N") {
				checkCount++;
			}
		});
		
		if(checkCount == 0){
			alert("출하내역을 선택해주세요");
			return;
		}
		var formData = makeFormData('CONFIRM');
	
		// 공장에서는 재고관리시 길이는 관리불가임으로 공통으로 8m를 입력한다. 나머진 하치장, 외주는 실제 길이 관리한다.
		var mngPrdtLen = ''; 
		if($('#shipView #whType').val() == "WHDIV01") {mngPrdtLen = 8;}
		formData.append("mngPrdtLen", mngPrdtLen);
		
		filePutAjax("/user/ar/ar01/updateConfirm", formData, function(data){
			alert(data.resultMessage);  
			if(data.resultCode == 200) {
				// grid 조회
				var targetGrid = modalStack.last().paramObj.targetGrid;
				if(targetGrid){
					targetGrid.setData(targetGrid.target.page.currentPage);
				}else{
					shipGridView.setData(shipGridView.target.page.currentPage);
				}
				modalStack.close();
			}
		});
	}
	
	function updateCancel(btnElem) {
		// confirm
		var isConfirmed = confirmBefore(btnElem);
		if(!isConfirmed) return false;
		
		var checkCount = 0;
		$.each($('#shipView #detailTable tr[name="detailRow"]'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "Y") {
				checkCount++;
			}
		});
		
		if(checkCount == 0){
			alert("확정 건이 존재하지 않습니다.");
			return;
		}
		var formData = makeFormData('CANCEL');
		
		// 공장에서는 재고관리시 길이는 관리불가임으로 공통으로 8m를 입력한다. 나머진 하치장, 외주는 실제 길이 관리한다.
		var mngPrdtLen = ''; 
		if($('#shipView #whType').val() == "WHDIV01") {mngPrdtLen = 8;}
		formData.append("mngPrdtLen", mngPrdtLen);

		filePutAjax("/user/ar/ar01/updateCancel", formData, function(data){
			alert(data.resultMessage);         
			if(data.resultCode == 200) {
				// grid 조회
				var targetGrid = modalStack.last().paramObj.targetGrid;
				if(targetGrid){
					targetGrid.setData(targetGrid.target.page.currentPage);
				}else{
					shipGridView.setData(shipGridView.target.page.currentPage);
				}
				var shipSeq = $('#shipSeq').val();
				modalStack.close();
				shipGridView.setData(0);
				setTimeout(function(){
					viewShipModal(shipSeq);
				}, 500);	
			}
		});
	}
	
	function confirmBefore(btnElem){
		return confirm("\'"+$(btnElem).text()+"\'하시겠습니까?");
	}
	
	function makeFormData(type) {
		//콤마 제거
		$.each($('#shipView input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#shipView #popForm")[0]);
		
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#shipView #detailTable tr[name="detailRow"]'), function(idx, elem){
			if(type == "CONFIRM") {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "N") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						if(elem.name == "shipProcId" && elem.value == "") elem.value = jwt.userId;
						if(elem.name == "shipProcNm" && elem.value == "") elem.value = jwt.userNm;
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			} else {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "Y") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}
	
	function setReportPopup() {
		var flag = false;
		var fileName = "AR0101R02.jrf";
		var detailListLen = $('#shipView #detailTable tr[name="detailRow"]').length;
		var arg = "coCd#"			+ $('#shipView #coCd').val()
	         + "#clntCd#"		+ $('#shipView #clntCd').val()
	         + "#shipSeq#"		+ $('#shipView #shipSeq').val()
	         + "#";
		openSecondModal("/static/html/user/ar/ar01/AR0102P04.html", 600, 200, "납품서 출력 선택", null, function (rptName) {
			if(rptName == 'STD') {
				if (detailListLen > 6) {
					fileName = "AR0101R03.jrf";
				}else {
					fileName = 'AR0101R02.jrf';
				}	
			}else {
				if (detailListLen > 4) {
					fileName = "AR0101R05.jrf";
				}else {
					fileName = 'AR0101R04.jrf';
				}	
			}
			callReport(fileName, arg, "1050", "700");
		});
		//callReport(fileName, arg, "1050", "700");
	}
	
	
	function openAllocVehltPopup() {
		var paramObj= {
			"coCd": $('#shipView #coCd').val(),
			"shipSeq": $('#shipView #shipSeq').val()
		};
		openSecondModal("/static/html/user/ar/ar01/AR0102P05.html", 600, 500, "배차현황", paramObj, "");
	}
</script>
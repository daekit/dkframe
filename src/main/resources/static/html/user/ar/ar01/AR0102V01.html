<body>
	<div id="arViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
		<div class="tit_contents">
			<h4 class="tit">출하요청서 조회</h4>
		</div>
		<div class="popup_table">
			<form id="popForm">
				<input type="hidden" id="pgmId"       name="pgmId" value="AR0102V01">
				<input type="hidden" id="reqDt"       name="reqDt">
				<input type="hidden" id="selpchCd"    name="selpchCd" value="SELPCH2">
				<input type="hidden" id="shipSeq"     name="shipSeq"> 
				<input type="hidden" id="ordrgSeq"    name="ordrgSeq"> <!-- 발주번호 -->
				<input type="hidden" id="ordrgDtlSeq" name="ordrgDtlSeq"> <!-- 발주상세번호 -->
				<input type="hidden" id="odrDtlSeq"   name="odrDtlSeq"> <!-- 주문상세번호 -->
				<input type="hidden" id="whClntCd"    name="whClntCd"> <!--재고주체가 자사인경우 거래처 창고의 거래처-->
				<input type="hidden" id="whType"      name="whType"> <!--공장여부 확인-->
				<input type="hidden" id="trspTypCd"   name="trspTypCd" value="TRSPTYP1"> <!--정상거래로 인식-->
				<input type="hidden" id="prjctCd"     name="prjctCd"> 
				<input type="hidden" id="prjctNm"     name="prjctNm">
				<table>
					<colgroup>
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
					</colgroup>
					<tr>
						<th>회사명</th>
						<td>
							<input type="hidden" id="coCd" name="coCd"> 
							<input type="text" id="coNm" name="coNm" readonly>
						</td>
						<th>판매유형</th>
						<td>
							<input type="hidden" id="typCd" name="typCd"> 
							<input type="text" id="typNm" name="typNm" readonly>
						</td>
						<th>직송여부</th>
						<td>
							<input type="text" id="dirtrsYn" name="dirtrsYn" readonly>
						</td>
					</tr>
					<tr>
						<th>매출거래처</th>
						<td>
							<input type="hidden" id="clntCd" name="clntCd"> 
							<input type="text" id="clntNm" name="clntNm" readonly></td>
						<th>재고주체</th>
						<td>
							<input type="hidden" id="ownerCd" name="ownerCd">
							<input type="text" id="ownerNm" name="ownerNm" readonly>
						</td>
						<th>영업담당자</th>
						<td>
							<input type="hidden" id="salesMng" name="salesMng">
							<input type="text" id="salesMngNm" name="salesMngNm" readonly>
						</td>
					</tr>
					<tr>
						<th>수입여부</th>
						<td>
							<input type="text" id="impYn" name="impYn" readonly>
						</td>
						<th>출하창고</th>
						<td>
							<input type="hidden" id="whCd" name="whCd">
							<input type="text" id="whNm" name="whNm" readonly></td>
						<th>계산서발행법인</th>
						<td>
							<input type="hidden" id="taxivcCoprt" name="taxivcCoprt">
							<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" readonly>
						</td>
					</tr>
					<tr>
						<th>Maker</th>
						<td>
							<input type="hidden" id="makrCd" name="makrCd"> 
							<input type="text" id="makrNm" name="makrNm" readonly></td>
						<th>현장명</th>
						<td>
							<input type="hidden" id="siteCd" name="siteCd">
							<input type="text" id="siteNm" name="siteNm" readonly>
						</td>
						<th>판매지역</th>
						<td class="drctArea">
							<input type="hidden" id="salesAreaCd" name="salesAreaCd">
							<input type="text" id="salesAreaNm" name="salesAreaNm" readonly>
						</td>
					</tr>
					<tr>
						<th>주문번호</th>
						<td>
							<div class="search_form">
								<input type="text" id="odrSeq" name="odrSeq" readonly>
							</div>
						</td>
						<th>착지연락처</th>
						<td>
							<input type="text" id="mngTel" name="mngTel" readonly>
						</td>
						<th>납기일자</th>
						<td>
							<input type="text" id="dlvrDttm" name="dlvrDttm" readonly>
						</td>
					</tr>
					<tr>
						<th rowspan="2">착지주소</th>
						<td>
							<input type="text" id="addrZip" name="addrZip" readonly>
						</td>
						<th>운송비</th>
						<td>
							<input type="text" id="transAmt" name="transAmt" onkeypress="onlyNumber(this);" comma readonly>
						</td>
						<th>운송차수</th>
						<td>
							<input type="text" id="shipCnt" name="shipCnt" readonly>
						</td>
					</tr>
					<tr>
						<td colspan="3" style="border-left: 0px !important;">
							<input type="text" id="addrMain" name="addrMain" readonly>
						</td>
						<td colspan="2">
							<input type="text" id="addrSub" name="addrSub">
						</td>
					</tr>
					<tr>
						<th>납기 비고<br>(내부용)
						</th>
						<td colspan="5">
							<textarea class="form-control" id="dlvrRmk" name="dlvrRmk" style="height: 60px;" maxlength="500" readonly></textarea>
						</td>
					</tr>
					<tr>
						<th>출하 비고</th>
						<td colspan="5">
							<textarea class="form-control" id="shipRmk" name="shipRmk" style="height: 60px;" maxlength="500" readonly></textarea>
						</td>
					</tr>
				</table>
			</form>
		</div>

		<br>
		<!-- 테이블 -->
		<div class="popup_table">
			<table>
				<tr>
					<td colspan="2" style="text-align: LEFT; border-right: 0;">※상세내역</td>
					<td colspan="14"></td>
				</tr>
			</table>

			<div class="ofx_s" style="width: 100%;">
				<table id="detailTable" style="width: 1600px;">
					<colgroup>
						<col width="2%">
						<col width="2%">  <!-- 확정여부 -->
						<col width="13%"> <!-- 제품명 -->
						<col width="7%">  <!-- SIZE -->
						<col width="7%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="6%">  <!-- 출하지시 수량-->
						<col width="6%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 출하지시 단가-->
						<col width="7%">  <!-- 출하지시 금액-->
						<col width="7%">  <!-- 출하지시 손익-->
						<col width="7%">  <!-- 완료일자 -->
						<col width="8%">  <!-- 차량번호 -->
						<col width="15%"> <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" style="padding: 3px;"> 
							<input type="checkbox" id="allChkBox" onchange="ctrlDetailChkBox(this);">
						</th>
					    <th class="tc pd0">매출</th>
						<th class="tc">제품명</th>
						<th class="tc">사이즈</th>
						<th class="tc">SPEC</th>
						<th class="tc">길이</th>
						<th class="tc">단위</th>
						<th class="tc">수량</th>
						<th class="tc">중량(KG)</th>
						<th class="tc">매출단가</th>
						<th class="tc">금액</th>
						<th class="tc">예상손익</th>
						<th class="tc">완료일자</th>
						<th class="tc">차량번호</th>
						<th class="tc">비고</th>
					</tr>
				</table>
				<table id="frameTable" style="display: none;">
					<tr name="detailRow">
						<input type="hidden" name="shipDtlSeq"> 
						<input type="hidden" name="odrDtlSeq"> 
						
<!-- 						<input type="hidden" name="shipYn"> -->
						<input type="hidden" name="shipProcId">
						
						<input type="hidden" name="prdtDiv">
						<input type="hidden" name="prdtStkn">
						<input type="hidden" name="prdtStockCd">
						<input type="hidden" name="prdtCoilYn"> 
						<input type="hidden" name="prdtCnvrsnWt">
						<input type="hidden" name="prdtDt">
						
						<input type="hidden" name="pchsUpr">
						<input type="hidden" name="sellUpr">
						<input type="hidden" name="stockUpr">
						<input type="hidden" name="prdtUpr">
						<input type="hidden" name="bilgVatAmt"> <!-- 부가세 -->
						
						<input type="hidden" name="realShipQty">
						<input type="hidden" name="realShipWt">
						<input type="hidden" name="realShipUpr">
						<input type="hidden" name="realShipAmt">
						<td>
							<input type="checkbox" name="detailChkBox" onclick="ctrlAllChkBox();">
						</td>
						<td>
							<input type="text" class="tc" name="shipYn" readonly>
						</td>
						<td>
							<input type="hidden" name="prdtCd">
							<input type="text" name="prdtNm" readonly>
						</td>
						<td>
							<input type="text" class="tc" name="prdtSize" readonly>
						</td>
						<td>
							<input type="text" class="tc" name="prdtSpec" readonly>
						</td>
						<td>
							<input type="text" class="tr" name="prdtLen" readonly>
						</td>
						<td>
							<input type="hidden" name="prdtUnit">
							<input type="text" class="tc" name="prdtUnitNm" readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipQty" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipWt" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipUpr" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipAmt" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="epctPal" comma readonly>
						</td>
						<td>
							<input type="text" class="tc" name="shipDttm" readonly>
						</td>
						<td>
							<input type="text" name="shipVehNo" readonly>
						</td>
						<td>
							<input type="text" name="shipDtlRmk" readonly>
						</td>
					</tr>
				</table>
				<table style="width: 1600px;">
					<colgroup>
						<col width="2%">
						<col width="2%">  <!-- 확정 여부 -->
						<col width="13%"> <!-- 제품명 -->
						<col width="7%">  <!-- SIZE -->
						<col width="7%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="6%">  <!-- 출하지시 수량-->
						<col width="6%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 출하지시 단가-->
						<col width="7%">  <!-- 출하지시 금액-->
						<col width="7%">  <!-- 출하지시 손익-->
						<col width="7%">  <!-- 완료일자 -->
						<col width="8%">  <!-- 차량번호 -->
						<col width="15%"> <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" colspan="7">합계</th>
						<td>
							<input class="tr" type="text" id="shipTotQty" name="shipTotQty" comma readonly>
						</td>
						<td>
							<input class="tr" type="text" id="shipTotWt" name="shipTotWt" comma readonly>
						</td>
						<td>-</td>
						<td>
							<input class="tr" type="text" id="shipTotAmt" name="shipTotAmt" comma readonly>
						</td>
						<td>
							<input class="tr" type="text" id="totEpctPal" name="totEpctPal" comma readonly>
						</td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
		</div>
		<br>
		<div class="popup_table">
			<table>
				<colgroup>
					<col width="12%">
				</colgroup>
				<tr>
					<th>첨부파일</th>
					<td>
						<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
					</td>
				</tr>
			</table>
		</div>
		<!-- 하단 버튼 -->
		<div class="popup_bottom_btn">
			<button id="reportBtn" onclick="setReport('SHIP');" title="제품만 출력합니다.">
				<i class="fas fa-print"></i>납품서
			</button>
			<button id="recptYnBtn" onclick="updateRecptYn();" authchk>접수</button>
			<button id="actionBtn" authchk>수정</button>
			<button id="shipYnBtn" onclick="updateConfirm();" authchk>출하처리</button>
			<button id="cancelBtn" onclick="updateCancel();" style="background-color: red;" authchk>출하취소</button>
			<button class="close_btn" onclick="modalStack.close();">닫기</button>
		</div>
	</div>
</body>
<script type="text/javascript">
	var fileArr = [];
	var selectedIdx = 0;
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 460},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		// 파일 그리드 초기화
		fileGridView.initView();
		
		selectShipInfo();
		
		if(openFrom == "SD0502P01" || openFrom == "SD0402V01" || openFrom == "SD0402P01"){
			$("#actionBtn").hide();
			$("#shipYnBtn").hide();
		}else{
			$('#actionBtn').on("click", function(){updateShipModal(modalStack.last().paramObj.shipSeq);});
			$('#actionBtn').text("수정");
			$("#shipYnBtn").show();
		}
		authChk("AR0101M01");
	});
	
	function selectShipInfo() {
		var paramObj = modalStack.last().paramObj;
		postAjax("/user/ar/ar01/selectShipInfo", paramObj, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var fileInfo = obj.fileList;
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		
		// 메인정보 세팅
		$.each(shipInfo, function(key, value){
			var itemValue = value;
			if($('#'+key).is('[comma]')){
				itemValue = addCommaStr(itemValue);
			}
			$('#'+key).val(itemValue);
		});
		
		//상세정보 세팅
		$.each(shipDetail, function(idx, obj){
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
					if(elem.name == "shipYn" && itemValue == 'N') { //red
						$(elem).css({"color": "red"});
					}
					
				}
			});
			
// 			if(obj.shipYn == "Y") {
// 				$addedRow.find('input[name="detailChkBox"]').prop("disabled", true);
// 				$addedRow.find('input[name="detailChkBox"]').prop("checked", true);
// 				$addedRow.find('a').remove();
// 			}
		});
		countTot();

		// 첨부파일 set
		$.each(fileInfo, function(idx, obj){
			fileArr.push({
				'fileKey' : obj.fileKey,
		      	'fileName' : obj.fileName,
		      	'fileType' : obj.fileType,
		      	'fileSize' : obj.fileSize,
		      	'file' : obj
			});
		});
		
		// 첨부파일 그리드 set
		fileGridView.setData();
		
		// 창고담당자가 확인한경우 접수버튼 hide
		if(shipInfo.recptYn == "Y") {
			$("#recptYnBtn").hide();
		}
		
		// 전체 출하확정시 출하처리 및 수정버튼 hide
		if(shipInfo.shipYn == "Y") {
			$("#shipYnBtn").hide();
			$("#actionBtn").hide();
		}
		
		// 확정된 상세가 없을경우 취소버튼 hide
		if(shipInfo.confirmCnt == 0){
			$("#cancelBtn").hide();
		}
	}
	
	function addDetailRow() {
		var $detailRow = $('#frameTable tr[name="detailRow"]').clone();
		$('#detailTable tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function ctrlAllChkBox(){
		var isAllChk = true;
		var $detailChkBoxes = $('#detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)');
		if($detailChkBoxes.length > 0){
			$.each($detailChkBoxes, function(idx, elem){
				if(!$(elem).is(':checked')){
					isAllChk = false;
				}
			});
			if(isAllChk){
				$('#allChkBox').prop("checked", true);
			}else{
				$('#allChkBox').prop("checked", false);
			}
		}else{
			$('#allChkBox').prop("checked", false);
		}
	}
	
	function ctrlDetailChkBox(elem){
		if($(elem).is(':checked')){
			$('#detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", true);
		}else{
			$('#detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", false);
		}
	}
	
	function countTot() {
		var shipTotQty = 0;
		var shipTotWt = 0;
		var shipTotAmt = 0;
		var totEpctPal = 0;
		
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			var shipQty = Number(deleteCommaStr($(elem).find('input[name="shipQty"]').val()));
			var shipWt = Number(deleteCommaStr($(elem).find('input[name="shipWt"]').val()));
			var shipAmt = Number(deleteCommaStr($(elem).find('input[name="shipAmt"]').val()));
			var epctPal = Number(deleteCommaStr($(elem).find('input[name="epctPal"]').val()));
			
			shipTotQty += shipQty;
			shipTotWt += shipWt;
			shipTotAmt += shipAmt; 
			totEpctPal += epctPal; 
		});
		
		$('#shipTotQty').val(addCommaStr(shipTotQty));
		$('#shipTotWt').val(addCommaStr(shipTotWt));
		$('#shipTotAmt').val(addCommaStr(shipTotAmt));
		$("#totEpctPal").val(addCommaStr(totEpctPal));
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function updateShipModal(shipSeq) {
		modalStack.close();
		setTimeout(function(){
			var paramObj = {
				"actionType": "U",
				"shipSeq": shipSeq
			};
			openModal("/static/html/user/ar/ar01/AR0102P01.html", 1200, 780, "", paramObj);
		}, 500);
	}
	
	function updateConfirm() {
		var checkCount = 0;
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "N") {
				checkCount++;
			}
		});
		
		if(checkCount == 0){
			alert("출하내역을 선택해주세요");
			return;
		}
		var formData = makeFormData('CONFIRM');
	
// 공장에서는 재고관리시 길이는 관리불가임으로 공통으로 8m를 입력한다. 나머진 하치장, 외주는 실제 길이 관리한다.
//		$('#whType').val($("#whCd option:selected").data("rprc"));  // 하치장, 공장, 외주 구분
		var mngPrdtLen = ''; 
		if($('#whType').val() == "WHDIV01") {mngPrdtLen = 8;}
		formData.append("mngPrdtLen", mngPrdtLen);           // 길이관리,,,, 공장의 경우 길이는  8m로 고정할때 사용한다.
//--------------------------------------------------------------------------------------------------------------
		
		filePutAjax("/user/ar/ar01/updateConfirm", formData, function(data){
			alert(data.resultMessage);  
			if(data.resultCode == 200) {
				var targetGrid;
				if(openFrom == "CM1001M01"){
					targetGrid = shipGridView;
				} else {
					targetGrid = gridView;
				}        
				targetGrid.setData(0);
				modalStack.close();
			}
		});
	}
	
	function updateCancel() {
		var checkCount = 0;
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "Y") {
				checkCount++;
			}
		});
		
		if(checkCount == 0){
			alert("확정 건이 존재하지 않습니다.");
			return;
		}
		var formData = makeFormData('CANCEL');		
// 공장에서는 재고관리시 길이는 관리불가임으로 공통으로 8m를 입력한다. 나머진 하치장, 외주는 실제 길이 관리한다.
//		$('#whType').val($("#whCd option:selected").data("rprc"));  // 하치장, 공장, 외주 구분
		var mngPrdtLen = ''; 
		if($('#whType').val() == "WHDIV01") {mngPrdtLen = 8;}
		formData.append("mngPrdtLen", mngPrdtLen);           // 길이관리,,,, 공장의 경우 길이는  8m로 고정할때 사용한다.
//--------------------------------------------------------------------------------------------------------------

		filePutAjax("/user/ar/ar01/updateCancel", formData, function(data){
			alert(data.resultMessage);         
			if(data.resultCode == 200) {
				gridView.setData(0);
				modalStack.close();	
			}
		});
	}
	
	function makeFormData(type) {
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#popForm")[0]);
		
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#detailTable tr[name="detailRow"]'), function(idx, elem){
			if(type == "CONFIRM") {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "N") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						if(elem.name == "shipProcId" && elem.value == "") elem.value = jwt.userId;
						if(elem.name == "shipProcNm" && elem.value == "") elem.value = jwt.userNm;
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			} else {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "Y") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}
	
	function setReport(type) {
		var flag = false;
		
		if(type == 'SHIP'){
			var fileName = "AR0101R02.jrf";
			if ($('#detailTable tr[name="detailRow"]').length > 6) {
				fileName = "AR0101R03.jrf";
			}
			var arg = "coCd#"			+ $('#coCd').val()
		         + "#clntCd#"		+ $('#clntCd').val()
		         + "#shipSeq#"		+ $('#shipSeq').val()
		         + "#";
		}
		callReport(fileName, arg, "1050", "700");
	}
</script>
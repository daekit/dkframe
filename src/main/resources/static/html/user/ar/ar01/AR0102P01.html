<body>
  <div class="popup_area of_a" style="width: 100%; height: 100%;">
    <div class="tit_contents">
        <h4 class="tit">출하요청서</h4>
    </div>

    <div class="popup_table">
    	<input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/>
    	<form id="popForm">
	        <table>
	            <colgroup>
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	                <col width="12%">
	                <col width="">
	            </colgroup>
	            <tr>
	                <th class="hit">회사</th>
	                <td>                             
	                    <select id="coCd" name="coCd" data-kind="CO" required="required">
	                    </select>
	                </td>
	                <th class="hit">판매유형</th>
	                <td>                                
	                    <select id="typCd" name="typCd" data-kind="SELLTYPE" required="required">
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	                <th class="hit">직송여부</th>
	                <td>                                
	                    <select id="dirtrsYn" name="dirtrsYn" disabled="disabled" required="required">
		                  	<option value="N" selected="selected">N</option>
		                  	<option value="Y" >Y</option>
		                </select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">매출거래처</th>
	                <td>     
	                    <input type="hidden" id="clntCd" name="clntCd" style="width: 76%;" readonly="readonly">
	                    <div class="search_form">
	                    	<input type="text" id="clntNm" readonly="readonly" required="required">
	                    	<button type="button" onclick="openSecondClntSearch();"><i class="i_search_w"></i></button>
	                    </div>
	                </td>
	                <th class="hit">재고주체</th>
	                <td>   
	                	<select id="ownerCd" name="ownerCd" data-kind="OWNER" required="required">
	                        <option value="">선택</option> 
	                    </select>               
	                </td>
	                <th class="hit">영업담당자</th>
	                <td>                                
	                    <input type="hidden" id="salesMng" name="salesMng">
	                    <div class="search_form">
		                    <input type="text" id="salesMngNm" name="salesMngNm" readonly="readonly" required="required">
	                    	<button type="button" onclick="openSecondUserSearch();"><i class="i_search_w"></i></button>
	                    </div>
	                </td>
	            </tr>
	            <tr>
	            	<th class="hit">Maker</th>
	                <td>                                
	                    <select id="makrCd" name="makrCd" data-kind="MAKR" required="required">
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	                <th class="hit">출하창고</th>
	                <td>                                
	                    <select id="whCd" name="whCd" data-kind="WH" required="required">
		                  	<option value="">선택</option> 
		                </select>
	                </td>
	                <th>판매지역</th>
	                <td class="drctArea">                                
	                    <select id="salesAreaCd" name="salesAreaCd" data-kind="SALESAREA">
	                        <option value="">선택</option> 
	                    </select>
	                </td>
	            </tr>
	            <tr>
	                <th class="hit">수입여부</th>
	                <td>
		                <select id="impYn" name="impYn">
		                  	<option value="N" selected="selected">N</option>
		                  	<option value="Y" >Y</option>
		                </select>
	                </td>
	            	<th>운송비</th>
	                <td>     
	                    <input id="transAmt" name="transAmt" type="text" onkeyup="addComma(this);" comma>
	                </td>
	                <th>요청일자</th>
	                <td>
	                	<input type="text" id="reqDt" name="reqDt" class="input_calendar">
	                </td>
	            </tr>
	            <tr>
	                <th>주문번호</th>
	                <td>     
	                	<div class="search_form">
		                    <input type="text" id="odrSeq" name="odrSeq" readonly="readonly"><!-- 주문번호 -->
	                    	<a onclick="odrSearch();"><i class="i_search_w"></i></a>
	                    </div>
	                </td>
	                <th>담당자Tel</th>
	                <td>
	                	<input type="text" id="mngTel" name="mngTel">
	                </td>
	                <th class="hit">납품일시</th>
	                <td>
                		<input type="text" id="dlvrDttm" name="dlvrDttm" class="input_calendar">
<!-- 	                	<input type="text" id="dlvrDttm" name="dlvrDttm" style="width: 35% !important;"> -->
	                </td>
	            </tr>
	            <tr>
	                <th rowspan="2">우편번호</th>
	                <td>
	                	<div class="search_form">
		                    <input id="addrZip" name="addrZip" type="text" readonly="readonly">
	                    	<button type="button" onclick="openDaumPostcode();"><i class="i_search_w"></i></button>
	                    </div>
	                </td>
	                <th>현장명</th>
	                <td>
	                	<div class="search_form">
			              <input type="hidden" id="siteCd" name="siteCd" value="0">
			              <input type="text" id="siteNm" name="siteNm">
			              <button type="button" onclick="openSecondSiteSearch();"><i class="i_search_w"></i></button>
			            </div>
	                </td>
	                <th>프로젝트명</th>
	                <td>
	                	<div class="search_form">
			              <input type="hidden" id="prjctCd" name="prjctCd" value="0">
			              <input type="text" id="prjctNm" name="prjctNm">
			              <button type="button" onclick="openSecondPrjctSearch();"><i class="i_search_w"></i></button>
			            </div>
	                </td>
	            </tr>
	            <tr>
	                <td colspan="3" style="border-left: 0px !important;">
	                    <input id="addrMain" name="addrMain" type="text" style="width: 100%;" placeholder="선택 주소지" readonly="readonly">
	                </td>
	                <td colspan="2">
	                	<input id="addrSub" name="addrSub" type="text" style="width: 100%;" placeholder="상세 주소 입력">
	                </td>
	            </tr>
	            <tr>
	            	<th>납기 비고</th>
	                <td colspan="5">     
	                	<textarea class="form-control" id="dlvrRmk" name="dlvrRmk" type="text" style="height: 60px;" maxlength="500"></textarea>
	                </td>
	            </tr>
	            <tr>
	            	<th>출하 비고</th>
	                <td colspan="5">     
	                	<textarea class="form-control" id="shipRmk" name="shipRmk" type="text" style="height: 60px;" maxlength="500"></textarea>
	                </td>
	            </tr>
	            <tr>
	                <th style="text-align: center;">총 수량</th>
	            	<td><input type="text" name="shipTotQty" style="text-align: right;" readonly="readonly" comma></td>
	            	<th style="text-align: center;">총 금액</th>
	            	<td><input type="text" name="shipTotAmt" style="text-align: right;" readonly="readonly" comma></td>

	            </tr>
	            
	        </table>
<!-- 
	        <table>
	            <colgroup>
	                <col width="17%">
	                <col width="17%">
	                <col width="17%">
	                 <col width="17%">
	                <col width="17%">
	                <col width="17%">
	               
	            </colgroup>
	            <tr>
	            	<th colspan="3" style="text-align: center;">출하 요청</th>
	             	<th colspan="3" style="text-align: center;">실 출하</th>  
	            </tr>
	            <tr>
	             	<th style="text-align: center;">총 수량</th>
	            	<th style="text-align: center;">총 중량</th>
	            	<th style="text-align: center;">총 금액</th>
	            	<th style="text-align: center;">총 수량</th>
	            	<th style="text-align: center;">총 중량</th>
	            	<th style="text-align: center;">총 금액</th>
	            
	            </tr>
	            <tr>
	            	<td><input type="text" name="shipTotQty" style="text-align: right;" readonly="readonly" comma></td>
	            	<td><input type="text" name="shipTotWt" style="text-align: right;" readonly="readonly" comma></td>
	            	<td><input type="text" name="shipTotAmt" style="text-align: right;" readonly="readonly" comma></td>
	             	<td><input type="text" name="realTotQty" style="text-align: right;" readonly="readonly" comma></td>
	            	<td><input type="text" name="realTotWt" style="text-align: right;" readonly="readonly" comma></td>
	            	<td><input type="text" name="realTotAmt" style="text-align: right;" readonly="readonly" comma></td>
	            	
	            </tr>
            </table>
 -->
	        <input type="hidden" id="userId"      name="userId">
	        <input type="hidden" id="pgmId"       name="pgmId"    value="AR0102P01">
	        <input type="hidden" id="shipSeq"     name="shipSeq">
	        <input type="hidden" id="ordrgSeq"    name="ordrgSeq">			<!-- 발주번호 -->
	        <input type="hidden" id="ordrgDtlSeq" name="ordrgDtlSeq">	<!-- 발주상세번호 -->
	        <input type="hidden" id="realTotQty"  name="realTotQty">	<!-- 총 수량 -->
	        <input type="hidden" id="realTotWt"   name="realTotWt">     <!-- 총 중량 -->
	        <input type="hidden" id="realTotAmt"  name="realTotAmt">	<!-- 총 금액 -->
	        <input type="hidden" id="realTotAmt"  name="shipTotWt">	    <!-- 총 금액 -->
	        <input type="hidden" id="sellVatCd"  name="sellVatCd">	    <!-- 부가세 코드-->
	    </form>
    </div>

    <br>
    <!-- 테이블 -->
    <div class="popup_table">
      <table>
        <tr>
          <td colspan="2" style=" text-align: LEFT; border-right: 0; ">※상세내역</td>
          <td colspan="14">
            <div class="add_btn">
              <a onclick="addRow();">+</a>
              <a onclick="removeDetailRow();">-</a>
            </div>
          </td>
        </tr>
      </table>
      
     <div class="ofx_s" style="width:100%;">
      <table id="detailTb" style="width: 1800px;">
        <colgroup>
        	<col width="2%">
        	<col width="7%">   <!-- 제품명 -->
      		<col width="5%">   <!-- SIZE -->
      		<col width="5%">   <!-- SPEC-->
      		<col width="3%">   <!-- 길이 -->
      		<col width="3%">   <!-- 단위 -->
      		<col width="5%">   <!-- 출하지시 수량-->
 <!--       		<col width="5%">   -->
      		<col width="5%">
      		<col width="5%">
      		<!-- 실출하 -->
<!--       		<col width="5%">   
      		<col width="5%">
      		<col width="5%">
      		<col width="5%">
 -->      		
      		<col width="4%">   <!-- 상태 -->
      		<col width="5%">   <!-- 담당자 -->
      		<col width="5%">   <!-- 완료일자 -->
      		<col width="6%">   <!-- 차량번호 -->
      		<col width="12%">  <!-- 지고 -->
        </colgroup>
        <tr>
        	<th rowspan="2"></th>
            <th rowspan="2" style="text-align: center;" class="hit">제품명</th>
<!--             <th rowspan="2">제품강종</th> -->
            <th rowspan="2" style="text-align: center;">사이즈</th>
            <th rowspan="2" style="text-align: center;">SPEC</th>
            <th rowspan="2" style="text-align: center;">길이</th>
            <th rowspan="2" style="text-align: center;">단위</th>
            <th colspan="3" style="text-align: center;">출하지시</th>
<!--             <th colspan="4" style="text-align: center;">실출하</th>   -->
            <th rowspan="2" style="text-align: center;">상태</th>
            <th rowspan="2" style="text-align: center;">담당자</th>
            <th rowspan="2" style="text-align: center;">완료일자</th>
            <th rowspan="2" style="text-align: center;">차량번호</th>
            <th rowspan="2" style="text-align: center;">비고</th>
        </tr>
        <tr>
            <th style="text-align: center;" class="hit">수량</th>
 <!--            <th style="text-align: center;" class="hit">중량</th>  -->
            <th style="text-align: center;">단가</th>
            <th style="text-align: center;">금액</th>
<!--             <th style="text-align: center;">수량</th>
            <th style="text-align: center;">중량</th>
            <th style="text-align: center;">단가</th>
            <th style="text-align: center;">금액</th>
 -->            
        </tr>
        <!-- // -->
        <tbody>
          <tr class="detailRow">
          	<td>
				<input type="checkbox" name="detailChkBox">
			</td>
            <td>
              <input type="hidden" name="shipDtlSeq">
              <input type="hidden" name="odrDtlSeq">
              <input type="hidden" name="prdtCd">
              <input type="hidden" name="pchsUpr">
              <input type="hidden" name="sellUpr">
              <input type="hidden" name="stockUpr">
              <input type="hidden" name="prdtUpr">
	          <input type="hidden" name="prdtCnvrsnWt" >  
	          <input type="hidden" name="realShipQty">  
	          <input type="hidden" name="realShipWt">  
	          <input type="hidden" name="realShipUpr">  
	          <input type="hidden" name="realShipAmt">   
	          <input type="hidden" name="shipWt">   
	          <input type="hidden" name="bilgVatAmt">    <!-- 부가세 -->
	        
              <div class="search_form">
                <input type="text" name="prdtNm" readonly="readonly">
              	<button type="button" onclick="openSecondPrdtSearch(this);"><i class="i_search_w"></i></button>
              </div>
            </td>
<!--             <td><input type="text" name="prdtStknNm" readonly="readonly"></td> -->
            <td><input type="text" style="text-align: right;" name="prdtSize"></td>
            <td><input type="text" style="text-align: right;" name="prdtSpec"></td>
            <td><input type="text" style="text-align: right;" name="prdtLen"></td>
            <td><input type="text" name="prdtUnitNm" readonly="readonly" style="text-align: center;"></td>
            <td>
	            <input type="text" name="shipQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
	        </td>
 <!--       <td>
            	<input type="text" name="shipWt" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" required comma>
            </td>
  -->
            <td>
            	<input type="text" name="shipUpr" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" comma>
            </td>
            <td>
            	<input type="text" name="shipAmt" style="text-align: right;" readonly="readonly" comma>
            </td>
 <!--            <td>
	            <input type="text" name="realShipQty" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" comma value="0">
	        </td>
            <td>
            	<input type="text" name="realShipWt" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" comma value="0">
            </td>
            <td>
            	<input type="text" name="realShipUpr" style="text-align: right;" onkeyup="addComma(this);countAmt(this);" comma value="0">
            </td>
            <td>
            	<input type="text" name="realShipAmt" style="text-align: right;" readonly="readonly" comma value="0">
            </td>
  -->
            <td>
            	<input type="text" name="shipYn" readonly="readonly" style="text-align: center;">
            </td>
            <td>
            	<div class="search_form">
	                <input type="hidden" name="shipProcId">
	                <input type="text" name="shipProcNm" readonly="readonly">
	            	<button type="button" onclick="openSecondUserSearch();"><i class="i_search_w"></i></button>  <!-- this, 'SHIP' -->
	            </div>
            </td>
            <td>
            	<input type="text" name="shipDttm" readonly="readonly" style="text-align: center;">
            </td>
            <td>
            	<input type="text" name="shipVehNo">
            </td>
            <td>
            	<input type="text" name="shipDtlRmk">
            </td>
          </tr>
        </tbody>
      </table>
      <table style="width: 1800px;">
      	<colgroup>
       	<col width="2%">
        	<col width="7%">   <!-- 제품명 -->
      		<col width="5%">   <!-- SIZE -->
      		<col width="5%">   <!-- SPEC-->
      		<col width="3%">   <!-- 길이 -->
      		<col width="3%">   <!-- 단위 -->
      		<col width="5%">   <!-- 출하지시 수량-->
 <!--       		<col width="5%">   -->
      		<col width="5%">
      		<col width="5%">
      		<!-- 실출하 -->
<!--       		<col width="5%">   
      		<col width="5%">
      		<col width="5%">
      		<col width="5%">
 -->      		
      		<col width="4%">   <!-- 상태 -->
      		<col width="5%">   <!-- 담당자 -->
      		<col width="5%">   <!-- 완료일자 -->
      		<col width="6%">   <!-- 차량번호 -->
      		<col width="12%">  <!-- 비고 -->
        </colgroup>
      	<tr>
            <th colspan="6" style="text-align: center;">합계</th>
            <td id="shipTotQty" style="text-align: right;" comma></td>
 <!--           <td id="shipTotWt" style="text-align: right;" comma></td>    -->
            <td>-</td>
            <td id="shipTotAmt" style="text-align: right;" comma></td>
<!--             <td id="realTotQty" style="text-align: right;" comma></td>
            <td id="realTotWt" style="text-align: right;" comma></td>
            <td>-</td>
            <td id="realTotAmt" style="text-align: right;" comma></td>
  -->
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
      </table>
      </div>
    </div>
    <br>
    <div class="popup_table">
      <table>
        <colgroup>
        	<col width="12%">
        </colgroup>
	  	<tr>
	  		<th>
	  			<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="file.click();">첨부파일</button>
	  		</th>
	  		<td>
	  			<div data-ax5grid="file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
	  		</td>
	  	</tr>
	  </table>
    </div>
    <!-- 하단 버튼 -->
    <div class="popup_bottom_btn">
      <button id="actionBtn">등록</button>
      <button class="close_btn" onclick="modal.close();">닫기</button>
    </div>
  </div>
 
</body>
<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	
	//매입매출구분
	var clntType = null;
	var treeType = null;
	var fileArr = [];
	var deleteFileArr = [];
	var selectedIdx = 0;
	var fileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            },
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 405},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	                {
						key:"fileDelete", label: "삭제", width: 55,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: fileArr,
				page : {
					totalElements : fileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		fileGridView.initView();
		setCommonSelect($(".popup_area select[data-kind]"));
		$('#dlvrDttm').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		setInit();
	});
	
	function setInit() {
		if(actionType == "C"){
			$('#actionBtn').on("click", function(){insertShip();});
			$('#actionBtn').text("등록");
			$("#reqDt").val(dateToStr(new Date()));
		}else if(actionType == "U"){
			selectShipInfo();
			$('#actionBtn').on("click", function(){updateShip();});
			$('#actionBtn').text("저장");
		}else if(actionType == "O"){
			getOrderInfo();
			$('#odrSeq').siblings('a').remove();
			$('#actionBtn').on("click", function(){insertShip();});
			$('#actionBtn').text("등록");
		}
	}
	
	function selectShipInfo() {
		var row;
		if(openFrom == "CM1001M01"){
			row = shipGridView.target.getList("selected")[0];
		} else {
			row = gridView.target.getList("selected")[0];
		}
		var formData = {
			"shipSeq" : row.shipSeq,
			"reqDt" : row.reqDt.replace(/-/g, "")
		}
		postAjax("/user/ar/ar01/selectShipInfo", formData, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function getOrderInfo(){
		var formData = {
			"odrSeq": odrSeq,
			"odrDtlSeqArr": odrDtlSeqArr
		};
		postAjax("/user/ar/ar01/getOrderInfo", formData, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var fileInfo = obj.fileList;
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		if(shipInfo.shipYn == "Y") {
			$("#actionBtn").hide();
		}
		//메인정보 세팅
		$.each(shipInfo, function(key, value){
			$('#'+key).val(value);
		});
		
		//상세정보 세팅
		$.each(shipDetail, function(idx, item){
			if(idx != 0) addRow();
			$.each(item, function(key, value){
				if($(".detailRow").find("input[name="+key+"]")[idx] != undefined) {
					$(".detailRow").find("input[name="+key+"]")[idx].value = value;
				}
			});
			if(item.shipYn == "Y") {
				$($("input[name='detailChkBox']")[idx]).prop("checked", true);
				$($("input[name='detailChkBox']")[idx]).prop("disabled", true);
				$($(".detailRow")[idx]).find("input").prop("disabled", true);
				$($(".detailRow")[idx]).find("button").prop("disabled", true);
			} else {
				$($("input[name='detailChkBox']")[idx]).prop("disabled", false);
			}
			countTot();
		});
		
		//콤마 추가
		$.each($('input[comma]'), function(idx, elem){
			addComma(elem);
		});
		
		if(actionType != "O"){
			$.each(fileInfo, function(idx, obj){
				fileArr.push({
					'fileKey' : obj.fileKey,
			      	'fileName' : obj.fileName,
			      	'fileType' : obj.fileType,
			      	'fileSize' : obj.fileSize,
			      	'file' : obj
				});
			});
			// 첨부파일 그리드 set
			fileGridView.setData();
		}
	}
	
	function addRow() {
		var row = $("#detailTb > tbody:last > tr:last").clone();
		$("#detailTb > tbody:last").append(row);
		$.each($(row).find(':input'), function(){
			this.value = '';
			this.checked = '';
			$(this).prop("disabled", false);
		});
		$(row).find('input[name=realShipQty]').val("0");
		$(row).find('input[name=realShipWt]').val("0");
		$(row).find('input[name=realShipUpr]').val("0");
		$(row).find('input[name=realShipAmt]').val("0");
		countTot();
	}

	function removeDetailRow(){
		$.each($('input:checkbox[name="detailChkBox"]'), function(idx, elem){
			if($(elem).is(":checked") && ($($("input[name='shipYn']")[idx]).val() == "" || $($("input[name='shipYn']")[idx]).val() == "N")){
				$(elem).closest('.detailRow').remove();
			}
		});
		countTot();
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": fileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function setFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var tempArr = obj.name.split(".");
			fileArr.push({
				'fileKey' : 0,
		      	'fileName' : obj.name,
		      	'fileType' : tempArr[tempArr.length-1],
		      	'fileSize' : obj.size,
		      	'file' : obj
			});
		});
		fileGridView.setData();
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		fileGridView.target.removeRow(rowIndex);
		
		if(fileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(fileArr[rowIndex].fileKey);
		}
		
		fileArr.splice(rowIndex, 1);
		
		fileGridView.setData();
	}
	
	// 제품 검색
	function openSecondPrdtSearch(elem) {
		$targetRow = $(elem).closest('tr.detailRow');
		
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"selpchCd": "SELPCH2",
			"impYn": $("#impYn").val(), 
			"clntCd" : $("#clntCd").val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 600, 420, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$targetRow.find('input[name="prdtCd"]').val(row.prdtCd);
			$targetRow.find('input[name="prdtCnvrsnWt"]').val(row.prdtCnvrsnWt);
			$targetRow.find('input[name="prdtNm"]').val(row.prdtNm);
			$targetRow.find('input[name="prdtUnitNm"]').val(row.prdtUnitNm);
			$targetRow.find('input[name="shipUpr"]').val(row.ordrgUpr);
			$targetRow.find('input[name="prdtUpr"]').val(row.ordrgUpr);
			$targetRow.find('input[name="prdtSpec"]').val(row.prdtSpec);
			$targetRow.find('input[name="prdtSize"]').val(row.prdtSize);
		//	$targetRow.find('input[name="odrUpr"]').val(row.ordrgUpr);
		});
	}
	
	function makeFormData() {
		$("#popForm input").prop("disabled", false);
		$("#popForm select").prop("disabled", false);
		$("#userId").val(jwt.userId);
		$("#reqDt").val($("#reqDt").val().replace(/-/g, ""));
		if($("#prjctCd").val() == "") $("#prjctCd").val("0");
		//콤마 제거
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		var formData = new FormData($("#popForm")[0]);
		
		// 첨부파일 추가
		$.each(fileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('.detailRow'), function(midx, elem){
			if($(elem).find("input[name='shipYn']").val() == "N" || $(elem).find("input[name='shipYn']").val() == "") {
				var detailObj = {};
				$.each($(elem).find('[name]'), function(idx, elem){
					if(elem.name == "realShipQty" && elem.value == "0") elem.value = $($('.detailRow')[midx]).find("input[name=shipQty]")[0].value;
					if(elem.name == "realShipWt"  && elem.value == "0") elem.value = $($('.detailRow')[midx]).find("input[name=shipWt]")[0].value;
					if(elem.name == "realShipUpr" && elem.value == "0") elem.value = $($('.detailRow')[midx]).find("input[name=shipUpr]")[0].value;
					if(elem.name == "realShipAmt" && elem.value == "0") elem.value = $($('.detailRow')[midx]).find("input[name=shipAmt]")[0].value;
					detailObj[elem.name] = elem.value;
				});
				detailArr.push(detailObj);
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		if(actionType == "U") {
			formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		}
		
		return formData;
	}
	
	function insertShip() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePostAjax("/user/ar/ar01/insertShip", formData, function(data){
				alert(data.resultMessage);
				gridView.setData(0);
			//	modal.close();
			});
		}
	}
	
	function updateShip() {
		if(inputValidation($('input[required]'))) {
			var formData = makeFormData();
			filePutAjax("/user/ar/ar01/updateShip", formData, function(data){
				alert(data.resultMessage);   
				if(openFrom == "CM1001M01"){
					targetGrid = shipGridView;
				} else {
					targetGrid = gridView;
				}        
				targetGrid.setData(0);
				viewShipModal();
			//	modal.close();
			});
		}
	}
	
	
	// 사용자 검색
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : $('#coCd').val(),
			"userId": $('#salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#salesMng').val(checkedNode.id);
			$('#salesMngNm').val(checkedNode.text);
		});
	}
		
	
	// 구버전 
/*	function openUserTree(el, type) {
		treeType = type; 
		selectedIdx = $(el).closest('tr').prevAll().length;
		openSecondModal("/static/html/user/od/od01/OD0102P04.html", 300, 500, "사용자 검색");
	}
*/	
	function countAmt(el) {
		var rowIdx       = $(el).closest('tr').prevAll().length;
		var shipQty      = $("input[name='shipQty']")[rowIdx].value;
		var shipUpr      = $("input[name='shipUpr']")[rowIdx].value;
		var prdtCnvrsnWt = $("input[name='prdtCnvrsnWt']")[rowIdx].value;
		var realShipQty  = $("input[name='realShipQty']")[rowIdx].value;
		var realShipUpr  = $("input[name='realShipUpr']")[rowIdx].value;
		var sellVatCd    = $('#sellVatCd').val();	
		var vatRate      = 0;

		   // 실발주 단가가 없을 경우 지시단가로 초기값 정함.
/*		if(realShipUpr == 0 && realShipQty != 0) 
		 { $("input[name='realShipUpr']")[rowIdx].value = shipUpr; 
		     realShipUpr  = shipUpr; }
*/		
		$("input[name='shipWt']")[rowIdx].value      = (deleteCommaStr(shipQty)     * deleteCommaStr(prdtCnvrsnWt));
		$("input[name='shipAmt']")[rowIdx].value     = (deleteCommaStr(shipQty)     * deleteCommaStr(shipUpr));
		
		$("input[name='realShipQty']")[rowIdx].value     = deleteCommaStr(shipQty);
		$("input[name='realShipUpr']")[rowIdx].value     = deleteCommaStr(shipUpr);
		$("input[name='realShipWt']")[rowIdx].value      = (deleteCommaStr(shipQty)     * deleteCommaStr(prdtCnvrsnWt));
		$("input[name='realShipAmt']")[rowIdx].value     = (deleteCommaStr(shipQty)     * deleteCommaStr(shipUpr));
		
//		$("input[name='realShipWt']")[rowIdx].value  = (deleteCommaStr(realShipQty) * deleteCommaStr(prdtCnvrsnWt));
//		$("input[name='realShipAmt']")[rowIdx].value = (deleteCommaStr(realShipQty) * deleteCommaStr(realShipUpr));
		addComma($("input[name='shipAmt']")[rowIdx]);
		addComma($("input[name='shipWt']")[rowIdx]);
//		addComma($("input[name='realShipWt']")[rowIdx]);
//		addComma($("input[name='realShipAmt']")[rowIdx]);
		countTot();
	}
	
	function countTot() {
		var shipTotQty = 0;
		var shipTotWt = 0;
		var shipTotAmt = 0;
		var realTotQty = 0;
		var realTotWt = 0;
		var realTotAmt = 0;
		$.each($(".detailRow"), function(idx, item){
			var shipQty = $("input[name='shipQty']")[idx].value;
			var shipWt = $("input[name='shipWt']")[idx].value;
			var shipAmt = $("input[name='shipAmt']")[idx].value;
			var realShipQty = $("input[name='realShipQty']")[idx].value;
			var realShipWt = $("input[name='realShipWt']")[idx].value;
			var realShipAmt = $("input[name='realShipAmt']")[idx].value;
			shipTotQty += Number(deleteCommaStr(shipQty)); 
			shipTotWt += Number(deleteCommaStr(shipWt)); 
			shipTotAmt += Number(deleteCommaStr(shipAmt));
			realTotQty += Number(deleteCommaStr(realShipQty)); 
			realTotWt += Number(deleteCommaStr(realShipWt)); 
			realTotAmt += Number(deleteCommaStr(realShipAmt)); 
		});
		$("#shipTotQty").html(addCommaStr(shipTotQty));
		$("#shipTotWt").html(addCommaStr(shipTotWt));
		$("#shipTotAmt").html(addCommaStr(shipTotAmt));
		$("#realTotQty").html(addCommaStr(realTotQty));
		$("#realTotWt").html(addCommaStr(realTotWt));
		$("#realTotAmt").html(addCommaStr(realTotAmt));
		
		$("input[name='shipTotQty']").val(addCommaStr(shipTotQty));
		$("input[name='shipTotWt']").val(deleteCommaStr(shipTotWt));
		$("input[name='shipTotAmt']").val(addCommaStr(shipTotAmt));
		$("input[name='realTotQty']").val(deleteCommaStr(realTotQty));
		$("input[name='realTotWt']").val(deleteCommaStr(realTotWt));
		$("input[name='realTotAmt']").val(deleteCommaStr(realTotAmt));
	}

	// 프로젝트 검색
	function openSecondPrjctSearch(){
		var paramObj = {"coCd": $('#coCd').val()}
		openSecondModal("/static/html/cmn/modal/prjctSearch.html", 700, 420, "프로젝트 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			
			$("#prjctCd").val(row.prjctCd);
			$("#prjctNm").val(row.prjctNm);
			$('#addrZip').val(row.prjctAddrZip);
			$('#addrMain').val(row.prjctAddr);
			$('#addrSub').val(row.prjctAddrSub);
		});
	}
/*	
	function prjctSearch() {
		openSecondModal("/static/html/user/od/od01/OD0102P05.html", 700, 420, "프로젝트");
	}
*/	
	function odrSearch() {
		openSecondModal("/static/html/user/od/od01/OD0102P06.html", 700, 420, "주문서");
	}

	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#addrZip').val(data.zonecode);
				$('#addrMain').val((data.roadAddress || data.address) + ' ' + data.buildingName);
			}
		}).open();
	}

	
	// 거래처 검색
	function openSecondClntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#clntCd').val(row.clntCd);
			$('#clntNm').val(row.clntNm);
			$('#sellVatCd').val(row.sellVatCd);			
		});
	}

	
	function viewShipModal() {
		var targetGrid;
		if(openFrom == "CM1001M01"){
			targetGrid = shipGridView;
		} else {
			targetGrid = gridView;
		}
		selectedRowIdx = targetGrid.target.getList("selected")[0].__index;
		openModal("/static/html/user/ar/ar01/AR0102V01.html", 1200, 780, " ");
	}
	
	
</script>

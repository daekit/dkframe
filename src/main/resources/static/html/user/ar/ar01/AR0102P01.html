<div id="shipPopup" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div id="arViewDiv">
		<div class="tit_contents">
			<h4 class="tit"></h4>
		</div>
		<div class="popup_table">
			<input type="file" id="file" style="display: none" multiple="multiple" onchange="setFile(this);" />
			<form id="popForm">
				<input type="hidden" id="pgmId" name="pgmId" value="AR0102P01"> 
				<input type="hidden" id="reqDt" name="reqDt">
				<input type="hidden" id="shipSeq" name="shipSeq"> 
				<input type="hidden" id="ordrgSeq" name="ordrgSeq"> <!-- 발주번호 -->
				<input type="hidden" id="ordrgDtlSeq" name="ordrgDtlSeq"> <!-- 발주상세번호 -->
				<input type="hidden" id="realTotQty" name="realTotQty"> <!-- 총 수량 -->
				<input type="hidden" id="realTotWt" name="realTotWt"> <!-- 총 중량 -->
				<input type="hidden" id="realTotAmt" name="realTotAmt"> <!-- 총 금액 -->
				<input type="hidden" id="sellVatCd" name="sellVatCd"> <!-- 부가세 코드-->
				<input type="hidden" id="allocVehlNo" name="allocVehlNo"> <!-- 배차번호 -->
				<input type="hidden" id="odrCreatDiv" name="odrCreatDiv"> <!-- 오더생성 구분 -->
				<table>
					<colgroup>
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
					</colgroup>
					<tr>
						<th class="hit">회사</th>
						<td>
							<select id="coCd" name="coCd" data-kind="CO" msg="회사" onchange="setByCoCd(this.value);" required></select>
						</td>
						<th class="hit">판매유형</th>
						<td>
							<select id="typCd" name="typCd" data-kind="SELLTYPE" msg="판매유형" onchange="setBySellType(this.value);" required>
								<option value="">선택</option>
							</select>
						</td>
						<th>직송여부</th>
						<td>
							<select id="dirtrsYn" name="dirtrsYn" msg="직송여부" disabled>
								<option value="N" selected>N</option>
								<option value="Y">Y</option>
							</select>
						</td>
					</tr>
					<tr>
						<th class="hit">매출거래처</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="clntCd" name="clntCd" msg="매출거래처">
								<input type="text" id="clntNm" readonly  msg="매출거래처" required>
								<a onclick="openSecondClntSearch();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<th class="hit">재고주체</th>
						<td>
							<select id="ownerCd" name="ownerCd" data-kind="OWNER" msg="재고주체" required>
								<option value="">선택</option>
							</select>
						</td>
						<th class="hit">영업담당자</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="salesMng" name="salesMng">
								<input type="text" id="salesMngNm" name="salesMngNm" msg="영업담당자" readonly required>
								<a onclick="openSecondUserSearch();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
					</tr>
					<tr>
						<th>현장명</th>
						<td>
							<div class="search_form">
								<input type="hidden" id="prjctCd" name="prjctCd">
								<input type="hidden" id="siteCd" name="siteCd">
								<input type="text" id="siteNm" name="siteNm" readonly>
								<a onclick="openArSiteSearch();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<th class="hit">출하창고</th>
						<td>
							<select id="whCd" name="whCd" data-kind="WH" onchange="setTaxivcCoprt();" msg="출하창고" required>
								<option value="">선택</option>
							</select>
						</td>
						<th class="hit">계산서발행법인</th>
						<td>
							<select id="taxivcCoprt" name="taxivcCoprt" data-kind="ESTCOPRT" msg="계산서발행법인" required>
								<option value="">선택</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>판매지역</th>
						<td>
							<select id="salesAreaCd" name="salesAreaCd" data-kind="SALESAREA">
								<option value="">선택</option>
							</select>
						</td>
						<th>착지연락처</th>
						<td>
							<input type="text" id="mngTel" name="mngTel" onkeyup="telNumberFormatter(this);">
						</td>
						<th class="hit">출하일자</th>
						<td>
							<input type="text" class="input_calendar" id="dlvrDttm" name="dlvrDttm" autocomplete="off" msg="납품일시" date required>
						</td>
					</tr>
					<tr>
						<th>주문번호</th>
						<td>
							<div class="search_form">
								<input type="text" id="odrSeq" name="odrSeq" readonly>
								<a onclick="openSecondOrderSearch();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<th>운송비</th>
						<td>
							<div class="search_form">
							    <input type="hidden" id="transSeq" name="transSeq">
								<input type="text" id="transAmt" name="transAmt" onkeyup="onlyNumber(this);" comma> 
								<a onclick="transAmtModal();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<th>운송차수</th>
						<td>
							<input type="text" id="shipCnt" name="shipCnt" onkeyup="onlyNumber(this)" comma>
						</td>
					</tr>
					<tr>
						<th>착지주소</th>
						<td>
							<div class="search_form">
								<input id="addrZip" name="addrZip" type="text" readonly>
								<a onclick="openDaumPostcode();">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<td colspan="2" style="border-left: 0px !important;">
							<input type="text" id="addrMain" name="addrMain" placeholder="선택 주소지" readonly>
						</td>
						<td colspan="2">
							<input type="text" id="addrSub" name="addrSub" placeholder="상세 주소 입력">
						</td>
					</tr>
					<tr>
						<th>납기 비고<br>(내부용)</th>
						<td colspan="5">
							<textarea class="form-control" id="dlvrRmk" name="dlvrRmk" style="height: 60px;" maxlength="500"></textarea>
						</td>
					</tr>
					<tr>
						<th>출하 비고</th>
						<td colspan="5">
							<textarea class="form-control" id="shipRmk" name="shipRmk" style="height: 60px;" maxlength="500"></textarea>
						</td>
					</tr>
				</table>
			</form>
		</div>
		<br>
		<!-- 테이블 -->
		<div class="popup_table">
			<table>
				<tr>
					<td colspan="2" style="text-align: LEFT; border-right: 0;">※상세내역</td>
					<td colspan="14">
						<div class="add_btn">
							<a onclick="cloneDetailRow();" style="width: 50px" authchk>복사</a>
							<a onclick="openSecondMultiPrdtSearch();" authchk>+</a>
							<a onclick="removeDetailRow();" authchk>-</a>
						</div>
					</td>
				</tr>
			</table>
	
			<div class="ofx_s" style="width: 100%;">
				<table id="detailTable" style="width: 1600px;">
					<colgroup>
						<col width="2%">
						<col width="13%"> <!-- 제품명 -->
						<col width="6%">  <!-- SIZE -->
						<col width="6%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="6%">  <!-- 출하지시 수량-->
						<col width="6%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 출하지시 단가-->
						<col width="6%">  <!-- 출하지시 금액-->
						<col width="6%">  <!-- 출하지시 손익-->
						<col width="4%">  <!-- 수입여부 -->
						<col width="5%">  <!-- Maker -->
						<col width="6%">  <!-- 완료일자 -->
						<col width="6%">  <!-- 차량번호 -->
						<col width="13%"> <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" style="padding: 3px;"> 
							<input type="checkbox" id="allChkBox" onchange="ctrlDetailChkBox(this);">
						</th>
						<th class="tc hit">제품명</th>
						<th class="tc">사이즈</th>
						<th class="tc">SPEC</th>
						<th class="tc">길이</th>
						<th class="tc">단위</th>
						<th class="tc hit">수량</th>
						<th class="tc hit">중량(KG)</th>
						<th class="tc">매출단가</th>
						<th class="tc">금액</th>
						<th class="tc">예상손익</th>
						<th class="tc">수입</th>
						<th class="tc">Maker</th>
						<th class="tc">완료일자</th>
						<th class="tc">차량번호</th>
						<th class="tc">비고</th>
					</tr>
				</table>
				<table id="frameTable" style="display: none;">
					<tr name="detailRow">
						<input type="hidden" name="shipDtlSeq"> 
						<input type="hidden" name="odrDtlSeq"> 
						
						<input type="hidden" name="shipYn">
						<input type="hidden" name="shipProcId">
						
						<input type="hidden" name="prdtDiv">
						<input type="hidden" name="prdtStkn">
						<input type="hidden" name="prdtStockCd">
						<input type="hidden" name="prdtCoilYn"> 
						<input type="hidden" name="prdtCnvrsnWt">
						<input type="hidden" name="prdtDt">
						
						<input type="hidden" name="pchsUpr">
						<input type="hidden" name="sellUpr">
						<input type="hidden" name="stockUpr">
						<input type="hidden" name="prdtUpr">
						<input type="hidden" name="bilgVatAmt"> <!-- 부가세 -->
						
						<input type="hidden" name="realShipQty">
						<input type="hidden" name="realShipWt">
						<input type="hidden" name="realShipUpr">
						<input type="hidden" name="realShipAmt">
						<td>
							<input type="checkbox" name="detailChkBox" onclick="ctrlAllChkBox();">
						</td>
						<td>
							<div class="search_form">
								<input type="hidden" name="prdtCd">
								<input type="text" name="prdtNm" msg="제품명" readonly required>
								<a onclick="openSecondPrdtSearch(this);">
									<i class="i_search_w"></i>
								</a>
							</div>
						</td>
						<td>
							<input type="text" class="tc" name="prdtSize">
						</td>
						<td>
							<input type="text" class="tc" name="prdtSpec">
						</td>
						<td>
							<input type="text" class="tr" name="prdtLen" onkeyup="onlyPositive(this);" >
						</td>
						<td>
							<input type="hidden" name="prdtUnit">
							<input type="text" class="tc" name="prdtUnitNm" readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipQty" onkeyup="onlyNumber(this); calShipWt(this); countAmt(this);" msg="수량" comma required>
						</td>
						<td>
							<input type="text" class="tr" name="shipWt" onkeyup="onlyNumber(this); countAmt(this);" msg="중량" comma required>
						</td>
						<td>
							<input type="hidden" name="shipUprD">
							<input type="hidden" name="shipUprI">
							<input type="text" class="tr" name="shipUpr" onkeyup="onlyNumber(this); countAmt(this);" comma>
						</td>
						<td>
							<input type="text" class="tr" name="shipAmt" onkeyup="onlyNumber(this); copyAmt(this); countTot(this);" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="epctPal" comma readonly>
						</td>
						<td>
							<select name="impYn" onchange="setByImpYn(this);" msg="수입여부">
								<option value="N" selected>N</option>
								<option value="Y">Y</option>
							</select>
						</td>
						<td>
							<select name="makrCd" data-kind="MAKR" msg="Maker"></select>
						</td>
						<td>
							<input type="text" class="tc" name="shipDttm" readonly>
						</td>
						<td>
							<input type="text" name="shipVehNo">
						</td>
						<td>
							<input type="text" name="shipDtlRmk">
						</td>
					</tr>
				</table>
				<table style="width: 1600px;">
					<colgroup>
						<col width="2%">
						<col width="13%"> <!-- 제품명 -->
						<col width="6%">  <!-- SIZE -->
						<col width="6%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="6%">  <!-- 출하지시 수량-->
						<col width="6%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 출하지시 단가-->
						<col width="6%">  <!-- 출하지시 금액-->
						<col width="6%">  <!-- 출하지시 손익-->
						<col width="4%">  <!-- 수입여부 -->
						<col width="5%">  <!-- Maker -->
						<col width="6%">  <!-- 완료일자 -->
						<col width="6%">  <!-- 차량번호 -->
						<col width="13%"> <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" colspan="6">합계</th>
						<td>
							<input class="tr" type="text" id="shipTotQty" name="shipTotQty" comma readonly>
						</td>
						<td>
							<input class="tr" type="text" id="shipTotWt" name="shipTotWt" comma readonly>
						</td>
						<td>-</td>
						<td>
							<input class="tr" type="text" id="shipTotAmt" name="shipTotAmt" comma readonly>
						</td>
						<td>
							<input class="tr" type="text" id="totEpctPal" name="totEpctPal" comma readonly>
						</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
		</div>
		<br>
		<div class="popup_table">
			<table>
				<colgroup>
					<col width="12%">
				</colgroup>
				<tr>
					<th>
						<button type="button" class="btn btn-primary btn-sm" style="height: 25px; line-height: 15px;" onclick="file.click();" authchk>첨부파일</button>
					</th>
					<td>
						<div data-ax5grid="ship-file-grid" data-ax5grid-config="{}" style="height: 120px; width: 100%"></div>
					</td>
				</tr>
			</table>
		</div>
		<!-- 하단 버튼 -->
		<div class="popup_bottom_btn">
			<button id="actionArBtn" authchk>등록</button>
			<button class="close_btn" onclick="modalStack.close();">닫기</button>
		</div>
	</div>
</div>
<script type="text/javascript">
	var targetRow = null;
	var shipFileArr = [];
	var deleteFileArr = [];
	var shipFileGridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				target: $('[data-ax5grid="ship-file-grid"]'),
				showLineNumber: true,
				showRowSelector: false,
	        	multipleSelect: false,
				header: {selector: false},
				body: {
		        	onClick: function () {
		                this.self.select(this.dindex);
		            },
		            onDBLClick: function () {
		            	downloadFile(this.dindex);
		            }
		        },
	            columns: [
	                {key: "fileName", label: "파일명", width: 405},
	                {key: "fileType", label: "파일타입", width: 140},
	                {key: "fileSize", label: "파일크기", width: 140},
	                {
						key:"fileDelete", label: "삭제", width: 55,
						formatter:function() {
							return '<button type="button" class="btn btn-default btn-sm" style="height: 19px; padding: 0 0 0 0;" onclick="deleteFile('+this.dindex+');">삭제</button>';
						}
					}
	            ]
			});
		},
		setData : function() {
			var targetObj = this.target;
			targetObj.setData({
				list: shipFileArr,
				page : {
					totalElements : shipFileArr.length
				}
			});
		}
	}
	
	$(document).ready(function() {
		
		// 공통코드 selectBox set
		setCommonSelect($('#shipPopup select[data-kind]'));
		
		// 납기일자 datepicker bind
		$('#shipPopup #dlvrDttm').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		
		// 파일 그리드 초기화
		shipFileGridView.initView();
		
		var actionType = modalStack.last().paramObj.actionType;
		if(actionType == "C"){
			$('#shipPopup #coCd').val(jwt.coCd);
			$('#shipPopup #odrCreatDiv').val("ERP");
			$('#shipPopup #reqDt').val(moment(new Date()).format("YYYYMMDD"));
			setByCoCd($('#shipPopup #coCd').val());
			setByImpYn($('#shipPopup #frameTable select[name="impYn"]')[0]);
			$('#shipPopup #actionArBtn').on("click", function(){insertShip();});
			$('#shipPopup .tit_contents .tit').text("출하요청서 등록");
			$('#shipPopup #actionArBtn').text("등록");
		} else if(actionType == "U"){
			selectShipInfo(modalStack.last().paramObj.shipSeq);
			$('#shipPopup #actionArBtn').on("click", function(){updateShip();});
			$('#shipPopup .tit_contents .tit').text("출하요청서 수정");
			$('#shipPopup #actionArBtn').text("저장");
		} else if(actionType == "O"){
			getOrderInfo();
			$('#shipPopup #odrSeq').siblings('a').remove();
			$('#shipPopup #actionArBtn').on("click", function(){insertShip();});
			$('#shipPopup .tit_contents .tit').text("출하요청서 등록");
			$('#shipPopup #actionArBtn').text("등록");
		}
		authChk("AR0101M01");
	});
	
	function selectShipInfo(shipSeq) {
		var paramObj = {"shipSeq" : shipSeq};
		postAjax("/user/ar/ar01/selectShipInfo", paramObj, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function getOrderInfo(){
		var paramObj = modalStack.last().paramObj;
		postAjax("/user/ar/ar01/getOrderInfo", paramObj, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var fileInfo = obj.fileList;
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		
		// 메인정보 세팅
		$.each(shipInfo, function(key, value){
			if($('#shipPopup #'+key)[0]){
				if($('#shipPopup #'+key).is('[date]')){
					$('#shipPopup #'+key).datepicker("setDate", moment(value, 'YYYY-MM-DD').toDate());
				}else{
					if($('#shipPopup #'+key).is('[comma]')){
						value = addCommaStr(value);
					}
					$('#shipPopup #'+key).val(value);
				}
				
				// 창고, 판매법인 set
				if(key == "coCd"){
					setByCoCd(value);
				}
				
				// 재고주체 set
				if(key == "typCd"){
					setBySellType(value);  
				}
			}
		});
		
		// 상세정보 세팅
		$.each(shipDetail, function(idx, obj){
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is('[comma]')){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
				}
				
				if(elem.name == "impYn"){
					setByImpYn(elem);
				}
			});
			
			// 확정여부에 따른 dom 변경
			if(obj.shipYn == "Y") {
				$addedRow.find('input[name="detailChkBox"]').prop("disabled", true);
				$addedRow.find('input').prop("readonly", true);
				$addedRow.find('a').remove();
				// 재고관리 대상이 아닐경우 수량 필수 입력값 제외 (수량, 중량)
				$addedRow.find('input[name="shipQty"]').prop("required", false);
				$addedRow.find('input[name="shipWt"]').prop("required", false);
			}else{
				// 재고관리에 따른 dom 변경
				if(obj.prdtStockCd == "N"){
					$addedRow.find('input[name="prdtSize"]').prop("readonly", true);
					$addedRow.find('input[name="prdtSpec"]').prop("readonly", true);
					$addedRow.find('input[name="prdtLen"]').prop("readonly", true);
					$addedRow.find('input[name="shipQty"]').prop("readonly", true);
					$addedRow.find('input[name="shipWt"]').prop("readonly", true);
					// 재고관리 대상이 아닐경우 금액 수정 가능
					$addedRow.find('input[name="shipAmt"]').prop("readonly", false);
					// 재고관리 대상이 아닐경우 수량 필수 입력값 제외 (수량, 중량)
					$addedRow.find('input[name="shipQty"]').prop("required", false);
					$addedRow.find('input[name="shipWt"]').prop("required", false);
				}
			}
		});
		countTot();
		
		if(fileInfo){
		// 주문에서 열릴때 주문에 등록한 파일은 유지하지 않는다.
			$.each(fileInfo, function(idx, obj){
				shipFileArr.push({
					"fileKey" : obj.fileKey,
			      	"fileName" : obj.fileName,
			      	"fileType" : obj.fileType,
			      	"fileSize" : obj.fileSize,
			      	"file" : obj
				});
			});
			// 첨부파일 그리드 set
			shipFileGridView.setData();
		}
		
		// 전체 출하확정시 수정버튼 hide
		if(shipInfo.shipYn == "Y") {
			$('#shipPopup #actionArBtn').hide();
		}
	}
	
	// 창고, 판매법인 set
	function setByCoCd(value){
		$('#shipPopup #whCd').data("desc", value);
		$('#shipPopup #whCd').empty();
		setCommonSelect($('#shipPopup #whCd'));
		// 창고와 판매법인은 같이 바귐.		

		$('#shipPopup #taxivcCoprt').data("rprc", value);
		$('#shipPopup #taxivcCoprt option:not([value=""])').remove()
		setCommonSelect($('#shipPopup #taxivcCoprt'));  
	}
	
	function setBySellType(value){
		// 판매유형
		// SELLTYPE1: 유통
		// SELLTYPE2: 가공
		// SELLTYPE4: 임가공
		// SELLTYPE5: 관수
		
		// 재고주체
		// OWNER1: 자사
		// OWNER2: 제강사
		// OWNER3: 건설사
		// OWNER4: 기타
		
		if(value == "" || value == "SELLTYPE1" || value == "SELLTYPE2" || value == "SELLTYPE5"){
		// 판매유형이 선택, 유통, 가공일때
			
			// 재고주체 초기화
			$('#shipPopup #ownerCd option:not([value=""])').remove();
			setCommonSelect($('#shipPopup #ownerCd'));
			
			if(value == "" || value == "SELLTYPE5"){
			// 판매유형이 선택, 관수일때
				// 재고주체 활성화
				$('#shipPopup #ownerCd').prop("disabled", false);
			}else if(value == "SELLTYPE1" || value == "SELLTYPE2"){
			// 판매유형이 유통, 가공일때
				// 재고주체 자사 set, 비활성화
				$('#shipPopup #ownerCd').val("OWNER1");
				$('#shipPopup #ownerCd').prop("disabled", true);
			}
		}else if(value == "SELLTYPE4"){
		// 판매유형이 임가공일때
			// 재고주체에서 자사 삭제
			$('#shipPopup #ownerCd option[value="OWNER1"]').remove();
			$('#shipPopup #ownerCd').prop("disabled", false);
		}
	}
	
	// 거래처 검색
	function openSecondClntSearch(type) {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#shipPopup #clntCd').val(row.clntCd);
			$('#shipPopup #clntNm').val(row.clntNm);
			$('#shipPopup #sellVatCd').val(row.sellVatCd);
			
			var paramObj = {
				"coCd": $('#shipPopup #coCd').val(),
				"clntCd": row.clntCd
			}
			
			postAjax("/admin/bm/bm02/selectMngInfo", paramObj, null, function(data) {
				if(data.mngInfo != null) {
					$('#shipPopup #salesMng').val(data.mngInfo.salesEmpId);     // "kyungmi.kuan"
					$('#shipPopup #salesMngNm').val(data.mngInfo.salesEmpNm);	 //  "권경미"	
				}
			});
		});
	}
	
	// 입고창고 변경시 계산서발행법인 set
	function setTaxivcCoprt(){
		$('#shipPopup #taxivcCoprt').val($('#shipPopup #whCd option:selected').data("etc"));
	}
	
	// 현장 검색
	function openArSiteSearch() {
		var paramObj = {
			"coCd": $('#shipPopup #coCd').val(), 
			"clntCd": $('#shipPopup #clntCd').val(), 
			"clntNm": $('#shipPopup #clntNm').val()
		}
		openSecondModal("/static/html/cmn/modal/siteSearch.html", 600, 450, "현장 검색", paramObj, function (tree){
			var row = tree.target.getList("selected")[0];
			$('#shipPopup #siteCd').val(row.siteCd);
			$('#shipPopup #siteNm').val(row.siteNm);
			$('#shipPopup #prjctCd').val(row.prjctCd);
			$('#shipPopup #addrZip').val(row.siteAddrZip);
			$('#shipPopup #addrMain').val(row.siteAddr);
			$('#shipPopup #addrSub').val(row.siteAddrSub);
			$('#shipPopup #mngTel').val(row.telNo);
			$('#shipPopup #salesAreaCd').val(row.salesAreaCd);
			$('#shipPopup #clntCd').val(row.clntCd);
			$('#shipPopup #clntNm').val(row.clntNm);
			$('#shipPopup #salesMng').val(row.salesEmpId);
			$('#shipPopup #salesMngNm').val(row.salesEmpNm);
			
			var whCd = $('#shipPopup #whCd').val();
			if(whCd == ""){
				$('#shipPopup #whCd').val(row.whCd); 
			}
			
			var taxivcCoprt = $('#shipPopup #taxivcCoprt').val();
			if(taxivcCoprt == ""){
				$('#shipPopup #taxivcCoprt').val(row.taxivcCoprt);
			}
			
	  		if(row.ordTyp) {
				$('#shipPopup #typCd').val("SELLTYPE2"); // 가공
		  	} else{
				$('#shipPopup #typCd').val("SELLTYPE1"); // 유통
		  	}
	  		
		});
	}
	
	function openSecondOrderSearch(){
		openSecondModal("/static/html/cmn/modal/orderSearch.html", 700, 420, "주문서 검색", {}, function(grid){
			var row = grid.target.getList("selected")[0];
			$('#shipPopup #odrSeq').val(row.odrSeq);
		});
	}
	
	// 사용자 검색
	function openSecondUserSearch() {
		var paramObj = {
			"coCd" : "GUM", // $('#coCd').val(),
			"userId": $('#shipPopup #salesMng').val(),
			"useYn": "Y"
		};
		
		openSecondModal("/static/html/cmn/modal/userSearch.html", 300, 500, "사용자 검색", paramObj, function (tree){
			var checkedId = tree.get_checked()[0];
			var checkedNode = tree.get_node(checkedId);
			$('#shipPopup #salesMng').val(checkedNode.id);
			$('#shipPopup #salesMngNm').val(checkedNode.text);
		});
	}
	
	function openDaumPostcode() {
		new daum.Postcode({
			oncomplete:function(data){
				// 우편번호
				$('#shipPopup #addrZip').val(data.zonecode);
				$('#shipPopup #addrMain').val((data.roadAddress || data.address) + ' ' + data.buildingName);
			}
		}).open();
	}
	
	// 운송비
	function transAmtModal() {
		openFrom = "AR0102P01";
		var paramObj ={
			transSeq :$('#shipPopup #transSeq').val(),
			coCd :$('#shipPopup #coCd').val()
		}
		if(!$('#shipPopup #transSeq').val()) {
			paramObj.actionType = "C";
		} 
		openSecondModal("/static/html/user/ar/ar03/AR0301P01.html", 800, 450, "", paramObj);
	}
	
	// 제조사, 매출단가 set
	function setByImpYn(elem){
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		// 제조사 set
		$targetRow.find('select[name="makrCd"]').data("rprc", elem.value);
		$targetRow.find('select[name="makrCd"]').empty();
		setCommonSelect($targetRow.find('select[name="makrCd"]'));
		
		// 매출단가 변경은 수입여부 변경시에만 발생한다.
		if(event.type == "change"){
			// 매출단가 set
			var shipUpr = null;
			if(elem.value == "N"){
				shipUpr = $targetRow.find('input[name="shipUprD"]').val();
			}else{
				shipUpr = $targetRow.find('input[name="shipUprI"]').val();
			}
			$targetRow.find('input[name="shipUpr"]').val(shipUpr);
			countAmt($targetRow.find('input[name="shipUpr"]')[0]);
		}
	}
	
	function cloneDetailRow(){
		var $checkedInputs = $('#shipPopup #detailTable tr[name="detailRow"] input[name="detailChkBox"]:checked');
		
		if($checkedInputs.length == 0){
			alert("선택된 데이터가 없습니다.");
			return false;
		}
		
		if($checkedInputs.length > 1){
			alert("한 건만 선택해주세요.");
			return false;
		}
		
		var $checkedRow = $checkedInputs.closest('tr');
		var $clonedRow = $($checkedRow).clone();
		// 체크박스 해제
		$clonedRow.find('input[name="detailChkBox"]').prop("checked", false);
		// 수입여부 복사
		$clonedRow.find('select[name="impYn"]').val($checkedRow.find('select[name="impYn"]').val());
		// 제조사 복사
		$clonedRow.find('select[name="makrCd"]').val($checkedRow.find('select[name="makrCd"]').val());
		
		$checkedRow.after($clonedRow[0]);
		
		ctrlAllChkBox();
	}
	
	function addDetailRow() {
		var $detailRow = $('#shipPopup #frameTable tr[name="detailRow"]').clone();
		$('#shipPopup #detailTable tbody').append($detailRow[0]);
		ctrlAllChkBox();
		return $detailRow;
	}
	
	function removeDetailRow(){
		var $checkedDetails = $('#shipPopup #detailTable tr[name="detailRow"] input[name="detailChkBox"]:checked');
		if($checkedDetails.length > 0){
			$.each($checkedDetails, function(idx, elem){
				$(elem).closest('tr[name="detailRow"]').remove();
			});
			countTot();
			ctrlAllChkBox();
		}else{
			alert("삭제할 상세내역을 선택해주세요.");
		}
	}
	
	function ctrlAllChkBox(){
		var isAllChk = true;
		var $detailChkBoxes = $('#shipPopup #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)');
		if($detailChkBoxes.length > 0){
			$.each($detailChkBoxes, function(idx, elem){
				if(!$(elem).is(':checked')){
					isAllChk = false;
				}
			});
			if(isAllChk){
				$('#shipPopup #allChkBox').prop("checked", true);
			}else{
				$('#shipPopup #allChkBox').prop("checked", false);
			}
		}else{
			$('#shipPopup #allChkBox').prop("checked", false);
		}
	}
	
	function ctrlDetailChkBox(elem){
		if($(elem).is(':checked')){
			$('#shipPopup #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", true);
		}else{
			$('#shipPopup #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", false);
		}
	}
	
	// 제품 검색
	function openSecondPrdtSearch(elem) {
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $('#shipPopup #coCd').val(),
			"selpchCd": "SELPCH2",
			"impYn": "N",
			"clntCd" : $('#shipPopup #clntCd').val(),
			"prjctCd" : $('#shipPopup #prjctCd').val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			
			// 값 초기화
			$targetRow.find('input[name]').val("");
			// input 제어
			if(row.prdtStockCd == "Y"){
				$targetRow.find('input[name="prdtSize"]').prop("readonly", false);
				$targetRow.find('input[name="prdtSpec"]').prop("readonly", false);
				$targetRow.find('input[name="prdtLen"]').prop("readonly", false);
				$targetRow.find('input[name="shipQty"]').prop("readonly", false);
				$targetRow.find('input[name="shipWt"]').prop("readonly", false);
				// 재고관리 대상일 경우 금액 수정 불가능
				$targetRow.find('input[name="shipAmt"]').prop("readonly", true);
				// 재고관리 대상일 경우 수량 필수 입력값 추가 (수량, 중량)
				$targetRow.find('input[name="shipQty"]').prop("required", true);
				$targetRow.find('input[name="shipWt"]').prop("required", true);
			}else{
				$targetRow.find('input[name="prdtSize"]').prop("readonly", true);
				$targetRow.find('input[name="prdtSpec"]').prop("readonly", true);
				$targetRow.find('input[name="prdtLen"]').prop("readonly", true);
				$targetRow.find('input[name="shipQty"]').prop("readonly", true);
				$targetRow.find('input[name="shipWt"]').prop("readonly", true);
				// 재고관리 대상이 아닐경우 금액 수정 가능
				$targetRow.find('input[name="shipAmt"]').prop("readonly", false);
				// 재고관리 대상이 아닐경우 수량 필수 입력값 제외 (수량, 중량)
				$targetRow.find('input[name="shipQty"]').prop("required", false);
				$targetRow.find('input[name="shipWt"]').prop("required", false);
			}
			
			$.each(row, function(key, value){
				if($targetRow.find('[name="'+key+'"]')[0]){
					$targetRow.find('[name="'+key+'"]').val(value);
				}
			});
			$targetRow.find('input[name=prdtUpr]').val(row.ordrgUpr);
			
			countTot();
		});
	}
	
	// 제품 검색(다중)
	function openSecondMultiPrdtSearch() {
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $('#shipPopup #coCd').val(),
			"selpchCd": "SELPCH2",
			"impYn": "N",
			"clntCd" : $('#shipPopup #clntCd').val(),
			"prjctCd" : $('#shipPopup #prjctCd').val(),
			"useYn": "Y"
		};
				
		openSecondModal("/static/html/cmn/modal/multiPrdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var selectedRows = grid.target.getList("selected");
			$.each(selectedRows, function(idx, obj){
				// 행 추가
				var $addedRow = addDetailRow();
				// 값 set
				$.each($addedRow.find('[name]'), function(idx, elem){
					var itemValue = obj[elem.name];
					if(itemValue){
						$(elem).val(itemValue);
					}
				});
				$addedRow.find('input[name=prdtUpr]').val(obj.ordrgUpr);
				
				// 재고관리에 따른 dom 변경
				if(obj.prdtStockCd == "N"){
					$addedRow.find('input[name="prdtSize"]').prop("readonly", true);
					$addedRow.find('input[name="prdtSpec"]').prop("readonly", true);
					$addedRow.find('input[name="prdtLen"]').prop("readonly", true);
					$addedRow.find('input[name="shipQty"]').prop("readonly", true);
					$addedRow.find('input[name="shipWt"]').prop("readonly", true);
					// 재고관리 대상이 아닐경우 금액 수정 가능
					$addedRow.find('input[name="shipAmt"]').prop("readonly", false);
					// 재고관리 대상이 아닐경우 수량 필수 입력값 제외 (수량, 중량)
					$addedRow.find('input[name="shipQty"]').prop("required", false);
					$addedRow.find('input[name="shipWt"]').prop("required", false);
				}
			});
		});
	}
	
	function calShipWt(elem){
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		var shipQty = Number(deleteCommaStr($targetRow.find('input[name="shipQty"]').val())) || 0;
		var prdtCnvrsnWt = Number($targetRow.find('input[name="prdtCnvrsnWt"]').val()) || 0;
		var shipWt = shipQty * prdtCnvrsnWt;
		$targetRow.find('input[name="shipWt"]').val(addCommaStr(shipWt));
		$targetRow.find('input[name="realShipWt"]').val(shipWt);
	}
	
	function countAmt(elem) {
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		var prdtStockCd = $targetRow.find('input[name="prdtStockCd"]').val();
		var shipQty = Number(deleteCommaStr($targetRow.find('input[name="shipQty"]').val())) || 0;
		var shipWt = Number(deleteCommaStr($targetRow.find('input[name="shipWt"]').val())) || 0;
		var shipUpr = Number(deleteCommaStr($targetRow.find('input[name="shipUpr"]').val())) || 0;
		var stockUpr = Number($targetRow.find('input[name="stockUpr"]').val()) || 0;
		
		if(prdtStockCd == "Y"){
			$targetRow.find('input[name="shipAmt"]').val(addCommaStr(Math.round(shipQty * shipUpr)))
			$targetRow.find('input[name="epctPal"]').val(addCommaStr(Math.round(shipQty * shipUpr) - Math.round(shipQty * stockUpr)));
		}else{
			$targetRow.find('input[name="shipAmt"]').val(addCommaStr(shipUpr));
		}
		
		// real관련 값 복사
		$targetRow.find('input[name="realShipQty"]').val(deleteCommaStr($targetRow.find('input[name="shipQty"]').val()));
		$targetRow.find('input[name="realShipWt"]').val(deleteCommaStr($targetRow.find('input[name="shipWt"]').val()));
		$targetRow.find('input[name="realShipUpr"]').val(deleteCommaStr($targetRow.find('input[name="shipUpr"]').val()));
		$targetRow.find('input[name="realShipAmt"]').val(deleteCommaStr($targetRow.find('input[name="shipAmt"]').val()));
		
		countTot();
	}
	
	// 재고관리 대상이 아닐경우 금액만 입력시 realShipUpr, realShipAmt에 값 복사
	function copyAmt(elem){
		$targetRow = $(elem).closest('tr[name="detailRow"]');
		$targetRow.find('input[name="realShipUpr"]').val(deleteCommaStr($targetRow.find('input[name="shipUpr"]').val()));
		$targetRow.find('input[name="realShipAmt"]').val(deleteCommaStr($targetRow.find('input[name="shipAmt"]').val()));
	}
	
	function countTot() {
		var shipTotQty = 0;
		var shipTotWt = 0;
		var shipTotAmt = 0;
		var totEpctPal = 0;
		
		$.each($('#shipPopup #detailTable tr[name="detailRow"]'), function(idx, elem){
			var shipQty = Number(deleteCommaStr($(elem).find('input[name="shipQty"]').val())) || 0;
			var shipWt = Number(deleteCommaStr($(elem).find('input[name="shipWt"]').val())) || 0;
			var shipAmt = Number(deleteCommaStr($(elem).find('input[name="shipAmt"]').val())) || 0;
			var epctPal = Number(deleteCommaStr($(elem).find('input[name="epctPal"]').val())) || 0;
			
			shipTotQty += shipQty;
			shipTotWt += shipWt;
			shipTotAmt += shipAmt; 
			totEpctPal += epctPal; 
		});
		
		$('#shipPopup #shipTotQty').val(addCommaStr(shipTotQty));
		$('#shipPopup #shipTotWt').val(addCommaStr(shipTotWt));
		$('#shipPopup #shipTotAmt').val(addCommaStr(shipTotAmt));
		$('#shipPopup #realTotQty').val(shipTotQty);
		$('#shipPopup #realTotWt').val(shipTotWt);
		$('#shipPopup #realTotAmt').val(shipTotAmt);
		$('#shipPopup #totEpctPal').val(addCommaStr(totEpctPal));

	}
	
	function setFile(elem){
		var tempFiles = elem.files;
		$.each(tempFiles, function(idx, obj){
			var tempArr = obj.name.split(".");
			shipFileArr.push({
				"fileKey" : 0,
		      	"fileName" : obj.name,
		      	"fileType" : tempArr[tempArr.length-1],
		      	"fileSize" : obj.size,
		      	"file" : obj
			});
		});
		shipFileGridView.setData();
		$(elem).val("");
	}
	
	function deleteFile(rowIndex) {
		shipFileGridView.target.removeRow(rowIndex);
		
		if(shipFileArr[rowIndex].fileKey){
		// 기 등록되어 있는 파일 삭제시
			deleteFileArr.push(shipFileArr[rowIndex].fileKey);
		}
		
		shipFileArr.splice(rowIndex, 1);
		
		shipFileGridView.setData();
	}
	
	function downloadFile(idx) {
		postAjax("/admin/cm/cm08/fileDownInfo", {"fileKey": shipFileArr[idx].fileKey}, null, function(data){
			var fileInfo = data.fileInfo;
			var filePath = encodeURI(fileInfo.filePath + fileInfo.fileKey + "_" + fileInfo.fileName , "UTF-8");
			location.href = "/admin/cm/cm08/fileDownload?filePath="+filePath;
		});
	}
	
	function insertShip() {
		if(!lengthValidation()) return false;
		if(inputValidation($('#shipPopup [required]').not('#shipPopup #frameTable [required]'))) {
			if(!siteValidation()) return false;
			var formData = makeFormData();
			filePostAjax("/user/ar/ar01/insertShip", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					var shipSeq = data.shipSeq;
					modalStack.close();
					shipGridView.setData(0);
					setTimeout(function(){
						viewShipModal(shipSeq);
					}, 500);
				}
			});
		}
	}
	
	function updateShip() {
		if(!lengthValidation()) return false;
		if(inputValidation($('#shipPopup [required]').not('#shipPopup #frameTable [required]'))) {
			if(!siteValidation()) return false;
			var formData = makeFormData();
			filePutAjax("/user/ar/ar01/updateShip", formData, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					var shipSeq = $('#shipSeq').val();
					modalStack.close();
					shipGridView.setData(0);
					setTimeout(function(){
						viewShipModal(shipSeq);
					}, 500);
				}
			});
		}
	}
	
	function lengthValidation() {
		var isValid = true;
		$.each($('#shipPopup #detailTable tr[name="detailRow"]'), function(idx, elem){
			var prdtDiv = $(elem).find('input[name="prdtDiv"]').val();
			var prdtCoilYn = $(elem).find('input[name="prdtCoilYn"]').val();
			var prdtStockCd = $(elem).find('input[name="prdtStockCd"]').val();
			var prdtLen = $(elem).find('input[name="prdtLen"]').val();
			
			// 철근이면서 코일여부가 N이고 재고관리 대상이면 길이가 있어야 한다.
			if(prdtDiv == "PRDTDIV11" && prdtCoilYn == "N" && prdtStockCd == "Y" && (prdtLen == 0 || prdtLen == "")){
				isValid = false;
				alert("길이가 0인 제품이 존재합니다.");
				return false;
			}
		});
		return isValid;
	}
	
	function siteValidation(){
		var isValid = true;
		var typeChk = $('#shipPopup #typCd').val();
		var siteChk = $('#shipPopup #siteCd').val();
		if(typeChk == "SELLTYPE2"  && siteChk == ""){
			alert("판매유형이 가공일경우 현장은 필수입니다. 현장을 입력하세요.");
			isValid = false;
		}
		return isValid;
	}
	
	function makeFormData() {
		$('#shipPopup input').prop("disabled", false);
		$('#shipPopup select').prop("disabled", false);
		if($('#shipPopup #prjctCd').val() == "") $('#shipPopup #prjctCd').val("0");
		
		//콤마 제거
		$.each($('#shipPopup input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($('#shipPopup #popForm')[0]);

		var typeChk = $('#shipPopup #typCd').val();
		var siteChk = $('#shipPopup #siteCd').val();
		if(typeChk == 'SELLTYPE2'  && siteChk == ""){
			alert("판매유형이 가공일경우 현장은 필수입니다. 현장을 입력하세요.");
			return false;
		}		
		
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 총수량, 총중량, 총금액 추가
		formData.append("shipTotQty", $('#shipTotQty').val());
		formData.append("shipTotWt", $('#shipTotWt').val());
		formData.append("shipTotAmt", $('#shipTotAmt').val());
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#shipPopup #detailTable tr[name="detailRow"]'), function(midx, elem){
			if($(elem).find('input[name="shipYn"]').val() == "N" || $(elem).find('input[name="shipYn"]').val() == "") {
				var detailObj = {};
				$.each($(elem).find('[name]'), function(idx, elem){
					detailObj[elem.name] = elem.value;
				});
				detailArr.push(detailObj);
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		// 첨부파일 추가
		$.each(shipFileArr, function(idx, obj){
			// 신규파일만 추가
			if(obj.fileKey == 0){
				formData.append("files", obj.file);
			}
		});
		formData.append("deleteFileArr", JSON.stringify(deleteFileArr));
		
		return formData;
	}
</script>
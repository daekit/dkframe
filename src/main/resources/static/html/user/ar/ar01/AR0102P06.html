<body>
	<div id="allocView" class="popup_area of_a" style="width: 100%; height: 100%;">
		<div class="tit_contents">
			<h4 class="tit">배차 관리</h4>
		</div>
		<div class="popup_table">
			<form id="popForm">
				<input type="hidden" id="pgmId"       name="pgmId" value="AR0102P06">
				<input type="hidden" id="shipSeq"     name="shipSeq"> 
				<input type="hidden" id="allocSeq"    name="allocSeq"> <!-- 배차번호 -->
				<input type="hidden" id="shipSeq"     name="shipSeq">				
				<input type="hidden" id="rprcSeq"     name="rprcSeq">  <!-- 거래내역지시번호.. 여기서는 출하지시번호 혹은 발주서 번호 -->
				<input type="hidden" id="transCreatDiv"     name="transCreatDiv"> <!-- 발주서(OD) 혹은 출하요청서(AR) -->   
				<input type="hidden" id="siteCd"      name="siteCd"> 
				<input type="hidden" id="prjctCd"     name="prjctCd"> 
				<input type="hidden" id="prjctNm"     name="prjctNm">
				<input type="hidden" id="salesDept"   name="salesDept">
				<input type="hidden" id="salesDept"   name="transSeq">  <!-- 매입운반 번호 -->
				<input type="hidden" id="salesDept"   name="transAmt">
				<table>
					<colgroup>
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
						<col width="12%">
						<col width="">
					</colgroup>
					<tr>
						<th>회사명</th>
						<td>
							<input type="hidden" id="coCd" name="coCd"> 
							<input type="text" id="coNm" name="coNm" readonly>
						</td>
						<th>판매유형</th>
						<td>
							<input type="hidden" id="typCd" name="typCd"> 
							<input type="text" id="typNm" name="typNm" readonly>
						</td>
						<th>매출거래처</th>
						<td>
							<input type="hidden" id="clntCd" name="clntCd"> 
							<input type="text" id="clntNm" name="clntNm" readonly>
						</td>
					</tr>
					<tr>
						<th>법인</th>
						<td>
							<input type="hidden" id="taxivcCoprt" name="taxivcCoprt">
							<input type="text" id="taxivcCoprtNm" name="taxivcCoprtNm" readonly>
						</td>
						<th>착지</th>
						<td>
							<input type="hidden" id="desCd" name="desCd">
							<input  type="text"  id="desNm" name="desNm"style="width: 100%;">
						</td>
						<th>운전기사</th>
						<td>
							<input  type="text"  id="drivrNm" name="drivrNm"style="width: 100%;">
						</td>
					</tr>	
					<tr>
						<th>현장명</th>
						<td>
							<input type="hidden" id="siteCd" name="siteCd">
							<input type="text" id="siteNm" name="siteNm" readonly>
						</td>
						<th>출하창고</th>
						<td>
							<input type="hidden" id="whCd" name="whCd">
							<input type="text" id="whNm" name="whNm" readonly>
						</td>
						<th>영업담당자</th>
						<td>
							<input type="hidden" id="salesMng" name="salesMng">
							<input type="text" id="salesMngNm" name="salesMngNm" readonly>
						</td>
						
					</tr>
					<tr>
						<th class="hit">운송업체</th>
						<td class="drctArea">
							<div class="search_form">
								<input type="hidden" id="transCo" name="transCo">
								<input type="text" id="transNm" name="transNm" disabled required msg="운송업체">
								<a onclick="openSecondClntSearch('T');"><i class="i_search_w"></i></a>
							</div>
						</td>
						<th>운전기사</th>
						<td>
							<input  type="text"  id="drivrNm" name="drivrNm"style="width: 100%;">
						</td>
						<th>차량번호</th>
						<td>
							<input id="shipVehNo" name="shipVehNo" type="text">
						</td>
					</tr>
					<tr>
						<th class="hit">배차 차수</th>
							<td>
								<input id="shipCnt" name="shipCnt" type="text" required msg="배차 차수">
							</td>
						</tr>
					<tr>
						<th class="hit">운송일자</th>
						<td>
							<input type="text" class="input_calendar" id="allocDt" name="allocDt" autocomplete="off" msg="배차일자" required>
						</td>
						<th>착지연락처</th>
						<td>
							<input type="text" id="mngTel" name="mngTel" >
						</td>
						<th>매출 일자</th>
						<td>
							<input type="hidden" id="realDlvrDttm" name="realDlvrDttm">
							<input type="text" id="dlvrDttm" name="dlvrDttm" readonly>
						</td>
					</tr>
					<tr>
						<th>착지주소</th>
						<td>
							<input type="text" id="addrZip" name="addrZip" readonly>
						</td>
						<td colspan="2" style="border-left: 0px !important;">
							<input type="text" id="addrMain" name="addrMain" readonly>
						</td>
						<td colspan="2">
							<input type="text" id="addrSub" name="addrSub">
						</td>
					</tr>
					<tr>
						<th>납기비고</th>
						<td colspan="2">
							<textarea class="form-control" id="dlvrRmk" name="dlvrRmk" style="height: 60px;" maxlength="500" readonly></textarea>
						</td>
						<th>출하비고</th>
						<td colspan="2">
							<textarea class="form-control" id="shipRmk" name="shipRmk" style="height: 60px;" maxlength="500" readonly></textarea>
						</td>
					</tr>
					<tr>
						
					</tr>
				</table>
			</form>
		</div>
<!-- 배차관련 항목정리 Table -->


<!-- 배차항목 정리 끝. -->
		<br>
		<!-- 테이블 -->
		<div class="popup_table">
			<table>
				<tr>
					<td colspan="2" style="text-align: LEFT; border-right: 0;">※상세내역</td>
					<td colspan="17"></td>
				</tr>
			</table>

			<div class="ofx_s" style="width: 100%;">
				<table id="detailTable" style="width: 1700px;">
					<colgroup>
						<col width="2%">
						<col width="2%">
						<col width="13%"> <!-- 제품명 -->
						<col width="6%">  <!-- SIZE -->
						<col width="6%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="5%">  <!-- 출하지시 수량-->
						<col width="5%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 번들 -->
						<col width="4%">  <!-- 수입여부 -->
						<col width="5%">  <!-- Maker -->
						<col width="6%">  <!-- 완료일자 -->
						<col width="8%">  <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" style="padding: 3px;"> 
							<input type="checkbox" id="allChkBox" onchange="ctrlDetailChkBox(this);">
						</th>
					    <th class="tc pd0">매출</th>
						<th class="tc hit">제품명</th>
						<th class="tc">사이즈</th>
						<th class="tc">SPEC</th>
						<th class="tc">길이</th>
						<th class="tc">단위</th>
						<th class="tc hit">수량</th>
						<th class="tc hit">중량(KG)</th>
						<th class="tc">번들</th>
						<th class="tc">수입</th>
						<th class="tc">Maker</th>
						<th class="tc">완료일자</th>
						<th class="tc">비고</th>
					</tr>
				</table>
				<table id="frameTable" style="display: none;">
					<tr name="detailRow">
						<input type="hidden" name="shipDtlSeq"> 
						<input type="hidden" name="odrDtlSeq"> 
						
				   <!-- <input type="hidden" name="shipYn"> -->
						<input type="hidden" name="shipProcId">
						
						<input type="hidden" name="prdtDiv">
						<input type="hidden" name="prdtStkn">
						<input type="hidden" name="prdtStockCd">
						<input type="hidden" name="prdtCoilYn"> 
						<input type="hidden" name="prdtCnvrsnWt">
						<input type="hidden" name="prdtDt">
						
						<input type="hidden" name="pchsUpr" value="0">
						<input type="hidden" name="sellUpr" value="0">
						<input type="hidden" name="stockUpr" value="0">
						<input type="hidden" name="prdtUpr" value="0">
						
						<input type="hidden" name="realShipQty" value="0">
						<input type="hidden" name="realShipWt" value="0">
						<input type="hidden" name="realShipUpr" value="0">
						<input type="hidden" name="realShipAmt" value="0">
						<td>
							<input type="checkbox" name="detailChkBox" onclick="ctrlAllChkBox();">
						</td>
						<td>
							<input type="text" class="tc" name="shipYn" readonly>
						</td>
						<td>
							<input type="hidden" name="prdtCd">
							<input type="text" name="prdtNm" readonly>
						</td>
						<td>
							<input type="text" class="tc" name="prdtSize" readonly>
						</td>
						<td>
							<input type="text" class="tc" name="prdtSpec" readonly>
						</td>
						<td>
							<input type="text" class="tr" name="prdtLen" comma readonly>
						</td>
						<td>
							<input type="hidden" name="prdtUnit">
							<input type="text" class="tc" name="prdtUnitNm" readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipQty" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipWt" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="bdCnt" maxlength="5" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipUpr" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="shipAmt" comma readonly>
						</td>
						<td>
							<input type="text" class="tr" name="epctPal" comma readonly>
						</td>
						<td>
							<input type="text" class="tc" name="impYn" readonly>
						</td>
						<td>
							<input type="hidden" name="makrCd">
							<input type="text" class="tc" name="makrNm" readonly>
						</td>
						<td>
							<input type="text" class="tc" name="shipDttm" readonly>
						</td>
						<td>
							<input type="text" name="shipVehNo" readonly>
						</td>
						<td>
							<input type="text" name="shipDtlRmk" readonly>
						</td>
					</tr>
				</table>
				<table style="width: 1700px;">
					<colgroup>
						<col width="2%">
						<col width="2%">
						<col width="13%"> <!-- 제품명 -->
						<col width="6%">  <!-- SIZE -->
						<col width="6%">  <!-- SPEC-->
						<col width="5%">  <!-- 길이 -->
						<col width="5%">  <!-- 단위 -->
						<col width="5%">  <!-- 출하지시 수량-->
						<col width="5%">  <!-- 출하지시 중량-->
						<col width="5%">  <!-- 번들 -->
						<col width="4%">  <!-- 수입여부 -->
						<col width="5%">  <!-- Maker -->
						<col width="6%">  <!-- 완료일자 -->
						<col width="8%">  <!-- 비고 -->
					</colgroup>
					<tr>
						<th class="tc" colspan="7">합계</th>
						<td>
							<input class="tr" type="text" id="shipTotQty" name="shipTotQty" comma readonly>
						</td>
						<td>
							<input class="tr" type="text" id="shipTotWt" name="shipTotWt" comma readonly>
						</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
				</table>
			</div>
		</div>
		<br>
		<!-- 하단 버튼 -->
		<div class="popup_bottom_btn">
			<button id="actionBtn" onclick="updateAllocVehlModal();" authchk>배차</button>
			<button class="close_btn" onclick="modalStack.close();">닫기</button>
		</div>
	</div>
</body>
<script type="text/javascript">

	
	$(document).ready(function() {
		selectShipInfo();
		authChk("AR0101M01");
	});
	
	function selectShipInfo() {
		var paramObj = modalStack.last().paramObj;
		postAjax("/user/ar/ar01/selectShipInfo", paramObj, null, function(data){
			setShipInfo(data.result);
		});
	}
	
	function setShipInfo(obj) {
		var shipInfo = obj.shipInfo;
		var shipDetail = obj.shipDetail;
		
		// 메인정보 세팅
		$.each(shipInfo, function(key, value){
			var itemValue = value;
			if($('#allocView #'+key).is('[comma]')){
				itemValue = addCommaStr(itemValue);
			}
			$('#allocView #'+key).val(itemValue);
		});
		
		//상세정보 세팅
		$.each(shipDetail, function(idx, obj){
			var $addedRow = addDetailRow();
			$.each($addedRow.find('[name]'), function(idx, elem){
				var itemValue = obj[elem.name];
				if(itemValue){
					if($(elem).is("[comma]")){
						itemValue = addCommaStr(itemValue);
					}
					$(elem).val(itemValue);
					if(elem.name == "shipYn" && itemValue == "N") { //red
						$(elem).css({"color": "red"});
					}
					
				}
			});
			
		});
		countTot();
	}
	
	function addDetailRow() {
		var $detailRow = $('#allocView #frameTable tr[name="detailRow"]').clone();
		$('#allocView #detailTable tbody').append($detailRow[0]);
		return $detailRow;
	}
	
	function ctrlAllChkBox(){
		var isAllChk = true;
		var $detailChkBoxes = $('#allocView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)');
		if($detailChkBoxes.length > 0){
			$.each($detailChkBoxes, function(idx, elem){
				if(!$(elem).is(':checked')){
					isAllChk = false;
				}
			});
			if(isAllChk){
				$('#allocView #allChkBox').prop("checked", true);
			}else{
				$('#allocView #allChkBox').prop("checked", false);
			}
		}else{
			$('#allocView #allChkBox').prop("checked", false);
		}
	}
	
	function ctrlDetailChkBox(elem){
		if($(elem).is(':checked')){
			$('#allocView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", true);
		}else{
			$('#allocView #detailTable tr[name="detailRow"] input[name="detailChkBox"]:not(:disabled)').prop("checked", false);
		}
	}
	
	function countTot() {
		var shipTotQty = 0;
		var shipTotWt = 0;
		var shipTotAmt = 0;
		var totEpctPal = 0;
		
		$.each($('#allocView #detailTable tr[name="detailRow"]'), function(idx, elem){
			var shipQty = Number(deleteCommaStr($(elem).find('input[name="shipQty"]').val()));
			var shipWt = Number(deleteCommaStr($(elem).find('input[name="shipWt"]').val()));
			var shipAmt = Number(deleteCommaStr($(elem).find('input[name="shipAmt"]').val()));
			var epctPal = Number(deleteCommaStr($(elem).find('input[name="epctPal"]').val()));
			
			shipTotQty += shipQty;
			shipTotWt += shipWt;
			shipTotAmt += shipAmt; 
			totEpctPal += epctPal; 
		});
		
		$('#allocView #shipTotQty').val(addCommaStr(shipTotQty));
		$('#allocView #shipTotWt').val(addCommaStr(shipTotWt));
		$('#allocView #shipTotAmt').val(addCommaStr(shipTotAmt));
		$("#allocView #totEpctPal").val(addCommaStr(totEpctPal));
	}
	

	
	function updateAllocVehlModal() {
		var paramObj = modalStack.last().paramObj;
		
		
		
		postAjax("/user/ar/ar01/insertAllocVehl", formData, function(data){
			alert(data.resultMessage);  
			if(data.resultCode == 200) {
				shipGridView.setData(0);
				modalStack.close();
			}
		});
		
		
		
		modalStack.close();
		
		
		
		setTimeout(function(){
			paramObj.actionType = "U";
			openModal("/static/html/user/ar/ar01/AR0102P05.html", 1300, 780, "", paramObj);
		}, 500);
	}
	

	
	function makeFormData(type) {
		//콤마 제거
		$.each($('#allocView input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		
		// 폼데이터 생성
		var formData = new FormData($("#allocView #popForm")[0]);
		
		// 유저아이디 추가
		formData.append("userId", jwt.userId);
		
		// 상세내역 추가
		var detailArr = [];
		$.each($('#allocView #detailTable tr[name="detailRow"]'), function(idx, elem){
			if(type == "CONFIRM") {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "N") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						if(elem.name == "shipProcId" && elem.value == "") elem.value = jwt.userId;
						if(elem.name == "shipProcNm" && elem.value == "") elem.value = jwt.userNm;
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			} else {
				if($(elem).find("input[name='detailChkBox']").is(":checked") && $(elem).find("input[name='shipYn']").val() == "Y") {
					var detailObj = {};
					$.each($(elem).find('[name]'), function(idx, elem){
						detailObj[elem.name] = elem.value;
					});
					detailArr.push(detailObj);
				}
			}
		});
		formData.append("detailArr", JSON.stringify(detailArr));
		
		return formData;
	}	

</script>
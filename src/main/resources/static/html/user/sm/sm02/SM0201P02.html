<body>
	<div class="container-fluid">
      <div class="row">
        <div class="popup_area">
		        <div  class="popup_table">
		          <div class="contents no_bg">
				    <ul class="btn_ul">
				      <li class="btn_r">
				        <a onclick = "gridView1.setData(0);">
				          <button class="bg_gray">검 색</button>
				        </a>
				        <a onclick = "searchInit()">
				          	<button class="bg_gray">초기화</button>
				        </a>
				      </li>
				    </ul>
			      </div>
		          <table>
		          	<tbody>
		          		<tr>
		          			<th colspan= "2">출고 회사</th>
		          			<td colspan="3"> 
		          				<select id="searchDtlOutCoCd" name="searchDtlOutCoCd" data-kind="CO" onchange="setWareHouse(this.value); gridView1.setData(0);"></select>
		          			</td>
		          			<th colspan="2">출고지(창고)</th>
		          			<td colspan="3"> 
		          				<select id="searchDtlOutWhCd" name="searchDtlOutWhCd" data-kind="WH" onchange="gridView1.setData(0);" >
		          				<option value="">전체</option>
		          				</select>
		          			</td>
		          			<th colspan="2">재고주체</th>
		          			<td colspan="3"> 
		          				<select id="searchDtlOwnerCd" data-kind="OWNER" onchange="gridView1.setData(0);" >
		          				<option value="">전체</option>
		          				</select>
		          			</td>
		          			<th colspan= "2">거래처</th>
			                <td class="drctArea" colspan="3">
			                	<input type="hidden" id="searchDtlClntCd" name="searchDtlClntNm" style="width: 76%;">                   
			                	<div class="search_form">
				                    <input type="text" id="searchDtlClntNm" name="searchDtlClntNm" readonly="readonly">
			                    	<a onclick="clntSearch();"><i class="i_search_w"></i></a>
			                    </div>
			                </td>
		          		</tr>
		          		<tr name="tableCd">
		          			<th colspan="2">판매유형</th>
		          			<td colspan="3"> 
		          				<select id="searchDtlTypCd" data-kind="SELLTYPE" onchange="gridView1.setData(0);" >
		          				<option value="">전체</option>
		          				</select>
		          			</td>
<!-- 		          			<th colspan= "2">제조사</th> -->
<!-- 		          			<td colspan="3">  -->
<!-- 		          				<select id="searchDtlMakr" data-kind="MAKR" onchange="gridView1.setData(0);" > -->
<!-- 		          				<option value="">전체</option> -->
<!-- 		          				</select> -->
<!-- 		          			</td> -->
		          			<th colspan="2">수입구분</th>
		          			<td colspan="3"> 
		          				<select id="searchDtlImpYn" data-kind="YN" onchange="gridView1.setData(0);" >
		          				<option value="">전체</option>
		          				</select>
		          			</td>
			          		<th colspan= "2">제품</th>
			                <td class="drctArea" colspan="3">
			                	<input type="hidden" id="prdtCoilYn" name="prdtCoilYn" >  
			                	<input type="hidden" id="searchDtlPrdtCd" name="searchDtlPrdtCd" style="width: 76%;">                   
			                	<div class="search_form">
				                    <input type="text" id="searchDtlPrdtNm" name="searchDtlPrdtNm" readonly="readonly">
			                    	<a onclick="prdtSearch(this);"><i class="i_search_w"></i></a>
			                    </div>
			                </td>	
		          		</tr>
		          	</tbody>
		          </table>
	          </div>
	        <div class="contents">
			  <div data-ax5grid="search-grid" data-ax5grid-config="{}" style="height: 200px; width: 100%"></div>
		    </div>
        </div>
      </div>
      <div class="popup_area">
      <div class="popup_table">
      	<div class="contents no_bg">
	      <ul class="btn_ul">
	        <li class="btn_r">
	          <a id="move">
	            <button class="bg_gray" onclick = "insertUpdateMove()">이동</button>
	          </a>
	        </li>
	      </ul>
		 </div>
      	<div class="contents">
          <table>
          	<tbody>
          	  <tr>
          		<th colspan="2">입고지</th>
          		<td colspan="3"> 
			      <input type="hidden" id="sCoCd"         name="sCoCd" >
                  <input type="hidden" id="searchPrjctCd" name="searchMovePrdtCd" style="width: 76%;">
          		  <select id="searchDtlWhCd" name="searchDtlWhCd" data-kind="WH" required></select>
          		</td> 
          		<th colspan="2">판매유형</th>
          		<td colspan="3"> 
          		  <select id="searchDtlType" data-kind="SELLTYPE" required></select>
          		</td>
			    <th colspan= "2">이동일자</th>
      		    <td colspan="3"> 
      			  <input type="text" id="sTransDt" name="sTransDt" class="input_calendar">
      		    </td>
           	  	<th colspan= "2"  rowspan = "2">메모</th>
      			<td colspan="3" rowspan = "2"> 
      			  <input id="searchRmk" style="height: 65px;" required>
      		    </td>	  
          	  </tr>
          	  <tr  name="tableCd2">
      		    <th colspan= "2">제품</th>
                <td class="drctArea" colspan="3">
                	<input type="hidden" id="searchMovePrdtCd" name="searchMovePrdtCd" style="width: 76%;">
                	<input type="hidden" id="searchMovePrdtSize" name="searchMovePrdtSize" style="width: 76%;">
                	<div class="search_form">
	                    <input type="text" id="searchMovePrdtNm" name="searchMovePrdtNm" readonly="readonly">
                    	<a onclick="prdtSearch2(this);"><i class="i_search_w"></i></a>
                    </div>
                </td>              	  
          	  	<th colspan= "2" class = "hit">길이</th>
      		    <td colspan="3"> 
      			  <input type="text" id="searchMovePrdtLen" name="searchMovePrdtLen" required>
      		    </td>   
          	  	<th colspan= "2">SPEC</th>
      		    <td colspan="3"> 
      			  <input type="text" id="searchMovePrdtSpec" name="searchMovePrdtSpec" readonly>
      		    </td>
          	  </tr>
          	</tbody>
          </table>      		
      	</div>
      </div>
      </div>
    </div>
    <a id="closeBtn" >
    	<button class="bg_gray" onclick="modal.close();">닫기</button>
    </a>
    <form id="popForm">
		<input type="hidden" id="userId" name="userId">
	    <input type="hidden" id="pgmId" name="pgmId" value="SM0201P01">
	</form>
</body>

<link rel="stylesheet" href="/static/css/jstree/style.min.css" />
<script src="/static/js/jstree/jstree.min.js"></script>
<script type="text/javascript">
	var authId = null;
	var authRole = null;
	var actionType = null;
	var searchGrid = null;
	var insertOK = false;
	
	var gridView1 = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
				showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		    	target: $('[data-ax5grid="search-grid"]'),
		        header: {
		        	align: "center", 
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		        		var idx = this.self.select(this.dindex);
		        		var prjctCdIdx = idx.list[this.dindex].prjctCd;
		                $("#prjctCd").val(prjctCdIdx);
		                
		                
		            },
		            onDBLClick: function () {
		            	//updateProjectModal("U");
		            }, 
		            onDataChanged: function() {
		            	debugger;
		        		var idx = this.self.select(this.dindex);
		        		idx.list[this.dindex].moveWt = idx.list[this.dindex].moveQty * idx.list[this.dindex].prdtCnvrsnWt
		            	this.self.repaint();
		            }
		        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            searchIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	gridView1.setData(this.page.selectPage);
		            }
		        },
		        columns: [
		            {key: "coNm",           label: "출고 회사",      align : "center", width : "10%"},
		            {key: "whNm",           label: "출고지"  ,      align : "center", width : 100},
		            {key: "ownerNm",        label: "재고주체",       align : "center", width : 60},
		            {key: "typNm",          label: "판매 유형",      align : "center", width : 60},
		            {key: "clntNm",         label: "거래처",        align : "left",   width : "10%"},
		            {key: "prdtNm",         label: "제품",          align : "left",   width : "13%"},
		            {key: "prdtSpec",       label: "Spec",         align : "center", width : 50},
		            {key: "prdtSize",       label: "Size",         align : "center", width : 50},
		            {key: "prdtLen",        label: "길이",          align : "center", width : 50},
		            {key: "impNm",          label: "수입",         align : "center", width : 50},
		            {key: "stockQty",       label: "현 재고",  		align : "right",  width : 100, formatter: "money"},
		            {key: "stockWt",        label: "현 재고 중량(KG)", align : "right",  width : 100, formatter: "money"},
		            {key: "moveQty",        label: "이동수량",  		align : "right",  width :100, formatter: "money", editor: {type:"text"}, styleClass:"grid-cell-blue"},
		            {key: "moveWt",         label: "이동 중량(KG)",  align : "right",  width : 120, formatter: "money"},
		            {key: "coCd",           label: "재고단가",       hidden:"true"},
		            {key: "stockUpr",       label: "재고단가",       hidden:"true"},
		            {key: "stdUpr",         label: "기준단가",       hidden:"true"},
		            {key: "pchsUpr",        label: "최종매입단가",    hidden:"true"},
		            {key: "sellUpr",        label: "최종매출단가",    hidden:"true"},
		            {key: "etcField1",      label: "여분필드(고정)",  hidden:"true"},
		            {key: "etcField2",      label: "여분필드(숫자)",  hidden:"true"},
		            {key: "etcField3",      label: "여분필드(가변)",  hidden:"true"},
		            {key: "stockAmt",       label: "단가",         hidden:"true"},
		            {key: "proprtStockQty", label: "적정재고수량(KG)",hidden:"true"},
		            {key: "stockChgCd",     label: "재고변동사유",    hidden:"true"},
		            {key: "prjctCd",        label: "프로젝트",      align : "center", width : 100,hidden:"true"},
		            {key: "stokSeq",        label: "재고일련번호",   hidden:"true"},
    		        {key: "prdtCnvrsnWt",   label: "변환중량",     formatter: "money",       hidden:false}
    		          //  {key: "makrNm",         label: "제조사",        align : "center", width : 80},
    		    	
		        ]
		    });
			return this;
		},
		setData: function(_pageNo) {
			searchGrid = this.target;
			 var formData = {
				"coCd"   : $("#searchDtlOutCoCd").val(),
				"whCd"   : $("#searchDtlOutWhCd").val(),
				"clntNm": $("#searchDtlClntNm").val(),
				"ownerCd"  : $("#searchDtlOwnerCd").val(),
				"typCd" : $("#searchDtlTypCd").val(),			
// 				"prjctCd" : $("#prjctCd_S").val(),
// 				"prjctNm" : $("#prjctNm_S").val(),
			//	"makrCd" : $("#searchDtlMakr").val(),
				"impYn" : $("#searchDtlImpYn").val(),
				"prdtNm" : $("#searchDtlPrdtNm").val(),
			//	"prdtCoilYn" : $("#prdtCoilYn").val(),
				"pageNo" : _pageNo + 1
			} 
			
			postAjax("/user/sm/sm02/selectStockMoveStatMngmDtlList", formData, null, function(data){
				var list = data.smsmDtlList;
				searchGrid.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
			}); 
		} 
	} 
	
	//화면로드시
	$(document).ready(function() {
		setCommonSelect($(".popup_area select[data-kind]"));
		$("#searchDtlOutCoCd").val(jwt.coCd);

		//창고 초기값 설정
		setWareHouse(jwt.coCd);

	    //setDtlSelectCombo();
	    gridView1.initView().setData(0);
	    $("#sTransDt").val(dateToStr(new Date()));
	    $('#sTransDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
	    
	 // 재고이동은 유통 <->가공간에만 발생함.
		$("#searchDtlTypCd option[value='SELLTYPE3']").remove();
		$("#searchDtlTypCd option[value='SELLTYPE4']").remove();
		$("#searchDtlType option[value='SELLTYPE3']").remove();
		$("#searchDtlType option[value='SELLTYPE4']").remove();
	    
	})	
	
	//공통코드 조회
	/* function setDtlSelectCombo(){  
		var paramObj = {
			"userId" : jwt.userId,
			"wh" 		: "WH",
			"co" 		: "CO",
			"owner" 	: "OWNER",
			"makr"		: "MAKR",
			"selltype"  : "SELLTYPE",
			"prdtimp"	: "YN"
		};
		
		postAjax("/user/sm/sm02/selectDtlCmnCodeList", paramObj, null,  function(data){
			var whDtlHtml = '<option value="" selected>전체선택</option>';
			var coDtlHtml = '<option value="" selected>전체선택</option>';
			var makrDtlHtml = '<option value="" selected>전체선택</option>';
			var ownerDtlHtml = '<option value="" selected>전체선택</option>';
			var selltypeDtlHtml = '<option value="" selected>전체선택</option>';
			var ynDtlHtml = '<option value="" selected>전체선택</option>';
			var cmnDtlCodeInfo = data.cmnDtlCodeInfo;
			$.each(cmnDtlCodeInfo, function(index, item){
				if(item.codeKind == 'WH'){
					whDtlHtml += '<option value='+item.codeId+'>';
					whDtlHtml += item.codeNm;
					whDtlHtml += '</option>';
				}else if(item.codeKind == 'CO'){
					coDtlHtml += '<option value='+item.codeId+'>';
					coDtlHtml += item.codeNm;
					coDtlHtml += '</option>';
				}else if(item.codeKind == 'MAKR'){
					makrDtlHtml += '<option value='+item.codeId+'>';
					makrDtlHtml += item.codeNm;
					makrDtlHtml += '</option>';
				}else if(item.codeKind == 'OWNER'){
					ownerDtlHtml += '<option value='+item.codeId+'>';
					ownerDtlHtml += item.codeNm;
					ownerDtlHtml += '</option>';
				}else if(item.codeKind == 'SELLTYPE'){
					selltypeDtlHtml += '<option value='+item.codeId+'>';
					selltypeDtlHtml += item.codeNm;
					selltypeDtlHtml += '</option>';
				}else if(item.codeKind == 'YN'){
					ynDtlHtml += '<option value='+item.codeId+'>';
					ynDtlHtml += item.codeNm;
					ynDtlHtml += '</option>';
				}
				
				//상단검색조건
				document.getElementById("searchDtlOutCoCd").innerHTML = coDtlHtml;
				document.getElementById("searchDtlOutWhCd").innerHTML = whDtlHtml;
				document.getElementById("searchDtlMakr").innerHTML = makrDtlHtml;
				document.getElementById("searchDtlOwnerCd").innerHTML = ownerDtlHtml;
				document.getElementById("searchDtlTypCd").innerHTML = selltypeDtlHtml;
				document.getElementById("searchDtlImpYn").innerHTML = ynDtlHtml;
				
				//하단검색조건
				document.getElementById("searchDtlCoCd").innerHTML = coDtlHtml;
				document.getElementById("searchDtlWhCd").innerHTML = whDtlHtml;
			});
		});
	} */
	
	function insertUpdateMove(){
		if(inputValidation($('input[required]'))) {		
			var formData = makeFormData();
			putAjax("/user/sm/sm02/insertUpdateBarterStockMove", formData, null, function(data){
				alert(data.resultMessage);           
				gridView.setData(0);
				modal.close();
			})
		}
	}
	
	function makeFormData() {
		$("#userId").val(jwt.userId);
		
		/* var whCd = $("#searchDtlWhCd").val();
		var sTransDt = $("sTransDt").val();
		var sRmk = $("searchRmk").val(); */
		
		var formData = $("#popForm").serializeObject();
		var formData2 = {
			"sCoCd"  : $("#searchDtlOutCoCd").val(),   // 출고회사가 바뀌면 매입매출고 처리함.
			"sWhCd" : $("#searchDtlWhCd").val(),
			"sTransDt" : $("#sTransDt").val(),
			"sRmk" : $("#searchRmk").val(),	
			"sellType" : $("#searchDtlType").val(),
			"sPrjctCd" : $("#searchPrjctCd").val(),
			"sPrdtCd" : $("#searchMovePrdtCd").val(),
			"sPrdtSpec" : $("#searchMovePrdtSpec").val(),
			"sPrdtSize" : $("#searchMovePrdtSize").val(),
			"sPrdtLen" : $("#searchMovePrdtLen").val()
		}
		// 상세내역 추가
		//formData["detailArr"] = searchGrid.getList();
		formData["detailArr2"] = JSON.stringify(formData2);
		var detailArr = searchGrid.getList("modified");
		/* formData.append("mWhCd", );
		formData.append("sTransDt", );
		formData.append("sRmk", ); */
	
		formData["detailArr"] = JSON.stringify(detailArr);
		return formData;
	}
	
	//초기화 함수
	function searchInit(){
		$("#searchDtlOutCoCd option:eq(0)").prop("selected",true); 
		$("#searchDtlOutWhCd option:eq(0)").prop("selected",true);
		$("#searchDtlClntCd").val('');
		$("#searchDtlOwnerCd option:eq(0)").prop("selected",true);
		$("#searchDtlTypCd option:eq(0)").prop("selected",true);
	//	$("#searchDtlMakr option:eq(0)").prop("selected",true);
		$("#searchDtlImpYn option:eq(0)").prop("selected",true);
		$("#searchDtlPrdtCd").val('');
		$("#searchDtlPrdtNm").val('');
	    gridView1.initView().setData(0);
	}
	
	//거래처 검색
	function clntSearch() {
		openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#searchDtlClntCd').val(row.clntCd);
			$('#searchDtlClntNm').val(row.clntNm);
		});
	}
	//제품 검색
	function prdtSearch(elem) {
		$targetRow = $(elem).closest('tr[name="tableCd"]');
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $('#searchDtlOutCoCd').val(),
			"selpchCd": "SELPCH2",
			"impYn": "N", 
			"clntCd" : $("#clntCd").val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$targetRow.find('input[name="searchDtlPrdtCd"]').val(row.prdtCd);
			$targetRow.find('input[name="searchDtlPrdtNm"]').val(row.prdtNm);
			$targetRow.find('input[name="prdtCoilYn"]').val(row.prdtCoilYn);
		});
	}
	
	//제품 검색
	function prdtSearch2(elem) {
		$targetRow = $(elem).closest('tr[name="tableCd2"]');
		// selpchCd - SELPCH2: 매출
		var paramObj = {
			"coCd": $('#searchDtlOutCoCd').val(),
			"selpchCd": "SELPCH2",
			"impYn": "N", 
			"clntCd" : $("#clntCd").val(),
			"useYn": "Y"
		};
		openSecondModal("/static/html/cmn/modal/prdtSearch.html", 800, 600, "제품 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$targetRow.find('input[name="searchMovePrdtCd"]').val(row.prdtCd);
			$targetRow.find('input[name="searchMovePrdtNm"]').val(row.prdtNm);
			$targetRow.find('input[name="searchMovePrdtSize"]').val(row.prdtSize);
			$targetRow.find('input[name="searchMovePrdtSpec"]').val(row.prdtSpec);
			$targetRow.find('input[name="searchMovePrdtLen"]').val(row.prdtLen);
		});
	}

	// 창고 set
	function setWareHouse(value){
		//출고고지 창고 법인별 설정
		$('#searchDtlOutWhCd').data("desc", value);
		$('#searchDtlOutWhCd').empty();
		setCommonSelect($('#searchDtlOutWhCd'));
		//임고지 창고법인별 설정
		$('#searchDtlWhCd').data("desc", value);
		$('#searchDtlWhCd').empty();
		setCommonSelect($('#searchDtlWhCd'));
	}		

</script>
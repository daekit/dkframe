<div id="transViewDiv" class="popup_area of_a" style="width: 100%; height: 100%;">
	<div class="tit_contents">
		<h4 class="tit"></h4>
	</div>

	<div class="popup_table">
		<!-- <input type="file" id="file" style="display:none" multiple="multiple" onchange="setFile(this);"/> -->
		<form id="popForm">
			<table>
				<colgroup>
					<col width="15%">
					<col width="35%">
					<col width="15%">
					<col width="35%">
					<col>
				</colgroup>
				<tr>
					<th class="hit">운송일자</th>
					<td>
						<input type="text" id="transDt" name="transDt" class="input_calendar" autocomplete="off" required msg="운송일자">
					</td>
					<th class="">회사</th>
					<td>
						<select id="coCd" name="coCd" data-kind="CO" onchange="setByCoCd(this.value);"></select>
					</td>
				</tr>
				<tr>
					<th>운송업체</th>
					<td class="drctArea">
						<input type="hidden" id="transCo" name="transCo" style="width: 76%;">
						<div class="search_form">
							<input type="text" id="transNm" name="transNm" disabled msg="운송업체">
							<a onclick="clntSearch('T');"><i class="i_search_w"></i></a>
						</div>
					</td>
					<th>거래처</th>
					<td class="drctArea">
						<input type="hidden" id="clntCd" name="clntCd" style="width: 76%;">
						<div class="search_form">
							<input type="text" id="clntNm" name="clntNm"> 
							<a onclick="clntSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				<tr>
					<th class="">중량(KG)</th>
					<td>
						<input id="totWt" name="totWt" type="text" style="width: 100%;" onchange="transPrc();" onkeyup="onlyNumber(this);" comma>
					</td>
					<th class="">현 장</th>
					<td>
						<div class="search_form">
							<input type="hidden" id="prjctCd" name="prjctCd"> 
							<input type="hidden" id="prjctNm" name="prjctNm"> 
							<input type="hidden" id="siteCd" name="siteCd"> 
							<input type="text" id="siteNm" name="siteNm" disabled>
							<a onclick="openThirdSiteSearch();"><i class="i_search_w"></i></a>
						</div>
					</td>
				</tr>
				<tr>
					<th class="">도착지</th>
					<td>
						<input id="desCd" name="desCd" type="hidden" style="width: 100%;"> 
						<input id="desNm" name="desNm" type="text" style="width: 100%;">
					</td>
					<th class="">착불여부</th>
					<td>
						<input type="hidden" id="totWt2" name="totWt2">
						<select id="arvpayYn" name="arvpayYn" data-kind="YN" onchange="changePayCo();"></select>
					</td>
				</tr>
				<tr>
					<th class="">상차지(창고)</th>
					<td>
						<select id="whCd" name="whCd" data-kind="WH">
							<option value=""></option>
						</select>
					</td>
					<th class="">지불회사</th>
					<td>
						<input id="payCo" name="payCo" type="text">
					</td>
				</tr>
				<tr>
					<th class="">운전기사</th>
					<td>
						<input id="drivrNm" name="drivrNm" type="text">
					</td>
					<th class="">차량번호</th>
					<td>
						<input id="shipVehNo" name="shipVehNo" type="text">
					</td>
				</tr>
				<tr>
					<th class="hit">운송단가</th>
					<td>
						<input id="transUpr" name="transUpr" type="text" onkeyup="onlyNumber(this);transPrc();" comma required msg="운송단가">
					</td>
					<th class="hit">매입법인</th>
					<td>
						<select id="taxivcCoprt" name="taxivcCoprt" data-kind="ESTCOPRT" msg="계산서발행법인" required>
							<option value="">선택</option>
						</select>
					</td>
				</tr>
				<tr>
					<th class="hit">운송비</th>
					<td>
						<input id="transAmt" name="transAmt" type="text" onkeyup="onlyNumber(this);" comma required msg="운송비">
					</td>
					<th class="hit">제품그룹</th>
				    <td>
	                 	<select id="prdtGrp" name="prdtGrp" data-kind="PRDTGRP" onchange="gridView.setData(0);" msg="제품그룹" required>
	                 		<option value="">전체</option>
	                 	</select>
	                </td>
				</tr>
				<tr>
					<th></th>
					<td>
					</td>
					<th class="">지불처리 완료여부</th>
					<td>
						<select id="procYn" name="procYn" data-kind="YN"></select>
					</td>
				</tr>
				<tr>
					<th class="">비고</th>
					<td colspan="5">
						<input id="transRmk" name="transRmk" type="text">
					</td>
				</tr>
			</table>
			<input type="hidden" id="userId" name="userId"> 
			<input type="hidden" id="pgmId" name="pgmId" value="AR0301P01">
			<input type="hidden" id="shipSeq" name="shipSeq">
			<input type="hidden" id="transSeq" name="transSeq">
		</form>
	</div>
	<!-- 출하요청서 테이블 -->
	<table class="popup_table" id="shipmentTable" style="display: none">
		<colgroup>
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
			<col width="14%">
		</colgroup>
		<thead>
			<tr>
				<td colspan="6" style="text-align: left;">출하요청서</td>
				<td style="text-align: right;"><a class="tbody_more_btn"></a></td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td colspan="7">
					<div class="contents">
						<div data-ax5grid="AR01-grid" data-ax5grid-config="{}" style="height: 150px;"></div>
					</div>
				</td>
			</tr>
		</tbody>
	</table>
	<div class="popup_bottom_btn">
	    <button id="actionBtn">등록</button>
		<button type="button" onclick="deleteTrans();"  authchk>삭제</a> 
		<button type="button" class="close_btn" onclick="modalStack.close();">닫기</button>
	</div>
</div>
<script type="text/javascript">
	var AR01Grid = null;
	var AR01GridView = {
		initView: function(){
			this.target = new ax5.ui.grid();
			this.target.setConfig({
		    	showRowSelector: false,
		    	multipleSelect: false,
		    	sortable: true,
		        target: $('[data-ax5grid="AR01-grid"]'),
		        header: {
		        	align: "center",
		        	selector: false
		        },
		        body: {
		        	onClick: function () {
		                this.self.select(this.dindex); 
		            },
		            onDBLClick: function(){
		            	this.self.clearSelect();
		            	this.self.select(this.dindex);
		            	viewShipDtlModal(this.item.shipSeq);
		            },
		        },
		        page: {
		            navigationItemCount: 9,
		            height: 30,
		            display: true,
		            firstIcon: '<i class="fa fa-step-backward" aria-hidden="true"></i>',
		            prevIcon: '<i class="fa fa-caret-left" aria-hidden="true"></i>',
		            nextIcon: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
		            lastIcon: '<i class="fa fa-step-forward" aria-hidden="true"></i>',
		            onChange: function () {
		            	AR01GridView.setData(this.page.selectPage);
		            }
		        },
		        columns: [
//		          	{key: "shipSeq", label: "shipSeq", align: "center", width: 100},
		          	{key: "coNm", label: "회사", align: "center", width: 100},
		          	{key: "whNm", label: "창고", align: "center", width: 120},
		            {key: "clntNm", label: "거래처", align: "left", width: 200},
		            {key: "reqDt", label: "요청일자", align: "center", width: 100},
//		        	{key: "dirtrsYn", label: "직송", align: "center", width: 40},
		        	{key: "dlvrDttm", label: "납기일시", align: "center", width: 100},
//		        	{label: "출하요청",  columns:[
//		          		{key: "shipTotQty", label: "수량", align: "right", width: "10%", formatter: "money" },
//			          	{key: "shipTotWt", label: "중량", align: "right", width: "10%", formatter: "money" },
//			          	{key: "shipTotAmt", label: "총금액", align: "right", width: "10%",formatter: "money" }
//		          	]},
//		          	{label: "실 출하",  columns:[
		          		{key: "realTotQty", label: "수량", align: "right", width: 100, formatter: "money" },
//			          	{key: "realTotWt", label: "중량", align: "right", width: 100, formatter: "money" },
//			          	{key: "realTotAmt", label: "총금액", align: "right", width: "10%", formatter: "money" },
//		          	]},
		        	{key: "shipYn", label: "출하", align: "center", width: 80},
//		        	{key: "shipDttm", label: "출하완료일", align: "center", width: "10%"},
//		        	{key: "transAmt", label: "운송비", align: "right", width: 100, formatter: "money"},
//		        	{key: "odrCreatDiv", label: "오더구분", align: "center", width: "10%"},
		        ]
		    });
			return this;
		}, 
		setData: function(_pageNo) {
			AR01Grid = this.target;
			var formData = {
				"siteCd" : $("#siteCd").val(),
				"shipSeq" : $("#shipSeq").val(),
				"transSeq" : $("#transSeq").val(),
				"pageNo" : _pageNo + 1, 
				"recordCnt" : $("#recordCnt").val()
			}
			
			postAjax("/user/ar/ar03/selectShipList", formData, null, function(data){
				var list = data.resultList;
				AR01Grid.setData({
					list : list,
					page : {
						currentPage : _pageNo,
						pageSize : data.paginationInfo.pageSize,
						totalElements : data.paginationInfo.totalRecordCount,
						totalPages : data.paginationInfo.totalPageCount
					}
				});
		//		if(AR01Grid.list.length == 0){
		//			$("#shipmentTable").hide();
		//		}
			});
		}
	}
	
	
	$(document).ready( function() {
		// 영역 접기/열기 이벤트 바인딩
		$("#userId").val(jwt.userId);
		setCommonSelect($("#transViewDiv select[data-kind]"));
		/* $('a.tbody_more_btn').click(function() {
			$(this).toggleClass('on');
			$(this).closest('table').find('tbody').toggle();
		}); */
		document.getElementById('transDt').value= new Date().toISOString().slice(0, 10);
		$('#transDt').datepicker({
			format : "yyyy-mm-dd",
			language : "ko",
			autoclose : true
		});
		if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "AR0202P01" || openFrom == "OD0202P01" || openFrom == "AR0202P01") {
			$("#transViewDiv #coCd").val($("#arViewDiv #coCd").val());
			$("#transViewDiv #transSeq").val($("#arViewDiv #transSeq").val());
		}else if(openFrom == "SM0201P01"){ //  일반재고이동시 운반비 발생
			$("#transViewDiv #coCd").val($("#arViewDiv #searchDtlOutCoCd").val());
			$("#transViewDiv #transSeq").val($("#arViewDiv #transSeq").val());
		}
		setInit();
	});
	
	function setInit() {
		var actionType = modalStack.last().paramObj.actionType;
		if(actionType == "C") {
			$('#coCd').val(modalStack.last().paramObj.coCd);
            // 판매법인, 창고 set
			setByCoCd($('#coCd').val());
			if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "SM0201P01" || openFrom == "SM0201P02" || openFrom == "AR0202P01" || openFrom == "OD0202P01"){ //  일반재고이동시 운반비 발생
				if(openFrom == "AR0102P01"  || openFrom == "SM0201P01" || openFrom == "SM0201P02") {
					$("#transViewDiv #clntCd").val($("#arViewDiv #clntCd").val());
					$("#transViewDiv #clntNm").val($("#arViewDiv #clntNm").val());
					$("#transViewDiv #totWt").val($("#arViewDiv #shipTotWt").val());
				} else {
					$("#transViewDiv #clntCd").val($("#arViewDiv #sellClntCd").val());
					$("#transViewDiv #clntNm").val($("#arViewDiv #sellClntNm").val());
					$("#transViewDiv #totWt").val($("#arViewDiv #totWt").val());
				}
				$("#transViewDiv #prjctCd").val($("#arViewDiv #prjctCd").val());
				$("#transViewDiv #prjctNm").val($("#arViewDiv #prjctNm").val());
				$("#transViewDiv #siteCd").val($("#arViewDiv #siteCd").val());
				$("#transViewDiv #siteNm").val($("#arViewDiv #siteNm").val());
				$("#transViewDiv #whCd").val($("#arViewDiv #whCd").val());
				$("#transViewDiv #taxivcCoprt").val($("#arViewDiv #taxivcCoprt").val());
				$("#transViewDiv #desNm").val($("#arViewDiv #addrMain").val());
			}
			if( openFrom == "SM0201P01"){ //  일반재고이동시 운반비 발생
				$("#transViewDiv #transRmk").val("재고이동");
				$("#transViewDiv #taxivcCoprt").val($('#arViewDiv #searchDtlOutWhCd option:selected').data("etc")); // 판매법인
			}
            
			$('#transViewDiv .tit_contents .tit').text("운반비 등록");
			$('#actionBtn').on("click", function(){insertCaryng();});
			$("#actionBtn").text("등록");
			$("#arvpayYn").val("N");
		}else if(actionType == "U"){
			selectCaryngInfo();
			if(!(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "AR0202P01" || openFrom == "OD0202P01")) {
				$("#shipmentTable").show();
				AR01GridView.initView().setData(0);
			}
			$('#transViewDiv .tit_contents .tit').text("운반비 수정");
			$('#actionBtn').on("click", function(){updateCaryng();});
			$('#actionBtn').text("수정");
		}
		changePayCo();
	}
	
	function changePayCo(){
		var prvpayYn =  $("#arvpayYn").val();
		if(prvpayYn == "N"){
			$("#payCo").val($('#coCd option:selected').text());
			$("#taxivcCoprt").prop("required", true);
			$("#taxivcCoprt").prop("disabled", false);
		}else{
			$("#payCo").val("착불");
			$("#taxivcCoprt").val("");
			$("#taxivcCoprt").prop("required", false);
			$("#taxivcCoprt").prop("disabled", true);
		}
	}
	
	function selectCaryngInfo(){
		var paramObj = modalStack.last().paramObj;
		postAjaxSync("/user/ar/ar03/selectCaryngInfo", paramObj, null, function(data){
			setCaryngInfo(data.result);
		});
	}
	
	function setCaryngInfo(obj){
		
    	var transInfo = obj;
		//메인정보 세팅
		$.each(transInfo, function(key, value){
			$('#transViewDiv #'+key).val(value);
			if(key=="transDt"){
				$('#'+key).datepicker("setDate", moment(value, 'YYYYMMDD').toDate());
			}else if(key == "coCd"){
	            // 판매법인, 창고 set
				setByCoCd(value);
			}
		});
		//콤마세팅
		$.each($('#transViewDiv input[comma]'), function(idx, elem){
			onlyNumber(elem);
		});
	}
	
	//중량*운송단가
	function transPrc(){
		var totVal = $('#totWt').val();
		var transVal = $('#transUpr').val();
		
		if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "AR0202P01" || openFrom == "OD0202P01") {
			$("#transViewDiv #transAmt").val(transVal);
		} else {
			$("#transAmt").val(transVal);
		}
	}
	
	function insertCaryng() {		
		if(inputValidation($('#transViewDiv [required]'))) {
			var formData = makeCaryngData();
			postAjax("/user/ar/ar03/insertCaryng", formData, null, function(data){
				alert(data.resultMessage);
				if(data.resultCode == 200){
					if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "SM0201P01" ||
					   openFrom == "AR0202P01" || openFrom == "OD0202P01" || openFrom == "SM0201P02") {
						$("#arViewDiv #transAmt").val($("#transViewDiv #transAmt").val());
						$("#arViewDiv #transSeq").val(data.transSeq);
//						onlyNumber($("#arViewDiv #transAmt"));
						modalStack.close();
					} else {
						gridView.setData(0);
						modalStack.close();
					}
				}
			});
		}
	}
	
	function updateCaryng() {
		if(inputValidation($('#transViewDiv [required]'))) {
			var formData = makeCaryngData();
			putAjax("/user/ar/ar03/updateCaryng", formData, null, function(data){
				alert(data.resultMessage);           
				if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "SM0201P01" ||
				   openFrom == "AR0202P01" || openFrom == "OD0202P01" || openFrom == "SM0201P02") {
					$("#arViewDiv #transAmt").val($("#transViewDiv #transAmt").val());
				//	onlyNumber($("#arViewDiv #transAmt"));
					modalStack.close();
				}else{
					gridView.setData(0);
					modalStack.close();
				}
			});
		}
	}
	
	function makeCaryngData() {
		$.each($('input[comma]'), function(idx, elem){
			deleteComma(elem);
		});
		var formData = new $('#transViewDiv form')[0];
		var tempObj = $(formData).serializeObject();
//		tempObj.coCd = jwt.coCd;
		tempObj.userId = jwt.userId;
		//formData[tempForm.id] = tempObj;
		formData = tempObj;
		return formData;
	}
	
	//거래처
	function clntSearch(type) {
		if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom=="SM0201P01" ||
		   openFrom == "AR0202P01" || openFrom == "OD0202P01" || openFrom=="SM0201P02") {
			openThirdModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
				var row = grid.target.getList("selected")[0];
				if(type == "T") {
					$('#transViewDiv #transCo').val(row.clntCd);
					$('#transViewDiv #transNm').val(row.clntNm);
				} else {
					$('#transViewDiv #clntCd').val(row.clntCd);
					$('#transViewDiv #clntNm').val(row.clntNm);					
				}
			});
		} else {
			openSecondModal("/static/html/cmn/modal/clntSearch.html", 600, 420, "거래처 검색", {}, function (grid) {
				var row = grid.target.getList("selected")[0];
				if(type == "T") {
					$('#transCo').val(row.clntCd);
					$('#transNm').val(row.clntNm);
				} else {
					$('#clntCd').val(row.clntCd);
					$('#clntNm').val(row.clntNm);
				}
				
			});
		}
	}
	
	// 현장 검색
	function openSecondSiteSearch(){
		var paramObj = {
			"coCd": $('#coCd').val(),
			"clntCd": $('#clntCd').val()
		}
		
		openSecondModal("/static/html/cmn/modal/siteSearch.html", 700, 420, "현장 검색", paramObj, function (grid) {
			var row = grid.target.getList("selected")[0];
			$('#prjctCd').val(row.prjctCd);
			$('#prjctNm').val(row.siteNm);
		});
	}
	
	
	
	// 현장 검색
	function openThirdSiteSearch(){
		var paramObj = {"coCd"   : $('#coCd').val(),
                        "clntCd" : $('#clntCd').val(),
                        "clntNm" : $('#clntNm').val()}
		if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "OD0202P01" ||
		   openFrom == "AR0301M01" || openFrom == "AR0202P01" || openFrom == "OD0202P02") {
			openThirdModal("/static/html/cmn/modal/siteSearch.html", 700, 420, "현장 검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];
				$("#transViewDiv #prjctCd").val(row.prjctCd);
				$("#transViewDiv #prjctNm").val(row.prjctNm);
				$("#transViewDiv #siteCd").val(row.sitetCd);
				$("#transViewDiv #siteNm").val(row.siteNm);
			});
		} else {
			openSecondModal("/static/html/cmn/modal/siteSearch.html", 700, 420, "현장  검색", paramObj, function (grid) {
				var row = grid.target.getList("selected")[0];
				$('#prjctCd').val(row.prjctCd);
				$('#prjctNm').val(row.prjctNm);
				$('#siteCd').val(row.siteCd);
				$('#siteNm').val(row.siteNm);
			});
		}
	}
	
	function viewShipDtlModal(shipSeq) {
		var paramObj = {"shipSeq": shipSeq};
		openSecondModal("/static/html/user/ar/ar01/AR0102V01.html", 1300, 780, "", paramObj);
	}
	
	function setByCoCd(value){
		// 창고 set
		$('#transViewDiv #whCd').data("desc", value);
		$('#transViewDiv #whCd option:not([value=""])').remove();
		setCommonSelect($('#transViewDiv #whCd'));
		// 판매법인 set
		$('#transViewDiv #taxivcCoprt').data("rprc", value);
		$('#transViewDiv #taxivcCoprt option:not([value=""])').remove();
		setCommonSelect($('#transViewDiv #taxivcCoprt'));
	}
	
	//운송비 삭제
	function deleteTrans() {
		var transSeq =  $('#transViewDiv #transSeq').val();
		var formData = {
			"transSeq" : transSeq,
			"pgmId"    : openFrom,
			"userId"   : jwt.userId
		}
		if(confirm("삭제하시겠습니까?")){
			deleteAjax("/user/ar/ar03/deleteTrans", formData, null, function(data){
				if(openFrom == "AR0102P01" || openFrom == "OD0102P01" || openFrom == "SM0201P01" ||
				   openFrom == "AR0202P01" || openFrom == "OD0202P01" || openFrom == "SM0201P02") {
					$("#arViewDiv #transAmt").val(0);
					$("#arViewDiv #transSeq").val("");	
					alert(data.resultMessage);
					modalStack.close();
				}
			});
		}
	}
			
</script>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.ar.ar05.mapper.AR05Mapper">
	
	<select id="selectEtrdpsCount" resultType="int">
		SELECT 
			COUNT(*)
		FROM
			TB_AR05M01 D
			LEFT JOIN TB_AR05D01 B ON D.BIL_NO = B.BIL_NO
			INNER JOIN TB_BM02M01 C ON D.CLNT_CD = C.CLNT_CD
		<where>
			<if test="coCd != null and !coCd.equals('')">
				D.CO_CD = #{coCd}
			</if>
			<if test="startDt != null and !startDt.equals('')">
				<![CDATA[ AND TO_DATE(D.ETRDPS_DT, 'YYYYMMDD') >= TO_DATE(#{startDt}, 'YYYY-MM-DD') ]]>
			</if>
			<if test="endDt != null and !endDt.equals('')">
				<![CDATA[ AND TO_DATE(D.ETRDPS_DT, 'YYYYMMDD') < TO_DATE(#{endDt}, 'YYYY-MM-DD') + 1 ]]>
			</if>
			<if test="clntDivCd != null and !clntDivCd.equals('')">
				AND C.CLNT_DIV_CD = #{clntDivCd}
			</if>
			<if test="setleTypCd != null and !setleTypCd.equals('')">
				AND D.SETLE_TYP_CD = #{setleTypCd}
			</if>
			<if test="etrdpsBkacCd != null and !etrdpsBkacCd.equals('')">
				AND D.ETRDPS_BKAC_CD = #{etrdpsBkacCd}
			</if>
			<if test="etrdpsTyp != null and !etrdpsTyp.equals('')">
				AND D.ETRDPS_TYP = #{etrdpsTyp}
			</if>
			<if test="clntNm != null and !clntNm.equals('')">
				AND C.CLNT_NM LIKE '%'|| #{clntNm} ||'%'
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND C.CLNT_CD = #{clntCd}
			</if>
        	<if test="taxivcCoprt != null and !taxivcCoprt.equals('')">
		        AND D.TAXIVC_COPRT = #{taxivcCoprt}
	        </if>
			        
			        
			
		</where>
	</select>
	
	<select id="selectEtrdpsList" resultType="CamelMap">
		SELECT
			*
		FROM
		(
			SELECT
				ROWNUM AS RNUM, A.*
			FROM
			(
				SELECT
				    D.CO_CD,
					FN_CM05M01_CD_TO_NM(D.CO_CD) AS CO_NM,
					D.ETRDPS_SEQ,
					TO_CHAR(TO_DATE(D.ETRDPS_DT, 'YYYYMMDD'), 'YYYY-MM-DD') ETRDPS_DT,
					C.CLNT_CD,
					C.CLNT_NM,
					D.TAXIVC_COPRT,
					FN_CM05M01_CD_TO_NM(D.SETLE_TYP_CD) AS SETLE_TYP_NM,
					D.ETRDPS_AMT,
					FN_CM05M01_CD_TO_NM(D.ETRDPS_BKAC_CD) AS ETRDPS_BKAC_NM, 
					D.SUMRY,
					FN_CM05M01_CD_TO_NM(B.BIL_TYP_CD) AS BIL_TYP_NM,
					B.BIL_NO,
					TO_CHAR(TO_DATE(B.EXPRTN_DT, 'YYYYMMDD'), 'YYYY-MM-DD') EXPRTN_DT,
					FN_CM05M01_CD_TO_NM(B.PYMNT_BANK_CD) AS PYMNT_BANK_NM,
					B.ENDRS_PSN,
					ETRDPS_TYP,
					FN_CM05M01_CD_TO_NM(D.ETRDPS_TYP) AS ETRDPS_TYP_NM,
					D.TAXIVC_COPRT,
					FN_CM05M01_CD_TO_NM(D.TAXIVC_COPRT) AS TAXIVC_COPRT_NM,
					D.MSCL_PRFT_YN
				FROM
					TB_AR05M01 D
					LEFT JOIN TB_AR05D01 B ON D.BIL_NO = B.BIL_NO
					INNER JOIN TB_BM02M01 C ON D.CLNT_CD = C.CLNT_CD
				<where>
					<if test="coCd != null and !coCd.equals('')">
						D.CO_CD = #{coCd}
					</if>
					<if test="startDt != null and !startDt.equals('')">
						<![CDATA[ AND TO_DATE(D.ETRDPS_DT, 'YYYYMMDD') >= TO_DATE(#{startDt}, 'YYYY-MM-DD') ]]>
					</if>
					<if test="endDt != null and !endDt.equals('')">
						<![CDATA[ AND TO_DATE(D.ETRDPS_DT, 'YYYYMMDD') < TO_DATE(#{endDt}, 'YYYY-MM-DD') + 1 ]]>
					</if>
					<if test="clntDivCd != null and !clntDivCd.equals('')">
						AND C.CLNT_DIV_CD = #{clntDivCd}
					</if>
					<if test="clntNm != null and !clntNm.equals('')">
						AND C.CLNT_NM LIKE '%'|| #{clntNm} ||'%'
					</if>
					<if test="clntCd != null and !clntCd.equals('')">
						AND C.CLNT_CD = #{clntCd}
					</if>
					<if test="setleTypCd != null and !setleTypCd.equals('')">
						AND D.SETLE_TYP_CD = #{setleTypCd}
					</if>
					<if test="etrdpsBkacCd != null and !etrdpsBkacCd.equals('')">
						AND D.ETRDPS_BKAC_CD = #{etrdpsBkacCd}
					</if>
		        	<if test="etrdpsTyp != null and !etrdpsTyp.equals('')">
				        AND D.ETRDPS_TYP = #{etrdpsTyp}
			        </if>
		        	<if test="taxivcCoprt != null and !taxivcCoprt.equals('')">
				        AND D.TAXIVC_COPRT = #{taxivcCoprt}
			        </if>
				</where>
				ORDER BY D.CO_CD, D.TAXIVC_COPRT, D.ETRDPS_DT, C.CLNT_NM, D.CREAT_DTTM DESC
			) A
		)
		WHERE
			RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<select id="selectEtrdpsInfo" resultType ="CamelMap">
		SELECT
			D.CO_CD,
			D.ETRDPS_SEQ,
			D.CLNT_CD,
			C.CLNT_NM,
			TO_CHAR(TO_DATE(D.ETRDPS_DT, 'YYYYMMDD'), 'YYYY-MM-DD') ETRDPS_DT,
			D.SETLE_TYP_CD,
			D.TAXIVC_COPRT,
			D.MSCL_PRFT_YN,
			D.ETRDPS_AMT,
			D.ETRDPS_BKAC_CD,
			D.BIL_NO,
			D.SUMRY,
			D.ETRDPS_TYP		
		FROM
			TB_AR05M01 D
			INNER JOIN TB_BM02M01 C ON D.CLNT_CD = C.CLNT_CD
		WHERE
			ETRDPS_SEQ = ${etrdpsSeq}
	</select>
	
	<select id="selectBillInfo" resultType="CamelMap">
		SELECT
			B.BIL_TYP_CD,
			B.BIL_NO,
			TO_CHAR(TO_DATE(B.EXPRTN_DT, 'YYYYMMDD'), 'YYYY-MM-DD') EXPRTN_DT,
			B.PYMNT_BANK_CD,
			B.BIL_PBLS_PSN,
			B.ENDRS_PSN_CNT,
			B.BIL_AMT,
			TO_CHAR(TO_DATE(B.BIL_PBLS_DT, 'YYYYMMDD'), 'YYYY-MM-DD') BIL_PBLS_DT,
			B.ENDRS_PSN,
			B.SUMRY
		FROM
			TB_AR05D01 B
		WHERE
			B.BIL_NO = #{bilNo}
	</select>
	
	<insert id="insertEtrdps">
		<selectKey keyProperty="etrdpsSeq" resultType="String" order="BEFORE">
			SELECT TB_AR05M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_AR05M01 (
			CO_CD,
			ETRDPS_DT,
			CLNT_CD,
			ETRDPS_SEQ,
			SETLE_TYP_CD,
			ETRDPS_AMT,
			ETRDPS_BKAC_CD,
			<if test="bilNo != null and !bilNo.equals('')">
				BIL_NO,
			</if>
			SUMRY,
			CREAT_ID, CREAT_PGM, CREAT_DTTM,
			UDT_ID, UDT_PGM, UDT_DTTM,
			ETRDPS_TYP,
			TAXIVC_COPRT,
			MSCL_PRFT_YN		
	 	) VALUES (
	 		#{coCd},
			#{etrdpsDt},
			#{clntCd},
			#{etrdpsSeq},
			#{setleTypCd},
			#{etrdpsAmt},
			#{etrdpsBkacCd},
			<if test="bilNo != null and !bilNo.equals('')">
				#{bilNo},
			</if>
			#{sumry},
			#{userId}, #{pgmId}, SYSDATE,
			#{userId}, #{pgmId}, SYSDATE,
			#{etrdpsTyp},
			#{taxivcCoprt},
			#{msclPrftYn}
	 	)
	</insert>
	
	<insert id="insertBill">
		INSERT INTO TB_AR05D01 (
			CO_CD,
			CLNT_CD,
			BIL_NO,
			BIL_TYP_CD,
			EXPRTN_DT,
			PYMNT_BANK_CD,
			BIL_PBLS_PSN,
			ENDRS_PSN_CNT,
			ENDRS_PSN,
			BIL_AMT,
			BIL_PBLS_DT,
			SUMRY,
			CREAT_ID,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM,
			UDT_DTTM
	 	) VALUES (
	 		#{coCd},
	 		#{clntCd},
	 		#{bilNo},
	 		#{bilTypCd},
	 		#{exprtnDt},
	 		#{pymntBankCd},
	 		#{bilPblsPsn},
	 		#{endrsPsnCnt},
	 		#{endrsPsn},
	 		#{bilAmt},
	 		#{bilPblsDt},
	 		#{sumry},
	 		#{userId},
	 		#{pgmId},
	 		SYSDATE,
	 		#{userId},
	 		#{pgmId},
	 		SYSDATE
	 	)
	</insert>
	
	<select id="callCreditLoan" resultType="int">
    	SELECT F_CREDIT_LOAN('D', #{clntCd}, #{coCd}, #{etrdpsDt}, #{etrdpsAmt}) FROM DUAL
    </select>
	
	<update id="updateEtrdps">
		UPDATE TB_AR05M01
		SET
			ETRDPS_DT      = #{etrdpsDt},
			ETRDPS_BKAC_CD = #{etrdpsBkacCd},
			SUMRY          = #{sumry},
			UDT_ID         = #{userId},
			UDT_PGM        = #{pgmId}, 
			UDT_DTTM       = SYSDATE,
			ETRDPS_TYP     = #{etrdpsTyp},
			TAXIVC_COPRT   = #{taxivcCoprt},
			MSCL_PRFT_YN   = #{msclPrftYn}
		WHERE
			ETRDPS_SEQ     = #{etrdpsSeq}
	</update>
	
	<update id="updateBill">
		UPDATE TB_AR05D01
		SET
			BIL_TYP_CD    = #{bilTypCd},
			EXPRTN_DT     = #{exprtnDt},
			PYMNT_BANK_CD = #{pymntBankCd},
			BIL_PBLS_PSN  = #{bilPblsPsn},
			ENDRS_PSN_CNT = #{endrsPsnCnt},
			BIL_AMT       = #{bilAmt},
			BIL_PBLS_DT   = #{bilPblsDt},
			ENDRS_PSN     = #{endrsPsn},
			SUMRY         = #{sumry},
			UDT_ID        = #{userId},
			UDT_PGM       = #{pgmId},
			UDT_DTTM      = SYSDATE
		WHERE
			BIL_NO = #{bilNo}
	</update>
	
	<delete id="deleteEtrdps">
		DELETE
		FROM
			TB_AR05M01
		WHERE
			ETRDPS_SEQ = #{etrdpsSeq}
	</delete>
	
	<delete id="deleteBill">
		DELETE
		FROM
			TB_AR05D01
		WHERE
			BIL_NO = #{bilNo}
	</delete>
	
	<select id="selectEtrdpsDtlList" parameterType="Map" resultType="CamelMap">
	SELECT A.CO_CD
		 , A.TRST_CLNT_CD
		 , C.CLNT_NM
		 , TO_CHAR(TO_DATE(A.TRST_DT, 'YYYYMMDD'), 'YYYY-MM-DD') TRST_DT
		 , A.PRJCT_CD
		 , B.PRJCT_NM
		 , FN_CM05M01_CD_TO_NM(CASE WHEN (A.PRJCT_CD != 0 OR A.PRJCT_CD != NULL) THEN B.PMNT_MTD_CD
		 		ELSE C.SELL_PMNT_MTD_CD END) PMNT_MTD_NM
		 , CASE WHEN (A.PRJCT_CD != 0 OR A.PRJCT_CD != NULL) THEN B.PMNT_MTD_CD
		 		ELSE C.SELL_PMNT_MTD_CD END PMNT_MTD_CD -- 결제방법
		 , FN_CM05M01_CD_TO_NM(CASE WHEN (A.PRJCT_CD != 0 OR A.PRJCT_CD != NULL) THEN B.CLMN_DIV_CD
		 	    ELSE C.SELL_CLMN_DIV_CD END) CLMN_DIV_NM
		 , CASE WHEN (A.PRJCT_CD != 0 OR A.PRJCT_CD != NULL) THEN B.CLMN_DIV_CD
		 	    ELSE C.SELL_CLMN_DIV_CD END CLMN_DIV_CD -- 수금조건
		 , CASE WHEN (A.PRJCT_CD != 0 OR A.PRJCT_CD != NULL) THEN B.CLMN_DAY
		 	    ELSE C.SELL_CLMN_DAY END CLMN_DAY -- 수금일자
		 , A.BILG_VAT_AMT + A.BILG_AMT - A.ETRDPS_AMT BILG_TOT -- 청구금액
		 , A.BILG_CERT_NO
		 , A.TRST_CERTI_NO
		 , E.PRDT_GRP
		 , D.TAX_BILG_NO
	  FROM TB_AR02M01 A
		LEFT OUTER JOIN TB_SD05M01 B
		ON A.PRJCT_CD = B.PRJCT_CD
		LEFT OUTER JOIN TB_BM02M01 C
		ON A.TRST_CLNT_CD = C.CLNT_CD
		LEFT OUTER JOIN TB_AR04M01 D
		ON A.BILG_CERT_NO = D.BILG_CERT_NO
		LEFT OUTER JOIN TB_BM01M01 E
		ON A.TRST_PRDT_CD = E.PRDT_CD
		WHERE A.CO_CD = #{coCd}
		  AND A.TRST_CLNT_CD = #{clntCd}
		  AND A.TAXIVC_COPRT = #{taxivcCoprt}
		  AND A.BILG_CERT_NO IS NOT NULL
		  AND A.ETRDPS_YN = 'N'
		  AND D.TAX_BILG_NO IS NOT NULL
	</select>
	
	<update id="updateEtrdpsDtl" parameterType="Map">	
	UPDATE TB_AR02M01
	   SET ETRDPS_AMT = NVL(ETRDPS_AMT, 0) + #{etrdpsAmt}
	     , ETRDPS_YN = CASE WHEN #{etrdpsAmt} = (BILG_VAT_AMT + BILG_AMT - ETRDPS_AMT) THEN 'Y' ELSE 'N' END
	 WHERE CO_CD = #{coCd}
	   AND TRST_CERTI_NO = #{trstCertiNo}
	</update>

	<insert id="insertEtrdpsDtl" parameterType="Map">
	INSERT INTO TB_AR05D02
	(
		CO_CD
		, ETRDPS_SEQ
		, ETRDPS_DTL_SEQ
		, BILG_CERT_NO
		, TRST_CERTI_NO
		, ETRDPS_DT
		, TRST_DT
		, CLNT_CD
		, SELL_CLMN_DIV_CD
		, SELL_PMNT_MTD_CD
		, SELL_CLMN_DAY
		, TAX_BILG_NO
		, PRJCT_CD
		, ETRDPS_AMT
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
		, PRDT_GRP
	)
	VALUES
	(
		#{coCd}
		, #{etrdpsSeq}
		, (SELECT NVL(MAX(ETRDPS_DTL_SEQ), 0) + 1 FROM TB_AR05D02 WHERE ETRDPS_SEQ = #{etrdpsSeq})
		, #{bilgCertNo}
		, #{trstCertiNo}
		, TO_CHAR(SYSDATE, 'YYYYMMDD')
		, REPLACE(#{trstDt}, '-', '')
		, #{trstClntCd, jdbcType=VARCHAR}
		, #{clmnDivCd, jdbcType=VARCHAR}
		, #{pmntMtdCd, jdbcType=VARCHAR}
		, REPLACE(#{clmnDay}, '-', '')
		, #{taxBilgNo}
		, #{prjctCd, jdbcType=VARCHAR}
		, #{etrdpsAmt, jdbcType=VARCHAR}
		, #{userId}
		, #{pgmId}
		, SYSDATE
		, NVL(#{prdtGrp}, 'PRDTGRP1')
	)
	</insert>
	
	<insert id="insertAdvPay" parameterType="Map">
	INSERT INTO TB_AR05D02
	(
		CO_CD
		, ETRDPS_SEQ
		, ETRDPS_DTL_SEQ
		, BILG_CERT_NO
		, TRST_CERTI_NO
		, ETRDPS_DT
		, TRST_DT
		, CLNT_CD
		, SELL_CLMN_DIV_CD
		, SELL_PMNT_MTD_CD
		, SELL_CLMN_DAY
		, TAX_BILG_NO
		, PRJCT_CD
		, ETRDPS_AMT
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
		, PRDT_GRP
	)
	VALUES
	(
		#{coCd}
		, #{etrdpsSeq}
		, (SELECT NVL(MAX(ETRDPS_DTL_SEQ), 0) + 1 FROM TB_AR05D02 WHERE ETRDPS_SEQ = #{etrdpsSeq})
		, '0'
		, '0'
		, TO_CHAR(SYSDATE, 'YYYYMMDD')
		, NULL
		, #{clntCd}
		, #{clmnDivCd, jdbcType=VARCHAR}
		, #{pmntMtdCd, jdbcType=VARCHAR}
		, REPLACE(#{clmnDay, jdbcType=VARCHAR}, '-', '')
		, '0'
		, #{prjctCd, jdbcType=VARCHAR}
		, #{diffAmt}
		, #{userId}
		, #{pgmId}
		, SYSDATE
		, NVL(#{prdtGrp, jdbcType=VARCHAR}, 'PRDTGRP1')
	)
	</insert>
	
	<update id="updateEtrdpsDtlDelete" parameterType="Map">
	UPDATE TB_AR02M01
	   SET ETRDPS_YN = 'N'
	     , ETRDPS_AMT = 0
	 WHERE TRST_CERTI_NO IN (SELECT TRST_CERTI_NO FROM TB_AR05D02 WHERE ETRDPS_SEQ = #{etrdpsSeq})
	</update>
	
	<delete id="deleteEtrdpsDtl" parameterType="Map">
	DELETE FROM TB_AR05D02
	 WHERE ETRDPS_SEQ = #{etrdpsSeq}
	</delete>
	
</mapper>
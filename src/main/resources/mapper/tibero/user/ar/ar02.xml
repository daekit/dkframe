<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.ar.ar02.mapper.AR02Mapper">

	<insert id="insertPchsSell" parameterType="Map">
		<selectKey keyProperty="trstCertiNo" resultType="String" order="BEFORE">
			SELECT TB_AR02M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_AR02M01 
		(
			CO_CD,
			TRST_CERTI_NO,
			SELPCH_CD,
			TAXIVC_COPRT,
			TRST_DT,
			TRST_CLNT_CD,
			TRST_PRDT_CD,
			OWNER_CD,
			IMP_YN,
			TYP_CD,
			TRSP_TYP_CD,
			TRST_RPRC_SEQ,
			TRST_DTL_SEQ,
			<if test="prdtLen != null and !prdtLen.equals('')">
				PRDT_LEN,
			</if>
			ODR_NO,
			SALES_MNG,
			PRJCT_CD,
			MAKR_CD,
			WH_CD,
			MNG_TEL,
			DLVR_DTTM,
			DIRTRS_YN,
			<if test="prdtDiv != null and !prdtDiv.equals('')">
				PRDT_DIV,
			</if>
			<if test="prdtStkn != null and !prdtStkn.equals('')">
				PRDT_STKN,
			</if>
			<if test="prdtSize != null and !prdtSize.equals('')">
				PRDT_SIZE,
			</if>
			<if test="prdtUnit != null and !prdtUnit.equals('')">
				PRDT_UNIT,
			</if>
			<if test="prdtUpr != null and !prdtUpr.equals('')">
				PRDT_UPR,
			</if>
			STOCK_UPR,
			PCHS_UPR,
			SELL_UPR,
			TRST_QTY,
			TRST_WT,
			TRST_UPR,
			TRST_AMT,
			REAL_TRST_QTY,
			REAL_TRST_WT,
			REAL_TRST_UPR,
			REAL_TRST_AMT,
			BILG_QTY,
			BILG_WT,
			BILG_UPR,
			BILG_AMT,
			TRST_DC_AMT,
			ETC_AMT,
			TRSP_RMK,
			TRANS_AMT,
			SHIP_VEH_NO,
			CLNT_NM,
			BILG_CERT_NO,
			LOSS_RATE,
			ODR_CREAT_DIV,
			ETC_FIELD1,
			ETC_FIELD2,
			ETC_FIELD3,
			CREAT_ID,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM,
			UDT_DTTM 
		)
		VALUES 
		(
			#{coCd},
			#{trstCertiNo},
			#{selpchCd},
			NULL,
			TO_CHAR(SYSDATE, 'yyyyMMdd'),
			#{clntCd},
			<if test="prdtCd != null and !prdtCd.equals('')">
				#{prdtCd},
			</if>
			#{ownerCd},
			#{impYn},
			#{typCd},
			NULL,
			NULL,
			NULL,
			<if test="prdtLen != null and !prdtLen.equals('')">
				#{prdtLen},
			</if>
			NULL,
			#{salesMng},
			#{prjctCd},
			#{makrCd},
			#{whCd},
			#{mngTel},
			#{dlvrDttm},
			#{dirtrsYn},
			<if test="prdtDiv != null and !prdtDiv.equals('')">
				#{prdtDiv},
			</if>
			<if test="prdtStkn != null and !prdtStkn.equals('')">
				#{prdtStkn},
			</if>
			<if test="prdtSize != null and !prdtSize.equals('')">
				#{prdtSize},
			</if>
			<if test="prdtUnit != null and !prdtUnit.equals('')">
				#{prdtUnit},
			</if>
			<if test="prdtUpr != null and !prdtUpr.equals('')">
				#{prdtUpr},
			</if>
			NULL,
			#{pchsUpr},
			#{sellUpr},
			#{trstQty},
			#{trstWt},
			#{trstUpr},
			#{trstAmt},
			#{realTrstQty},
			#{realTrstWt},
			#{realTrstUpr},
			#{realTrstAmt},
			#{bilgQty},
			#{bilgWt},
			#{bilgUpr},
			#{bilgAmt},
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			#{userId},
			#{pgmId},
			SYSDATE,
			#{userId},
			#{pgmId},
			SYSDATE
		)
	</insert>
	
	<select id="selectSellCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM TB_AR02M01
	 	WHERE SELPCH_CD = #{selpchCd}
		<if test="coCd != null and !coCd.equals('')">
			AND CO_CD = #{coCd}				
		</if>
	 	<if test="reqDtFrom != null and !reqDtFrom.equals('')">
			AND TRST_DT BETWEEN #{reqDtFrom} AND #{reqDtTo}		
		</if>
	 	<if test="clntNm != null and !clntNm.equals('')">
			AND CLNT_NM = #{clntNm}				
		</if>
	 	<if test="prdtDiv != null and !prdtDiv.equals('')">
			AND PRDT_DIV = #{prdtDiv}				
		</if>
	 	<if test="estCoprt != null and !estCoprt.equals('')">
			AND TAXIVC_COPRT = #{estCoprt}				
		</if>
	 	<if test="dirtrsYn != null and !dirtrsYn.equals('')">
			AND DIRTRS_YN = #{dirtrsYn}				
		</if>
	 	<if test="typCd != null and !typCd.equals('')">
			AND TYP_CD = #{typCd}				
		</if>
		<if test="prjctCd != null and !prjctCd.equals('')">
			AND PRJCT_CD = #{prjctCd}				
		</if>
		<if test="pdsk != null and !pdsk.equals('')">
			AND PRDT_STKN = #{pdsk}				
		</if>
		<if test="bilgYn != null and bilgYn.equals('Y')">
			AND BILG_CERT_NO IS NOT NULL 		
		</if>
		<if test="bilgYn != null and bilgYn.equals('N')">
			AND BILG_CERT_NO IS NULL 		
		</if>
	</select>
	
	<select id="selectSellList" parameterType="Map" resultType="CamelMap">
		SELECT * FROM (
			SELECT 
				ROWNUM RNUM,
				CO_CD,
		        TRST_CERTI_NO,
		        SELPCH_CD,
		        FN_CM05M01_CD_TO_NM(SELPCH_CD) AS SELPCH_NM,
		        TAXIVC_COPRT,
		        FN_CM05M01_CD_TO_NM(TAXIVC_COPRT) AS TAXIVC_COPRT_NM,
		        TO_CHAR(TO_DATE(TRST_DT), 'YYYY-MM-DD') AS TRST_DT,
		        TRST_CLNT_CD,
		        TRST_PRDT_CD,
		        (SELECT PRDT_NM FROM TB_BM01M01 WHERE PRDT_CD = T.TRST_PRDT_CD) AS PRDT_NM,
		        OWNER_CD,
		        FN_CM05M01_CD_TO_NM(OWNER_CD) AS OWNER_NM,
		        IMP_YN,
		        TYP_CD,
		        FN_CM05M01_CD_TO_NM(TYP_CD) AS TYP_NM,
		        TRSP_TYP_CD,
		        TRST_RPRC_SEQ,
		        TRST_DTL_SEQ,
		        PRDT_LEN,
		        ODR_NO,
		        SALES_MNG,
		        PRJCT_CD,
		        (SELECT PRJCT_NM FROM TB_SD05M01 WHERE PRJCT_CD = T.PRJCT_CD) AS PRJCT_NM,
		        MAKR_CD,
		        FN_CM05M01_CD_TO_NM(MAKR_CD) AS MAKR_NM,
		        WH_CD,
		        FN_CM05M01_CD_TO_NM(WH_CD) AS WH_NM,
		        MNG_TEL,
		        TO_CHAR(DLVR_DTTM, 'YYYY-MM-DD') AS DLVR_DTTM,
		        DIRTRS_YN,
		        PRDT_DIV,
		        PRDT_STKN,
		        FN_CM05M01_CD_TO_NM(PRDT_STKN) AS PRDT_STKN_NM,
		        PRDT_SIZE,
		        NVL(FN_CM05M01_CD_TO_NM(PRDT_SIZE), PRDT_SIZE) AS PRDT_SIZE_NM,
		        PRDT_UNIT,
		        PRDT_UPR,
		        STOCK_UPR,
		        PCHS_UPR,
		        SELL_UPR,
		        TRST_QTY,
		        TRST_WT,
		        TRST_UPR,
		        TRST_AMT,
		        REAL_TRST_QTY,
		        REAL_TRST_WT,
		        REAL_TRST_UPR,
		        REAL_TRST_AMT,
		        BILG_QTY,
		        BILG_WT,
		        BILG_UPR,
		        BILG_AMT,
		        NVL(TRST_DC_AMT, '0') AS TRST_DC_AMT,
		        NVL(ETC_AMT, '0') AS ETC_AMT,
		        TRSP_RMK,
		        NVL(TRANS_AMT, '0') AS TRANS_AMT,
		        SHIP_VEH_NO,
		        CLNT_NM,
		        BILG_CERT_NO,
		        CASE WHEN BILG_CERT_NO IS NOT NULL THEN 'Y' ELSE 'N' END BILG_YN,
		        NVL(LOSS_RATE, '0') AS LOSS_RATE,
		        ODR_CREAT_DIV,
		        ETC_FIELD1,
		        ETC_FIELD2,
		        ETC_FIELD3,
		        CREAT_ID,
		        CREAT_PGM,
		        TO_CHAR(CREAT_DTTM, 'yyyy-MM-dd') AS CREAT_DTTM,
		        UDT_ID,
		        UDT_PGM,
		        TO_CHAR(UDT_DTTM, 'yyyy-MM-dd') AS UDT_DTTM,
		        SALES_AREA_CD
			FROM 
			(
			 	SELECT * FROM TB_AR02M01 T
			 	WHERE SELPCH_CD = #{selpchCd}
				<if test="coCd != null and !coCd.equals('')">
					AND CO_CD = #{coCd}				
				</if>
			 	<if test="reqDtFrom != null and !reqDtFrom.equals('')">
					AND TRST_DT BETWEEN #{reqDtFrom} AND #{reqDtTo}		
				</if>
			 	<if test="clntNm != null and !clntNm.equals('')">
					AND CLNT_NM = #{clntNm}				
				</if>
			 	<if test="prdtDiv != null and !prdtDiv.equals('')">
					AND PRDT_DIV = #{prdtDiv}				
				</if>
			 	<if test="estCoprt != null and !estCoprt.equals('')">
					AND TAXIVC_COPRT = #{estCoprt}				
				</if>
			 	<if test="dirtrsYn != null and !dirtrsYn.equals('')">
					AND DIRTRS_YN = #{dirtrsYn}				
				</if>
			 	<if test="typCd != null and !typCd.equals('')">
					AND TYP_CD = #{typCd}				
				</if>
				<if test="prjctCd != null and !prjctCd.equals('')">
					AND PRJCT_CD = #{prjctCd}				
				</if>
				<if test="pdsk != null and !pdsk.equals('')">
					AND PRDT_STKN = #{pdsk}				
				</if>
				<if test="bilgYn != null and bilgYn.equals('Y')">
					AND BILG_CERT_NO IS NOT NULL 		
				</if>
				<if test="bilgYn != null and bilgYn.equals('N')">
					AND BILG_CERT_NO IS NULL 		
				</if>
				ORDER BY UDT_DTTM DESC
			) T
		)
		WHERE RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
	<update id="updatePchsSell" parameterType="Map">
		UPDATE TB_AR02M01
		SET
<!-- 			CO_CD           = #{coCd}, -->
<!-- 	        TRST_CERTI_NO   = #{}, -->
<!-- 	        SELPCH_CD       = #{}, -->
<!-- 	        TAXIVC_COPRT    = #{}, -->
<!-- 	        TRST_DT         = #{}, -->
<!-- 	        TRST_CLNT_CD    = #{}, -->
<!-- 	        TRST_PRDT_CD    = #{}, -->
<!-- 	        OWNER_CD        = #{}, -->
<!-- 	        IMP_YN          = #{}, -->
<!-- 	        TYP_CD          = #{}, -->
<!-- 	        TRSP_TYP_CD     = #{}, -->
<!-- 	        TRST_RPRC_SEQ   = #{}, -->
<!-- 	        TRST_DTL_SEQ    = #{}, -->
<!-- 	        PRDT_LEN        = #{}, -->
<!-- 	        ODR_NO          = #{}, -->
<!-- 	        SALES_MNG       = #{}, -->
<!-- 	        PRJCT_CD        = #{}, -->
<!-- 	        MAKR_CD         = #{}, -->
<!-- 	        WH_CD           = #{}, -->
<!-- 	        MNG_TEL         = #{}, -->
<!-- 	        DLVR_DTTM       = #{}, -->
<!-- 	        DIRTRS_YN       = #{}, -->
<!-- 	        PRDT_DIV        = #{}, -->
<!-- 	        PRDT_STKN       = #{}, -->
<!-- 	        PRDT_SIZE       = #{}, -->
<!-- 	        PRDT_UNIT       = #{}, -->
<!-- 	        PRDT_UPR        = #{}, -->
<!-- 	        STOCK_UPR       = #{}, -->
<!-- 	        PCHS_UPR        = #{}, -->
<!-- 	        SELL_UPR        = #{}, -->
<!-- 	        TRST_QTY        = #{trstQty}, -->
<!-- 	        TRST_WT         = #{trstWt}, -->
<!-- 	        TRST_UPR        = #{trstUpr}, -->
<!-- 	        TRST_AMT        = #{trstAmt}, -->
<!-- 	        REAL_TRST_QTY   = #{realTrstQty}, -->
<!-- 	        REAL_TRST_WT    = #{realTrstWt}, -->
<!-- 	        REAL_TRST_UPR   = #{realTrstUpr}, -->
<!-- 	        REAL_TRST_AMT   = #{realTrstAmt}, -->
	        BILG_QTY        = #{bilgQty},
	        BILG_WT         = #{bilgWt},
	        BILG_UPR        = #{bilgUpr},
	        BILG_AMT        = #{bilgAmt},
	        TRST_DC_AMT     = #{trstDcAmt},
	        ETC_AMT         = #{etcAmt},
	        TRSP_RMK        = #{trspRmk},
	        TRANS_AMT       = #{transAmt},
	        <if test="shipVehNo != null and !shipVehNo.equals('')">
				SHIP_VEH_NO = #{shipVehNo},
			</if>
	        LOSS_RATE       = #{lossRate},
	        ODR_CREAT_DIV   = 'ERP',
	        UDT_ID          = #{userId},
	        UDT_PGM         = #{pgmId},
	        UDT_DTTM        = SYSDATE
<!-- 	        SALES_AREA_CD   = #{} -->
		WHERE TRST_CERTI_NO = #{trstCertiNo}
	</update>
	
	<delete id="deleteSell" parameterType="Map">
		DELETE FROM TB_AR02M01
		WHERE TRST_CERTI_NO = #{trstCertiNo}
	</delete>
	
</mapper>
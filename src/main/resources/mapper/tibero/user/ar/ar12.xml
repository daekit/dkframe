<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.ar.ar12.mapper.AR12Mapper">
	<select id="SelectPtnCreditCount" resultType="int">
		WITH T AS (
			SELECT
				CO_CD,
				CLNT_CD,
				CLNT_NM,
				TO_CHAR(TO_DATE(TRST_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS TRST_DT,
				FN_CM05M01_CD_TO_NM(SELPCH_CD) AS SELPCH_NM,
				RMK,
				TRST_SEQ,
				CREAT_ID AS ACC_NM,
				FN_CM05M01_CD_TO_NM(TAXIVC_COPRT_CD) AS TAXIVC_COPRT_NM,
				NVL(CASE SELPCH_CD WHEN 'SELPCH2' THEN BILG_TOT_AMT END, 0) AS SELL_AMT,
				NVL(CASE SELPCH_CD WHEN 'SELPCH1' THEN BILG_TOT_AMT END, 0) AS PCHS_AMT,
				PRDT_NM || ' ' || PRDT_SIZE || ' ' || SITE_NM AS TEXT
			FROM
				TB_AR10M01
									
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				AND TRST_DT >= #{trstDtFrom}
			</if>
			<if test="trstDtTo != null and !trstDtTo.equals('')">
				<![CDATA[ AND TRST_DT <= #{trstDtTo} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD = #{clntCd}
			</if>	
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND SELPCH_CD = #{selpchCd}
			</if>
			
			UNION ALL
			
			SELECT
				CO_CD,
				CLNT_CD,
				CLNT_NM,
				TO_CHAR(TO_DATE(ETRDPS_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS TRST_DT,
				FN_CM05M01_CD_TO_NM(DECODE(ETRDPS_TYP, 'ETRDPS01', 'SELPCH2', 'ETRDPS02', 'SELPCH1')) AS SELPCH_NM,
				SUMRY,
				ETRDPS_SEQ,
				ACC_NM,
				FN_CM05M01_CD_TO_NM(TAXIVC_COPRT_CD) AS TAXIVC_COPRT_NM,
				NVL(CASE ETRDPS_TYP WHEN 'ETRDPS02' THEN ETRDPS_AMT END, 0) AS SELL_AMT,
				NVL(CASE ETRDPS_TYP WHEN 'ETRDPS01' THEN ETRDPS_AMT END, 0) AS PCHS_AMT,
				SUMRY AS TEXT
			FROM
				TB_AR11M01 E
				
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				AND ETRDPS_DT >= #{trstDtFrom}
			</if>
			<if test="trstDtTo != null and !trstDtTo.equals('')">
				<![CDATA[ AND ETRDPS_DT <= #{trstDtTo} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD = #{clntCd}
			</if>				
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND DECODE(ETRDPS_TYP, 'ETRDPS01', 'SELPCH2', 'ETRDPS02', 'SELPCH1') = #{selpchCd}
			</if>
			
		)
		SELECT COUNT(*) FROM T
	</select>

	<select id="SelectPtnCreditList" resultType="CamelMap">
		WITH T AS (
			SELECT
				CO_CD,
				CLNT_CD,
				CLNT_NM,
				TO_CHAR(TO_DATE(TRST_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS TRST_DT,
				FN_CM05M01_CD_TO_NM(SELPCH_CD) AS SELPCH_NM,
				RMK,
				TRST_SEQ,
				'' AS ACC_NM,
				FN_CM05M01_CD_TO_NM(TAXIVC_COPRT_CD) AS TAXIVC_COPRT_NM,
				NVL(CASE SELPCH_CD WHEN 'SELPCH2' THEN BILG_TOT_AMT END, 0) AS SELL_AMT,
				NVL(CASE SELPCH_CD WHEN 'SELPCH1' THEN BILG_TOT_AMT END, 0) AS PCHS_AMT,
				PRDT_NM || ' ' || PRDT_SIZE || ' ' || SITE_NM AS TEXT
			FROM
				TB_AR10M01	
									
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				AND TRST_DT >= #{trstDtFrom}
			</if>
			<if test="trstDtTo != null and !trstDtTo.equals('')">
				<![CDATA[ AND TRST_DT <= #{trstDtTo} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD =  #{clntCd}
			</if>	
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND SELPCH_CD = #{selpchCd}
			</if>
			
			UNION ALL
			
			SELECT
				CO_CD,
				CLNT_CD,
				CLNT_NM,
				TO_CHAR(TO_DATE(ETRDPS_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS TRST_DT,
				FN_CM05M01_CD_TO_NM(DECODE(ETRDPS_TYP, 'ETRDPS01', 'SELPCH2', 'ETRDPS02', 'SELPCH1')) AS SELPCH_NM,
				SUMRY AS RMK,
				ETRDPS_SEQ AS TRST_SEQ,
				ACC_NM,
				FN_CM05M01_CD_TO_NM(TAXIVC_COPRT_CD) AS TAXIVC_COPRT_NM,
				NVL(CASE ETRDPS_TYP WHEN 'ETRDPS02' THEN ETRDPS_AMT END, 0) AS SELL_AMT,
				NVL(CASE ETRDPS_TYP WHEN 'ETRDPS01' THEN ETRDPS_AMT END, 0) AS PCHS_AMT,
				SUMRY AS TEXT
			FROM
				TB_AR11M01 E
				
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				AND ETRDPS_DT >= #{trstDtFrom}
			</if>
			<if test="trstDtTo != null and !trstDtTo.equals('')">
				<![CDATA[ AND ETRDPS_DT <= #{trstDtTo} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD = #{clntCd}
			</if>				
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND DECODE(ETRDPS_TYP, 'ETRDPS01', 'SELPCH2', 'ETRDPS02', 'SELPCH1') = #{selpchCd}
			</if>
			
		),
		C AS (
			SELECT
				CO_CD,
				SUM(NVL(CASE SELPCH_CD WHEN 'SELPCH2' THEN BILG_TOT_AMT END, 0)) AS SELL_AMT,
				SUM(NVL(CASE SELPCH_CD WHEN 'SELPCH1' THEN BILG_TOT_AMT END, 0)) AS PCHS_AMT
			FROM
				TB_AR10M01	
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				<![CDATA[ AND TRST_DT < #{trstDtFrom} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD = #{clntCd}
			</if>				
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND SELPCH_CD = #{selpchCd}
			</if>
			GROUP BY CO_CD
			
			
			UNION ALL
			
			SELECT
				CO_CD,
				SUM(NVL(CASE ETRDPS_TYP WHEN 'ETRDPS02' THEN ETRDPS_AMT END, 0)) AS SELL_AMT,
				SUM(NVL(CASE ETRDPS_TYP WHEN 'ETRDPS01' THEN ETRDPS_AMT END, 0)) AS PCHS_AMT
			FROM
				TB_AR11M01 E
			WHERE
				CO_CD = #{coCd}	
			<if test="trstDtFrom != null and !trstDtFrom.equals('')">
				<![CDATA[ AND ETRDPS_DT < #{trstDtFrom} ]]>
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD = #{clntCd}
			</if>				
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%'|| #{clntNm} || '%'
			</if>	
			<if test="taxivcCoprtCd != null and !taxivcCoprtCd.equals('')">
				AND TAXIVC_COPRT_CD = #{taxivcCoprtCd}
			</if>
			<if test="selpchCd != null and !selpchCd.equals('')">
				AND DECODE(ETRDPS_TYP, 'ETRDPS01', 'SELPCH2', 'ETRDPS02', 'SELPCH1') = #{selpchCd}
			</if>
			GROUP BY CO_CD
		)
		SELECT
			*
		FROM
		(
			SELECT
				A.*,
				ROWNUM AS RNUM
			FROM
			(
				SELECT
					*
				FROM
				(
					SELECT
						1 SEQ,
						H.*,
						SUM(SELL_AMT_CAL - PCHS_AMT) OVER(ORDER BY TRST_DT, TRST_SEQ) REMAIND_AMT
					FROM 
					(
						SELECT
							CO_CD,
							0 AS CLNT_CD,
							'' AS CLNT_NM,
							TO_CHAR(TO_DATE(#{trstDtFrom}, 'YYYYMMDD') -1, 'YYYY-MM-DD') AS TRST_DT,
							'이월' AS SELPCH_NM,
							'' AS RMK,
							0 AS TRST_SEQ,
							'' AS ACC_NM,
							'' AS TAXIVC_COPRT_NM,
							SUM(SELL_AMT) - SUM(PCHS_AMT) AS SELL_AMT_CAL,
							0 AS SELL_AMT,
							0 AS PCHS_AMT,
							'' AS TEXT
						FROM 
							C
						GROUP BY CO_CD
				
						UNION ALL
				
						SELECT
							CO_CD,
							CLNT_CD,
							CLNT_NM,
							TRST_DT,
							SELPCH_NM,
							RMK,
							TRST_SEQ,
							ACC_NM,
							TAXIVC_COPRT_NM,
							SELL_AMT,
							SELL_AMT,
							PCHS_AMT,
							TEXT
						FROM
							T
					) H
					
					<if test='dailySumYn != null and dailySumYn.equals("Y")'>
						UNION ALL
						
						SELECT
							2 SEQ,
							MAX(CO_CD),
							0,
							'일계',
							TRST_DT,
							'합계' xxx,
							'',
							999999999,
							'',
							'',
							0,
							SUM(SELL_AMT),
							SUM(PCHS_AMT),
							'',
							0
						FROM
							T
						GROUP BY
							TRST_DT
					</if>
					
					<if test='monthlySumYn != null and monthlySumYn.equals("Y")'>
						UNION ALL
						
						SELECT
							3 SEQ,
							MAX(CO_CD),
							0,
							'월계',
							TO_CHAR(TO_DATE(TRST_DT, 'YYYY-MM-DD'), 'YYYY-MM'),
							'합계' xxx,
							'',
							999999999,
							'',
							'',
							0,
							SUM(SELL_AMT),
							SUM(PCHS_AMT),
							'',
							0
						FROM
							T
						GROUP BY
							TO_CHAR(TO_DATE(TRST_DT, 'YYYY-MM-DD'), 'YYYY-MM')
					</if>	
				)
				ORDER BY 
					CO_CD,
					DECODE(LENGTH(TRST_DT), 10, TRST_DT, TO_CHAR(LAST_DAY(TO_DATE(TRST_DT, 'YYYY-MM')), 'YYYY-MM-DD')),
					TRST_SEQ,
					SEQ,
					CLNT_NM,
					CLNT_CD
			)A
		)
		WHERE RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
</mapper>
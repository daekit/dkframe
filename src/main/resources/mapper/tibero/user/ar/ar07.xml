<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.ar.ar07.mapper.AR07Mapper">
	
	<select id="selectMtClosCditCount" resultType="int">
	WITH AR05 AS (
	SELECT CO_CD
		 , SUBSTRING(ETRDPS_DT, 0, 6) ETRDPS_YM
		 , CLNT_CD
		 , SUM(ETRDPS_AMT) ETRDPS_AMT
	  FROM TB_AR05M01
	  <where>
	  <if test="coCd != null and !coCd.equals('')">
	  AND CO_CD = #{coCd}				
	  </if>	
	  <if test="closeYm != null and !closeYm.equals('')">
	  AND SUBSTRING(ETRDPS_DT, 0, 6) = REPLACE(#{closeYm}, '-', '')				
	  </if>
	  <if test="clntCd != null and !clntCd.equals('')">
	  AND CLNT_CD = #{clntCd}				
	  </if>
	  </where>
	  GROUP BY CO_CD, SUBSTRING(ETRDPS_DT, 0, 6), CLNT_CD
	),
	AR02 AS (
	SELECT CO_CD
		 , TRST_CLNT_CD CLNT_CD
		 , SUBSTRING(TRST_DT, 0, 6) TRST_YM
		 , SUM(NVL(BILG_AMT, 0 ) + NVL(BILG_VAT_AMT, 0)) BILG_AMT
	  FROM TB_AR02M01
	  WHERE SELPCH_CD = 'SELPCH2'
	  <if test="coCd != null and !coCd.equals('')">
	  AND CO_CD = #{coCd}				
	  </if>	
	  <if test="closeYm != null and !closeYm.equals('')">
	  AND SUBSTRING(TRST_DT, 0, 6) = REPLACE(#{closeYm}, '-', '')				
	  </if>
	  <if test="clntCd != null and !clntCd.equals('')">
	  AND TRST_CLNT_CD = #{clntCd}				
	  </if>
	  GROUP BY CO_CD, SUBSTRING(TRST_DT, 0, 6), TRST_CLNT_CD 
	),
	BM02D02 AS (
	SELECT CLNT_CD
		 , SUM(PLDG_AMT * PLDG_RCOGN_RATE /100) AS DEPOSIT 
		 FROM TB_BM02D02
		 WHERE USE_YN  = 'Y'
		   <if test="coCd != null and !coCd.equals('')">
		    AND CO_CD = #{coCd}				
		</if>
	    <if test="clntCd != null and !clntCd.equals('')">
	        AND CLNT_CD = #{clntCd}				
	    </if>
	GROUP BY CLNT_CD
	)
	SELECT COUNT(*)
		FROM
		(
			SELECT (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = TT.CO_CD) AS CO_NM,
				   SUBSTRING(ETRDPS_YM, 0, 4) || '-' || SUBSTRING(ETRDPS_YM, 5,2) CLOSE_YM,
				   (SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = TT.CLNT_CD) AS CLNT_NM,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN BASIS_AMT
				   		ELSE BFR_BASIS_AMT END BASIS_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN CLMN_AMT
				   		ELSE BFR_CLMN_AMT END CLMN_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN TOT_AMT
				   		ELSE BFR_TOT_AMT END TOT_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN BASIS_AMT + TOT_AMT - CLMN_AMT
				   		ELSE BFR_TRMEND_AMT END TRMEND_AMT,
				   ----NVL(T3.BASIS_CDTLN_AMT + T2.DEPOSIT, 0)  CRDT_LMT,  -- 그룹기본여신 + 담보금액 = 여신한도
				   F_CREDIT_LOAN('T',TT.CLNT_CD,TT.CO_CD,TO_CHAR(LAST_DAY(TO_DATE(REPLACE(#{closeYm},'-',''), 'YYYYMM')), 'YYYYMMDD'),0) AS CRDT_LMT,  -- 여신한도
				   F_CREDIT_LOAN('C',TT.CLNT_CD,TT.CO_CD,TO_CHAR(LAST_DAY(TO_DATE(REPLACE(#{closeYm},'-',''), 'YYYYMM')), 'YYYYMMDD'),0) AS CRDT_LOAN  	
			  FROM 
			  (SELECT T.CO_CD
			  		, T.ETRDPS_YM
			  		, T.CLNT_CD
			  		, SUM(BASIS_AMT) BASIS_AMT
			  		, SUM(CLMN_AMT) CLMN_AMT
			  		, SUM(TOT_AMT) TOT_AMT
			  		, SUM(BFR_BASIS_AMT) BFR_BASIS_AMT
			  		, SUM(BFR_CLMN_AMT) BFR_CLMN_AMT
			  		, SUM(BFR_TOT_AMT) BFR_TOT_AMT
			  		, SUM(BFR_TRMEND_AMT) BFR_TRMEND_AMT
			  		FROM
				  (SELECT CASE WHEN A.CO_CD IS NOT NULL THEN A.CO_CD
				  			   WHEN B.CO_CD IS NOT NULL THEN B.CO_CD
				  			   WHEN C.CO_CD IS NOT NULL THEN C.CO_CD END CO_CD,
					      CASE WHEN A.ETRDPS_YM IS NOT NULL THEN A.ETRDPS_YM
				  			   WHEN B.TRST_YM IS NOT NULL THEN B.TRST_YM
				  			   WHEN C.CLOSE_YM IS NOT NULL THEN CASE WHEN REPLACE(#{closeYm}, '-', '') = TO_CHAR(SYSDATE, 'YYYYMM') THEN TO_CHAR(ADD_MONTHS(TO_DATE(C.CLOSE_YM, 'YYYYMM'), +1), 'YYYYMM')
				  			   										 ELSE TO_CHAR(TO_DATE(C.CLOSE_YM, 'YYYYMM'), 'YYYYMM') END END ETRDPS_YM,
					      CASE WHEN A.CLNT_CD IS NOT NULL THEN A.CLNT_CD
				  			   WHEN B.CLNT_CD IS NOT NULL THEN B.CLNT_CD
				  			   WHEN C.CLNT_CD IS NOT NULL THEN C.CLNT_CD END CLNT_CD,
					      NVL(C.TRMEND_CREDIT_AMT, 0) BASIS_AMT,     --전월 기말잔액 (당월기초)
					      NVL(A.ETRDPS_AMT, 0)        CLMN_AMT,      -- 입금관리 당월 입금(당월수금)
					      NVL(B.BILG_AMT, 0)     TOT_AMT,       -- 매출거래내역 당월매출(당월매출)
					      NVL(C.BASIS_CREDIT_AMT, 0)  BFR_BASIS_AMT, -- 전월기초
					      NVL(C.CELL_CLMN_AMT, 0)     BFR_CLMN_AMT,  --전월수금
					      NVL(C.CELL_TOT_AMT, 0)      BFR_TOT_AMT,   --전월매출
					      NVL(C.TRMEND_CREDIT_AMT, 0) BFR_TRMEND_AMT --전월기말
				  	 FROM AR05 A
				  	 FULL OUTER JOIN AR02 B
				     	ON  A.CO_CD     = B.CO_CD
				     	AND A.ETRDPS_YM = B.TRST_YM
				     	AND A.CLNT_CD   = B.CLNT_CD
				     FULL OUTER JOIN TB_AR07M01 C
				       ON  A.CO_CD     = C.CO_CD
				       AND A.ETRDPS_YM = C.CLOSE_YM
				       AND A.CLNT_CD   = C.CLNT_CD
					<where>
					   <if test="closeYm != null and !closeYm.equals('')">
				       AND (SUBSTRING(C.CLOSE_YM , 0, 6) = 
				       CASE WHEN REPLACE(#{closeYm}, '-', '') = TO_CHAR(SYSDATE, 'YYYYMM') THEN TO_CHAR(ADD_MONTHS(TO_DATE(REPLACE(#{closeYm}, '-', ''), 'YYYYMM'), -1), 'YYYYMM')
				       		ELSE REPLACE(#{closeYm}, '-', '') END				       			
				       		 OR C.CLOSE_YM IS NULL)
					   </if>
					 </where>
				) T, BM02D02 T2,	TB_BM02M01 T3
					WHERE T.CLNT_CD = T2.CLNT_CD(+)
					  AND T2.CLNT_CD = T3.CLNT_CD(+)
				GROUP BY CO_CD, T.ETRDPS_YM, T.CLNT_CD
			)TT
		) A
	</select>
	
	<select id="selectMtClosCditList" resultType="CamelMap">
	WITH AR05 AS (
	SELECT CO_CD
		 , SUBSTRING(ETRDPS_DT, 0, 6) ETRDPS_YM
		 , CLNT_CD
		 , SUM(ETRDPS_AMT) ETRDPS_AMT
	  FROM TB_AR05M01
	  <where>
	  <if test="coCd != null and !coCd.equals('')">
	  AND CO_CD = #{coCd}				
	  </if>	
	  <if test="closeYm != null and !closeYm.equals('')">
	  AND SUBSTRING(ETRDPS_DT, 0, 6) = REPLACE(#{closeYm}, '-', '')				
	  </if>
	  <if test="clntCd != null and !clntCd.equals('')">
	  AND CLNT_CD = #{clntCd}				
	  </if>
	  </where>
	  GROUP BY CO_CD, SUBSTRING(ETRDPS_DT, 0, 6), CLNT_CD
	),
	AR02 AS (
	SELECT CO_CD
		 , TRST_CLNT_CD CLNT_CD
		 , SUBSTRING(TRST_DT, 0, 6) TRST_YM
		 , SUM(NVL(BILG_AMT, 0 ) + NVL(BILG_VAT_AMT, 0)) BILG_AMT
	  FROM TB_AR02M01
	  WHERE SELPCH_CD = 'SELPCH2'
	  <if test="coCd != null and !coCd.equals('')">
	  AND CO_CD = #{coCd}				
	  </if>	
	  <if test="closeYm != null and !closeYm.equals('')">
	  AND SUBSTRING(TRST_DT, 0, 6) = REPLACE(#{closeYm}, '-', '')				
	  </if>
	  <if test="clntCd != null and !clntCd.equals('')">
	  AND TRST_CLNT_CD = #{clntCd}				
	  </if>
	  GROUP BY CO_CD, SUBSTRING(TRST_DT, 0, 6), TRST_CLNT_CD 
	)
	SELECT
		*
	FROM
	(
		SELECT
			ROWNUM AS RNUM, A.*
			, (SELECT SUM(BASIS_CREDIT_AMT)  FROM TB_AR07M01 A3 WHERE A3.CO_CD = A.CO_CD AND A3.CLOSE_YM  = TO_CHAR(ADD_MONTHS(TO_DATE(A.ETRDPS_YM,'YYYYMM'),-2),'YYYYMM') AND A3.CLNT_CD = A.CLNT_CD) AS BASIS_CREDIT_AMT  
			, (SELECT SUM(TRMEND_CREDIT_AMT) FROM TB_AR07M01 A2 WHERE A2.CO_CD = A.CO_CD AND A2.CLOSE_YM  = TO_CHAR(ADD_MONTHS(TO_DATE(A.ETRDPS_YM,'YYYYMM'),-2),'YYYYMM') AND A2.CLNT_CD = A.CLNT_CD) AS CLOSE_YM2
			, (SELECT SUM(TRMEND_CREDIT_AMT) FROM TB_AR07M01 A1 WHERE A1.CO_CD = A.CO_CD AND A1.CLOSE_YM  = TO_CHAR(ADD_MONTHS(TO_DATE(A.ETRDPS_YM,'YYYYMM'),-1),'YYYYMM') AND A1.CLNT_CD = A.CLNT_CD) AS CLOSE_YM1
		FROM
		(
			SELECT TT.CO_CD,
			       (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = TT.CO_CD) AS CO_NM,
			       ETRDPS_YM,
				   SUBSTRING(ETRDPS_YM, 0, 4) || '-' || SUBSTRING(ETRDPS_YM, 5,2) CLOSE_YM,
				   TT.CLNT_CD,
				   (SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = TT.CLNT_CD) AS CLNT_NM,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN BASIS_AMT
				   		ELSE BFR_BASIS_AMT END BASIS_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN CLMN_AMT
				   		ELSE BFR_CLMN_AMT END CLMN_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN TOT_AMT
				   		ELSE BFR_TOT_AMT END TOT_AMT,
				   CASE WHEN ETRDPS_YM = TO_CHAR(SYSDATE, 'YYYYMM') THEN BASIS_AMT + TOT_AMT - CLMN_AMT
				   		ELSE BFR_TRMEND_AMT END TRMEND_AMT,
				   ----NVL(T3.BASIS_CDTLN_AMT + T2.DEPOSIT, 0)  CRDT_LMT,  -- 그룹기본여신 + 담보금액 = 여신한도
				   F_CREDIT_LOAN('T',TT.CLNT_CD,TT.CO_CD,TO_CHAR(LAST_DAY(TO_DATE(REPLACE(#{closeYm},'-',''), 'YYYYMM')), 'YYYYMMDD'),0) AS CRDT_LMT,  -- 여신한도
				   F_CREDIT_LOAN('C',TT.CLNT_CD,TT.CO_CD,TO_CHAR(LAST_DAY(TO_DATE(REPLACE(#{closeYm},'-',''), 'YYYYMM')), 'YYYYMMDD'),0) AS CRDT_LOAN  	
			  FROM 
			  (SELECT T.CO_CD
			  		, T.ETRDPS_YM
			  		, T.CLNT_CD
			  		, SUM(BASIS_AMT) BASIS_AMT
			  		, SUM(CLMN_AMT) CLMN_AMT
			  		, SUM(TOT_AMT) TOT_AMT
			  		, SUM(BFR_BASIS_AMT) BFR_BASIS_AMT
			  		, SUM(BFR_CLMN_AMT) BFR_CLMN_AMT
			  		, SUM(BFR_TOT_AMT) BFR_TOT_AMT
			  		, SUM(BFR_TRMEND_AMT) BFR_TRMEND_AMT
			  		FROM
				  (SELECT CASE WHEN A.CO_CD IS NOT NULL THEN A.CO_CD
				  			   WHEN B.CO_CD IS NOT NULL THEN B.CO_CD
				  			   WHEN C.CO_CD IS NOT NULL THEN C.CO_CD END CO_CD,
					      CASE WHEN A.ETRDPS_YM IS NOT NULL THEN A.ETRDPS_YM
				  			   WHEN B.TRST_YM IS NOT NULL THEN B.TRST_YM
				  			   WHEN C.CLOSE_YM IS NOT NULL THEN CASE WHEN REPLACE(#{closeYm}, '-', '') = TO_CHAR(SYSDATE, 'YYYYMM') THEN TO_CHAR(ADD_MONTHS(TO_DATE(C.CLOSE_YM, 'YYYYMM'), +1), 'YYYYMM')
				  			   										 ELSE TO_CHAR(TO_DATE(C.CLOSE_YM, 'YYYYMM'), 'YYYYMM') END END ETRDPS_YM,
					      CASE WHEN A.CLNT_CD IS NOT NULL THEN A.CLNT_CD
				  			   WHEN B.CLNT_CD IS NOT NULL THEN B.CLNT_CD
				  			   WHEN C.CLNT_CD IS NOT NULL THEN C.CLNT_CD END CLNT_CD,
					      NVL(C.TRMEND_CREDIT_AMT, 0) BASIS_AMT,     --전월 기말잔액 (당월기초)
					      NVL(A.ETRDPS_AMT, 0)        CLMN_AMT,      -- 입금관리 당월 입금(당월수금)
					      NVL(B.BILG_AMT, 0)     TOT_AMT,       -- 매출거래내역 당월매출(당월매출)
					      NVL(C.BASIS_CREDIT_AMT, 0)  BFR_BASIS_AMT, -- 전월기초
					      NVL(C.CELL_CLMN_AMT, 0)     BFR_CLMN_AMT,  --전월수금
					      NVL(C.CELL_TOT_AMT, 0)      BFR_TOT_AMT,   --전월매출
					      NVL(C.TRMEND_CREDIT_AMT, 0) BFR_TRMEND_AMT --전월기말
				  	 FROM AR05 A
				  	 FULL OUTER JOIN AR02 B
				     	ON  A.CO_CD     = B.CO_CD
				     	AND A.ETRDPS_YM = B.TRST_YM
				     	AND A.CLNT_CD   = B.CLNT_CD
				     FULL OUTER JOIN TB_AR07M01 C
				       ON  A.CO_CD     = C.CO_CD
				       AND A.ETRDPS_YM = C.CLOSE_YM
				       AND A.CLNT_CD   = C.CLNT_CD
					<where>
					   <if test="closeYm != null and !closeYm.equals('')">
				       AND (SUBSTRING(C.CLOSE_YM , 0, 6) = 
				       CASE WHEN REPLACE(#{closeYm}, '-', '') = TO_CHAR(SYSDATE, 'YYYYMM') THEN TO_CHAR(ADD_MONTHS(TO_DATE(REPLACE(#{closeYm}, '-', ''), 'YYYYMM'), -1), 'YYYYMM')
				       		ELSE REPLACE(#{closeYm}, '-', '') END				       			
				       		 OR C.CLOSE_YM IS NULL)
					   </if>
					 </where>
				) T,TB_BM02M01 T3
					WHERE T.CLNT_CD = T3.CLNT_CD(+)
				GROUP BY CO_CD, T.ETRDPS_YM, T.CLNT_CD
				ORDER BY T.CO_CD, T.CLNT_CD
			)TT
		) A
	)
	WHERE RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.pp.pp04.mapper.PP04Mapper">
	
	<select id="selectMesShipCount" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_AR02M01_MES A
		WHERE 1=1  
		<if test= "mesFtrCd != null and !mesFtrCd.equals('')">
		  AND A.MES_FTR_CD = #{mesFtrCd} 
		</if> 
		<if test= "cfYn != null and !cfYn.equals('')">
          AND A.CF_YN = #{cfYn}  
		</if>
		<if test= "coCd != null and !coCd.equals('')">
          AND A.CO_CD = #{coCd} 
		</if> 
		<if test= "selpchCd != null and !selpchCd.equals('')">
          AND A.SELPCH_CD = #{selpchCd}  
		</if>
		<if test= "taxivcCoprt != null and !taxivcCoprt.equals('')">
          AND A.TAXIVC_COPRT = #{taxivcCoprt} 
		</if> 
		<if test= "trstDt != null and !trstDt.equals('')">
          AND A.TRST_DT = #{trstDt}  
		</if>
		<if test= "trstClntCd != null and !trstClntCd.equals('')">
          AND A.TRST_CLNT_CD = #{trstClntCd}  
		</if>
		<if test= "trstPrdtCd != null and !trstPrdtCd.equals('')">
          AND A.TRST_PRDT_CD = #{trstPrdtCd} 
		</if> 
		<if test= "ownerCd != null and !ownerCd.equals('')">
          AND A.OWNER_CD = #{ownerCd}
		</if>  
		<if test= "impYn != null and !impYn.equals('')">
          AND A.IMP_YN = #{impYn}  
		</if>
		<if test= "typCd != null and !typCd.equals('')">
          AND A.TYP_CD = #{typCd} 
		</if> 
		<if test= "trspTypCd != null and !trspTypCd.equals('')">
          AND A.TRSP_TYP_CD = #{trspTypCd} 
		</if> 
		<if test= "trstRprcSeq != null and !trstRprcSeq.equals('')">
          AND A.TRST_RPRC_SEQ = #{trstRprcSeq}  
		</if>
		<if test= "trstDtlSeq != null and !trstDtlSeq.equals('')">
          AND A.TRST_DTL_SEQ = #{trstDtlSeq}
		</if>
		<if test= "prdtLen != null and !prdtLen.equals('')">
          AND A.PRDT_LEN = #{prdtLen} 
		</if> 
		<if test= "odrNo != null and !odrNo.equals('')">
          AND A.ODR_NO = #{odrNo}
		</if>  
		<if test= "salesMng != null and !salesMng.equals('')">
          AND A.SALES_MNG = #{salesMng} 
		</if> 
		<if test= "prjctCd != null and !prjctCd.equals('')">
          AND A.PRJCT_CD = #{prjctCd}
		</if>  
		<if test= "makrCd != null and !makrCd.equals('')">
          AND A.MAKR_CD = #{makrCd}
		</if>  
		<if test= "whCd != null and !whCd.equals('')">
          AND A.WH_CD = #{whCd}
		</if>
	</select>
	
	<select id="selectMesShipList" parameterType="Map" resultType="CamelMap">
		SELECT *
			FROM(
				SELECT
						ROWNUM AS RNUM, D.*
				FROM(		
				SELECT
					   A.MES_CERTI_NO
				     , A.MES_FTR_CD
				     , A.CF_YN
				     , A.CO_CD
				     , A.SELPCH_CD
				     , A.TAXIVC_COPRT
				     , A.TRST_DT
				     , A.TRST_CLNT_CD
				     , (SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = A.TRST_CLNT_CD) AS TRST_CLNT_NM
				     , A.TRST_PRDT_CD
					 , (SELECT PRDT_NM FROM TB_BM01M01 WHERE PRDT_CD = A.TRST_PRDT_CD) AS TRST_PRDT_NM
				     , A.OWNER_CD
					 , (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = A.OWNER_CD) AS OWNER_NM
				     , A.IMP_YN
				     , (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = A.IMP_YN) AS IMP_NM
				     , A.TYP_CD
				     , (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = A.TYP_CD) AS TYP_NM
				     , A.TRSP_TYP_CD
				     , A.TRST_RPRC_SEQ
				     , A.TRST_DTL_SEQ
				     , A.PRDT_LEN
				     , A.ODR_NO
				     , A.SALES_MNG
				     , A.PRJCT_CD
				     , (SELECT PRJCT_NM FROM TB_SD05M01 WHERE PRJCT_CD = A.PRJCT_CD) AS PRJCT_NM
				     , A.MAKR_CD
				     , (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = A.MAKR_CD) AS MAKR_NM
				     , A.WH_CD
					 , (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = A.WH_CD) AS WH_NM
				     , A.MNG_TEL
				     , A.DLVR_DTTM
				     , A.DIRTRS_YN
				     , A.PRDT_DIV
				     , A.PRDT_STKN
				     , A.PRDT_SIZE
				     , A.PRDT_UNIT
				     , A.PRDT_UPR
				     , A.STOCK_UPR
				     , A.PCHS_UPR
				     , A.SELL_UPR
				     , A.TRST_QTY
				     , A.TRST_WT
				     , A.TRST_UPR
				     , A.TRST_AMT
				     , A.REAL_TRST_QTY
				     , A.REAL_TRST_WT
				     , A.REAL_TRST_UPR
				     , A.REAL_TRST_AMT
				     , A.BILG_QTY
				     , A.BILG_WT
				     , A.BILG_UPR
				     , A.BILG_AMT
				     , A.TRST_DC_AMT
				     , A.ETC_AMT
				     , A.TRSP_RMK
				     , A.TRANS_AMT
				     , A.SHIP_VEH_NO
				     , A.CLNT_NM
				     , A.BILG_CERT_NO
				     , A.LOSS_RATE
				     , A.ODR_CREAT_DIV
				     , A.ETC_FIELD1
				     , A.ETC_FIELD2
				     , A.ETC_FIELD3
				     , A.CREAT_ID
				     , A.CREAT_PGM
				     , A.CREAT_DTTM
				     , A.UDT_ID
				     , A.UDT_PGM
				     , A.UDT_DTTM
				     , A.SALES_AREA_CD
				FROM TB_AR02M01_MES A
				WHERE 1=1
				<if test= "mesFtrCd != null and !mesFtrCd.equals('')">
				  AND A.MES_FTR_CD = #{mesFtrCd} 
				</if> 
				<if test= "cfYn != null and !cfYn.equals('')">
		          AND A.CF_YN = #{cfYn}  
				</if>
				<if test= "coCd != null and !coCd.equals('')">
		          AND A.CO_CD = #{coCd} 
				</if> 
				<if test= "selpchCd != null and !selpchCd.equals('')">
		          AND A.SELPCH_CD = #{selpchCd}  
				</if>
				<if test= "taxivcCoprt != null and !taxivcCoprt.equals('')">
		          AND A.TAXIVC_COPRT = #{taxivcCoprt} 
				</if> 
				<if test= "trstDt != null and !trstDt.equals('')">
		          AND A.TRST_DT = #{trstDt}  
				</if>
				<if test= "trstClntCd != null and !trstClntCd.equals('')">
		          AND A.TRST_CLNT_CD = #{trstClntCd}  
				</if>
				<if test= "trstPrdtCd != null and !trstPrdtCd.equals('')">
		          AND A.TRST_PRDT_CD = #{trstPrdtCd} 
				</if> 
				<if test= "ownerCd != null and !ownerCd.equals('')">
		          AND A.OWNER_CD = #{ownerCd}
				</if>  
				<if test= "impYn != null and !impYn.equals('')">
		          AND A.IMP_YN = #{impYn}  
				</if>
				<if test= "typCd != null and !typCd.equals('')">
		          AND A.TYP_CD = #{typCd} 
				</if> 
				<if test= "trspTypCd != null and !trspTypCd.equals('')">
		          AND A.TRSP_TYP_CD = #{trspTypCd} 
				</if> 
				<if test= "trstRprcSeq != null and !trstRprcSeq.equals('')">
		          AND A.TRST_RPRC_SEQ = #{trstRprcSeq}  
				</if>
				<if test= "trstDtlSeq != null and !trstDtlSeq.equals('')">
		          AND A.TRST_DTL_SEQ = #{trstDtlSeq}
				</if>
				<if test= "prdtLen != null and !prdtLen.equals('')">
		          AND A.PRDT_LEN = #{prdtLen} 
				</if> 
				<if test= "odrNo != null and !odrNo.equals('')">
		          AND A.ODR_NO = #{odrNo}
				</if>  
				<if test= "salesMng != null and !salesMng.equals('')">
		          AND A.SALES_MNG = #{salesMng} 
				</if> 
				<if test= "prjctCd != null and !prjctCd.equals('')">
		          AND A.PRJCT_CD = #{prjctCd}
				</if>  
				<if test= "makrCd != null and !makrCd.equals('')">
		          AND A.MAKR_CD = #{makrCd}
				</if>  
				<if test= "whCd != null and !whCd.equals('')">
		          AND A.WH_CD = #{whCd}
				</if>
			) D
		)
		WHERE
			RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>

	<update id="updatMesSHip" parameterType="Map">
		UPDATE TB_AR02M01_MES 
		   SET MES_FTR_CD    = #{mesFtrCd}
		     , CF_YN         = #{cfYn}
		     , CO_CD         = #{coCd}
		     , SELPCH_CD     = #{selpchCd}
		     , TAXIVC_COPRT  = #{taxivcCoprt}
		     , TRST_DT       = #{trstDt}
		     , TRST_CLNT_CD  = #{trstClntCd}
		     , TRST_PRDT_CD  = #{trstPrdtCd}
		     , OWNER_CD      = #{ownerCd}
		     , IMP_YN        = #{impYn}
		     , TYP_CD        = #{typCd}
		     , TRSP_TYP_CD   = #{trspTypCd}
		     , TRST_RPRC_SEQ = #{trstRprcSeq}
		     , TRST_DTL_SEQ  = #{trstDtlSeq}
		     , PRDT_LEN      = #{prdtLen}
		     , ODR_NO        = #{odrNo}
		     , SALES_MNG     = #{salesMng}
		     , PRJCT_CD      = #{prjctCd}
		     , MAKR_CD       = #{makrCd}
		     , WH_CD         = #{whCd}
		     , MNG_TEL       = #{mngTel}
		     , DLVR_DTTM     = #{dlvrDttm}
		     , DIRTRS_YN     = #{dirtrsYn}
		     , PRDT_DIV      = #{prdtDiv}
		     , PRDT_STKN     = #{prdtStkn}
		     , PRDT_SIZE     = #{prdtSize}
		     , PRDT_UNIT     = #{prdtUnit}
		     , PRDT_UPR      = #{prdtUpr}
		     , STOCK_UPR     = #{stockUpr}
		     , PCHS_UPR      = #{pchsUpr}
		     , SELL_UPR      = #{sellUpr}
		     , TRST_QTY      = #{trstQty}
		     , TRST_WT       = #{trstWt}
		     , TRST_UPR      = #{trstUpr}
		     , TRST_AMT      = #{trstAmt}
		     , REAL_TRST_QTY = #{realTrstQty}
		     , REAL_TRST_WT  = #{realTrstWt}
		     , REAL_TRST_UPR = #{realTrstUpr}
		     , REAL_TRST_AMT = #{realTrstAmt}
		     , BILG_QTY      = #{bilgQty}
		     , BILG_WT       = #{bilgWt}
		     , BILG_UPR      = #{bilgUpr}
		     , BILG_AMT      = #{bilgAmt}
		     , TRST_DC_AMT   = #{trstDcAmt}
		     , ETC_AMT       = #{etcAmt}
		     , TRSP_RMK      = #{trspRmk}
		     , TRANS_AMT     = #{transAmt}
		     , SHIP_VEH_NO   = #{shipVehNo}
		     , CLNT_NM       = #{clntNm}
		     , BILG_CERT_NO  = #{bilgCertNo}
		     , LOSS_RATE     = #{lossRate}
		     , ODR_CREAT_DIV = #{odrCreatDiv}
		     , UDT_ID        = #{udtId}
		     , UDT_PGM       = #{udtPgm}
		     , UDT_DTTM      = #{udtDttm}
		     , SALES_AREA_CD = #{salesAreaCd}
		 WHERE MES_CERTI_NO  = #{mesCertiNo}	
	</update>
	
	<delete id="deleteMesShip" parameterType="Map">
		 DELETE FROM TB_AR09M01_MES
		  WHERE MES_CERTI_NO = #{mesCertiNo}
	</delete>
	
	<insert id="insertMesShip">
<!-- 	   <selectKey keyProperty="mesCertiNo" resultType="mesCertiNo" order="BEFORE">
			SELECT TB_AR02M01_MES_SQ01.NEXTVAL FROM DUAL
		</selectKey>
 -->
 	INSERT INTO TB_AR02M01_MES
          ( MES_CERTI_NO
          , MES_FTR_CD
          , CF_YN
          , CO_CD
          , SELPCH_CD
          , TAXIVC_COPRT
          , TRST_DT
          , TRST_CLNT_CD
          , TRST_PRDT_CD
          , OWNER_CD
          , IMP_YN
          , TYP_CD
          , TRSP_TYP_CD
          , TRST_RPRC_SEQ
          , TRST_DTL_SEQ
          , PRDT_LEN
          , ODR_NO
          , SALES_MNG
          , PRJCT_CD
          , MAKR_CD
          , WH_CD
          , MNG_TEL
          , DLVR_DTTM
          , DIRTRS_YN
          , PRDT_DIV
          , PRDT_STKN
          , PRDT_SIZE
          , PRDT_UNIT
          , PRDT_UPR
          , STOCK_UPR
          , PCHS_UPR
          , SELL_UPR
          , TRST_QTY
          , TRST_WT
          , TRST_UPR
          , TRST_AMT
          , REAL_TRST_QTY
          , REAL_TRST_WT
          , REAL_TRST_UPR
          , REAL_TRST_AMT
          , BILG_QTY
          , BILG_WT
          , BILG_UPR
          , BILG_AMT
          , TRST_DC_AMT
          , ETC_AMT
          , TRSP_RMK
          , TRANS_AMT
          , SHIP_VEH_NO
          , CLNT_NM
          , BILG_CERT_NO
          , LOSS_RATE
          , ODR_CREAT_DIV
          , ETC_FIELD1
          , ETC_FIELD2
          , ETC_FIELD3
          , CREAT_ID
          , CREAT_PGM
          , CREAT_DTTM
          , UDT_ID
          , UDT_PGM
          , UDT_DTTM
          , SALES_AREA_CD
 ) VALUES ( #{mesCertiNo}
          , #{mesFtrCd}
          , #{cfYn}
          , #{coCd}
          , #{selpchCd}
          , #{taxivcCoprt}
          , #{trstDt}
          , #{trstClntCd}
          , #{trstPrdtCd}
          , #{ownerCd}
          , #{impYn}
          , #{typCd}
          , #{trspTypCd}
          , #{trstRprcSeq}
          , #{trstDtlSeq}
          , #{prdtLen}
          , #{odrNo}
          , #{salesMng}
          , #{prjctCd}
          , #{makrCd}
          , #{whCd}
          , #{mngTel}
          , #{dlvrDttm}
          , #{dirtrsYn}
          , #{prdtDiv}
          , #{prdtStkn}
          , #{prdtSize}
          , #{prdtUnit}
          , #{prdtUpr}
          , #{stockUpr}
          , #{pchsUpr}
          , #{sellUpr}
          , #{trstQty}
          , #{trstWt}
          , #{trstUpr}
          , #{trstAmt}
          , #{realTrstQty}
          , #{realTrstWt}
          , #{realTrstUpr}
          , #{realTrstAmt}
          , #{bilgQty}
          , #{bilgWt}
          , #{bilgUpr}
          , #{bilgAmt}
          , #{trstDcAmt}
          , #{etcAmt}
          , #{trspRmk}
          , #{transAmt}
          , #{shipVehNo}
          , #{clntNm}
          , #{bilgCertNo}
          , #{lossRate}
          , #{odrCreatDiv}
          , #{etcField1}
          , #{etcField2}
          , #{etcField3}
          , #{creatId}
          , #{creatPgm}
          , #{creatDttm}
          , #{udtId}
          , #{udtPgm}
          , #{udtDttm}
          , #{salesAreaCd}
          )
	</insert>

	<update id="updatMesSHipConfirm" parameterType="Map">
		UPDATE TB_AR09M01_MES
		   SET 
			 CF_YN		    = #{cfYn}
			,UDT_ID         = #{userId}
			,UDT_PGM        = #{pgmId}										
			,UDT_DTTM       = SYSDATE
		WHERE
			MES_CERTI_NO = #{mesCertiNo}
	</update>
	
	<select id="selectMesMtrlRstlCount" parameterType="Map" resultType="int">		
	         SELECT  COUNT(*)
	         FROM(		
		         SELECT WORKS_CD, FAC_CD, ALLOC_VEHL_NO, BASE_DD,
	                    MTRL_CHG_CAUSE_CD, SUP_CUST_CD, CUST_CD,
	                    VEHL_NO, 
	                    MTRL_CHG_CAUSE,
	                    ERP_TRANS_YN,
	                    (SELECT CUST_NM FROM KUMMUN.TB_MES_CUST_INFO WHERE WORKS_CD = A.WORKS_CD AND CUST_TP = '1' AND CUST_CD = A.CUST_CD) AS SITE_NM ,
	                    SUM(LOSS_MTRL_WGT) LOSS_MTRL_WGT,
	                    SUM( MTRL_WGT)MTRL_WGT
		         FROM  KUMMUN.TB_MES_MTRL_RSLT A
		         WHERE WORKS_CD = #{mesFtrCd}
	               AND BASE_DD  BETWEEN #{reqDtFrom}  and  #{reqDtTo}
	               AND MTRL_CHG_CAUSE_CD = '8'
	               <if test= "cfYn != null and !cfYn.equals('')">
	               AND ERP_TRANS_YN = #{cfYn}
	               </if>
	               AND ALLOC_VEHL_NO IS NOT NULL
	             GROUP BY WORKS_CD, FAC_CD, ALLOC_VEHL_NO,BASE_DD,
	                      MTRL_CHG_CAUSE_CD, SUP_CUST_CD, CUST_CD, VEHL_NO, 
	                      MTRL_CHG_CAUSE,ERP_TRANS_YN
            )  
	    <if test= "siteNm != null and !siteNm.equals('')">
         WHERE SITE_NM  LIKE '%${siteNm}%'
         </if>
	</select>

	<select id="selectMesMtrlRstlList" parameterType="Map" resultType="CamelMap">
	SELECT *
			FROM(
				SELECT
						ROWNUM AS RNUM, D.*
				FROM(		
	         SELECT WORKS_CD, FAC_CD, ALLOC_VEHL_NO, BASE_DD,
                    MTRL_CHG_CAUSE_CD, SUP_CUST_CD, CUST_CD,
                    VEHL_NO, 
                    MTRL_CHG_CAUSE,
                    ERP_TRANS_YN,
                    (SELECT CUST_NM FROM KUMMUN.TB_MES_CUST_INFO WHERE WORKS_CD = A.WORKS_CD AND CUST_TP = '1' AND CUST_CD = A.CUST_CD) AS SITE_NM ,
	                (SELECT CUST_NM FROM KUMMUN.TB_MES_CUST_INFO WHERE WORKS_CD = A.WORKS_CD AND CUST_TP = '3' AND CUST_CD = A.SUP_CUST_CD) AS SUP_CUST_NM,             
                    SUM(LOSS_MTRL_WGT) LOSS_MTRL_WGT,
                    SUM( MTRL_WGT)MTRL_WGT
	         FROM  KUMMUN.TB_MES_MTRL_RSLT A
	         WHERE WORKS_CD = #{mesFtrCd}
               AND BASE_DD  BETWEEN #{reqDtFrom}  and  #{reqDtTo}
               AND MTRL_CHG_CAUSE_CD = '8'
               <if test= "cfYn != null and !cfYn.equals('')">
               AND ERP_TRANS_YN = #{cfYn}
               </if>
               AND ALLOC_VEHL_NO IS NOT NULL
             GROUP BY WORKS_CD, FAC_CD, ALLOC_VEHL_NO,BASE_DD,
                      MTRL_CHG_CAUSE_CD, SUP_CUST_CD, CUST_CD, VEHL_NO, 
                      MTRL_CHG_CAUSE,ERP_TRANS_YN
         ) D
         <if test= "siteNm != null and !siteNm.equals('')">
         WHERE D.SITE_NM  LIKE '%${siteNm}%'
         </if>
		)
		WHERE
			RNUM BETWEEN ${firstIndex} AND ${lastIndex}    
	</select>
	<select id="selectMesAllocVehlDtlList" parameterType="Map" resultType="CamelMap">
		       SELECT  F.WORKS_CD, F.FAC_CD,
					   F.ALLOC_VEHL_NO, 
					   SUM(A.ORD_PACK_WGT) AS ORD_PACK_WGT, 
					   F.ISS_DD AS BASE_DD,
					   I.LOSS_RATE,
					   H.CUST_CD, 
					   H.CUST_NM, 
					   H.ORD_COMP_CD,
					   (SELECT CUST_NM FROM KUMMUN.TB_MES_CUST_INFO WHERE WORKS_CD = F.WORKS_CD AND FAC_CD = F.FAC_CD AND CUST_TP != '1' AND CUST_CD = H.ORD_COMP_CD) AS ORD_COMP_NM,
					   G.DIMS_CD,
					   E.ORD_NO,
					   G.ORD_LINE_NO,
					   D.REF_CD_2 AS PRODUCT_NAME_CD,
					   F.VEHL_NO,
					   (SELECT ODR_SEQ     FROM TB_SD04m01_MES WHERE MES_FTR_CD = F.WORKS_CD AND MES_ORD_NO = E.ORD_NO) AS ODR_SEQ,
                       (SELECT ODR_DTL_SEQ FROM TB_SD04D01_MES WHERE MES_FTR_CD = F.WORKS_CD AND MES_ORD_NO = E.ORD_NO AND MES_ORD_LINE_NO = MES_ORD_LINE_NO) AS ODR_DTL_SEQ
			FROM   KUMMUN.TB_MES_ORD_ITEM A
						JOIN KUMMUN.TB_MES_LOAD_ORG B   ON A.WORKS_CD = B.WORKS_CD AND A.FAC_CD = B.FAC_CD AND A.LOAD_ORG_NO = B.LOAD_ORG_NO
						JOIN KUMMUN.TB_MES_ALLOC_VEHL F ON B.WORKS_CD = F.WORKS_CD AND B.FAC_CD = F.FAC_CD AND B.ALLOC_VEHL_NO = F.ALLOC_VEHL_NO
						JOIN  ( SELECT MAX(EQP_CD) AS EQP_CD, TAG_NO, MAX(SCAN_NO) AS SCAN_NO, WORKS_CD, FAC_CD 
						          FROM KUMMUN.TB_MES_PROD_RSLT 
						          GROUP BY TAG_NO, WORKS_CD, FAC_CD
							  ) C ON A.WORKS_CD = C.WORKS_CD AND A.FAC_CD =C.FAC_CD AND A.TAG_NO = C.TAG_NO
						JOIN KUMMUN.TB_MES_CODE_DTL D  ON D.WORKS_CD = C.WORKS_CD AND D.FAC_CD = C.FAC_CD AND D.CD_TP   = 'EQP_CD'  AND D.CD_V = C.EQP_CD
						JOIN KUMMUN.TB_MES_ORD_DTL G   ON A.WORKS_CD = G.WORKS_CD AND A.FAC_CD = G.FAC_CD AND A.ORD_NO  = G.ORD_NO  AND A.ORD_LINE_NO = G.ORD_LINE_NO 
						JOIN KUMMUN.TB_MES_ORD_MST E   ON A.WORKS_CD = E.WORKS_CD AND A.FAC_CD = E.FAC_CD AND A.ORD_NO  = E.ORD_NO 
						JOIN KUMMUN.TB_MES_CUST_INFO H ON E.WORKS_CD = H.WORKS_CD AND E.FAC_CD = H.FAC_CD AND E.CUST_CD = H.CUST_CD
						LEFT OUTER JOIN KUMMUN.TB_MES_CUST_INFO_DTL I ON H.WORKS_CD = I.WORKS_CD AND H.FAC_CD = I.FAC_CD AND H.CUST_CD = I.CUST_CD AND G.DIMS_CD = I.DIMS_CD
			WHERE A.WORKS_CD      = #{worksCd}
			  AND F.ALLOC_VEHL_NO = #{allocVehlNo}
			  AND H.CUST_CD       = #{custCd}
			GROUP BY F.ALLOC_VEHL_NO, I.LOSS_RATE, H.CUST_CD, H.CUST_NM, H.ORD_COMP_CD, G.DIMS_CD,
			         E.ORD_NO,G.ORD_LINE_NO, D.REF_CD_2, F.WORKS_CD, F.FAC_CD, F.ISS_DD, F.VEHL_NO
			ORDER BY ORD_NO
	</select> 
	<update id="updateMesMtrlRslt" parameterType="Map">
		UPDATE KUMMUN.TB_MES_MTRL_RSLT
		   SET 
			 ERP_TRANS_YN   = 'Y'
		WHERE
			ALLOC_VEHL_NO = #{allocVehlNo}
	</update>
	<select id="selectErpMesShipList" parameterType="Map" resultType="CamelMap">
        SELECT SHIP.WORKS_CD,
               SHIP.FAC_CD,
			   SHIP.ALLOC_VEHL_NO, 
			   SHIP.ORD_PACK_WGT, 
			   SHIP.BASE_DD,
			   SHIP.LOSS_RATE,
			   SHIP.CUST_CD, 
			   SHIP.CUST_NM, 
			   SHIP.ORD_COMP_CD,
			   SHIP.ORD_COMP_NM,
			   SHIP.DIMS_CD,
			   SHIP.PRODUCT_NAME_CD,
			   SHIP.VEHL_NO,
			   SHIP.ODR_SEQ,
               SHIP.ODR_DTL_SEQ
               SD04M.CO_CD
               SD04M.REQ_DT
               SD04M.CLNT_CD
               SD04M.PRJCT_CD
               SD04M.MAKR_CD
               SD04M.TYP_CD
               SD04M.OWNER_CD
               SD04M.IMP_YN
               SD04M.WH_CD
               SD04M.MNG_TEL
               SD04M.DLVR_DTTM
               SD04M.ADDR_ZIP
               SD04M.ADDR_MAIN
               SD04M.ADDR_SUB
               SD04M.ODR_RMK
               SD04M.DIRTRS_YN
               SD04M.TOT_QTY
               SD04M.TOT_WT
               SD04M.TOT_AMT
               SD04M.SALES_MNG
               SD04M.ODR_CREAT_DIV
               SD04M.SITE_CD
               SD04D.PRDT_CD
               SD04D.PRDT_UNIT
               SD04D.PRDT_LEN
               SD04D.ODR_QTY
               SD04D.ODR_WT
               SD04D.ODR_UPR
               SD04D.ODR_AMT
               SD04D.PRDT_UPR
               SD04D.STOCK_UPR
               SD04D.PCHS_UPR
               SD04D.SELL_UPR
               SD04D.ODR_DTL_RMK
               SD04D.CLOSE_YN
               SD04D.CLOSE_ID
               SD04D.CLOSE_DTTM
         FROM 
            (
		       SELECT  F.WORKS_CD, F.FAC_CD,
					   F.ALLOC_VEHL_NO, 
					   SUM(A.ORD_PACK_WGT) AS ORD_PACK_WGT, 
					   F.ISS_DD AS BASE_DD,
					   I.LOSS_RATE,
					   H.CUST_CD, 
					   H.CUST_NM, 
					   H.ORD_COMP_CD,
					   (SELECT CUST_NM FROM KUMMUN.TB_MES_CUST_INFO WHERE WORKS_CD = F.WORKS_CD AND FAC_CD = F.FAC_CD AND CUST_TP != '1' AND CUST_CD = H.ORD_COMP_CD) AS ORD_COMP_NM,
					   G.DIMS_CD,
					   D.REF_CD_2 AS PRODUCT_NAME_CD,
					   F.VEHL_NO,
					   (SELECT ODR_SEQ     FROM TB_SD04m01_MES WHERE MES_FTR_CD = F.WORKS_CD AND MES_ORD_NO = E.ORD_NO) AS ODR_SEQ,
                       (SELECT ODR_DTL_SEQ FROM TB_SD04D01_MES WHERE MES_FTR_CD = F.WORKS_CD AND MES_ORD_NO = E.ORD_NO AND MES_ORD_LINE_NO = MES_ORD_LINE_NO) AS ODR_DTL_SEQ
			FROM   KUMMUN.TB_MES_ORD_ITEM A
						JOIN KUMMUN.TB_MES_LOAD_ORG B   ON A.WORKS_CD = B.WORKS_CD AND A.FAC_CD = B.FAC_CD AND A.LOAD_ORG_NO = B.LOAD_ORG_NO
						JOIN KUMMUN.TB_MES_ALLOC_VEHL F ON B.WORKS_CD = F.WORKS_CD AND B.FAC_CD = F.FAC_CD AND B.ALLOC_VEHL_NO = F.ALLOC_VEHL_NO
						JOIN  ( SELECT MAX(EQP_CD) AS EQP_CD, TAG_NO, MAX(SCAN_NO) AS SCAN_NO, WORKS_CD, FAC_CD 
						          FROM KUMMUN.TB_MES_PROD_RSLT 
						          GROUP BY TAG_NO, WORKS_CD, FAC_CD
							  ) C ON A.WORKS_CD = C.WORKS_CD AND A.FAC_CD =C.FAC_CD AND A.TAG_NO = C.TAG_NO
						JOIN KUMMUN.TB_MES_CODE_DTL D  ON D.WORKS_CD = C.WORKS_CD AND D.FAC_CD = C.FAC_CD AND D.CD_TP   = 'EQP_CD'  AND D.CD_V = C.EQP_CD
						JOIN KUMMUN.TB_MES_ORD_DTL G   ON A.WORKS_CD = G.WORKS_CD AND A.FAC_CD = G.FAC_CD AND A.ORD_NO  = G.ORD_NO  AND A.ORD_LINE_NO = G.ORD_LINE_NO 
						JOIN KUMMUN.TB_MES_ORD_MST E   ON A.WORKS_CD = E.WORKS_CD AND A.FAC_CD = E.FAC_CD AND A.ORD_NO  = E.ORD_NO 
						JOIN KUMMUN.TB_MES_CUST_INFO H ON E.WORKS_CD = H.WORKS_CD AND E.FAC_CD = H.FAC_CD AND E.CUST_CD = H.CUST_CD
						LEFT OUTER JOIN KUMMUN.TB_MES_CUST_INFO_DTL I ON H.WORKS_CD = I.WORKS_CD AND H.FAC_CD = I.FAC_CD AND H.CUST_CD = I.CUST_CD AND G.DIMS_CD = I.DIMS_CD
			WHERE A.WORKS_CD      = #{worksCd}
			  AND F.ALLOC_VEHL_NO = #{allocVehlNo}
			GROUP BY F.ALLOC_VEHL_NO, I.LOSS_RATE, H.CUST_CD, H.CUST_NM, H.ORD_COMP_CD, G.DIMS_CD,
			         E.ORD_NO,G.ORD_LINE_NO, D.REF_CD_2, F.WORKS_CD, F.FAC_CD, F.ISS_DD, F.VEHL_NO
			ORDER BY ORD_NO
	     ) SHIP
	     INNER JOIN TB_SD04M01 SD04M
	             ON  SD04M.ODR_SEQ     = SHIP.ODR_SEQ
         INNER JOIN TB_SD04D01 SD04D
                 ON SD04D.ODR_SEQ     = SD04M.ODR_SEQ
                AND SD04D.ODR_DTL_SEQ = SHIP.ODR_DTL_SEQ
	</select> 		
    
	
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sd.sd02.mapper.SD02Mapper">

	<select id="selectSellCount" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_SD01M01 
		WHERE 1=1
		<if test="coCd != null and !coCd.equals('')">
			AND CO_CD = #{coCd}
		</if>
		<if test="planYm != null and !planYm.equals('')">
			AND PLAN_YM = TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
		</if>
		<if test="planSalesId != null and !planSalesId.equals('')">
			AND PLAN_SALES_ID = #{planSalesId}
		</if>
		ORDER BY PLAN_SEQ
	</select>
	
	<select id="selectSellList" parameterType="Map" resultType="CamelMap">
		SELECT *
		FROM(
			SELECT
					ROWNUM AS RNUM, D.*
			FROM(
				WITH SD01 AS (
				   	 SELECT CO_CD
				       , CLNT_CD 
				       , TRIM(PRDT_DIV) PRDT_DIV
				       , NVL(SALES_AREA_CD, 'SALESAREA99') SALES_AREA_CD
				       , PLAN_YM
				       , SUM(PLAN_WT) PLAN_WT
				     FROM TB_SD01M01 S
				     WHERE 1=1
				      <if test="coCd != null and !coCd.equals('')">
				        AND CO_CD = #{coCd}
				      </if>
				      <if test="planYm != null and !planYm.equals('')">  
			            AND PLAN_YM = TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
			          </if>
			          <if test="planSalesId != null and !planSalesId.equals('')">
					    AND PLAN_SALES_ID = #{planSalesId}
					  </if>
			          GROUP BY CO_CD
				       , CLNT_CD 
				       , TRIM(PRDT_DIV)
				       , NVL(SALES_AREA_CD, 'SALESAREA99')
				       , PLAN_YM
				), AR02 AS (
				   SELECT CO_CD
				       , TRST_CLNT_CD
				       , TRIM(PRDT_DIV) PRDT_DIV 
				       , NVL(SALES_AREA_CD, 'SALESAREA99') SALES_AREA_CD 
				       , SUBSTRING(TRST_DT, 0, 6) TRST_DT
				       , SUM(DECODE(IMP_YN, 'Y', REAL_TRST_QTY)) TRST_Y
				       , SUM(DECODE(IMP_YN, 'N', REAL_TRST_QTY)) TRST_N
				     FROM TB_AR02M01
				    WHERE 1=1
				      <if test="coCd != null and !coCd.equals('')">
				        AND CO_CD = #{coCd}
				      </if>
				      <if test="planYm != null and !planYm.equals('')">  
			            AND SUBSTRING(TRST_DT, 0, 6) = TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
			          </if>
			          <if test="selpchCd != null and !selpchCd.equals('')">
			      	    AND SELPCH_CD = #{selpchCd}
			      	  </if>	
			      	   <if test="planSalesId != null and !planSalesId.equals('')">
					    AND SALES_MNG = #{planSalesId}
					  </if>
				   GROUP BY CO_CD, TRST_CLNT_CD, TRIM(PRDT_DIV) ,NVL(SALES_AREA_CD, 'SALESAREA99') , SUBSTRING(TRST_DT, 0, 6)
				)
				SELECT T1.CO_CD
					 , BM02.CLNT_DIV_CD
					 , T1.SALES_AREA_CD
					 , T1.PRDT_DIV
					 , T1.CLNT_CD
					 , FN_CM05M01_CD_TO_NM(T1.CO_CD) CO_NM
					 , FN_CM05M01_CD_TO_NM(BM02.CLNT_DIV_CD) CLNT_DIV_NM
					 , FN_CM05M01_CD_TO_NM(SALES_AREA_CD) SALES_AREA_NM
					 , FN_CM05M01_CD_TO_NM(T1.PRDT_DIV) PRDT_DIV_NM
					 , NVL(BM02.CLNT_NM, '기타') CLNT_NM
					 , T1.PLAN_WT
					 , T1.TRST_Y
					 , T1.TRST_N
					 , T1.TRST_RATE
				  FROM (
				SELECT CASE WHEN S.CO_CD IS NOT NULL THEN S.CO_CD
				         ELSE A.CO_CD END CO_CD
				    , CASE WHEN S.CLNT_CD IS NOT NULL THEN S.CLNT_CD
				          ELSE A.TRST_CLNT_CD END CLNT_CD
				    , CASE WHEN S.PRDT_DIV IS NOT NULL THEN S.PRDT_DIV
				          ELSE A.PRDT_DIV END PRDT_DIV
				    , CASE WHEN S.SALES_AREA_CD IS NULL THEN A.SALES_AREA_CD
				          ELSE S.SALES_AREA_CD END SALES_AREA_CD
				    , NVL(PLAN_WT,0) AS PLAN_WT
				    , NVL(TRST_Y,0) AS TRST_Y
				    , NVL(TRST_N,0) AS TRST_N
				    , CASE WHEN NVL(PLAN_WT,0) != 0 THEN ((NVL(TRST_N,0) + NVL(TRST_Y,0)) / NVL(PLAN_WT,0)) * 100 
				    		ELSE 0 END AS TRST_RATE
				  FROM SD01 S
				 FULL OUTER JOIN AR02 A
				 ON S.CO_CD = A.CO_CD
				 AND S.CLNT_CD = A.TRST_CLNT_CD
				 AND S.PRDT_DIV = A.PRDT_DIV
				 AND S.SALES_AREA_CD = A.SALES_AREA_CD
				 AND S.PLAN_YM = A.TRST_DT) T1
				 , TB_BM02M01 BM02
				 WHERE T1.CLNT_CD = BM02.CLNT_CD(+)
				 ORDER BY T1.CO_CD, BM02.CLNT_DIV_CD,SALES_AREA_CD, T1.PRDT_DIV, T1.CLNT_CD 
		    ) D
		)
		WHERE
			RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
	<select id="selectPlanInfo" parameterType="Map" resultType="camelMap">
		SELECT T.*,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.CO_CD) AS CO_NM,		
			(SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.CLNT_CD) AS CLNT_NM,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.PRDT_DIV) AS PRDT_NM,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.SALES_AREA_CD) AS SALES_AREA_NM,
			TO_CHAR(TO_DATE(PLAN_YM,'YYYYMM'),'YYYY-MM') as PLAN_YM2,
			PLAN_SALES_ID AS SALES_MNG_ID,
			C.NAME AS SALES_MNG_NM,
			PAN_DEPT_ID AS DEPT_ID,
			D.DEPT_NM AS DEPT_NM
		FROM TB_SD01M01 T
		INNER JOIN  TB_CM06M01 C
		   ON T.PLAN_SALES_ID = C.ID
		INNER JOIN  TB_CM04M01 D 
		   ON C.DEPT_ID = D.DEPT_ID
		LEFT OUTER JOIN TB_BM02M01 B
	       ON T.CLNT_CD = B.CLNT_CD
		WHERE 1=1
		  AND PLAN_SEQ = #{planSeq}
	</select>
	
	<insert id="insertPlan">
		<selectKey keyProperty="planSeq" resultType="String" order="BEFORE">
			SELECT TB_SD01M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_SD01M01 (
			 PLAN_SEQ
			,CO_CD
			,PLAN_YM
			,SELPCH_CD
			,PAN_DEPT_ID
			,PLAN_SALES_ID
			,CLNT_CD
			,SALES_AREA_CD
			,PRDT_DIV
			,PRDT_STKN
			,PLAN_WT
			,RMK
			,DRAW_DT
			,CREAT_ID
			,CREAT_PGM
			,CREAT_DTTM
		)VALUES(
			 #{planSeq}
			,#{coCd}
			,TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
			,#{selpchCd}
			,#{panDeptId}
			,#{planSalesId}
			,#{clntCd}
			,#{selesAreaCd}
			,#{prdtDiv}
			,#{prdtStkn}
			,#{planWt}
			,#{rmk}
			,TO_CHAR(TO_DATE(SYSDATE, 'YYYY-MM-DD'), 'YYYYMMDD')
			,#{userId}
			,#{pgmId}
			,SYSDATE
		)
	</insert>
	
	<update id="updatePlan">
		UPDATE TB_SD01M01 SET
			CLNT_CD = #{clntCd},
			SALES_AREA_CD = #{selesAreaCd},
			PRDT_DIV = #{prdtDiv},
			PRDT_STKN = #{prdtStkn},
			PLAN_WT = #{planWt},
			RMK = #{rmk},
			UDT_ID = #{userId},
			UDT_PGM = #{pgmId},
			UDT_DTTM = SYSDATE
		WHERE		
			 PLAN_SEQ = #{planSeq}
	</update>
	
	<insert id="copyInsert">
		INSERT INTO TB_SD01M01
		(
			PLAN_SEQ,
			CO_CD,
			SELPCH_CD,
			PRDT_DIV,
			ETC_FIELD1,
			UDT_DTTM,
			PLAN_YM,
			PAN_DEPT_ID,
			PLAN_SALES_ID,
			MAKR_CD,
			CLNT_CD,
			SALES_AREA_CD,
			PRDT_STKN,
			PLAN_WT,
			RMK,
			DRAW_DT,
			ETC_FIELD2,
			CREAT_ID,
			ETC_FIELD3,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM
		)
		SELECT 
			TB_SD01M01_SQ01.NEXTVAL,
			CO_CD,
			SELPCH_CD,
			PRDT_DIV,
			ETC_FIELD1,
			UDT_DTTM,
			TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM'),'YYYYMM'),
			PAN_DEPT_ID,
			PLAN_SALES_ID,
			MAKR_CD,
			CLNT_CD,
			SALES_AREA_CD,
			PRDT_STKN,
			PLAN_WT,
			RMK,
			DRAW_DT,
			ETC_FIELD2,
			CREAT_ID,
			ETC_FIELD3,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM from TB_SD01M01
		WHERE 
			PLAN_YM = TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM') + INTERVAL '-1' MONTH, 'YYYYMM')
	</insert>
	
	<delete id="deleteCopy">
		DELETE FROM TB_SD01M01
		WHERE PLAN_YM = TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM'),'YYYYMM')
	</delete>
	
	<delete id="deletePlan" parameterType="Map">
		DELETE FROM TB_SD01M01
		WHERE PLAN_SEQ = #{planSeq}
	</delete>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sd.sd05.mapper.SD05Mapper">

	<select id="selectProjectList" parameterType="Map" resultType="CamelMap">
		SELECT *
			FROM(
				SELECT
						ROWNUM AS RNUM, D.*,
						NVL(D.TOT_WT,0) - NVL(D.TOT_CELL,0) AS TOT_REM
				FROM(		
				SELECT
					 A.CO_CD
					,FN_CM05M01_CD_TO_NM(A.CO_CD) AS CO_NM					 
					,A.PRJCT_CD
					,A.PRJCT_NM
					,A.TNKEY_YN
					,A.CLNT_CD
					,B.CLNT_NM
					,A.MAKR_CD
					,FN_CM05M01_CD_TO_NM(A.MAKR_CD) AS MAKR_NM
					,A.PRJCT_ADDR_ZIP
					,A.PRJCT_ADDR
					,A.PRJCT_ADDR_SUB
					,A.PRJCT_MNG_NM
					,A.TEL_NO
					,A.LOSS_RATE
					,A.MNG_ID
					,C.NAME AS MNG_NM
					,TO_CHAR(TO_DATE(A.STRT_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS STRT_DT
					,TO_CHAR(TO_DATE(A.END_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS END_DT
					,A.TOT_WT
					,A.ODR_NO
					,A.ODR_DT
					,A.USE_YN
					,A.RMK
					,A.PRJCT_MES_CD
					,A.ETC_FIELD1
					,A.ETC_FIELD2
					,A.ETC_FIELD3
					,A.CREAT_PGM
					,TO_CHAR(A.CREAT_DTTM,'YYYY-MM-DD') AS CREAT_DTTM
					,A.CREAT_DTTM
					,A.UDT_ID
					,A.UDT_PGM
					,TO_CHAR(A.UDT_DTTM,'YYYY-MM-DD') AS UDT_DTTM
					,NVL((SELECT SUM(REAL_TRST_QTY) FROM TB_AR02M01 WHERE PRJCT_CD = A.PRJCT_CD),0) AS TOT_CELL
					,A.ORD_TYP
					,A.BILDNG_TYP
					,A.ENGRK_TYP
					,A.MAKR_MNG_NM
					,A.CLNT_EMAIL
					,A.CLNT_FAX_NO
					,A.PRCSN_UPR
					,A.DC_DIV
					,A.PRDT_UPR
					,A.CPLR_YN
					,A.PMNT_MTD_CD
					,A.SHOP_CLNT_CD
			        ,(SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = A.SHOP_CLNT_CD) AS SHOP_CLNT_NM
					,A.SHOP_UPR
					,A.CTRT_RMK
					,A.OUTORD_UPR
					,A.OUTORD_LOSS_RATE
					,A.OUTORD_MNG_NM
					,A.OUTORD_TEL_NO
					,A.OUTORD_FAX_NO
					,A.WH_CD
				FROM TB_SD05M01 A, TB_BM02M01 B, TB_CM06M01 C
				WHERE A.CLNT_CD = B.CLNT_CD(+)
				 AND  A.MNG_ID = C.ID(+)
				 AND  A.USE_YN = 'Y'
				<if test= "coCd != null and !coCd.equals('')">
		 			AND A.CO_CD = #{coCd}
				</if>
				<if test="strtDt != null and !strtDt.equals('') and endDt != null and !endDt.equals('')">
				 	AND (A.STRT_DT BETWEEN #{strtDt} AND #{endDt} OR A.END_DT BETWEEN #{strtDt} AND #{endDt})
				</if>
				<if test="searchValue != null and !searchValue.equals('') and searchType != null and !searchType.equals('')">
					AND ${searchType} LIKE '%${searchValue}%'
				</if>
				ORDER BY  A.STRT_DT DESC
			) D
		)
		WHERE
			RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
	<select id="selectPrjInfo" parameterType="Map" resultType="camelMap">
		SELECT T.*,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.MAKR_CD) AS MAKR_NM,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.CO_CD) AS CO_NM,		
			(SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.CLNT_CD) AS CLNT_NM,
			(SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.SHOP_CLNT_CD) AS SHOP_CLNT_NM,
			MNG_ID AS SALES_MNG,
			(SELECT NAME FROM TB_CM06M01 WHERE ID = T.MNG_ID) AS MNG_NM, 
			TO_CHAR(TO_DATE(STRT_DT,'YYYYMMDD'),'YYYY-MM-DD') as STRT_DT2,
			TO_CHAR(TO_DATE(END_DT,'YYYYMMDD'),'YYYY-MM-DD') as END_DT2,
			TO_CHAR(CREAT_DTTM,'YYYY-MM-DD') as CREAT_DTTM2 
		FROM TB_SD05M01 T
		WHERE PRJCT_CD = #{prjctCd}
	</select>
	
	<select id="selectOrdDetail" parameterType="Map" resultType="camelMap">
		SELECT TO_CHAR(TO_DATE(REQ_DT,'YYYYMMDD'),'YYYY-MM-DD') AS ORD_REQ_DT
			  ,B.CLNT_CD AS ORD_CLNT_CD
			  ,A.WH_CD AS ORD_WH_CD
			  ,ADDR_MAIN AS ORD_ADDR_MAIN
			  ,ADDR_SUB AS ORD_ADDR_SUB
			  ,CONCAT(CONCAT(B.ADDR_MAIN,' '),B.ADDR_SUB) AS ORD_ADDR
			  ,TO_CHAR(B.ORDRG_PROC_DTTM,'YYYY-MM-DD') AS ORD_ORDRG_PROC_DTTM
			  ,C.ORDRG_WT AS ORD_ORDRG_WT
			  ,C.REAL_DLVR_WT AS ORD_REAL_DLVR_WT
		FROM TB_SD05M01 A, TB_OD01M01 B, TB_OD01D01 C
		WHERE 1=1
		  AND A.PRJCT_CD = B.PRJCT_CD
		  AND B.ORDRG_SEQ = C.ORDRG_SEQ
		  AND B.PRJCT_CD = #{prjctCd}
	</select>
	
	<select id="selectShipmentDetail" parameterType="Map" resultType="camelMap">
		SELECT TO_CHAR(TO_DATE(REQ_DT,'YYYYMMDD'),'YYYY-MM-DD') AS SMT_REQ_DT
			  ,A.WH_CD AS SMT_WH_CD
			  ,ADDR_MAIN AS SMT_ADDR_MAIN
			  ,ADDR_SUB AS SMT_ADDR_SUB
			  ,CONCAT(CONCAT(B.ADDR_MAIN,' '),B.ADDR_SUB) AS SMT_ADDR
			  ,TO_CHAR(B.SHIP_DTTM,'YYYY-MM-DD') AS SMT_SHIP_DTTM
			  ,C.SHIP_WT AS SMT_SHIP_WT
			  ,C.REAL_SHIP_WT AS SMT_REAL_SHIP_WT
		FROM TB_SD05M01 A, TB_AR01M01 B, TB_AR01D01 C
		WHERE 1=1
		AND A.PRJCT_CD = B.PRJCT_CD
		AND B.SHIP_SEQ = C.SHIP_SEQ
		  AND B.PRJCT_CD = #{prjctCd}
	</select>
	
	<select id="selectProjectDtl" parameterType="Map" resultType="camelMap">
	SELECT CO_CD
		 , PRJCT_CD
		 , PRJCT_SEQ
		 , PRDT_DIV PRDT_DIV_CD
		 , PRDT_STKN PRDT_STKN_CD 
		 , SIZE_LIST PRDT_SIZE_NM
	  FROM TB_SD05D01
	 WHERE PRJCT_CD = #{prjctCd}
	</select>
	
	<select id="selectProjectClntList" parameterType="Map" resultType="CamelMap">
		SELECT CLNT_CD, CLNT_NM FROM TB_BM02M01 WHERE 1=1
		<if test="searchValue != null and !searchValue.equals('')">
			AND CLNT_CD LIKE '${searchValue}%'
			AND CLNT_NM LIKE '${searchType}%'
		</if>
	</select>
	
	<select id="selectProjectKeyList" parameterType="Map" resultType="CamelMap">
		SELECT * FROM TB_SD05M01 WHERE 1=1 AND PRJCT_CD = #{prjctCd}
	</select>
	
	<select id="selectProjectCount" parameterType="Map" resultType="int">
	 	SELECT 
	 		COUNT(*) 
	 	FROM TB_SD05M01 A, TB_BM02M01 B, TB_CM06M01 C
	 	WHERE 1=1
	 	AND A.CLNT_CD = B.CLNT_CD(+)
	 	AND A.USE_YN = 'Y'
		AND  A.MNG_ID = C.ID(+)
		<if test= "coCd != null and !coCd.equals('')">
 			AND A.CO_CD = #{coCd}
		</if>
		<if test="strtDt != null and !strtDt.equals('') and endDt != null and !endDt.equals('')">
		 	AND A.END_DT >= #{strtDt} AND A.STRT_DT <![CDATA[ <= ]]> #{endDt}
		</if>
		<if test="searchValue != null and !searchValue.equals('') and searchType != null and !searchType.equals('')">
			AND ${searchType} LIKE '%${searchValue}%'
		</if>
	</select>
	
	<update id="updateProject" parameterType="Map">
		UPDATE TB_SD05M01 
			SET 
			 COPRT_CD         = (SELECT CODE_ETC FROM TB_CM05M01 WHERE CODE_KIND = 'WH' AND CODE_ID = #{whCd} )
			, TNKEY_YN         = 'N'
			, CLNT_CD          = #{clntCd}
			, MAKR_CD          = #{makrCd}
			, PRJCT_NM         = #{prjctNm}
			, PRJCT_ADDR_ZIP   = #{prjctAddrZip}
			, PRJCT_ADDR       = #{prjctAddr}
			, PRJCT_ADDR_SUB   = #{prjctAddrSub}
			, PRJCT_MNG_NM     = #{prjctMngNm}
			, TEL_NO           = #{telNo}
			, LOSS_RATE        = #{lossRate}
			, STRT_DT          = REPLACE(#{strtDt}, '-', '')
			, END_DT           = REPLACE(#{endDt}, '-', '')
			, TOT_WT           = #{totWt}
			, MNG_ID           = #{mngId}
			, USE_YN           = #{useYn}
			, RMK              = #{rmk}
			, ORD_TYP          = #{ordTyp}                
			, BILDNG_TYP       = #{bildngTyp}             
			, ENGRK_TYP        = #{engrkTyp}              
			, MAKR_MNG_NM      = #{makrMngNm}             
			, CLNT_EMAIL       = #{clntEmail}             
			, CLNT_FAX_NO      = #{clntFaxNo}             
			, PRCSN_UPR        = #{prcsnUpr}              
			, DC_DIV           = #{dcDiv}                 
			, PRDT_UPR         = #{prdtUpr}               
			, CPLR_YN          = #{cplrYn}                
			, PMNT_MTD_CD      = #{pmntMtdCd}             
			, SHOP_CLNT_CD     = #{shopClntCd}            
			, SHOP_UPR         = #{shopUpr}               
			, CTRT_RMK         = #{ctrtRmk}               
			, OUTORD_UPR       = #{outordUpr}             
			, OUTORD_LOSS_RATE = #{outordLossRate}        
			, OUTORD_MNG_NM    = #{outordMngNm}           
			, OUTORD_TEL_NO    = #{outordTelNo} 
			, OUTORD_FAX_NO    = #{outordFaxNo}		
			, WH_CD            = #{whCd}             
			,UDT_ID         = #{userId}		 
			,UDT_PGM        = #{pgmId}							
			,UDT_DTTM       = SYSDATE		 
		WHERE 
			PRJCT_CD = #{prjctCd}
			AND CO_CD            = #{coCd}
	</update>
	
	<update id="updatePrjctDtl" parameterType="Map">
	UPDATE TB_SD05D01
	   SET PRDT_DIV = #{prdtDivCd}
		 , PRDT_STKN = #{prdtStknCd}
		 , SIZE_LIST = #{prdtSizeNm}
	 WHERE CO_CD = #{coCd}
	   AND PRJCT_CD = #{prjctCd}
	   AND PRJCT_SEQ = #{prjctSeq}
	</update>
	
	<delete id="deleteProjectDtl" parameterType="Map">
	DELETE FROM TB_SD05D01
	 WHERE CO_CD = #{coCd}
	   AND PRJCT_CD = #{prjctCd}
	</delete>
	
	<insert id="insertProject" parameterType="Map">
		<selectKey keyProperty="prjctCd" resultType="String" order="BEFORE">
			SELECT TO_CHAR(SYSDATE, 'YYYYMMDD')||LPAD(TB_SD05M01_SQ01.NEXTVAL,3,0) FROM DUAL
		</selectKey>
		INSERT INTO TB_SD05M01
		(CO_CD
		, PRJCT_CD
		, COPRT_CD
		, TNKEY_YN
		, CLNT_CD
		, MAKR_CD
		, PRJCT_NM
		, PRJCT_ADDR_ZIP
		, PRJCT_ADDR
		, PRJCT_ADDR_SUB
		, PRJCT_MNG_NM
		, TEL_NO
		, LOSS_RATE
		, STRT_DT
		, END_DT
		, TOT_WT
		, MNG_ID
		, USE_YN
		, RMK
		, CREAT_ID
		, CREAT_PGM
		, CREAT_DTTM
		, ORD_TYP
		, BILDNG_TYP
		, ENGRK_TYP
		, MAKR_MNG_NM
		, CLNT_EMAIL
		, CLNT_FAX_NO
		, PRCSN_UPR
		, DC_DIV
		, PRDT_UPR
		, CPLR_YN
		, PMNT_MTD_CD
		, SHOP_CLNT_CD
		, SHOP_UPR
		, CTRT_RMK
		, OUTORD_UPR
		, OUTORD_LOSS_RATE
		, OUTORD_MNG_NM
		, OUTORD_TEL_NO
		, OUTORD_FAX_NO
		, WH_CD)
		VALUES 
		(
		#{coCd}
		, #{prjctCd}
		, (SELECT CODE_ETC FROM TB_CM05M01 WHERE CODE_KIND = 'WH' AND CODE_ID = #{whCd} )
		, 'N'
		, #{clntCd}
		, #{makrCd}
		, #{prjctNm}
		, #{prjctAddrZip}
		, #{prjctAddr}
		, #{prjctAddrSub}
		, #{prjctMngNm}
		, #{telNo}
		, #{lossRate}
		, REPLACE(#{strtDt}, '-', '')
		, REPLACE(#{endDt}, '-', '')
		, #{totWt}
		, #{mngId}
		, #{useYn}
		, #{rmk}
		, #{userId}
		, #{pgmId}
		, SYSDATE
		, #{ordTyp}
		, #{bildngTyp}
		, #{engrkTyp}
		, #{makrMngNm}
		, #{clntEmail}
		, #{clntFaxNo}
		, #{prcsnUpr}
		, #{dcDiv}
		, #{prdtUpr}
		, #{cplrYn}
		, #{pmntMtdCd}
		, #{shopClntCd}
		, #{shopUpr}
		, #{ctrtRmk}
		, #{outordUpr}
		, #{outordLossRate}
		, #{outordMngNm}
		, #{outordTelNo}
		, #{outordFaxNo}
		, #{whCd}
		)
	</insert>
	
	<insert id="insertProjectDtl" parameterType="Map">
		<selectKey keyProperty="prjctSeq" resultType="String" order="BEFORE">
			SELECT TB_SD05M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_SD05D01
		(
			CO_CD
			, PRJCT_CD
			, PRJCT_SEQ
			, PRDT_DIV
			, PRDT_STKN
			, SIZE_LIST
			, CREAT_ID
			, CREAT_PGM
			, CREAT_DTTM
		)
		VALUES
		(
			#{coCd}
			, #{prjctCd}
			, #{prjctSeq}
			, #{prdtDivCd}
			, #{prdtStknCd}
			, #{prdtSizeNm}
			, #{userId}
			, #{pgmId}
			, SYSDATE
		)
	</insert>
	
	<select id="selectConfirmCount" parameterType="Map" resultType="int">
		SELECT COUNT(B.PRJCT_CD) + COUNT(C.PRJCT_CD) + COUNT(D.PRJCT_CD) + COUNT(E.PRJCT_CD) CNT 
		FROM TB_SD05M01 A,
			 TB_AR01M01 B, 
			 TB_AR03M01 C,
			 TB_OD01M01 D,
			 TB_SD04M01 E
		WHERE A.PRJCT_CD = B.PRJCT_CD(+)
		  AND A.PRJCT_CD = C.PRJCT_CD(+)
		  AND A.PRJCT_CD = D.PRJCT_CD(+)
		  AND A.PRJCT_CD = E.PRJCT_CD(+)
		  AND A.PRJCT_CD = #{prjctCd}
	</select>
	
	<update id="deleteProject" parameterType="Map">
		UPDATE TB_SD05M01 
		SET USE_YN = 'N'
		WHERE PRJCT_CD = #{prjctCd}
	</update>
	
	<select id="selectPrdtDivCd" parameterType="Map" resultType="camelMap">
	SELECT CODE_ID PRDT_DIV_CD, CODE_NM PRDT_DIV_NM
	  FROM TB_CM05M01
	 WHERE CODE_KIND = 'PRDTDIV'
	   AND USE_YN = 'Y'
	ORDER BY CODE_ID
	</select>
	
	<select id="prdtDivCombo" parameterType="Map" resultType="camelMap">
	SELECT FN_CM05M01_CD_TO_NM(PRDT_STKN) PRDT_STKN_NM , PRDT_STKN
	  FROM TB_BM01M01
	 WHERE PRDT_DIV = #{prdtDivCd}
	   AND PRDT_STKN IS NOT NULL
	GROUP BY PRDT_STKN
	</select>
	
	<select id="prdtSizeCombo" parameterType="Map" resultType="camelMap">
	SELECT PRDT_SIZE
	  FROM TB_BM01M01
	 WHERE PRDT_DIV = 'PRDTDIV11'
	 <if test= "prdtDivCd != null and !prdtDivCd.equals('')">
	 AND PRDT_DIV = #{prdtDivCd}
	 </if>
	 <if test= "prdtStkn != null and !prdtStkn.equals('')">
     PRDT_STKN = #{prdtStkn} 
	 </if>
	 AND PRDT_SIZE IS NOT NULL
	GROUP BY PRDT_SIZE
	ORDER BY PRDT_SIZE
	</select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sd.sd09.mapper.SD09Mapper">
	
	<select id="selectSiteCount" resultType="int">
	SELECT 
 		COUNT(*) 
	  FROM TB_SD09M01 SD09
	  LEFT OUTER JOIN TB_BM02M01 BM01 ON BM01.CLNT_CD = SD09.CLNT_CD  
	 	<where>
	 	<if test="coCd != null and coCd != ''">
	 	AND CO_CD = #{coCd}
	 	</if>
	 	<if test="clntCd != null and clntCd != ''">
	    AND CLNT_CD = #{clntCd}
	 	</if>
	 	<if test="siteNm != null and siteNm != ''">
	    AND SITE_NM = #{siteNm}
	 	</if>
	 	<if test="clntNm != null and clntNm != ''">
			AND  BM01.CLNT_NM like '%' || #{clntNm} ||'%'
		</if>
	 	</where>
	</select>
	
	<select id="selectSiteList" resultType="CamelMap">
		SELECT
			*
		FROM
		(
			SELECT
				ROWNUM AS RNUM, A.*
				, NAME AS SALES_EMP_NM
			FROM
			(
				SELECT T.CO_CD
					 , FN_CM05M01_CD_TO_NM(T.CO_CD) CO_NM
					 , T.SITE_CD
					 , T.CLNT_CD
					 , (SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.CLNT_CD) AS CLNT_NM
					 , T.PRJCT_CD
					 , (SELECT PRJCT_NM FROM TB_SD05M01 WHERE PRJCT_CD = T.PRJCT_CD) AS PRJCT_NM
					 , DECODE(NVL(T.PRJCT_CD,0),0,'N','Y') AS PRJCT_YN
					 , T.SITE_NM
					 , T.SITE_ADDR_ZIP
					 , T.SITE_ADDR
					 , T.SITE_ADDR_SUB
					 , T.SITE_ADDR || '  ' || T.SITE_ADDR_SUB AS ADDR_FULL 
					 , T.SITE_MNG_NM
					 , T.TEL_NO
					 , T.USE_YN
					 , T.RMK
					 , T.SITE_MES_CD
					 , FN_CM05M01_CD_TO_NM(T.SALES_AREA_CD) SALES_AREA_NM
					 , T.SALES_AREA_CD
					 , T.ETC_FIELD1
					 , T.ETC_FIELD2
					 , T.ETC_FIELD3
					 , FN_BM02_MNG_ID( T.CO_CD, T.CLNT_CD)  SALES_EMP_ID
					 , SD05.MAKR_CD
					 , FN_CM05M01_CD_TO_NM(SD05.MAKR_CD) MAKR_NM
					 , T.WH_CD
					 , FN_CM05M01_CD_TO_NM(T.WH_CD) WH_NM
					 , (SELECT CODE_ETC FROM TB_CM05M01 WHERE CODE_ID = T.WH_CD) AS TAXIVC_COPRT
					 , SD05.ORD_TYP
					 , T.MNG_ID
					 , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.MNG_ID) AS MNG_NM
				  FROM TB_SD09M01 T
				  LEFT OUTER JOIN TB_SD05M01 SD05
				        ON SD05.PRJCT_CD = T.PRJCT_CD
				 	<where>
				 	<if test="coCd != null and coCd != ''">
				 	AND T.CO_CD = #{coCd}
				 	</if>
				 	<if test="clntCd != null and clntCd != ''">
				    AND T.CLNT_CD = #{clntCd}
				 	</if>
				 	<if test="siteNm != null and siteNm != ''">
				    AND T.SITE_NM LIKE '%' || UPPER(#{siteNm}) || '%'
				 	</if>
				 	<if test="useYn != null and useYn != ''">
				    AND T.USE_YN = #{useYn}
				 	</if>
				 	<if test="salesAreaCd != null and salesAreaCd != ''">
				    AND T.SALES_AREA_CD = #{salesAreaCd}
				 	</if>
				 	</where>
				 ORDER BY T.SITE_CD DESC, T.CO_CD, T.CLNT_CD, T.SITE_NM
			) A			
				  LEFT OUTER JOIN TB_CM06M01 ON ID = SALES_EMP_ID
		   <where>
		   <if test="clntNm != null and clntNm != ''">
				    CLNT_NM like '%' || #{clntNm} ||'%'
			</if>
		   </where>
		)
		WHERE
				RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<select id="selectSiteDetail" resultType="CamelMap">
	SELECT T.*, NAME AS SALES_EMP_NM
	FROM (
		SELECT CO_CD
			 , FN_CM05M01_CD_TO_NM(CO_CD) CO_NM
			 , SITE_CD
			 , CLNT_CD
			 , (SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.CLNT_CD) AS CLNT_NM
			 , PRJCT_CD
			 , (SELECT PRJCT_NM FROM TB_SD05M01 WHERE PRJCT_CD = T.PRJCT_CD) AS PRJCT_NM
			 , SITE_NM
			 , SITE_ADDR_ZIP
			 , SITE_ADDR
			 , SITE_ADDR_SUB
			 , SITE_MNG_NM
			 , TEL_NO
			 , USE_YN
			 , RMK
			 , SITE_MES_CD
			 , FN_CM05M01_CD_TO_NM(SALES_AREA_CD) SALES_AREA_NM
			 , SALES_AREA_CD
			 , TO_CHAR(CREAT_DTTM, 'YYYY-MM-DD') CREAT_DTTM
			 , FN_BM02_MNG_ID( CO_CD, CLNT_CD)  SALES_EMP_ID
			 , T.WH_CD
			 , FN_CM05M01_CD_TO_NM(T.WH_CD) WH_NM	
			 , T.MNG_ID
			 , (SELECT NAME FROM TB_CM06M01 WHERE ID = T.MNG_ID) AS MNG_NM	
		  FROM TB_SD09M01 T
		 WHERE CO_CD = #{coCd}
		   AND SITE_CD = #{siteCd}) T
	  LEFT OUTER JOIN TB_CM06M01 ON ID = SALES_EMP_ID	   
	</select>
	
	<select id="selectSiteCd" parameterType="Map" resultType="String">
	SELECT NVL(MAX(SITE_CD), 0) + 1 FROM TB_SD09M01
	</select>
	
	<insert id="insertSite" parameterType="Map">
	INSERT INTO TB_SD09M01
	(CO_CD
	 , SITE_CD
	 , CLNT_CD
	 , PRJCT_CD
	 , SITE_NM
	 , SITE_ADDR_ZIP
	 , SITE_ADDR
	 , SITE_ADDR_SUB
	 , SITE_MNG_NM
	 , TEL_NO
	 , USE_YN
	 , RMK
	 , SALES_AREA_CD
	 , CREAT_ID
	 , CREAT_PGM
	 , CREAT_DTTM
	 , WH_CD
	 , MNG_ID
	 ) VALUES (
	 #{coCd}
	 , #{siteCd}
	 , #{clntCd}
	 , #{prjctCd}
	 , #{siteNm}
	 , #{siteAddrZip}
	 , #{siteAddr}
	 , #{siteAddrSub}
	 , #{siteMngNm}
	 , #{telNo}
	 , NVL(#{useYn}, 'Y')
	 , #{rmk}
	 , #{salesAreaCd}
	 , #{userId}
	 , #{pgmId} 
	 , SYSDATE
	 , #{whCd} 
	 , #{mngId}
	 )
	</insert>
	
	<update id="updateSite" parameterType="Map">
	UPDATE TB_SD09M01
	SET CLNT_CD       = #{clntCd}
	  , PRJCT_CD      = #{prjctCd}
	  , SITE_NM       = #{siteNm}
	  , SITE_ADDR_ZIP = #{siteAddrZip}
	  , SITE_ADDR     = #{siteAddr}
	  , SITE_ADDR_SUB = #{siteAddrSub}
	  , SITE_MNG_NM   = #{siteMngNm}
	  , TEL_NO        = #{telNo}
	  , USE_YN        = #{useYn}
	  , RMK           = #{rmk}
	  , SALES_AREA_CD = #{salesAreaCd}
	  , WH_CD         = #{whCd}
	  , MNG_ID        = #{mngId}
	  , UDT_ID        = #{userId}
	  , UDT_PGM       = #{pgmId}
	  , UDT_DTTM      = SYSDATE
	WHERE CO_CD = #{coCd}
	  AND SITE_CD = #{siteCd}
	</update>
	
	<delete id="deleteSite" parameterType="Map">
	DELETE FROM TB_SD09M01 
	 WHERE CO_CD = #{coCd}
	   AND SITE_CD = #{siteCd}
	</delete>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.user.sd.sd01.mapper.SD01Mapper">

	<select id="selectSellCount" parameterType="Map" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_SD01M01 
		WHERE 1=1
		<if test="coCd != null and !coCd.equals('')">
			AND CO_CD = #{coCd}
		</if>
		<if test="planYm != null and !planYm.equals('')">
			AND PLAN_YM = TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
		</if>
		<if test="planSalesId != null and !planSalesId.equals('')">
			AND PLAN_SALES_ID = #{planSalesId}
		</if>
		ORDER BY PLAN_SEQ
	</select>
	
	<select id="selectSellList" parameterType="Map" resultType="CamelMap">
		SELECT *
		FROM(
			SELECT
					ROWNUM AS RNUM, D.*
			FROM(
				SELECT
					T.PLAN_SEQ, 
				    T.CO_CD,
				    T.PLAN_YM,
				    T.SELPCH_CD,
				    T.PAN_DEPT_ID, 
				    T.PLAN_SALES_ID, 
				    T.MAKR_CD,
				    T.CLNT_CD, 
				    T.SALES_AREA_CD, 
				    T.PRDT_DIV,
				    T.PRDT_STKN, 
				    T.PLAN_WT,
				    T.RMK,
				    (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.SALES_AREA_CD) AS SALES_AREA_NM,
				    (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.PRDT_DIV) AS PRDT_DIV_NM,
				    (SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = B.CLNT_DIV_CD) AS CLNT_DIV_NM,
				    B.CLNT_DIV_CD,
				    B.CLNT_NM,
				    SUM(DECODE(IMP_YN,'Y',REAL_TRST_QTY)) AS TRST_Y,
				    SUM(DECODE(IMP_YN,'N',REAL_TRST_QTY)) AS TRST_N,
				    NVL(SUM(DECODE(IMP_YN,'Y',REAL_TRST_QTY, 'N', REAL_TRST_QTY)),0) AS TRST_AVG
				FROM TB_SD01M01 T
				LEFT OUTER JOIN TB_BM02M01 B
				    ON T.CLNT_CD = B.CLNT_CD
				LEFT OUTER JOIN TB_AR02M01 A
				    ON  T.CO_CD         = A.CO_CD
				    AND T.CLNT_CD       = A.TRST_CLNT_CD
				    AND T.PRDT_DIV      = A.PRDT_DIV
				    AND T.PLAN_SALES_ID = A.SALES_MNG
				    AND T.SELPCH_CD     = A.SELPCH_CD
				    AND A.TRST_CLNT_CD  = B.CLNT_CD 
				WHERE 1=1
				<if test="coCd != null and !coCd.equals('')">
					AND T.CO_CD = #{coCd}
				</if>
				<if test="planYm != null and !planYm.equals('')">
					AND PLAN_YM = TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
				</if>
				<if test="planSalesId != null and !planSalesId.equals('')">
					AND PLAN_SALES_ID = #{planSalesId}
				</if>
			  	GROUP BY PLAN_SEQ, T.CO_CD, PLAN_YM, T.SELPCH_CD, PAN_DEPT_ID, PLAN_SALES_ID, T.MAKR_CD, T.CLNT_CD, 
			     		 T.SALES_AREA_CD, T.PRDT_DIV, T.PRDT_STKN, PLAN_WT, RMK, B.CLNT_NM, B.CLNT_DIV_CD
		    ) D
		)
		WHERE
			RNUM BETWEEN ${firstIndex} AND ${lastIndex}
	</select>
	
	<select id="selectPlanInfo" parameterType="Map" resultType="camelMap">
		SELECT T.*,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.CO_CD) AS CO_NM,		
			(SELECT CLNT_NM FROM TB_BM02M01 WHERE CLNT_CD = T.CLNT_CD) AS CLNT_NM,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.PRDT_DIV) AS PRDT_NM,
			(SELECT CODE_NM FROM TB_CM05M01 WHERE CODE_ID = T.SALES_AREA_CD) AS SALES_AREA_NM,
			TO_CHAR(TO_DATE(PLAN_YM,'YYYYMM'),'YYYY-MM') as PLAN_YM2,
			C.NAME AS PLAN_SALES_NM,
			D.DEPT_NM AS PAN_DEPT_NM
		FROM TB_SD01M01 T
		INNER JOIN  TB_CM06M01 C
		   ON T.PLAN_SALES_ID = C.ID
		INNER JOIN  TB_CM04M01 D 
		   ON C.DEPT_ID = D.DEPT_ID
		LEFT OUTER JOIN TB_BM02M01 B
	       ON T.CLNT_CD = B.CLNT_CD
		WHERE 1=1
		  AND PLAN_SEQ = #{planSeq}
	</select>
	
	<insert id="insertPlan">
		<selectKey keyProperty="planSeq" resultType="String" order="BEFORE">
			SELECT TB_SD01M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_SD01M01 (
			 PLAN_SEQ
			,CO_CD
			,PLAN_YM
			,SELPCH_CD
			,PAN_DEPT_ID
			,PLAN_SALES_ID
			,CLNT_CD
			,SALES_AREA_CD
			,PRDT_DIV
			,PRDT_STKN
			,PLAN_WT
			,RMK
			,DRAW_DT
			,CREAT_ID
			,CREAT_PGM
			,CREAT_DTTM
		)VALUES(
			 #{planSeq}
			,#{coCd}
			,TO_CHAR(TO_DATE(#{planYm},'YYYY-MM'),'YYYYMM')
			,#{selpchCd}
			,#{panDeptId}
			,#{planSalesId}
			,#{clntCd}
			,#{selesAreaCd}
			,#{prdtDiv}
			,#{prdtStkn}
			,#{planWt}
			,#{rmk}
			,TO_CHAR(TO_DATE(SYSDATE, 'YYYY-MM-DD'), 'YYYYMMDD')
			,#{userId}
			,#{pgmId}
			,SYSDATE
		)
	</insert>
	
	<update id="updatePlan">
		UPDATE TB_SD01M01 SET
			CLNT_CD = #{clntCd},
			SALES_AREA_CD = #{selesAreaCd},
			PRDT_DIV = #{prdtDiv},
			PRDT_STKN = #{prdtStkn},
			PLAN_WT = #{planWt},
			RMK = #{rmk},
			UDT_ID = #{userId},
			UDT_PGM = #{pgmId},
			UDT_DTTM = SYSDATE
		WHERE		
			 PLAN_SEQ = #{planSeq}
	</update>
	
	<insert id="copyInsert">
		INSERT INTO TB_SD01M01
		(
			PLAN_SEQ,
			CO_CD,
			SELPCH_CD,
			PRDT_DIV,
			ETC_FIELD1,
			UDT_DTTM,
			PLAN_YM,
			PAN_DEPT_ID,
			PLAN_SALES_ID,
			MAKR_CD,
			CLNT_CD,
			SALES_AREA_CD,
			PRDT_STKN,
			PLAN_WT,
			RMK,
			DRAW_DT,
			ETC_FIELD2,
			CREAT_ID,
			ETC_FIELD3,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM
		)
		SELECT 
			TB_SD01M01_SQ01.NEXTVAL,
			CO_CD,
			SELPCH_CD,
			PRDT_DIV,
			ETC_FIELD1,
			UDT_DTTM,
			TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM'),'YYYYMM'),
			PAN_DEPT_ID,
			PLAN_SALES_ID,
			MAKR_CD,
			CLNT_CD,
			SALES_AREA_CD,
			PRDT_STKN,
			PLAN_WT,
			RMK,
			DRAW_DT,
			ETC_FIELD2,
			CREAT_ID,
			ETC_FIELD3,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM from TB_SD01M01
		WHERE 
			PLAN_YM = TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM') + INTERVAL '-1' MONTH, 'YYYYMM')
	</insert>
	
	<delete id="deleteCopy">
		DELETE FROM TB_SD01M01
		WHERE PLAN_YM = TO_CHAR(TO_DATE(#{planYm}, 'YYYY-MM'),'YYYYMM')
	</delete>
	
	<delete id="deletePlan" parameterType="Map">
		DELETE FROM TB_SD01M01
		WHERE PLAN_SEQ = #{planSeq}
	</delete>
</mapper>
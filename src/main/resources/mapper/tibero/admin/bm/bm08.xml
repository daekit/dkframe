<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.bm.bm08.mapper.BM08Mapper">
	
	<select id="selectClntPledgeCount" resultType="int">
		SELECT count(*)
		FROM ( 
			SELECT 
			    count(*)
	        FROM TB_BM02M01 A
				INNER JOIN TB_BM02D02 B
				             ON  A.CLNT_CD = B.CLNT_CD 
				             AND nvl(B.EXPRTN_DT,99999999) >= to_char(CURRENT_DATE,'yyyymmdd')
							<if test="coCd !=null and !coCd.equals('')">
							  AND B.CO_CD = #{coCd} 
							</if>
		  WHERE 1=1
				<if test="useYn != null and !useYn.equals('')">
				  AND A.USE_YN = #{useYn}
				</if>
				<if test="clntCdS != null and !clntCdS.equals('')">
				  AND A.CLNT_CD = #{clntCdS}
				</if>
				<if test="clntNm != null and !clntNm.equals('')">
				  AND A.CLNT_NM like '%${clntNm}%'
				</if>
				<if test="clntDivCd !=null and !clntDivCd.equals('')">
				  AND A.CLNT_DIV_CD = #{clntDivCd} 
				</if>
			GROUP BY a.LINK_GRP_CLNT_CD, b.CO_CD, a.CLNT_CD
			) AS a  
		
		
	</select>
	
	<select id="selectClntPledgeList" resultType="CamelMap">
		SELECT
			*
		FROM
		(
			SELECT
				ROWNUM AS RNUM, A.*
			FROM
			(
	
			SELECT 
				A.USE_YN,
				A.LINK_GRP_CLNT_CD,
				LINK_GRP_CLNT_NM,
				CO_CD, CO_NM,
				CLNT_CD,
				CLNT_NM,
				sum(BASIS_CDTLN_AMT) AS BASIS_CDTLN_AMT,
				SUM(PLDG03_AMT) AS PLDG03_AMT,
				SUM(CDTLN_AMT) AS CDTLN_AMT,
				MAX(LOAN_AMT) AS LOAN_AMT
			FROM (
					SELECT 
							A.USE_YN,
						    nvl(A.LINK_GRP_CLNT_CD, A.CLNT_CD) as LINK_GRP_CLNT_CD,	
		                    nvl2(A.LINK_GRP_CLNT_CD, (SELECT CLNT_NM FROM TB_BM02M01 C WHERE C.CLNT_CD = A.LINK_GRP_CLNT_CD), A.CLNT_NM ) AS LINK_GRP_CLNT_NM,	
							B.CO_CD,
							FN_CM05M01_CD_TO_NM(b.CO_CD) CO_NM,
							A.CLNT_CD,
							A.CLNT_NM,
							A.BASIS_CDTLN_AMT,
							decode(b.PLDG_DIV_CD,'PLDG03', decode(B.USE_YN,'N',0,(B.PLDG_AMT * B.PLDG_RCOGN_RATE / 100)),0) AS PLDG03_AMT,
							decode(b.PLDG_DIV_CD,'PLDG03',0,decode(B.USE_YN,'N',0,(B.PLDG_AMT * B.PLDG_RCOGN_RATE / 100))) AS CDTLN_AMT,
						    F_CREDIT_LOAN('C', A.CLNT_CD,B.CO_CD, to_char(CURRENT_DATE,'yyyymmdd'),0) AS LOAN_AMT
			        FROM TB_BM02M01 A
					INNER JOIN TB_BM02D02 B
					             ON  A.CLNT_CD = B.CLNT_CD 
					             AND nvl(B.EXPRTN_DT,99999999) >= to_char(CURRENT_DATE,'yyyymmdd')
					             <if test="coCd !=null and !coCd.equals('')">
				     	         AND B.CO_CD = #{coCd} 
					            </if>
					WHERE 1=1
					<if test="useYn != null and !useYn.equals('')">
					  AND A.USE_YN = #{useYn}
					</if>
					<if test="clntCdS != null and !clntCdS.equals('')">
					  AND A.CLNT_CD = #{clntCdS}
					</if>
					<if test="clntNm != null and !clntNm.equals('')">
					  AND A.CLNT_NM like '%${clntNm}%'
					</if>
					<if test="clntDivCd !=null and !clntDivCd.equals('')">
					  AND A.CLNT_DIV_CD = #{clntDivCd} 
					</if>
				) AS a
				GROUP BY a.LINK_GRP_CLNT_CD , LINK_GRP_CLNT_NM, CLNT_CD, CLNT_NM, CO_CD, CO_NM, USE_YN
			) A
		)
		WHERE
			RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>

	
	<select id="selectClntPledgeDetailCount" resultType="int">
		SELECT COUNT(*) 
		FROM TB_BM02M01 A
		LEFT OUTER JOIN TB_BM02D02 B
	            ON  A.CLNT_CD = B.CLNT_CD
		WHERE 1=1
		  AND B.CO_CD = #{coCd}
		  AND B.CLNT_CD = #{clntCd}
		<if test="useYn != null and !useYn.equals('')">
		  AND B.USE_YN = #{useYn}
		</if>
	</select>
	
	<select id="selectClntPledgeDetailList" resultType="CamelMap">
		SELECT
			*
		FROM
		(
			SELECT
				ROWNUM AS RNUM, A.*
			FROM
			(
				SELECT 
					B.USE_YN,
					B.CO_CD,
					FN_CM05M01_CD_TO_NM(CO_CD) CO_NM,
					A.CLNT_CD,
					A.CLNT_NM,
					A.BASIS_CDTLN_AMT,
					B.PLDG_AMT,
					B.PLDG_DIV_CD,
					FN_CM05M01_CD_TO_NM(PLDG_DIV_CD) PLDG_DIV_NM,
					B.PLDG_RCOGN_RATE,
					B.PLDG_RMK,
					B.PLDG_AMT * PLDG_RCOGN_RATE / 100 AS CDTLN_AMT,
					B.EXPRTN_DT,
					B.SETUP_DT
				FROM
				  	TB_BM02M01 A
				LEFT OUTER JOIN TB_BM02D02 B
				             ON  A.CLNT_CD = B.CLNT_CD
				WHERE 1=1
				  AND B.CO_CD = #{coCd}
				  AND B.CLNT_CD = #{clntCd}
				<if test="useYn != null and !useYn.equals('')">
				  AND B.USE_YN = #{useYn}
				</if>
			) A
			ORDER BY PLDG_DIV_CD , CLNT_CD ,CO_CD 
		)
		WHERE
			RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dksys.biz.admin.bm.bm02.mapper.BM02Mapper">
	
	<select id="selectClntCount" resultType="int">
		SELECT 
			COUNT(*)
		FROM
			TB_BM02M01
		<where>
			<choose>
				<when test="useYn != null and !useYn.equals('')">
					USE_YN = #{useYn}
				</when>
				<otherwise>
					USE_YN = 'Y'
				</otherwise>
			</choose>
			<if test="searchValue != null and !searchValue.equals('')">
				AND ${searchType} LIKE '%${searchValue}%'
			</if>
			<if test="clntDivCd !=null and !clntDivCd.equals('')">
				AND CLNT_DIV_CD = #{clntDivCd} 
			</if>
			<if test="clntCd != null and !clntCd.equals('')">
				AND CLNT_CD =  #{clntCd}
			</if>
			<if test="clntNm != null and !clntNm.equals('')">
				AND CLNT_NM LIKE '%${clntNm}%'
			</if>
		</where>
		ORDER BY CLNT_CD
	</select>
	
	<select id="selectClntList" resultType="CamelMap">
		SELECT
			*
		FROM
		(
			SELECT
				ROWNUM AS RNUM, A.*
			FROM
			(
				SELECT 
					A.CLNT_CD,
					A.CLNT_NM,
					A.CRN,
					A.COPRT_NO,
					FN_CM05M01_CD_TO_NM(A.CLNT_DIV_CD) CLNT_DIV_NM,
					A.BIZCON_NM,
					A.BSTY_NM,
					A.BIZ_TEL_NO,
					TO_CHAR(A.CREAT_DTTM, 'YYYY-MM-DD') AS CREAT_DTTM,
					TO_CHAR(A.UDT_DTTM, 'YYYY-MM-DD') AS UDT_DTTM,
					A.BASIS_CDTLN_AMT,
					(SELECT SUM(B.PLDG_AMT * PLDG_RCOGN_RATE / 100) FROM TB_BM02D02 B
					 WHERE B.CLNT_CD = A.CLNT_CD  
					      <if test="coCd != null and !coCd.equals('')">
					       AND B.CO_CD = #{coCd}
					       </if>
					 ) AS CDTLN_AMT,
					 LINK_GRP_YN,
                     LINK_GRP_CLNT_CD,
                     (SELECT CLNT_NM FROM TB_BM02M01 B WHERE B.CLNT_CD = A.CLNT_CD ) AS LINK_GRP_CLNT_NM					 
				FROM
					TB_BM02M01 A
				<where>
					<choose>
						<when test="useYn != null and !useYn.equals('')">
							A.USE_YN = #{useYn}
						</when>
						<otherwise>
							A.USE_YN = 'Y'
						</otherwise>
					</choose>
					<if test="searchValue != null and !searchValue.equals('')">
						AND ${searchType} LIKE '%${searchValue}%'
					</if>
					<if test="clntDivCd !=null and !clntDivCd.equals('')">
						AND A.CLNT_DIV_CD = #{clntDivCd} 
					</if>
					<if test="clntCd != null and !clntCd.equals('')">
						AND A.CLNT_CD =  #{clntCd}
					</if>
					<if test="clntNm != null and !clntNm.equals('')">
						AND A.CLNT_NM LIKE '%${clntNm}%'
					</if>
				</where>
				ORDER BY CLNT_CD
			) A
		)
		WHERE
			RNUM BETWEEN #{firstIndex} AND #{lastIndex}
	</select>
	
	<resultMap id="resultInfoMap" type="CamelMap">
		<collection select="selectClntFileList" property="CLNT_FILE_LIST" column="{fileTrgtKey=CLNT_CD}" ofType="CamelMap"/>
		<collection select="selectBizdeptList" property="BIZDEPT_LIST" column="{clntCd=CLNT_CD}" ofType="CamelMap"/>
		<collection select="selectPldgList" property="PLDG_LIST" column="{clntCd=CLNT_CD}" ofType="CamelMap"/>
	</resultMap>
	
	<select id="selectClntInfo" resultMap="resultInfoMap">
		SELECT
			CLNT_CD, CLNT_NM, CRN, COPRT_NO,
			CLNT_DIV_CD, REPST_NM,
			BIZCON_NM, BSTY_NM,
			BIZ_ZIP, BIZ_ADDR, BIZ_ADDR_DTL,
			BIZ_TEL_NO, BIZ_FAX_NO, SUB_RMK_URL,
			BANK_CD, BKAC_NO, BKAC_OWNER, BASIS_CDTLN_AMT,
			PCHS_PAY_DIV_CD, PCHS_CLMN_DIV_CD, PCHS_PMNT_MTD_CD, PCHS_VAT_CD,
			SELL_PAY_DIV_CD, SELL_CLMN_DIV_CD, SELL_PMNT_MTD_CD, SELL_VAT_CD,
			CLNT_RMK, USE_YN,
			LINK_GRP_YN,
            LINK_GRP_CLNT_CD,
            (SELECT CLNT_NM FROM TB_BM02M01 B WHERE B.CLNT_CD = A.CLNT_CD ) AS LINK_GRP_CLNT_NM
		FROM
			TB_BM02M01 A
		WHERE
			CLNT_CD = ${clntCd}
	</select>
	
	<select id="selectClntFileList" resultType="CamelMap">
		SELECT * FROM TB_CM08M01 WHERE FILE_TRGT_TYP = 'TB_BM02M01' AND FILE_TRGT_KEY = #{fileTrgtKey}
	</select>
	
	<select id="selectBizdeptList" resultType="CamelMap">
		SELECT
		    CLNT_CD,
			BIZDEPT_NM,
			BIZDEPT_DIV_CD,
			MNG_NM,
			MNG_DEPT_NM,
			MNG_PST_CD,
			MNG_TEL_NO,
			MNG_MOBLPHON_NO,
			MNG_EMAIL,
			SALES_CO_CD,
			SALES_EMP_ID,
			(SELECT NAME FROM TB_CM06M01 WHERE ID = A.SALES_EMP_ID) AS SALES_EMP_NM,
			USE_YN
		FROM 
			TB_BM02D01 A
		WHERE 
			CLNT_CD = #{clntCd}
	    <if test="salesCoCd !=null and !salesCoCd.equals('')">
			AND SALES_CO_CD = #{salesCoCd} 
		</if>			
	</select>
	
	<select id="selectPldgList" resultType="CamelMap">
		SELECT * FROM TB_BM02D02 WHERE CLNT_CD = #{clntCd}
	</select>
	
	<select id="selectMngInfo" resultType="CamelMap">
		SELECT
			A.SALES_EMP_ID,
			(SELECT NAME FROM TB_CM06M01 WHERE ID = A.SALES_EMP_ID) AS SALES_EMP_NM			
		FROM 
			( SELECT FN_BM02_MNG_ID( #{coCd} , #{clntCd} ) AS SALES_EMP_ID FROM DUAL ) AS A
			
	</select>

	<insert id="insertClnt">
		<selectKey keyProperty="clntCd" resultType="String" order="BEFORE">
			SELECT TB_BM02M01_SQ01.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_BM02M01 (
			CLNT_CD, CLNT_NM, CRN, COPRT_NO,
			CLNT_DIV_CD, REPST_NM, 
			BIZCON_NM, BSTY_NM, 
			BIZ_ZIP, BIZ_ADDR, BIZ_ADDR_DTL, 
			BIZ_TEL_NO, BIZ_FAX_NO, SUB_RMK_URL, 
			BANK_CD, BKAC_NO, BKAC_OWNER, BASIS_CDTLN_AMT, 
			PCHS_PAY_DIV_CD, PCHS_CLMN_DIV_CD, PCHS_PMNT_MTD_CD, PCHS_VAT_CD, 
			SELL_PAY_DIV_CD, SELL_CLMN_DIV_CD, SELL_PMNT_MTD_CD, SELL_VAT_CD, 
			CLNT_RMK, USE_YN, 
			CREAT_ID, CREAT_PGM, CREAT_DTTM,
			UDT_ID, UDT_PGM, UDT_DTTM,
			LINK_GRP_YN,LINK_GRP_CLNT_CD
		) VALUES (
			#{clntCd}, #{clntNm}, #{crn}, #{coprtNo},
			#{clntDivCd}, #{repstNm},
			#{bizconNm}, #{bstyNm},
			#{bizZip}, #{bizAddr}, #{bizAddrDtl},
			#{bizTelNo}, #{bizFaxNo}, #{subRmkUrl},
			#{bankCd}, #{bkacNo}, #{bkacOwner}, #{basisCdtlnAmt},
			#{pchsPayDivCd}, #{pchsClmnDivCd}, #{pchsPmntMtdCd}, #{pchsVatCd},
			#{sellPayDivCd}, #{sellClmnDivCd}, #{sellPmntMtdCd}, #{sellVatCd},
			#{clntRmk}, #{useYn},
			#{userId}, #{pgmId}, SYSDATE,
			#{userId}, #{pgmId}, SYSDATE,
			#{linkGrpYn}, #{linkGrpClntCd}
			
		)
	</insert>
	
	<update id="updateClnt">
		UPDATE
			TB_BM02M01
		SET
			CLNT_NM      = #{clntNm}, 
			CRN          = #{crn}, 
			COPRT_NO     = #{coprtNo}, 
			CLNT_DIV_CD  = #{clntDivCd},
			REPST_NM     = #{repstNm}, 
			BIZCON_NM    = #{bizconNm},
		    BSTY_NM      = #{bstyNm},
			BIZ_ZIP      = #{bizZip},
			BIZ_ADDR     = #{bizAddr},
			BIZ_ADDR_DTL = #{bizAddrDtl},
			BIZ_TEL_NO   = #{bizTelNo},
			BIZ_FAX_NO   = #{bizFaxNo},
			SUB_RMK_URL  = #{subRmkUrl},
			BANK_CD      = #{bankCd},
			BKAC_NO      = #{bkacNo},
			BKAC_OWNER   = #{bkacOwner},
			BASIS_CDTLN_AMT  = #{basisCdtlnAmt},
			PCHS_PAY_DIV_CD  = #{pchsPayDivCd},
			PCHS_CLMN_DIV_CD = #{pchsClmnDivCd},
			PCHS_PMNT_MTD_CD = #{pchsPmntMtdCd},
			PCHS_VAT_CD      = #{pchsVatCd},
			SELL_PAY_DIV_CD  = #{sellPayDivCd},
			SELL_CLMN_DIV_CD = #{sellClmnDivCd},
			SELL_PMNT_MTD_CD = #{sellPmntMtdCd},
			SELL_VAT_CD      = #{sellVatCd},
			CLNT_RMK         = #{clntRmk},
			USE_YN           = #{useYn},
			UDT_ID           = #{userId},
			UDT_PGM          = #{pgmId},
			UDT_DTTM         = SYSDATE,			
			LINK_GRP_YN      = #{linkGrpYn,     jdbcType=VARCHAR},
			LINK_GRP_CLNT_CD = #{linkGrpClntCd, jdbcType=VARCHAR}
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<update id="unuseClnt">
		UPDATE
			TB_BM02M01
		SET
			USE_YN = 'N'
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<update id="unuseBizdept">
		UPDATE
			TB_BM02D01
		SET
			USE_YN = 'N'
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<update id="deleteBizdept">
		DELETE
		FROM
			TB_BM02D01
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<insert id="insertBizdept">
		INSERT INTO GOLDMOON.TB_BM02D01
		(
			BIZDEPT_SN,
			CLNT_CD,
			BIZDEPT_NM, 
			BIZDEPT_DIV_CD,
			MNG_NM,
			MNG_DEPT_NM,
			MNG_PST_CD,
			MNG_TEL_NO,
			MNG_MOBLPHON_NO,
			MNG_EMAIL,
			SALES_CO_CD,
			SALES_EMP_ID,
			USE_YN,
			CREAT_ID,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM,
			UDT_DTTM
		)
		VALUES
		(
			TB_BM02D01_SQ01.NEXTVAL,
			#{clntCd},
			#{bizdeptNm}, 
			#{bizdeptDivCd},
			#{mngNm},
			#{mngDeptNm},
			#{mngPstCd},
			#{mngTelNo},
			#{mngMoblphonNo},
			#{mngEmail},
			#{salesCoCd},
			#{salesEmpId},
			'Y',
			#{userId},
			#{pgmId},
			SYSDATE,
			#{userId},
			#{pgmId},
			SYSDATE
		)
	</insert>
	
	<update id="unusePldg">
		UPDATE
			TB_BM02D02
		SET
			USE_YN = 'N'
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<update id="deletePldg">
		DELETE
		FROM
			TB_BM02D02
		WHERE
			CLNT_CD = #{clntCd}
	</update>
	
	<insert id="insertPldg">
		INSERT INTO TB_BM02D02
		(
			PLDG_SN,
			CLNT_CD,
			CO_CD,
			PLDG_DIV_CD,
			PLDG_AMT,
			PLDG_RCOGN_RATE,
			PLDG_RMK,
			USE_YN,
			CREAT_ID,
			CREAT_PGM,
			CREAT_DTTM,
			UDT_ID,
			UDT_PGM,
			UDT_DTTM
		)
		VALUES(
			TB_BM02D02_SQ01.NEXTVAL,
			#{clntCd},
			#{coCd},
			#{pldgDivCd},
			#{pldgAmt},
			#{pldgRcognRate},
			#{pldgRmk},
			'Y',
			#{userId},
			#{pgmId},
			SYSDATE,
			#{userId},
			#{pgmId},
			SYSDATE
		)
	</insert>
</mapper>